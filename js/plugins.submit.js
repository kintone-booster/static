/*
* FileName "plugins.submit.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(y){var d={},z=function(b,c,u,q){u=void 0===u?!1:u;q=void 0===q?{}:q;return new Promise(function(r,k){var m=[],v=function(e,n){var w=function(){e++;e<b.length?v(e,n):n()};(function(h){kb.filter.scan(d.app,c,h.condition.value)?kb.filter.auth(h.user.value,h.organization.value,h.group.value).then(function(x){if(x){var t={duplicate:function(l){try{h.duplicateCriteria.value.some(function(a){return!(a.value.external.value in d.fieldInfos.parallelize&&a.value.internal.value in d.fieldInfos.parallelize)})?
(kb.alert("No field to lookup was found"),k()):function(a){a&&m.push(a);l()}(h.duplicateCriteria.value.reduce(function(a,f){a.push(kb.filter.query.create(d.fieldInfos.parallelize[f.value.external.value],f.value.operator.value,c[d.fieldInfos.parallelize[f.value.internal.value].code]));return a},[]).join(" and "))}catch(a){kb.alert(kb.error.parse(a)),k()}},error:function(l){try{if(h.errorMessage.value||0!=h.errorField.value.length){var a=kb.filter.scan(d.app,c,h.errorFilter.value);a?(h.errorField.value.each(function(f,
g){f.value.field.value in d.fieldInfos.parallelize&&function(p){p.tableCode?a[p.tableCode].value.each(function(A,B){A.value[f.value.field.value].error=f.value.message.value}):c[f.value.field.value].error=f.value.message.value}(d.fieldInfos.parallelize[f.value.field.value])}),u||kb.loadEnd(),r({error:!0,message:h.errorMessage.value})):l()}else l()}catch(f){kb.alert(kb.error.parse(f)),k()}},numbering:function(l){try{if(h.numberingField.value in d.fieldInfos.parallelize)if(c[h.numberingField.value].value)l();
else{var a="",f=h.numberingGroup.value.reduce(function(g,p){if(p.value.field.value in d.fieldInfos.parallelize)switch(a+=c[p.value.field.value].value,d.fieldInfos.parallelize[p.value.field.value].type){case "DROP_DOWN":case "RADIO_BUTTON":g.push(p.value.field.value+' in ("'+c[p.value.field.value].value+'")');break;default:g.push(p.value.field.value+'="'+c[p.value.field.value].value+'"')}return g},"$id"in c?['$id!="'+c.$id.value+'"']:[]);a in q?(q[a]++,c[h.numberingField.value].value=a+q[a].toString().lpad("0",
parseInt(h.numberingDigits.value)),l()):kintone.api(kintone.api.url("/k/v1/records",!0),"GET",{app:d.app.id,query:f.join(" and ")+" order by "+h.numberingField.value+" desc limit 1 offset 0"}).then(function(g){g=g.records;var p=0;0!=g.length&&(p=parseInt((g.first()[h.numberingField.value].value||" ").replace(/[ ]+/g,"").replace(new RegExp("^"+a,"g"),"")));p++;g=p;q[a]=g;c[h.numberingField.value].value=a+g.toString().lpad("0",parseInt(h.numberingDigits.value));l()})["catch"](function(g){kb.alert(kb.error.parse(g));
k()})}else l()}catch(g){kb.alert(kb.error.parse(g)),k()}},prompt:function(l){try{(function(a){0!=a.length?function(f){a.each(function(g,p){f.append(kb.field.activate(kb.field.create(g).css({width:"100%"}),d.app,!1))});u||kb.loadEnd();(new KintoneBoosterPopupform(f,600,"full",{ok:function(){var g=kb.record.get(f,d.app,!0);a.each(function(p,A){c[p.code].value=g.record[p.code].value});u||kb.loadStart();l()},cancel:function(){u||kb.loadStart();l()}})).show()}(kb.create("div").addClass("kb-scope").attr("form-id",
"form_"+d.app.id)):l()})(h.promptField.value.reduce(function(a,f){f.value.field.value in d.fieldInfos.parallelize&&(h.promptOverwrite.value.includes("overwrite")?a.push(d.fieldInfos.parallelize[f.value.field.value]):kb.field.isEmpty(c[f.value.field.value].value)&&a.push(d.fieldInfos.parallelize[f.value.field.value]));return a},[]))}catch(a){kb.alert(kb.error.parse(a)),k()}},verify:function(l){try{(function(a){0!=a.length?function(f){a.each(function(g,p){f.append(kb.field.activate(kb.field.create(g).addClass("kb-readonly").css({width:"100%"}),
d.app,!1))});kb.record.set(f,d.app,c);u||kb.loadEnd();(new KintoneBoosterPopupform(f,600,"full",{ok:function(){u||kb.loadStart();l()},cancel:function(){u||kb.loadEnd();r({error:!0})}})).show()}(kb.create("div").addClass("kb-scope kb-verify").attr("form-id","form_"+d.app.id).append(kb.create("p").html(h.verifyMessage.value))):l()})(h.verifyField.value.reduce(function(a,f){f.value.field.value in d.fieldInfos.parallelize&&a.push(d.fieldInfos.parallelize[f.value.field.value]);return a},[]))}catch(a){kb.alert(kb.error.parse(a)),
k()}}};t.numbering(function(){t.prompt(function(){t.verify(function(){t.error(function(){t.duplicate(function(){w()})})})})})}else w()})["catch"](function(x){kb.alert(kb.error.parse(x));k()}):w()})(b[e])};u||kb.loadStart();v(0,function(){u||kb.loadEnd();0!=m.length?kintone.api(kintone.api.url("/k/v1/records",!0),"GET",{app:d.app.id,query:function(e,n){return(n?"$id!="+n+" and ("+e+")":e)+" order by $id asc limit 5 offset 0"}(m.map(function(e){return"("+e+")"}).join(" or "),"$id"in c?c.$id.value:"")}).then(function(e){0!=
e.records.length?kb.confirm(function(n){e.records.each(function(w){n.append(kb.create("p").css({margin:"0"}).append(kb.create("a").attr("href",kb.record.page.detail(d.mobile,d.app.id,w.$id.value)).attr("target","_blank").html("Record No: "+w.$id.value)))});return n}(kb.create("div").append(kb.create("p").css({margin:"0"}).html(kb.constants.submit.message.duplicate[kb.operator.language]))),function(n){r({error:n})},!0):r({error:!1})})["catch"](function(e){kb.alert(kb.error.parse(e),function(){r({error:!1})})}):
r({error:!1})})})};kintone.events.on("app.record.create.submit app.record.detail.process.proceed app.record.edit.submit mobile.app.record.create.submit mobile.app.record.detail.process.proceed mobile.app.record.edit.submit".split(" "),function(b){return new Promise(function(c,u){(function(q,r){d.mobile=q;d.type=r;kb.config[y].config.get().then(function(k){0!=Object.keys(k).length?kb.field.load(kb.config[y].app,!0).then(function(m){d.app={id:kb.config[y].app,fields:m.origin};d.fieldInfos=m;try{(function(v){if(0!=
v.length)switch(d.type){case "create":case "edit":z(v,b.record).then(function(e){e.error&&(b.error="message"in e?e.message:kb.constants.submit.message.cancel.submit[kb.operator.language]);c(b)})["catch"](function(){b.error=kb.constants.submit.message.cancel.submit[kb.operator.language];c(b)});(function(e){if(0!=e.length)kintone.events.on((d.mobile?"mobile.":"")+"app.record."+d.type+".submit.success",function(n){return new Promise(function(w,h){var x=function(t){(function(l){kb.filter.scan(d.app,n.record,
l.condition.value)?kb.filter.auth(l.user.value,l.organization.value,l.group.value).then(function(a){if(a){a=l.url.value;var f=n.record,g;for(g in f)a=a.replace(new RegExp("%"+g+"%","g"),kb.field.stringify(d.fieldInfos.parallelize[g],f[g].value," / "));n.url=a}t++;t<e.length&&x(t)})["catch"](function(a){t++;t<e.length&&x(t)}):(t++,t<e.length&&x(t))})(e[t])};x(0);w(n)})})})(v.filter(function(e){return e.url.value}));break;case "process":(function(e){0!=e.length?z(e,b.record).then(function(n){n.error&&
(b.error="message"in n?n.message:kb.constants.submit.message.cancel.submit[kb.operator.language]);c(b)})["catch"](function(){b.error=kb.constants.submit.message.cancel.submit[kb.operator.language];c(b)}):c(b)})(v.filter(function(e){return e.action.value==b.action.value+":"+b.status.value+":"+b.nextStatus.value}))}else c(b)})(JSON.parse(k.tab).map(function(v,e){return kb.extend({sIndex:{value:e.toString()}},v.setting)}).reduce(function(v,e){(d.mobile?["both","mobile"]:["both","pc"]).includes(e.device.value)&&
e.event.value.includes(d.type)&&v.push(e);return v},[]))}catch(v){kb.alert(kb.error.parse(v)),c(b)}})["catch"](function(m){return c(b)}):c(b)})["catch"](function(k){return c(b)})})("mobile"==b.type.split(".").first(),b.type.split(".").slice(-2).first())})});kintone.events.on("app.record.create.show app.record.detail.show app.record.edit.show mobile.app.record.create.show mobile.app.record.detail.show mobile.app.record.edit.show".split(" "),function(b){return new Promise(function(c,u){kb.config[y].config.get().then(function(q){if(0!=
Object.keys(q).length)try{JSON.parse(q.tab).some(function(r){return!r.setting.duplicateCriteria})&&kb.alert(kb.error.config.update("Boost! Submit")),c(b)}catch(r){kb.alert(kb.error.parse(r)),c(b)}else c(b)})["catch"](function(q){return c(b)})})});kb.event.on("kb.submit.call",function(b){return new Promise(function(c,u){kb.config[y].config.get().then(function(q){0!=Object.keys(q).length?kb.field.load(kb.config[y].app,!0).then(function(r){d.app={id:kb.config[y].app,fields:r.origin};d.fieldInfos=r;try{(function(k){k.some(function(m){return!m.duplicateCriteria})&&
(kb.alert(kb.error.config.update("Boost! Submit")),k=[]);0!=k.length?z(k,b.record,!0,b.numbering).then(function(m){m.error?(b.error=!0,m.message?kb.alert(m.message,function(){return c(b)}):c(b)):c(b)})["catch"](function(){b.error=!0;c(b)}):c(b)})(JSON.parse(q.tab).map(function(k,m){return kb.extend({sIndex:{value:m.toString()}},k.setting)}).reduce(function(k,m){(b.mobile?["both","mobile"]:["both","pc"]).includes(m.device.value)&&m.event.value.includes(b.pattern)&&k.push(m);return k},[]))}catch(k){kb.alert(kb.error.parse(k)),
c(b)}})["catch"](function(r){return c(b)}):c(b)})["catch"](function(q){return c(b)})})})})(kintone.$PLUGIN_ID);
kb.constants=kb.extend({submit:{message:{cancel:{process:{en:"The process action was canceled.",ja:"\u30d7\u30ed\u30bb\u30b9\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u30ad\u30e3\u30f3\u30bb\u30eb\u3055\u308c\u307e\u3057\u305f\u3002",zh:"\u8fdb\u7a0b\u64cd\u4f5c\u5df2\u88ab\u53d6\u6d88\u3002"},submit:{en:"The submit was canceled.",ja:"\u4fdd\u5b58\u304c\u30ad\u30e3\u30f3\u30bb\u30eb\u3055\u308c\u307e\u3057\u305f\u3002",zh:"\u4fdd\u5b58\u5df2\u88ab\u53d6\u6d88\u3002"}},duplicate:{en:"A similar record already exists. Would you like to proceed with the registration anyway?",
ja:"\u985e\u4f3c\u30ec\u30b3\u30fc\u30c9\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u3053\u306e\u307e\u307e\u767b\u9332\u3057\u3066\u3082\u5b9c\u3057\u3044\u3067\u3059\u304b\uff1f",zh:"\u5df2\u7ecf\u6709\u7c7b\u4f3c\u7684\u8bb0\u5f55\u5b58\u5728\u4e86\uff0c\u60a8\u8fd8\u8981\u7ee7\u7eed\u6ce8\u518c\u5417\uff1f"}}}},kb.constants);