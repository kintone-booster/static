/*
* FileName "plugins.submit.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(w){var c={},y=function(a,d,n,r){n=void 0===n?!1:n;r=void 0===r?{}:r;return new Promise(function(u,m){var q=function(p,k){var t=function(){p++;p<a.length?q(p,k):k()};(function(g){kb.filter.scan(c.app,d,g.condition.value)?kb.filter.auth(g.user.value,g.organization.value,g.group.value).then(function(x){if(x){var v={error:function(e){try{g.errorMessage.value||0!=g.errorField.value.length?kb.filter.scan(c.app,d,g.errorFilter.value)?(g.errorField.value.each(function(b,f){b.value.field.value in
c.fieldInfos.parallelize&&(d[b.value.field.value].error=b.value.message.value)}),n||kb.loadEnd(),u({error:!0,message:g.errorMessage.value})):e():e()}catch(b){kb.alert(kb.error.parse(b)),m()}},numbering:function(e){try{if(g.numberingField.value in c.fieldInfos.parallelize)if(d[g.numberingField.value].value)e();else{var b="",f=g.numberingGroup.value.reduce(function(h,l){if(l.value.field.value in c.fieldInfos.parallelize)switch(b+=d[l.value.field.value].value,c.fieldInfos.parallelize[l.value.field.value].type){case "DROP_DOWN":case "RADIO_BUTTON":h.push(l.value.field.value+
' in ("'+d[l.value.field.value].value+'")');break;default:h.push(l.value.field.value+'="'+d[l.value.field.value].value+'"')}return h},"$id"in d?["$id!="+d.$id.value]:[]);b in r?(r[b]++,d[g.numberingField.value].value=b+r[b].toString().lpad("0",parseInt(g.numberingDigits.value)),e()):kintone.api(kintone.api.url("/k/v1/records",!0),"GET",{app:c.app.id,query:f.join(" and ")+" order by "+g.numberingField.value+" desc limit 1 offset 0"}).then(function(h){h=h.records;var l=0;0!=h.length&&(l=parseInt((h.first()[g.numberingField.value].value||
" ").replace(/[ ]+/g,"").replace(new RegExp("^"+b,"g"),"")));l++;h=l;r[b]=h;d[g.numberingField.value].value=b+h.toString().lpad("0",parseInt(g.numberingDigits.value));e()})["catch"](function(h){kb.alert(kb.error.parse(h));m()})}else e()}catch(h){kb.alert(kb.error.parse(h)),m()}},prompt:function(e){try{(function(b){0!=b.length?function(f){b.each(function(h,l){f.append(kb.field.activate(kb.field.create(h).css({width:"100%"}),c.app,!1))});n||kb.loadEnd();(new KintoneBoosterPopupform(f,600,"full",{ok:function(){var h=
kb.record.get(f,c.app,!0);b.each(function(l,z){d[l.code].value=h.record[l.code].value});n||kb.loadStart();e()},cancel:function(){n||kb.loadStart();e()}})).show()}(kb.create("div").addClass("kb-scope").attr("form-id","form_"+c.app.id)):e()})(g.promptField.value.reduce(function(b,f){f.value.field.value in c.fieldInfos.parallelize&&(g.promptOverwrite.value.includes("overwrite")?b.push(c.fieldInfos.parallelize[f.value.field.value]):kb.field.isEmpty(d[f.value.field.value].value)&&b.push(c.fieldInfos.parallelize[f.value.field.value]));
return b},[]))}catch(b){kb.alert(kb.error.parse(b)),m()}},verify:function(e){try{(function(b){0!=b.length?function(f){b.each(function(h,l){f.append(kb.field.activate(kb.field.create(h).addClass("kb-readonly").css({width:"100%"}),c.app,!1))});kb.record.set(f,c.app,d);n||kb.loadEnd();(new KintoneBoosterPopupform(f,600,"full",{ok:function(){n||kb.loadStart();e()},cancel:function(){n||kb.loadEnd();u({error:!0})}})).show()}(kb.create("div").addClass("kb-scope kb-verify").attr("form-id","form_"+c.app.id).append(kb.create("p").html(g.verifyMessage.value))):
e()})(g.verifyField.value.reduce(function(b,f){f.value.field.value in c.fieldInfos.parallelize&&b.push(c.fieldInfos.parallelize[f.value.field.value]);return b},[]))}catch(b){kb.alert(kb.error.parse(b)),m()}}};v.numbering(function(){v.prompt(function(){v.verify(function(){v.error(function(){t()})})})})}else t()})["catch"](function(x){kb.alert(kb.error.parse(x));m()}):t()})(a[p])};n||kb.loadStart();q(0,function(){n||kb.loadEnd();u({error:!1})})})};kintone.events.on("app.record.create.submit app.record.detail.process.proceed app.record.edit.submit mobile.app.record.create.submit mobile.app.record.detail.process.proceed mobile.app.record.edit.submit".split(" "),
function(a){return new Promise(function(d,n){(function(r,u){c.mobile=r;c.type=u;kb.config[w].config.get().then(function(m){0!=Object.keys(m).length?kb.field.load(kb.config[w].app,!0).then(function(q){c.app={id:kb.config[w].app,fields:q.origin};c.fieldInfos=q;try{(function(p){if(0!=p.length)switch(c.type){case "create":case "edit":y(p,a.record).then(function(k){k.error&&(a.error="message"in k?k.message:kb.constants.submit.message.cancel.submit[kb.operator.language]);d(a)})["catch"](function(){a.error=
kb.constants.submit.message.cancel.submit[kb.operator.language];d(a)});(function(k){if(0!=k.length)kintone.events.on((c.mobile?"mobile.":"")+"app.record."+c.type+".submit.success",function(t){return new Promise(function(g,x){var v=function(e){(function(b){kb.filter.scan(c.app,t.record,b.condition.value)?kb.filter.auth(b.user.value,b.organization.value,b.group.value).then(function(f){if(f){f=b.url.value;var h=t.record,l;for(l in h)f=f.replace(new RegExp("%"+l+"%","g"),kb.field.stringify(c.fieldInfos.parallelize[l],
h[l].value," / "));t.url=f}e++;e<k.length&&v(e)})["catch"](function(f){e++;e<k.length&&v(e)}):(e++,e<k.length&&v(e))})(k[e])};v(0);g(t)})})})(p.filter(function(k){return k.url.value}));break;case "process":(function(k){0!=k.length?y(k,a.record).then(function(t){t.error&&(a.error="message"in t?t.message:kb.constants.submit.message.cancel.submit[kb.operator.language]);d(a)})["catch"](function(){a.error=kb.constants.submit.message.cancel.submit[kb.operator.language];d(a)}):d(a)})(p.filter(function(k){return k.action.value==
a.action.value+":"+a.status.value+":"+a.nextStatus.value}))}else d(a)})((c.config?c.config:c.config=JSON.parse(m.tab)).reduce(function(p,k){(c.mobile?["both","mobile"]:["both","pc"]).includes(k.setting.device.value)&&k.setting.event.value.includes(c.type)&&p.push(k.setting);return p},[]))}catch(p){kb.alert(kb.error.parse(p)),d(a)}})["catch"](function(q){return d(a)}):d(a)})["catch"](function(m){return d(a)})})("mobile"==a.type.split(".").first(),a.type.split(".").slice(-2).first())})});kb.event.on("kb.submit.call",
function(a){return new Promise(function(d,n){kb.config[w].config.get().then(function(r){0!=Object.keys(r).length?kb.field.load(kb.config[w].app,!0).then(function(u){c.app={id:kb.config[w].app,fields:u.origin};c.fieldInfos=u;try{(function(m){0!=m.length?y(m,a.record,!0,a.numbering).then(function(q){q.error?(a.error=!0,q.message?kb.alert(q.message,function(){return d(a)}):d(a)):d(a)})["catch"](function(){a.error=!0;d(a)}):d(a)})((c.config?c.config:c.config=JSON.parse(r.tab)).reduce(function(m,q){(a.mobile?
["both","mobile"]:["both","pc"]).includes(q.setting.device.value)&&q.setting.event.value.includes(a.pattern)&&m.push(q.setting);return m},[]))}catch(m){kb.alert(kb.error.parse(m)),d(a)}})["catch"](function(u){return d(a)}):d(a)})["catch"](function(r){return d(a)})})})})(kintone.$PLUGIN_ID);
kb.constants=kb.extend({submit:{message:{cancel:{process:{en:"The process action was canceled.",ja:"\u30d7\u30ed\u30bb\u30b9\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u30ad\u30e3\u30f3\u30bb\u30eb\u3055\u308c\u307e\u3057\u305f\u3002",zh:"\u8fdb\u7a0b\u64cd\u4f5c\u5df2\u88ab\u53d6\u6d88\u3002"},submit:{en:"The submit was canceled.",ja:"\u4fdd\u5b58\u304c\u30ad\u30e3\u30f3\u30bb\u30eb\u3055\u308c\u307e\u3057\u305f\u3002",zh:"\u4fdd\u5b58\u5df2\u88ab\u53d6\u6d88\u3002"}}}}},kb.constants);