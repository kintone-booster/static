/*
* FileName "plugins.submit.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(y=>{var d={},z=(b,c,v=!1,t={})=>new Promise((q,k)=>{var n=[],u=(e,p)=>{var w=()=>{e++;e<b.length?u(e,p):p()};(h=>{kb.filter.scan(d.app,c,h.condition.value)?kb.filter.auth(h.user.value,h.organization.value,h.group.value).then(x=>{if(x){var r={duplicate:l=>{try{h.duplicateCriteria.value.some(a=>!(a.value.external.value in d.fieldInfos.parallelize&&a.value.internal.value in d.fieldInfos.parallelize))?(kb.alert("No field to lookup was found"),k()):(a=>{a&&n.push(a);l()})(h.duplicateCriteria.value.reduce((a,
f)=>{a.push(kb.filter.query.create(d.fieldInfos.parallelize[f.value.external.value],f.value.operator.value,c[d.fieldInfos.parallelize[f.value.internal.value].code]));return a},[]).join(" and "))}catch(a){kb.alert(kb.error.parse(a)),k()}},error:l=>{try{if(h.errorMessage.value||0!=h.errorField.value.length){var a=kb.filter.scan(d.app,c,h.errorFilter.value);a?(h.errorField.value.each((f,g)=>{f.value.field.value in d.fieldInfos.parallelize&&(m=>{m.tableCode?a[m.tableCode].value.each((A,B)=>{A.value[f.value.field.value].error=
f.value.message.value}):c[f.value.field.value].error=f.value.message.value})(d.fieldInfos.parallelize[f.value.field.value])}),v||kb.loadEnd(),q({error:!0,message:h.errorMessage.value})):l()}else l()}catch(f){kb.alert(kb.error.parse(f)),k()}},numbering:l=>{try{if(h.numberingField.value in d.fieldInfos.parallelize)if(c[h.numberingField.value].value)l();else{var a="",f=h.numberingGroup.value.reduce((g,m)=>{if(m.value.field.value in d.fieldInfos.parallelize)switch(a+=c[m.value.field.value].value,d.fieldInfos.parallelize[m.value.field.value].type){case "DROP_DOWN":case "RADIO_BUTTON":g.push(m.value.field.value+
' in ("'+c[m.value.field.value].value+'")');break;default:g.push(m.value.field.value+'="'+c[m.value.field.value].value+'"')}return g},"$id"in c?['$id!="'+c.$id.value+'"']:[]);a in t?(t[a]++,c[h.numberingField.value].value=a+t[a].toString().lpad("0",parseInt(h.numberingDigits.value)),l()):kintone.api(kintone.api.url("/k/v1/records",!0),"GET",{app:d.app.id,query:f.join(" and ")+" order by "+h.numberingField.value+" desc limit 1 offset 0"}).then(g=>{g=g.records;var m=0;0!=g.length&&(m=parseInt((g.first()[h.numberingField.value].value||
" ").replace(/[ ]+/g,"").replace(new RegExp("^"+a,"g"),"")),isNumeric(m)||(m=0));m++;g=m;t[a]=g;c[h.numberingField.value].value=a+g.toString().lpad("0",parseInt(h.numberingDigits.value));l()}).catch(g=>{kb.alert(kb.error.parse(g));k()})}else l()}catch(g){kb.alert(kb.error.parse(g)),k()}},prompt:l=>{try{(a=>{0!=a.length?(f=>{a.each((g,m)=>{f.append(kb.field.activate(kb.field.create(g).css({width:"100%"}),d.app,!1))});v||kb.loadEnd();(new KintoneBoosterPopupform(f,600,"full",{ok:()=>{var g=kb.record.get(f,
d.app,!0);a.each((m,A)=>{c[m.code].value=g.record[m.code].value});v||kb.loadStart();l()},cancel:()=>{v||kb.loadStart();l()}})).show()})(kb.create("div").addClass("kb-scope").attr("form-id","form_"+d.app.id)):l()})(h.promptField.value.reduce((a,f)=>{f.value.field.value in d.fieldInfos.parallelize&&(h.promptOverwrite.value.includes("overwrite")?a.push(d.fieldInfos.parallelize[f.value.field.value]):kb.field.isEmpty(c[f.value.field.value].value)&&a.push(d.fieldInfos.parallelize[f.value.field.value]));
return a},[]))}catch(a){kb.alert(kb.error.parse(a)),k()}},verify:l=>{try{(a=>{0!=a.length?(f=>{a.each((g,m)=>{f.append(kb.field.activate(kb.field.create(g).addClass("kb-readonly").css({width:"100%"}),d.app,!1))});kb.record.set(f,d.app,c);v||kb.loadEnd();(new KintoneBoosterPopupform(f,600,"full",{ok:()=>{v||kb.loadStart();l()},cancel:()=>{v||kb.loadEnd();q({error:!0})}})).show()})(kb.create("div").addClass("kb-scope kb-verify").attr("form-id","form_"+d.app.id).append(kb.create("p").html(h.verifyMessage.value))):
l()})(h.verifyField.value.reduce((a,f)=>{f.value.field.value in d.fieldInfos.parallelize&&a.push(d.fieldInfos.parallelize[f.value.field.value]);return a},[]))}catch(a){kb.alert(kb.error.parse(a)),k()}}};r.numbering(()=>{r.prompt(()=>{r.verify(()=>{r.error(()=>{r.duplicate(()=>{w()})})})})})}else w()}).catch(x=>{kb.alert(kb.error.parse(x));k()}):w()})(b[e])};v||kb.loadStart();u(0,()=>{v||kb.loadEnd();0!=n.length?kintone.api(kintone.api.url("/k/v1/records",!0),"GET",{app:d.app.id,query:((e,p)=>(p?"$id!="+
p+" and ("+e+")":e)+" order by $id asc limit 5 offset 0")(n.map(e=>"("+e+")").join(" or "),"$id"in c?c.$id.value:"")}).then(e=>{0!=e.records.length?kb.confirm((p=>{e.records.each(w=>{p.append(kb.create("p").css({margin:"0"}).append(kb.create("a").attr("href",kb.record.page.detail(d.mobile,d.app.id,w.$id.value)).attr("target","_blank").html("Record No: "+w.$id.value)))});return p})(kb.create("div").append(kb.create("p").css({margin:"0"}).html(kb.constants.submit.message.duplicate[kb.operator.language]))),
p=>{q({error:p})},!0):q({error:!1})}).catch(e=>{kb.alert(kb.error.parse(e),()=>{q({error:!1})})}):q({error:!1})})});kintone.events.on("app.record.create.submit app.record.detail.process.proceed app.record.edit.submit mobile.app.record.create.submit mobile.app.record.detail.process.proceed mobile.app.record.edit.submit".split(" "),b=>new Promise((c,v)=>{((t,q)=>{d.mobile=t;d.type=q;kb.config[y].config.get().then(k=>{0!=Object.keys(k).length?kb.field.load(kb.config[y].app,!0).then(n=>{d.app={id:kb.config[y].app,
fields:n.origin};d.fieldInfos=n;try{(u=>{if(0!=u.length)switch(d.type){case "create":case "edit":z(u,b.record).then(e=>{e.error&&(b.error="message"in e?e.message:kb.constants.submit.message.cancel.submit[kb.operator.language]);c(b)}).catch(()=>{b.error=kb.constants.submit.message.cancel.submit[kb.operator.language];c(b)});(e=>{if(0!=e.length)kintone.events.on((d.mobile?"mobile.":"")+"app.record."+d.type+".submit.success",p=>new Promise((w,h)=>{var x=r=>{(l=>{kb.filter.scan(d.app,p.record,l.condition.value)?
kb.filter.auth(l.user.value,l.organization.value,l.group.value).then(a=>{if(a){a=l.url.value;var f=p.record,g;for(g in f)a=a.replace(new RegExp("%"+g+"%","g"),kb.field.stringify(d.fieldInfos.parallelize[g],f[g].value," / "));p.url=a}r++;r<e.length&&x(r)}).catch(a=>{r++;r<e.length&&x(r)}):(r++,r<e.length&&x(r))})(e[r])};x(0);w(p)}))})(u.filter(e=>e.url.value));break;case "process":(e=>{0!=e.length?z(e,b.record).then(p=>{p.error&&(b.error="message"in p?p.message:kb.constants.submit.message.cancel.submit[kb.operator.language]);
c(b)}).catch(()=>{b.error=kb.constants.submit.message.cancel.submit[kb.operator.language];c(b)}):c(b)})(u.filter(e=>e.action.value==b.action.value+":"+b.status.value+":"+b.nextStatus.value))}else c(b)})(JSON.parse(k.tab).map((u,e)=>kb.extend({sIndex:{value:e.toString()}},u.setting)).reduce((u,e)=>{(d.mobile?["both","mobile"]:["both","pc"]).includes(e.device.value)&&e.event.value.includes(d.type)&&u.push(e);return u},[]))}catch(u){kb.alert(kb.error.parse(u)),c(b)}}).catch(n=>c(b)):c(b)}).catch(k=>
c(b))})("mobile"==b.type.split(".").first(),b.type.split(".").slice(-2).first())}));kintone.events.on("app.record.create.show app.record.detail.show app.record.edit.show mobile.app.record.create.show mobile.app.record.detail.show mobile.app.record.edit.show".split(" "),b=>new Promise((c,v)=>{kb.config[y].config.get().then(t=>{if(0!=Object.keys(t).length)try{JSON.parse(t.tab).some(q=>!q.setting.duplicateCriteria)&&kb.alert(kb.error.config.update("Boost! Submit")),c(b)}catch(q){kb.alert(kb.error.parse(q)),
c(b)}else c(b)}).catch(t=>c(b))}));kb.event.on("kb.submit.call",b=>new Promise((c,v)=>{kb.config[y].config.get().then(t=>{0!=Object.keys(t).length?kb.field.load(kb.config[y].app,!0).then(q=>{d.app={id:kb.config[y].app,fields:q.origin};d.fieldInfos=q;try{(k=>{k.some(n=>!n.duplicateCriteria)&&(kb.alert(kb.error.config.update("Boost! Submit")),k=[]);0!=k.length?z(k,b.record,!0,b.numbering).then(n=>{n.error?(b.error=!0,n.message?kb.alert(n.message,()=>c(b)):c(b)):c(b)}).catch(()=>{b.error=!0;c(b)}):c(b)})(JSON.parse(t.tab).map((k,
n)=>kb.extend({sIndex:{value:n.toString()}},k.setting)).reduce((k,n)=>{(b.mobile?["both","mobile"]:["both","pc"]).includes(n.device.value)&&n.event.value.includes(b.pattern)&&k.push(n);return k},[]))}catch(k){kb.alert(kb.error.parse(k)),c(b)}}).catch(q=>c(b)):c(b)}).catch(t=>c(b))}))})(kintone.$PLUGIN_ID);
kb.constants=kb.extend({submit:{message:{cancel:{process:{en:"The process action was canceled.",ja:"\u30d7\u30ed\u30bb\u30b9\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u30ad\u30e3\u30f3\u30bb\u30eb\u3055\u308c\u307e\u3057\u305f\u3002",zh:"\u8fdb\u7a0b\u64cd\u4f5c\u5df2\u88ab\u53d6\u6d88\u3002"},submit:{en:"The submit was canceled.",ja:"\u4fdd\u5b58\u304c\u30ad\u30e3\u30f3\u30bb\u30eb\u3055\u308c\u307e\u3057\u305f\u3002",zh:"\u4fdd\u5b58\u5df2\u88ab\u53d6\u6d88\u3002"}},duplicate:{en:"A similar record already exists. Would you like to proceed with the registration anyway?",
ja:"\u985e\u4f3c\u30ec\u30b3\u30fc\u30c9\u304c\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u3053\u306e\u307e\u307e\u767b\u9332\u3057\u3066\u3082\u5b9c\u3057\u3044\u3067\u3059\u304b\uff1f",zh:"\u5df2\u7ecf\u6709\u7c7b\u4f3c\u7684\u8bb0\u5f55\u5b58\u5728\u4e86\uff0c\u60a8\u8fd8\u8981\u7ee7\u7eed\u6ce8\u518c\u5417\uff1f"}}}},kb.constants);