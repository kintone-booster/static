/*
* FileName "plugins.spread.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(v=>{var p,f;kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],l=>new Promise((r,z)=>{((A,B)=>{p=A;kb.config[v].config.get().then(w=>{0!=Object.keys(w).length?kb.field.load(kb.config[v].app,!0).then(t=>{f={id:kb.config[v].app,disables:t.disables.reduce((c,d)=>{d in t.parallelize&&c.push(t.parallelize[d]);return c},[]),fields:((c,d)=>{var q={},m;for(m in c){var e=c[m];e.tableCode?e.tableCode in q||(q[e.tableCode]=d[e.tableCode]):q[m]=e}return q})(t.parallelize,
t.tables),view:{}};try{(c=>{c?(d=>{var q=()=>{d.elm(".kb-view").elms("[unsaved=unsaved]").each((m,e)=>{m.removeAttr("unsaved").removeClass("kb-unsaved")});window.location.reload(!0)};p&&kb.elm("body").addClass("kb-mobile");d.append(kb.create("div").addClass("kb-spread-toolbar").append(kb.create("button").addClass("kb-spread-toolbar-button kb-spread-toolbar-button-submit").html(kb.constants.common.caption.button.submit[kb.operator.language]).on("click",m=>{((e,u)=>{var g={post:[],put:[]},n={submit:(b,
a)=>{if(0!=e.length){var h=kb.record.get(e[b],f);h.error?a(!0):kb.event.call("kb.submit.call",{record:h.record,mobile:p,numbering:u,pattern:h.record.$id.value?"edit":"create",workplace:"view"}).then(k=>{k.error?(kb.record.set(e[b],f,k.record),a(!0)):(k.record.$id.value?g.put.push({id:k.record.$id.value,record:k.record}):g.post.push(k.record),b++,b<e.length?n.submit(b,a):a())}).catch(()=>{})}else a()},success:(b,a,h,k)=>{let y=()=>{b++;b<g[a].length?n.success(b,a,h,k):"post"==a?n.success(0,"put",h,
k):k()};0!=g[a].length?kb.event.call("kb."+h+".call",{record:"post"==a?g[a][b]:g[a][b].record,mobile:p,pattern:"post"==a?"create":"edit",workplace:"view"}).then(x=>{x.error||("post"==a?g[a][b]=x.record:g[a][b].record=x.record,y())}).catch(()=>{}):y()}};n.submit(0,b=>{b||(0!=g.post.length+g.put.length?(kb.loadStart(),kb.event.call("kb.view.submit",{container:d.elm(".kb-view"),records:g,viewId:c.view.value}).then(a=>{a.error||kb.confirm(kb.constants.common.message.confirm.submit[kb.operator.language],
()=>{kb.loadStart();kb.view.records.set(f.id,a.records,!0,!0).then(h=>{kb.event.call("kb.view.submit.success",{container:a.container,records:a.records,viewId:a.viewId}).then(k=>{k.error||n.success(0,"post","mail",()=>{n.success(0,"post","omail",()=>{n.success(0,"post","upsert",()=>{kb.alert("Done!",()=>q())})})})})}).catch(h=>{kb.alert(kb.error.parse(h));z()})})})):kb.alert(kb.constants.common.message.invalid.submit[kb.operator.language]))})})(d.elm(".kb-view").elms("[unsaved=unsaved]"),{})})).append(kb.create("button").addClass("kb-spread-toolbar-button").html(kb.constants.common.caption.button.cancel[kb.operator.language]).on("click",
m=>{0!=d.elm(".kb-view").elms("[unsaved=unsaved]").length&&kb.confirm(kb.constants.common.message.confirm.cancel[kb.operator.language],()=>q())})));kb.view.load(f.id).then(m=>{f.view={buttons:c.buttons.value,fields:m.list.reduce((e,u)=>u.id==c.view.value?u.fields:e,[]),mode:c.mode.value};kb.event.call("kb.attachment.call",{mode:"placeholder",fields:f.fields}).then(e=>{(u=>{l.records.each((g,n)=>{(b=>{kb.event.call("kb.action.call",{container:b.elm("[form-id=form_"+f.id+"]"),record:g,mobile:p,pattern:"editor"==
c.mode.value?"edit":"dummy",workplace:"view"}).then(a=>{kb.event.call("kb.style.call",{container:b.elm("[form-id=form_"+f.id+"]"),record:a.record,mobile:a.mobile,pattern:"editor"==c.mode.value?"edit":"detail",workplace:a.workplace}).then(h=>{kb.record.set(b.elm("[form-id=form_"+f.id+"]"),f,h.record).then(()=>{b.elm(".kb-view-row-edit").attr("href",kb.record.page.detail(p,f.id,h.record.$id.value));n==l.records.length-1&&d.parentNode.show()})}).catch(()=>{})}).catch(()=>{})})(u.addRow())})})(kb.view.create(d,
f,c.view.value,p).elm(".kb-view"));r(l)}).catch(()=>{})});window.on("beforeunload",m=>{0!=d.elm(".kb-view").elms("[unsaved=unsaved]").length&&(m.returnValue=kb.constants.common.message.confirm.changed[kb.operator.language])})})(kb.elm(p?".gaia-mobile-v2-indexviewpanel-tableview":"#view-list-data-gaia").addClass("kb-view-container").empty()):r(l)})(JSON.parse(w.flat).setting.value.reduce((c,d)=>{d.value.view.value==l.viewId.toString()&&(c=d.value);return c},null))}catch(c){kb.alert(kb.error.parse(c)),
r(l)}}).catch(t=>r(l)):r(l)}).catch(w=>r(l))})("mobile"==l.type.split(".").first(),l.type.split(".").slice(-2).first())}))})(kintone.$PLUGIN_ID);