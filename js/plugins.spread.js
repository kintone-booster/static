/*
* FileName "plugins.spread.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(v=>{var p,f;kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],l=>new Promise((r,z)=>{((A,B)=>{p=A;kb.config[v].config.get().then(w=>{Object.keys(w).length!=0?kb.field.load(kb.config[v].app,!0).then(t=>{f={id:kb.config[v].app,disables:t.disables.reduce((b,d)=>{d in t.parallelize&&b.push(t.parallelize[d]);return b},[]),fields:((b,d)=>{var q={},m;for(m in b){var e=b[m];e.tableCode?e.tableCode in q||(q[e.tableCode]=d[e.tableCode]):q[m]=e}return q})(t.parallelize,
t.tables),view:{}};try{(b=>{b?(d=>{var q=()=>{d.elm(".kb-view").elms("[unsaved=unsaved]").each((m,e)=>{m.removeAttr("unsaved").removeClass("kb-unsaved")});window.location.reload(!0)};p&&kb.elm("body").addClass("kb-mobile");d.append(kb.create("div").addClass("kb-spread-toolbar").append(kb.create("button").addClass("kb-spread-toolbar-button kb-spread-toolbar-button-submit").html(kb.constants.common.caption.button.submit[kb.operator.language]).on("click",m=>{((e,u)=>{var g={post:[],put:[]},n={submit:(c,
a)=>{if(e.length!=0){var h=kb.record.get(e[c],f);h.error?a(!0):kb.event.call("kb.submit.call",{record:h.record,mobile:p,numbering:u,pattern:h.record.$id.value?"edit":"create",workplace:"view"}).then(k=>{k.error?(kb.record.set(e[c],f,k.record),a(!0)):(k.record.$id.value?g.put.push({id:k.record.$id.value,record:k.record}):g.post.push(k.record),c++,c<e.length?n.submit(c,a):a())}).catch(()=>{})}else a()},success:(c,a,h,k)=>{let y=()=>{c++;c<g[a].length?n.success(c,a,h,k):a=="post"?n.success(0,"put",h,
k):k()};g[a].length!=0?kb.event.call("kb."+h+".call",{record:a=="post"?g[a][c]:g[a][c].record,mobile:p,pattern:a=="post"?"create":"edit",workplace:"view"}).then(x=>{x.error||(a=="post"?g[a][c]=x.record:g[a][c].record=x.record,y())}).catch(()=>{}):y()}};n.submit(0,c=>{c||(g.post.length+g.put.length!=0?(kb.loadStart(),kb.event.call("kb.view.submit",{container:d.elm(".kb-view"),records:g,viewId:b.view.value}).then(a=>{a.error||kb.confirm(kb.constants.common.message.confirm.submit[kb.operator.language],
()=>{kb.loadStart();kb.view.records.set(f.id,a.records,!0,!0).then(h=>{kb.event.call("kb.view.submit.success",{container:a.container,records:a.records,viewId:a.viewId}).then(k=>{k.error||n.success(0,"post","mail",()=>{n.success(0,"post","omail",()=>{n.success(0,"post","upsert",()=>{kb.alert("Done!",()=>q())})})})})}).catch(h=>{kb.alert(kb.error.parse(h));z()})})})):kb.alert(kb.constants.common.message.invalid.submit[kb.operator.language]))})})(d.elm(".kb-view").elms("[unsaved=unsaved]"),{})})).append(kb.create("button").addClass("kb-spread-toolbar-button").html(kb.constants.common.caption.button.cancel[kb.operator.language]).on("click",
m=>{d.elm(".kb-view").elms("[unsaved=unsaved]").length!=0&&kb.confirm(kb.constants.common.message.confirm.cancel[kb.operator.language],()=>q())})));b.mode.value=="viewer"&&d.elm(".kb-spread-toolbar").addClass("kb-hidden");kb.view.load(f.id).then(m=>{f.view={buttons:b.buttons.value,fields:m.list.reduce((e,u)=>u.id==b.view.value?u.fields:e,[]),mode:b.mode.value};kb.event.call("kb.attachment.call",{mode:"placeholder",fields:f.fields}).then(e=>{(u=>{l.records.each((g,n)=>{(c=>{kb.event.call("kb.action.call",
{container:c.elm("[form-id=form_"+f.id+"]"),record:g,mobile:p,pattern:b.mode.value=="editor"?"edit":"dummy",workplace:"view"}).then(a=>{kb.event.call("kb.style.call",{container:c.elm("[form-id=form_"+f.id+"]"),record:a.record,mobile:a.mobile,pattern:b.mode.value=="editor"?"edit":"detail",workplace:a.workplace}).then(h=>{kb.record.set(c.elm("[form-id=form_"+f.id+"]"),f,h.record).then(()=>{c.elm(".kb-view-row-edit").attr("href",kb.record.page.detail(p,f.id,h.record.$id.value));n==l.records.length-1&&
d.parentNode.show()})}).catch(()=>{})}).catch(()=>{})})(u.addRow())})})(kb.view.create(d,f,b.view.value,p,!0).elm(".kb-view"));r(l)}).catch(()=>{})});window.on("beforeunload",m=>{d.elm(".kb-view").elms("[unsaved=unsaved]").length!=0&&(m.returnValue=kb.constants.common.message.confirm.changed[kb.operator.language])})})(kb.elm(p?".gaia-mobile-v2-indexviewpanel-tableview":"#view-list-data-gaia").addClass("kb-view-container").empty()):r(l)})(JSON.parse(w.flat).setting.value.reduce((b,d)=>{d.value.view.value==
l.viewId.toString()&&(b=d.value);return b},null))}catch(b){kb.alert(kb.error.parse(b)),r(l)}}).catch(t=>r(l)):r(l)}).catch(w=>r(l))})(l.type.split(".").first()=="mobile",l.type.split(".").slice(-2).first())}))})(kintone.$PLUGIN_ID);