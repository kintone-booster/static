/*
* FileName "plugins.spread.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(u){var c={};kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],function(l){return new Promise(function(q,x){(function(y,z){c.mobile=y;c.type=z;kb.config[u].config.get().then(function(v){0!=Object.keys(v).length?kb.field.load(kb.config[u].app,!0).then(function(n){c.app={id:kb.config[u].app,disables:n.disables.reduce(function(e,g){g in n.parallelize&&e.push(n.parallelize[g]);return e},[]),fields:function(e,g){var p={},k;for(k in e){var f=e[k];f.tableCode?f.tableCode in
p||(p[f.tableCode]=g[f.tableCode]):p[k]=f}return p}(n.parallelize,n.tables),view:{}};c.fieldInfos=n;try{(function(e){e?function(g){var p=function(){g.elm(".kb-view").elms("[unsaved=unsaved]").each(function(k,f){k.removeAttr("unsaved").removeClass("kb-unsaved")});window.location.reload(!0)};c.mobile&&kb.elm("body").addClass("kb-mobile");g.append(kb.create("div").addClass("kb-spread-toolbar").append(kb.create("button").addClass("kb-spread-toolbar-button kb-spread-toolbar-button-submit").html(kb.constants.common.caption.button.submit[kb.operator.language]).on("click",
function(k){var f={},d={post:[],put:[]},m={submit:function(b,a,h){var r=function(){b++;b<d[a].length?m.submit(b,a,h):"post"==a?m.submit(0,"put",h):h()};0!=d[a].length?kb.event.call("kb.submit.call",{record:"post"==a?d[a][b]:d[a][b].record,mobile:c.mobile,pattern:"post"==a?"create":"edit",workplace:"view"}).then(function(t){t.error||("post"==a?d[a][b]=t.record:d[a][b].record=t.record,r())})["catch"](function(){}):r()},success:function(b,a,h,r){var t=function(){b++;b<d[a].length?m.success(b,a,h,r):
"post"==a?m.success(0,"put",h,r):r()};0!=d[a].length?kb.event.call("kb."+h+".call",{record:"post"==a?d[a][b]:d[a][b].record,mobile:c.mobile,pattern:"post"==a?"create":"edit",workplace:"view"}).then(function(w){w.error||("post"==a?d[a][b]=w.record:d[a][b].record=w.record,t())})["catch"](function(){}):t()}};g.elm(".kb-view").elms("[unsaved=unsaved]").each(function(b,a){f=kb.record.get(b,c.app);if(f.error)return PD_BREAK;f.record.$id.value?d.put.push({id:f.record.$id.value,record:f.record}):d.post.push(f.record)});
f.error||(0!=d.post.length+d.put.length?(kb.loadStart(),kb.event.call("kb.view.submit",{container:g.elm(".kb-view"),records:d,viewId:e.view.value}).then(function(b){b.error||m.submit(0,"post",function(){kb.confirm(kb.constants.common.message.confirm.submit[kb.operator.language],function(){kb.loadStart();kb.view.records.set(c.app.id,b.records,!0,!0).then(function(a){kb.event.call("kb.view.submit.success",{container:b.container,records:b.records,viewId:b.viewId}).then(function(h){h.error||m.success(0,
"post","mail",function(){m.success(0,"post","upsert",function(){kb.alert("Done!",function(){return p()})})})})})["catch"](function(a){kb.alert(kb.error.parse(a));x()})})})})):kb.alert(kb.constants.common.message.invalid.submit[kb.operator.language]))})).append(kb.create("button").addClass("kb-spread-toolbar-button").html(kb.constants.common.caption.button.cancel[kb.operator.language]).on("click",function(k){0!=g.elm(".kb-view").elms("[unsaved=unsaved]").length&&kb.confirm(kb.constants.common.message.confirm.cancel[kb.operator.language],
function(){return p()})})));kb.view.load(c.app.id).then(function(k){c.app.view={buttons:e.buttons.value,fields:k.list.reduce(function(f,d){return d.id==e.view.value?d.fields:f},[]),mode:e.mode.value};(function(f){l.records.each(function(d,m){(function(b){kb.event.call("kb.action.call",{record:d,mobile:c.mobile,pattern:"editor"==e.mode.value?"edit":"dummy",workplace:"view"}).then(function(a){kb.event.call("kb.style.call",{record:a.record,mobile:a.mobile,pattern:"editor"==e.mode.value?"edit":"detail",
workplace:a.workplace}).then(function(h){kb.record.set(b.elm("[form-id=form_"+c.app.id+"]"),c.app,h.record).then(function(){b.elm(".kb-view-row-edit").attr("href",kb.record.page.detail(c.mobile,c.app.id,h.record.$id.value));g.parentNode.show()})})["catch"](function(){})})["catch"](function(){})})(f.addRow())})})(kb.view.create(g,c.app,e.view.value,c.mobile).elm(".kb-view"));q(l)});window.on("beforeunload",function(k){0!=g.elm(".kb-view").elms("[unsaved=unsaved]").length&&(k.returnValue=kb.constants.common.message.confirm.changed[kb.operator.language])})}(kb.elm(c.mobile?
".gaia-mobile-v2-indexviewpanel-tableview":"#view-list-data-gaia").addClass("kb-view-container").empty()):q(l)})((c.config?c.config:c.config=JSON.parse(v.flat)).setting.value.reduce(function(e,g){g.value.view.value==l.viewId.toString()&&(e=g.value);return e},null))}catch(e){kb.alert(kb.error.parse(e)),q(l)}})["catch"](function(n){return q(l)}):q(l)})["catch"](function(v){return q(l)})})("mobile"==l.type.split(".").first(),l.type.split(".").slice(-2).first())})})})(kintone.$PLUGIN_ID);