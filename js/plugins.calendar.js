/*
* FileName "plugins.calendar.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(PLUGIN_ID){var vars={};var apply=function(container,setting){(function(viewInfo){var calendar=new FullCalendar.Calendar(container.addClass("kb-calendar"),{buttonText:function(){var res={};switch(kb.operator.language){case "en":res={month:"month",week:"week",day:"day"};break;case "ja":res={month:"\u6708",week:"\u9031",day:"\u65e5"};break;case "zh":res={month:"\u6708",week:"\u5468",day:"\u65e5"};break}return res}(),customButtons:{pickup:{text:"",click:function(e){kb.pickupDate(calendar.getDate().format("Y-m-d"),
function(date){calendar.gotoDate(new Date(date))})}}},editable:viewInfo.editable,eventDurationEditable:!viewInfo.singleDay,headerToolbar:{left:"prev,next,pickup,title",right:Object.values(viewInfo.type).join(",")},initialDate:viewInfo.session.date,initialView:function(initial){var res="";switch(initial){case "day":res=viewInfo.type.day;break;case "month":res=viewInfo.type.month;break;case "week":res=viewInfo.type.week;break;default:res=initial;break}return res}(viewInfo.session.initial),navLinks:true,
nowIndicator:!viewInfo.singleDay?viewInfo.time.start||viewInfo.time.end:false,selectable:viewInfo.editable,timeZone:"local",datesSet:function(info){sessionStorage.setItem("kb-calendar-"+setting.view.value,JSON.stringify({date:calendar.getDate().toISOString(),initial:info.view.type}));window.scrollTo(0,0)},eventChange:function(info){kb.view.records.set(vars.app.id,{put:function(){var res={id:info.event.extendedProps.recordId,record:{}};(function(changed){if(!viewInfo.tableCode)res.record[setting.start.value]=
{value:viewInfo.time.start?changed.start.toISOString():changed.start.format("Y-m-d")};else res.record[viewInfo.tableCode]={value:vars.records[info.event.extendedProps.recordId][viewInfo.tableCode].value.map(function(item){if(item.id==info.event.extendedProps.rowId)item.value[setting.start.value]={value:viewInfo.time.start?changed.start.toISOString():changed.start.format("Y-m-d")};return item})};if(!viewInfo.singleDay)if(!viewInfo.tableCode)res.record[setting.end.value]={value:viewInfo.time.end?changed.end.toISOString():
changed.end.format("Y-m-d")};else res.record[viewInfo.tableCode]={value:vars.records[info.event.extendedProps.recordId][viewInfo.tableCode].value.map(function(item){if(item.id==info.event.extendedProps.rowId)item.value[setting.end.value]={value:viewInfo.time.end?changed.end.toISOString():changed.end.format("Y-m-d")};return item})}})({start:info.event.start,end:function(){var res=null;if(!viewInfo.singleDay)if(viewInfo.time.end)res=info.event.end;else if(viewInfo.time.start)if(info.event.end.getHours()+
info.event.end.getMinutes()==0)res=info.event.end.calc("-1 day");else res=info.event.end;else res=info.event.end.calc((info.event.allDay?"-1":"0")+" day");return res}()});return[res]}()}).then(function(resp){})["catch"](function(error){return kb.alert(kb.error.parse(error))})},eventDidMount:function(info){info.el.elms(".fc-event-time,.fc-event-title").each(function(element,index){element.on("touchstart,mousedown",function(e){e.stopPropagation()}).on("click",function(e){kb.confirm(kb.constants.calendar.message.confirm.edit[kb.operator.language],
function(){sessionStorage.setItem("kb-calendar-edit",JSON.stringify({href:window.location.href}));window.location.href=info.event.extendedProps.url});e.stopPropagation();e.preventDefault()})})},events:function(info,success,failure){kb.view.records.get(vars.app.id,function(query){var res=[];var stringify=function(type,date,pattern){var res="";if(viewInfo.timeStamp[type])res=((viewInfo.time[type]?date.calc(pattern+" second").getTime():date.calc(pattern+" day").getTime())/1E3).toString();else res='"'+
(viewInfo.time[type]?date.calc(pattern+" second").toISOString():date.calc(pattern+" day").format("Y-m-d"))+'"';return res};res.push(function(){var res=[];res.push(setting.start.value+(viewInfo.tableCode?' not in ("")':'!=""'));res.push(setting.start.value+">"+stringify("start",info.start,"-1"));res.push(setting.start.value+"<"+stringify("start",info.end,"1"));return"("+res.join(" and ")+")"}());if(!viewInfo.singleDay){res.push(function(){var res=[];res.push(setting.end.value+(viewInfo.tableCode?' not in ("")':
'!=""'));res.push(setting.end.value+">"+stringify("end",info.start,"-1"));res.push(setting.end.value+"<"+stringify("end",info.end,"1"));return"("+res.join(" and ")+")"}());res.push(function(){var res=[];res.push(setting.start.value+"<"+stringify("start",info.start,"0"));res.push(setting.end.value+">"+stringify("end",info.end,"0"));return"("+res.join(" and ")+")"}())}return(query?"("+query+") and ":"")+"("+res.join(" or ")+")"}((vars.mobile?kintone.mobile.app:kintone.app).getQueryCondition())).then(function(resp){var recurse=
function(index,callback){var finish=function(){index++;if(index<resp.length)recurse(index,callback);else callback()};kb.event.call("kb.style.call",{record:resp[index],mobile:vars.mobile,pattern:"detail",workplace:"view"}).then(function(param){return finish()})["catch"](function(error){return finish()})};vars.records={};if(resp.length!=0)recurse(0,function(){success(function(records){return records.map(function(item){return{title:kb.field.stringify(vars.fieldInfos.parallelize[setting.title.value],
item[setting.title.value].value," / "),start:function(value){var res=value;if(!viewInfo.singleDay)if(!viewInfo.time.start)if(viewInfo.time.end)res=(new Date(res)).calc(kb.timezoneOffset()+" hour").toISOString();return res}(item[setting.start.value].value),end:function(value){var res=value;if(!viewInfo.singleDay)if(viewInfo.time.start){if(!viewInfo.time.end)res=(new Date(res)).calc("1 day").calc(kb.timezoneOffset()+" hour").toISOString()}else if(!viewInfo.time.end)res=(new Date(res)).calc("1 day").format("Y-m-d");
return res}(!viewInfo.singleDay?item[setting.end.value].value:null),backgroundColor:item[setting.title.value].backcolor,borderColor:item[setting.title.value].backcolor,textColor:item[setting.title.value].forecolor,extendedProps:{recordId:item["$id"].value,rowId:"$rowId"in item?item["$rowId"]:-1,url:kb.record.page.edit(vars.mobile,kb.config[PLUGIN_ID].app,item["$id"].value)}}})}(resp.reduce(function(result,current){vars.records[current["$id"].value]=current;if(viewInfo.tableCode)result=result.concat(current[viewInfo.tableCode].value.map(function(item){item.value["$id"]=
current["$id"];item.value["$rowId"]=item.id;return item.value}));else result.push(current);return result},[])))});else success([])})["catch"](function(error){return kb.alert(kb.error.parse(error))})},select:function(info){(function(selected){if(viewInfo.singleDay){if(selected.start.format("Y-m-d")==selected.end.format("Y-m-d"))kb.confirm(function(){var res=kb.constants.calendar.message.confirm.create.single[kb.operator.language];res=res.replace(/%date%/,selected.start.format(viewInfo.time.start?"Y-m-d H:i":
"Y-m-d"));return res}(),function(){sessionStorage.setItem("kb-calendar-create",JSON.stringify({href:window.location.href,start:{code:setting.start.value,tableCode:viewInfo.tableCode,value:viewInfo.time.start?selected.start.toISOString():selected.start.format("Y-m-d")}}));window.location.href=kb.record.page.add(vars.mobile,kb.config[PLUGIN_ID].app)})}else kb.confirm(function(){var res=kb.constants.calendar.message.confirm.create.multi[kb.operator.language];res=res.replace(/%start%/,selected.start.format(viewInfo.time.start?
"Y-m-d H:i":"Y-m-d"));res=res.replace(/%end%/,selected.end.format(viewInfo.time.end?"Y-m-d H:i":"Y-m-d"));return res}(),function(){sessionStorage.setItem("kb-calendar-create",JSON.stringify({href:window.location.href,start:{code:setting.start.value,tableCode:viewInfo.tableCode,value:viewInfo.time.start?selected.start.toISOString():selected.start.format("Y-m-d")},end:{code:setting.end.value,tableCode:viewInfo.tableCode,value:viewInfo.time.end?selected.end.toISOString():selected.end.format("Y-m-d")}}));
window.location.href=kb.record.page.add(vars.mobile,kb.config[PLUGIN_ID].app)})})({start:info.start,end:viewInfo.time.end?info.end:info.end.calc((info.allDay?"-1":"0")+" day")});calendar.unselect()}});calendar.setOption("locale",kb.operator.language);calendar.render()})(function(timeInfos){return{editable:timeInfos.start.isEditable&&timeInfos.end.isEditable,singleDay:!setting.end.value,session:function(session){return session?JSON.parse(session):{date:(new Date).format("Y-m-d"),initial:setting.initial.value}}(sessionStorage.getItem("kb-calendar-"+
setting.view.value)),tableCode:vars.fieldInfos.parallelize[setting.title.value].tableCode,time:{start:timeInfos.start.isDateTime,end:timeInfos.end.isDateTime},timeStamp:{start:timeInfos.start.isTimeStamp,end:timeInfos.end.isTimeStamp},type:{month:"dayGridMonth",week:setting.end.value?timeInfos.start.isDateTime||timeInfos.end.isDateTime?"timeGridWeek":"dayGridWeek":"dayGridWeek",day:setting.end.value?timeInfos.start.isDateTime||timeInfos.end.isDateTime?"timeGridDay":"dayGridDay":"dayGridDay"}}}({start:function(fieldInfo){switch(fieldInfo.type){case "CALC":switch(fieldInfo.format){case "DATE":fieldInfo.isDateTime=
false;fieldInfo.isEditable=false;break;case "DATETIME":fieldInfo.isDateTime=true;fieldInfo.isEditable=false;break}fieldInfo.isTimeStamp=true;break;case "CREATED_TIME":case "UPDATED_TIME":fieldInfo.isDateTime=true;fieldInfo.isEditable=false;fieldInfo.isTimeStamp=false;break;case "DATE":fieldInfo.isDateTime=false;fieldInfo.isEditable=true;fieldInfo.isTimeStamp=false;break;case "DATETIME":fieldInfo.isDateTime=true;fieldInfo.isEditable=true;fieldInfo.isTimeStamp=false;break}return fieldInfo}(vars.fieldInfos.parallelize[setting.start.value]),
end:function(fieldInfo){switch(fieldInfo.type){case "CALC":switch(fieldInfo.format){case "DATE":fieldInfo.isDateTime=false;fieldInfo.isEditable=false;break;case "DATETIME":fieldInfo.isDateTime=true;fieldInfo.isEditable=false;break}fieldInfo.isTimeStamp=true;break;case "CREATED_TIME":case "UPDATED_TIME":fieldInfo.isDateTime=true;fieldInfo.isEditable=false;fieldInfo.isTimeStamp=false;break;case "DATE":fieldInfo.isDateTime=false;fieldInfo.isEditable=true;fieldInfo.isTimeStamp=false;break;case "DATETIME":fieldInfo.isDateTime=
true;fieldInfo.isEditable=true;fieldInfo.isTimeStamp=false;break;default:fieldInfo.isDateTime=false;fieldInfo.isEditable=true;fieldInfo.isTimeStamp=false;break}return fieldInfo}(setting.end.value?vars.fieldInfos.parallelize[setting.end.value]:{type:""})}))};kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],function(e){return new Promise(function(resolve,reject){(function(mobile,type){vars.mobile=mobile;vars.type=type;kb.config[PLUGIN_ID].config.get().then(function(config){if(Object.keys(config).length!=
0)kb.field.load(kb.config[PLUGIN_ID].app,true).then(function(fieldInfos){vars.app={id:kb.config[PLUGIN_ID].app,fields:fieldInfos.origin};vars.fieldInfos=fieldInfos;vars.records={};try{(function(setting){if(setting){if(setting.title.value)if(!(setting.title.value in vars.fieldInfos.parallelize))resolve(e);if(setting.start.value)if(!(setting.start.value in vars.fieldInfos.parallelize))resolve(e);if(setting.end.value)if(!(setting.end.value in vars.fieldInfos.parallelize))resolve(e);(function(container){if(container)apply(container,
setting)})(kb.elm("#kb-calendar"));resolve(e)}else resolve(e)})(JSON.parse(config.tab).reduce(function(result,current){if(current.setting.view.value==e.viewId)result=current.setting;return result},null))}catch(error){kb.alert(kb.error.parse(error));resolve(e)}})["catch"](function(error){return resolve(e)});else resolve(e)})["catch"](function(error){return resolve(e)})})(e.type.split(".").first()=="mobile",e.type.split(".").slice(-2).first())})});kintone.events.on(["app.record.create.show","mobile.app.record.create.show"],
function(e){return new Promise(function(resolve,reject){(function(param){if(param){(function(param){if(param.start)(param.start.tableCode?e.record[param.start.tableCode].value.first().value[param.start.code]:e.record[param.start.code]).value=param.start.value;if(param.end)(param.end.tableCode?e.record[param.end.tableCode].value.first().value[param.end.code]:e.record[param.end.code]).value=param.end.value;kintone.events.on(["app.record.create.submit.success","mobile.app.record.create.submit.success"],
function(e){return new Promise(function(resolve,reject){e.url=param.href;resolve(e)})})})(JSON.parse(param));sessionStorage.removeItem("kb-calendar-create");resolve(e)}else resolve(e)})(sessionStorage.getItem("kb-calendar-create"))})});kintone.events.on(["app.record.edit.show","mobile.app.record.edit.show"],function(e){return new Promise(function(resolve,reject){(function(param){if(param){(function(param){(function(button){button.parentNode.insertBefore(button.clone().on("click",function(e){window.location.href=
param.href}),button.hide().nextElementSibling)})(kb.elm(".gaia-ui-actionmenu-cancel"));kintone.events.on(["app.record.edit.submit.success","mobile.app.record.edit.submit.success"],function(e){return new Promise(function(resolve,reject){e.url=param.href;resolve(e)})})})(JSON.parse(param));sessionStorage.removeItem("kb-calendar-edit");resolve(e)}else resolve(e)})(sessionStorage.getItem("kb-calendar-edit"))})})})(kintone.$PLUGIN_ID);
kb.constants=kb.extend({calendar:{message:{confirm:{create:{multi:{en:"Start Date: %start%<br>End Date: %end%<br>Would you like to add a record with the above details?",ja:"\u958b\u59cb\u65e5\u4ed8: %start%<br>\u7d42\u4e86\u65e5\u4ed8: %end%<br>\u4e0a\u8a18\u5185\u5bb9\u3067\u30ec\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u304b\uff1f",zh:"\u5f00\u59cb\u65e5\u671f: %start%<br>\u7ed3\u675f\u65e5\u671f: %end%<br>\u60a8\u60f3\u6839\u636e\u4e0a\u8ff0\u5185\u5bb9\u6dfb\u52a0\u8bb0\u5f55\u5417\uff1f"},
single:{en:"Date: %date%<br>Would you like to add a record with the above content?",ja:"\u65e5\u4ed8: %date%<br>\u4e0a\u8a18\u5185\u5bb9\u3067\u30ec\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u304b\uff1f",zh:"\u65e5\u671f: %date%<br>\u60a8\u60f3\u6dfb\u52a0\u4e0a\u8ff0\u5185\u5bb9\u7684\u8bb0\u5f55\u5417\uff1f"}},edit:{en:"Do you want to edit the record?",ja:"\u30ec\u30b3\u30fc\u30c9\u3092\u7de8\u96c6\u3057\u307e\u3059\u304b\uff1f",zh:"\u60a8\u60f3\u7f16\u8f91\u8fd9\u6761\u8bb0\u5f55\u5417\uff1f"}}}}},
kb.constants);