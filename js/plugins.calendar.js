/*
* FileName "plugins.calendar.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(t=>{var l={},v=(m,c)=>{(a=>{var p=()=>{l.mobile&&m.parentNode.css({overflowX:"unset"});var b=l.mobile?{height:0}:kb.elm("#header-global-navigation-root").elm("nav").getBoundingClientRect();m.elm(".fc-header-toolbar").addClass("fc-header-toolbar-border").css({top:b.height.toString()+"px"});m.elm("thead").css({top:(b.height+m.elm(".fc-header-toolbar").outerHeight(!1)).toString()+"px"})},k=new FullCalendar.Calendar(m.addClass("kb-calendar"),{buttonText:(()=>{var b={};switch(kb.operator.language){case "en":b=
{month:"month",week:"week",day:"day"};break;case "ja":b={month:"\u6708",week:"\u9031",day:"\u65e5"};break;case "zh":b={month:"\u6708",week:"\u5468",day:"\u65e5"};break;case "zh-TW":b={month:"\u6708",week:"\u9031",day:"\u5929"}}return b})(),customButtons:{pickup:{text:"",click:b=>{kb.pickupDate(k.getDate().format("Y-m-d"),g=>{k.gotoDate(new Date(g))})}}},contentHeight:"auto",editable:a.editable,eventDurationEditable:!a.singleDay,firstDay:parseInt((c.first||{value:"0"}).value),headerToolbar:{left:"prev,next,pickup,title",
right:Object.values(a.type).join(",")},height:"auto",initialDate:a.session.date,initialView:(b=>{switch(b){case "day":b=a.type.day;break;case "month":b=a.type.month;break;case "week":b=a.type.week}return b})(a.session.initial),navLinks:!0,nowIndicator:a.singleDay?!1:a.time.start||a.time.end,selectable:a.editable,timeZone:"local",datesSet:b=>{sessionStorage.setItem("kb-calendar-"+c.view.value,JSON.stringify({date:k.getDate().toISOString(),initial:b.view.type}));window.scrollTo(0,0);p()},eventChange:b=>
{kb.view.records.set(l.app.id,{put:(()=>{var g={id:b.event.extendedProps.recordId,record:{}};(d=>{a.tableCode?g.record[a.tableCode]={value:l.records[b.event.extendedProps.recordId][a.tableCode].value.map(f=>{f.id==b.event.extendedProps.rowId&&(f.value[c.start.value]={value:a.time.start?d.start.toISOString():d.start.format("Y-m-d")});return f})}:g.record[c.start.value]={value:a.time.start?d.start.toISOString():d.start.format("Y-m-d")};!a.singleDay&&d.end&&(a.tableCode?g.record[a.tableCode]={value:l.records[b.event.extendedProps.recordId][a.tableCode].value.map(f=>
{f.id==b.event.extendedProps.rowId&&(f.value[c.end.value]={value:a.time.end?d.end.toISOString():d.end.format("Y-m-d")});return f})}:g.record[c.end.value]={value:a.time.end?d.end.toISOString():d.end.format("Y-m-d")})})({start:b.event.start,end:(()=>{var d=null;a.singleDay||b.event.end&&(d=a.time.end?b.event.end:a.time.start?0==b.event.end.getHours()+b.event.end.getMinutes()?b.event.end.calc("-1 day"):b.event.end:b.event.end.calc((b.event.allDay?"-1":"0")+" day"));return d})()});return[g]})()}).then(g=>
{}).catch(g=>kb.alert(kb.error.parse(g)))},eventDidMount:b=>{b.el.elms(".fc-event-time,.fc-event-title").each((g,d)=>{g.on("touchstart,mousedown",f=>{f.stopPropagation()}).on("click",f=>{kb.confirm(kb.constants.calendar.message.confirm.edit[kb.operator.language],()=>{(c.page||{value:[]}).value.includes("detail")||sessionStorage.setItem("kb-calendar-edit",JSON.stringify({href:window.location.href}));window.location.href=b.event.extendedProps.url});f.stopPropagation();f.preventDefault()})})},events:(b,
g,d)=>{kb.view.records.get(l.app.id,(f=>{var q=[],n=(e,h,r)=>a.timeStamp[e]?((a.time[e]?h.calc(r+" second").getTime():h.calc(r+" day").getTime())/1E3).toString():'"'+(a.time[e]?h.calc(r+" second").toISOString():h.calc(r+" day").format("Y-m-d"))+'"';q.push((()=>{var e=[];e.push(c.start.value+(a.tableCode?' not in ("")':'!=""'));e.push(c.start.value+">"+n("start",b.start,"-1"));e.push(c.start.value+"<"+n("start",b.end,"1"));return"("+e.join(" and ")+")"})());a.singleDay||(q.push((()=>{var e=[];e.push(c.end.value+
(a.tableCode?' not in ("")':'!=""'));e.push(c.end.value+">"+n("end",b.start,"-1"));e.push(c.end.value+"<"+n("end",b.end,"1"));return"("+e.join(" and ")+")"})()),q.push((()=>{var e=[];e.push(c.start.value+"<"+n("start",b.start,"0"));e.push(c.end.value+">"+n("end",b.end,"0"));return"("+e.join(" and ")+")"})()));return(f?"("+f+") and ":"")+"("+q.join(" or ")+")"})((l.mobile?kintone.mobile.app:kintone.app).getQueryCondition()),(f=>{f=f.match(/order by/g)?f.replace(/^.*order by/g,""):"";return(f=f.replace(/limit [0-9]+/g,
"").replace(/ offset [0-9]+/g,"").replace(/^[ ]+/g,"").replace(/[ ]+$/g,""))?f:"$id asc"})((l.mobile?kintone.mobile.app:kintone.app).getQuery())).then(f=>{var q=(n,e)=>{kb.event.call("kb.style.call",{container:kb.elm("body"),record:f[n],mobile:l.mobile,pattern:"detail",workplace:"view"}).then(h=>{n++;n<f.length?q(n,e):e()}).catch(h=>{n++;n<f.length?q(n,e):e()})};l.records={};0!=f.length?q(0,()=>{g((n=>n.map(e=>(h=>{(c.allday||{value:[]}).value.includes("enabled")&&k.view.type.match(/^timeGrid/g)&&
h.start&&h.end&&"00:00"==(new Date(h.start)).format("H:i")&&"00:00"==(new Date(h.end)).format("H:i")&&(h.allDay=!0);return h})({title:kb.field.stringify(l.fieldInfos.parallelize[c.title.value],e[c.title.value].value," / "),start:(h=>{a.singleDay||a.time.start||a.time.end&&(h=(new Date(h)).calc(kb.timezoneOffset()+" hour").toISOString());return h})(e[c.start.value].value),end:(h=>{a.singleDay||(a.time.start?a.time.end||(h=(new Date(h)).calc("1 day").calc(kb.timezoneOffset()+" hour").toISOString()):
a.time.end||(h=(new Date(h)).calc("1 day").format("Y-m-d")));return h})(a.singleDay?null:e[c.end.value].value),backgroundColor:e[c.title.value].backcolor,borderColor:e[c.title.value].backcolor,textColor:e[c.title.value].forecolor,extendedProps:{recordId:e.$id.value,rowId:"$rowId"in e?e.$rowId:-1,url:((h,r,u)=>h?kb.record.page.detail(l.mobile,r,u):kb.record.page.edit(l.mobile,r,u))((c.page||{value:[]}).value.includes("detail"),kb.config[t].app,e.$id.value)}})))(f.reduce((n,e)=>{l.records[e.$id.value]=
e;a.tableCode?n=n.concat(e[a.tableCode].value.map(h=>{h.value.$id=e.$id;h.value.$rowId=h.id;return h.value})):n.push(e);return n},[])))}):g([])}).catch(f=>kb.alert(kb.error.parse(f)))},select:b=>{(g=>{a.singleDay?g.start.format("Y-m-d")==g.end.format("Y-m-d")&&kb.confirm((()=>{var d=kb.constants.calendar.message.confirm.create.single[kb.operator.language];return d=d.replace(/%date%/,g.start.format(a.time.start?"Y-m-d H:i":"Y-m-d"))})(),()=>{sessionStorage.setItem("kb-calendar-create",JSON.stringify({href:window.location.href,
start:{code:c.start.value,tableCode:a.tableCode,value:a.time.start?g.start.toISOString():g.start.format("Y-m-d")}}));window.location.href=kb.record.page.add(l.mobile,kb.config[t].app)}):kb.confirm((()=>{var d=kb.constants.calendar.message.confirm.create.multi[kb.operator.language];d=d.replace(/%start%/,g.start.format(a.time.start?"Y-m-d H:i":"Y-m-d"));return d=d.replace(/%end%/,g.end.format(a.time.end?"Y-m-d H:i":"Y-m-d"))})(),()=>{sessionStorage.setItem("kb-calendar-create",JSON.stringify({href:window.location.href,
start:{code:c.start.value,tableCode:a.tableCode,value:a.time.start?g.start.toISOString():g.start.format("Y-m-d")},end:{code:c.end.value,tableCode:a.tableCode,value:a.time.end?g.end.toISOString():g.end.format("Y-m-d")}}));window.location.href=kb.record.page.add(l.mobile,kb.config[t].app)})})({start:b.start,end:a.time.end?b.end:b.end.calc((b.allDay?"-1":"0")+" day")});k.unselect()}});k.setOption("locale",kb.operator.language);k.render();p()})((a=>{var p=a.start.isEditable&&a.end.isEditable,k=!c.end.value;
var b=(b=sessionStorage.getItem("kb-calendar-"+c.view.value))?JSON.parse(b):{date:(new Date).format("Y-m-d"),initial:c.initial.value};return{editable:p,singleDay:k,session:b,tableCode:l.fieldInfos.parallelize[c.title.value].tableCode,time:{start:a.start.isDateTime,end:a.end.isDateTime},timeStamp:{start:a.start.isTimeStamp,end:a.end.isTimeStamp},type:{month:"dayGridMonth",week:c.end.value?a.start.isDateTime||a.end.isDateTime?"timeGridWeek":"dayGridWeek":"dayGridWeek",day:c.end.value?a.start.isDateTime||
a.end.isDateTime?"timeGridDay":"dayGridDay":"dayGridDay"}}})({start:(a=>{switch(a.type){case "CALC":switch(a.format){case "DATE":a.isDateTime=!1;a.isEditable=!1;break;case "DATETIME":a.isDateTime=!0,a.isEditable=!1}a.isTimeStamp=!0;break;case "CREATED_TIME":case "UPDATED_TIME":a.isDateTime=!0;a.isEditable=!1;a.isTimeStamp=!1;break;case "DATE":a.isDateTime=!1;a.isEditable=!0;a.isTimeStamp=!1;break;case "DATETIME":a.isDateTime=!0,a.isEditable=!0,a.isTimeStamp=!1}return a})(l.fieldInfos.parallelize[c.start.value]),
end:(a=>{switch(a.type){case "CALC":switch(a.format){case "DATE":a.isDateTime=!1;a.isEditable=!1;break;case "DATETIME":a.isDateTime=!0,a.isEditable=!1}a.isTimeStamp=!0;break;case "CREATED_TIME":case "UPDATED_TIME":a.isDateTime=!0;a.isEditable=!1;a.isTimeStamp=!1;break;case "DATE":a.isDateTime=!1;a.isEditable=!0;a.isTimeStamp=!1;break;case "DATETIME":a.isDateTime=!0;a.isEditable=!0;a.isTimeStamp=!1;break;default:a.isDateTime=!1,a.isEditable=!0,a.isTimeStamp=!1}return a})(c.end.value?l.fieldInfos.parallelize[c.end.value]:
{type:""})}))};kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],m=>new Promise((c,a)=>{((p,k)=>{l.mobile=p;l.type=k;kb.config[t].config.get().then(b=>{0!=Object.keys(b).length?kb.field.load(kb.config[t].app,!0).then(g=>{l.app={id:kb.config[t].app,fields:g.origin};l.fieldInfos=g;l.records={};try{(d=>{if(d){d.title.value&&(d.title.value in l.fieldInfos.parallelize||c(m));d.start.value&&(d.start.value in l.fieldInfos.parallelize||c(m));d.end.value&&(d.end.value in l.fieldInfos.parallelize||
c(m));var f=kb.elm("#kb-calendar");f&&v(f,d)}c(m)})(JSON.parse(b.tab).map((d,f)=>kb.extend({sIndex:{value:f.toString()}},d.setting)).reduce((d,f)=>{f.view.value==m.viewId.toString()&&(d=f);return d},null))}catch(d){kb.alert(kb.error.parse(d)),c(m)}}).catch(g=>c(m)):c(m)}).catch(b=>c(m))})("mobile"==m.type.split(".").first(),m.type.split(".").slice(-2).first())}));kintone.events.on(["app.record.create.show","mobile.app.record.create.show"],m=>new Promise((c,a)=>{(p=>{p&&((k=>{k.start&&((k.start.tableCode?
m.record[k.start.tableCode].value.first().value[k.start.code]:m.record[k.start.code]).value=k.start.value);k.end&&((k.end.tableCode?m.record[k.end.tableCode].value.first().value[k.end.code]:m.record[k.end.code]).value=k.end.value);kintone.events.on(["app.record.create.submit.success","mobile.app.record.create.submit.success"],b=>new Promise((g,d)=>{b.url=k.href;g(b)}))})(JSON.parse(p)),sessionStorage.removeItem("kb-calendar-create"));c(m)})(sessionStorage.getItem("kb-calendar-create"))}));kintone.events.on(["app.record.edit.show",
"mobile.app.record.edit.show"],m=>new Promise((c,a)=>{(p=>{p&&((k=>{(b=>{b.parentNode.insertBefore(b.clone().removeAttr("disabled").on("click",g=>{window.location.href=k.href}),b.hide().nextElementSibling)})(kb.elm("mobile"==m.type.split(".").first()?".gaia-mobile-v2-app-record-edittoolbar-cancel":".gaia-ui-actionmenu-cancel"));kintone.events.on(["app.record.edit.submit.success","mobile.app.record.edit.submit.success"],b=>new Promise((g,d)=>{b.url=k.href;g(b)}))})(JSON.parse(p)),sessionStorage.removeItem("kb-calendar-edit"));
c(m)})(sessionStorage.getItem("kb-calendar-edit"))}))})(kintone.$PLUGIN_ID);
kb.constants=kb.extend({calendar:{message:{confirm:{create:{multi:{en:"Start Date: %start%<br>End Date: %end%<br>Would you like to add a record with the above details?",ja:"\u958b\u59cb\u65e5\u4ed8: %start%<br>\u7d42\u4e86\u65e5\u4ed8: %end%<br>\u4e0a\u8a18\u5185\u5bb9\u3067\u30ec\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u304b\uff1f",zh:"\u5f00\u59cb\u65e5\u671f: %start%<br>\u7ed3\u675f\u65e5\u671f: %end%<br>\u60a8\u60f3\u6839\u636e\u4e0a\u8ff0\u5185\u5bb9\u6dfb\u52a0\u8bb0\u5f55\u5417\uff1f","zh-TW":"\u958b\u59cb\u65e5\u671f: %start%<br>\u7d50\u675f\u65e5\u671f: %end%<br>\u60a8\u60f3\u6839\u64da\u4e0a\u8ff0\u5167\u5bb9\u65b0\u589e\u8a18\u9304\u55ce\uff1f"},
single:{en:"Date: %date%<br>Would you like to add a record with the above content?",ja:"\u65e5\u4ed8: %date%<br>\u4e0a\u8a18\u5185\u5bb9\u3067\u30ec\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u304b\uff1f",zh:"\u65e5\u671f: %date%<br>\u60a8\u60f3\u6dfb\u52a0\u4e0a\u8ff0\u5185\u5bb9\u7684\u8bb0\u5f55\u5417\uff1f","zh-TW":"\u65e5\u671f: %date%<br>\u60a8\u60f3\u65b0\u589e\u4e0a\u8ff0\u5167\u5bb9\u7684\u8a18\u9304\u55ce\uff1f"}},edit:{en:"Do you want to open the record?",ja:"\u30ec\u30b3\u30fc\u30c9\u3092\u958b\u304d\u307e\u3059\u304b\uff1f",
zh:"\u60a8\u8981\u6253\u5f00\u8bb0\u5f55\u5417\uff1f","zh-TW":"\u60a8\u8981\u6253\u958b\u8a18\u9304\u55ce\uff1f"}}}}},kb.constants);
