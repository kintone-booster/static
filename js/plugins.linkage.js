/*
* FileName "plugins.linkage.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(L=>{var d={handlers:{},stats:{}},O=(u,C)=>new Promise((M,J)=>{kb.field.load(u.app.value).then(z=>{(D=>{u.criteria.value.some(p=>!(p.value.external.value in D.external&&p.value.internal.value in D.internal))?(kb.alert("No field to linkage was found"),J()):u.mapping.value.some(p=>!(p.value.external.value in D.external))?(kb.alert("No field to linkage was found"),J()):(p=>{p.api=p.api.join(" and ");p.url=p.url.join(" and ");kb.view.records.get(u.app.value,p.api).then(v=>{0!=v.length?((t,x,E)=>{M((A=>
{A.records.sort((k,e)=>{var m=0;u.sort.value.each((h,b)=>{switch(z.parallelize[h.value.field.value].type){case "CALC":switch(z.parallelize[h.value.field.value].format){case "NUMBER":case "NUMBER_DIGIT":b=k[h.value.field.value].value?parseFloat(k[h.value.field.value].value):0;var l=e[h.value.field.value].value?parseFloat(e[h.value.field.value].value):0;break;default:b=k[h.value.field.value].value,l=e[h.value.field.value].value}break;case "CATEGORY":case "CHECK_BOX":case "CREATOR":case "FILE":case "GROUP_SELECT":case "MODIFIER":case "MULTI_SELECT":case "ORGANIZATION_SELECT":case "STATUS_ASSIGNEE":case "USER_SELECT":b=
JSON.stringify(k[h.value.field.value].value);l=JSON.stringify(e[h.value.field.value].value);break;case "NUMBER":b=k[h.value.field.value].value?parseFloat(k[h.value.field.value].value):0;l=e[h.value.field.value].value?parseFloat(e[h.value.field.value].value):0;break;default:b=k[h.value.field.value].value,l=e[h.value.field.value].value}switch(h.value.order.value){case "asc":b>l&&(m=1);b<l&&(m=-1);break;case "desc":b>l&&(m=-1),b<l&&(m=1)}if(m)return KB_BREAK});return m});return A})(t.reduce((A,k)=>{Array(E?
k[E].value.length:1).fill().map(()=>({})).each((e,m)=>{e.$id=k.$id;for(var h in z.parallelize)z.parallelize[h].tableCode?z.parallelize[h].tableCode==E&&(e[h]=k[E].value[m].value[h]):"$rowId"!=h?e[h]=k[h]:e.$rowId=E?{value:k[E].value[m].id}:{value:""};A.records.push(e)});return A},{offset:0,origin:x,query:p.url,records:[]})))})(v.reduce((t,x)=>{(x=kb.filter.scan({fields:z.origin},x,p.api))&&t.push(x);return t},[]),v,Array.from(new Set(u.mapping.value.map(t=>z.parallelize[t.value.external.value].tableCode))).join("")):
M({offset:0,records:[]})}).catch(v=>{kb.alert(kb.error.parse(v));J()})})(u.criteria.value.reduce((p,v)=>{p.api.push(kb.filter.query.create(D.external[v.value.external.value],v.value.operator.value,C[v.value.internal.value]));D.external[v.value.external.value].tableCode||p.url.push(p.api.last());return p},kb.filter.query.parse.expand({id:u.app.value,fields:z.origin},u.filter.value).reduce((p,v)=>{p.api.push(v.field+" "+v.operator+" "+v.value);D.external[v.field].tableCode||p.url.push(p.api.last());
return p},{api:[],url:[]})))})({external:z.parallelize,internal:d.fieldInfos.parallelize})}).catch(z=>{kb.alert(kb.error.parse(z));J()})});kintone.events.on("app.record.create.show app.record.detail.show app.record.edit.show app.record.index.show mobile.app.record.create.show mobile.app.record.detail.show mobile.app.record.edit.show mobile.app.record.index.show".split(" "),u=>new Promise((C,M)=>{((J,z)=>{d.mobile=J;d.type=z;for(var D in d.handlers)d.handlers[D].each((p,v)=>{kintone.events.off(D,p)});
kb.config[L].config.get().then(p=>{0!=Object.keys(p).length?kb.field.load(kb.config[L].app,!0).then(v=>{d.app={id:kb.config[L].app,fields:v.origin};d.fieldInfos=v;d.stats={};try{(t=>{if(0!=t.length){var x=(k,e,m,h)=>{var b=k.mapping.value.reduce((c,f)=>{switch(e.parallelize[f.value.external.value].type){case "CREATED_TIME":case "DATE":case "DATETIME":case "UPDATED_TIME":c[f.value.external.value]={max:"",min:""};break;case "NUMBER":c[f.value.external.value]={count:0,sum:"",avg:"",max:"",min:""}}return c},
{});h.each((c,f)=>{for(var a in c)if(a in e.parallelize)switch(e.parallelize[a].type){case "CREATED_TIME":case "DATE":case "DATETIME":case "UPDATED_TIME":if(a in b&&c[a].value){if(!b[a].max||c[a].value>b[a].max)b[a].max=c[a].value;if(!b[a].min||c[a].value<b[a].min)b[a].min=c[a].value}break;case "NUMBER":if(a in b&&kb.isNumeric(c[a].value)){if(!kb.isNumeric(b[a].max)||Number(c[a].value)>b[a].max)b[a].max=Number(c[a].value);if(!kb.isNumeric(b[a].min)||Number(c[a].value)<b[a].min)b[a].min=Number(c[a].value);
kb.isNumeric(b[a].sum)||(b[a].sum=0);b[a].sum+=Number(c[a].value);b[a].count++}}});for(var l in b)b[l].count&&(b[l].avg=b[l].sum/b[l].count),k.mapping.value.each((c,f)=>{f=JSON.parse(c.value.stats.value||"{}");for(var a in f){var q=f[a];q.value in d.fieldInfos.origin&&c.value.external.value==l&&(q=q.value,m[q]={type:d.fieldInfos.origin[q].type,value:d.stats[q].value=b[l][a]})}});switch(d.type){case "create":case "edit":(c=>{try{c()}catch(a){var f=setInterval(()=>{try{c(),clearInterval(f)}catch(q){}},
500)}})(()=>{0!=Object.keys(m).length&&(d.mobile?kintone.mobile.app.record:kintone.app.record).set({record:m})});break;case "detail":for(l in m)(c=>{var f=kb.field.stringify(c,m[l].value," / ");d.mobile?kb.field.get(c,d.mobile,d.type).value.html(f):kb.field.get(c,d.mobile,d.type).value.elm("span").html(f)})(d.fieldInfos.parallelize[l])}},E=(k,e,m)=>{var h=(b=>Array.from(new Set(b.map(l=>d.fieldInfos.parallelize[l.value.internal.value].tableCode))).reduce((l,c)=>{e[c].value=[];l[c]={fields:b.filter(f=>
d.fieldInfos.parallelize[f.value.internal.value].tableCode==c),row:kb.record.create(d.fieldInfos.origin[c],!1)};return l},{}))(k.mapping.value.reduce((b,l)=>{l.value.internal.value in d.fieldInfos.parallelize&&b.push(l);return b},[]));m.each((b,l)=>{for(var c in h)e[c].value.push((f=>{h[c].fields.each((a,q)=>{if(a.value.internal.value in d.fieldInfos.parallelize)switch(d.fieldInfos.parallelize[a.value.internal.value].type){case "lookup":q=b[a.value.external.value];f[a.value.internal.value]={lookup:!0,
search:"search"in q?q.search:"",value:q.value};break;default:f[a.value.internal.value].value=b[a.value.external.value].value}});return{value:f}})(kb.extend({},h[c].row)))});return e};t.first().mapping.value.some(k=>!("stats"in k.value))&&(kb.alert(kb.error.config.update("Boost! Linkage")),t=t.map(k=>{k.mapping.value=k.mapping.value.map(e=>{e.value.stats={value:""};return e});return k}));t.each((k,e)=>{k.mapping.value.each((m,h)=>{m=JSON.parse(m.value.stats.value||"{}");for(var b in m)((l,c)=>{c.value in
d.fieldInfos.origin&&(c.value in d.stats||((f,a)=>{kintone.events.on(f,a);f.each((q,G)=>{q in d.handlers||(d.handlers[q]=[]);d.handlers[q].push(a)})})(["app.record.create.change."+c.value,"app.record.edit.change."+c.value,"mobile.app.record.create.change."+c.value,"mobile.app.record.edit.change."+c.value],f=>{f.record[c.value].value!=d.stats[c.value].value&&(f.record[c.value].value=d.stats[c.value].value);return f}),d.stats[c.value]={value:""})})(b,m[b])})});d.mobile&&kb.elm("body").addClass("kb-mobile");
switch(d.type){case "create":case "edit":case "detail":var A=k=>{(e=>{(m=>{m&&kb.field.load(e.app.value).then(h=>{(b=>{((l,c)=>{var f={},a={copy:kb.create("button").addClass("kb-linkage-container-button").html(e.label.value).on("click",n=>{kb.confirm(e.message.value,()=>{kb.event.call("kb.action.call",{container:kb.elm("body"),record:E(e,(d.mobile?kintone.mobile.app.record:kintone.app.record).get().record,f.records),mobile:d.mobile,pattern:"change",fields:(g=>g.reduce((r,w)=>r=r.concat(Object.keys(d.fieldInfos.tables[w].fields)),
g))(e.mapping.value.reduce((g,r)=>{r.value.internal.value in d.fieldInfos.parallelize&&g.push(d.fieldInfos.parallelize[r.value.internal.value].tableCode);return g},[])),stopPropagation:!0,workplace:"record"}).then(g=>{kb.event.call("kb.style.call",{container:g.container,record:g.record,mobile:g.mobile,pattern:"$id"in g.record?g.record.$id.value?"edit":"create":"create",workplace:g.workplace}).then(r=>{kb.event.call("kb.cascade.call",r).then(w=>{(d.mobile?kintone.mobile.app.record:kintone.app.record).set({record:w.record})}).catch(()=>
{})}).catch(()=>{})}).catch(()=>{})})}),edit:kb.create("button").addClass("kb-icon kb-icon-edit").on("click",n=>{[a.total,a.reload,a.open,a.edit,a.prev,a.next,a.copy].each((g,r)=>g.addClass("kb-hidden"));[a.submit,a.cancel].each((g,r)=>g.removeClass("kb-hidden"));l.elms(".kb-field").each((g,r)=>g.removeClass("kb-readonly"));(g=>{g=kb.elm(".kb_spread_style_"+CSS.escape(g));g.parentNode.removeChild(g)})("view_"+b.id+"_"+b.view.id+"_"+location.host.split(".").first());m.parentNode.show()}),submit:kb.create("button").addClass("kb-linkage-container-button").on("click",
n=>{var g=l.tr.reduce((w,y,H)=>{w.error||"unsaved"!=y.elm(".kb-scope").attr("unsaved")||(y=kb.record.get(y.elm(".kb-scope"),b),y.error?w.error=!0:w.records["row"+H.toString()]=y.record);return w},{error:!1,records:{}}),r=(w=!1)=>{[a.total,a.reload,a.open,a.edit,a.prev,a.next,a.copy].each((y,H)=>y.removeClass("kb-hidden"));[a.submit,a.cancel].each((y,H)=>y.addClass("kb-hidden"));w?G((d.mobile?kintone.mobile.app.record:kintone.app.record).get().record):q()};g.error||0==Object.keys(g.records).length?
r():kb.confirm(kb.constants.common.message.confirm.submit[kb.operator.language],w=>{if(w)r();else{var y={},H;for(H in g.records)((I,R)=>{var K=I.$id.value,S=I.$rowId.value,N=JSON.parse(JSON.stringify(f.origin.find(B=>B.$id.value==K)||{}));0!=Object.keys(N)&&(K in y||(y[K]=(B=>{var F={id:K,record:{$id:N.$id}};B&&(F.record[B]=N[B]);return F})(Array.from(new Set(e.mapping.value.map(B=>h.parallelize[B.value.external.value].tableCode))).join(""))),y[K].record=b.view.fields.reduce((B,F)=>{l.tr[R].elm('[field-id="'+
CSS.escape(F)+'"]').hasAttribute("edited")&&(P=>{P?B[P].value.each((Q,T)=>{Q.id==S&&(Q.value[F]=I[F])}):B[F]=I[F]})(b.fields[F].tableCode);return B},y[K].record))})(g.records[H],H.replace(/^row/g,""));kb.view.records.set(b.id,{put:Object.values(y)},!1,!0).then(I=>{r(!0)}).catch(I=>{kb.alert(kb.error.parse(I));r()})}},!0)}).html(kb.constants.common.caption.button.submit[kb.operator.language]).addClass("kb-hidden"),cancel:kb.create("button").addClass("kb-linkage-container-button").on("click",n=>{[a.total,
a.reload,a.open,a.edit,a.prev,a.next,a.copy].each((g,r)=>g.removeClass("kb-hidden"));[a.submit,a.cancel].each((g,r)=>g.addClass("kb-hidden"));q()}).html(kb.constants.common.caption.button.cancel[kb.operator.language]).addClass("kb-hidden"),open:kb.create("button").addClass("kb-icon kb-icon-open").on("click",n=>{window.open(kb.record.page.view(d.mobile,b.id,"20",f.query))}),prev:kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-left").on("click",n=>{f.offset-=c;q()}),next:kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-right").on("click",
n=>{f.offset+=c;q()}),reload:kb.create("button").addClass("kb-icon kb-icon-reload").on("click",n=>{G((d.mobile?kintone.mobile.app.record:kintone.app.record).get().record)}),total:kb.create("span").addClass("kb-linkage-container-monitor").html("")},q=()=>{var n=f.records.slice(f.offset,f.offset+c);l.clearRows();n.each((g,r)=>{(w=>{kb.record.set(w.elm("[form-id=form_"+b.id+"]"),b,g).then(()=>{w.elm(".kb-view-row-edit").attr("href",kb.record.page.detail(d.mobile,b.id,g.$id.value)).attr("target","_blank");
r==n.length-1&&m.parentNode.show()})})(l.addRow())});switch(kb.operator.language){case "en":a.total.html(f.records.length.toString()+"records in total");break;case "ja":a.total.html("\u7dcf"+f.records.length.toString()+"\u884c");break;case "zh":a.total.html("\u5171"+f.records.length.toString()+"\u6761\u8bb0\u5f55");break;case "zh-TW":a.total.html("\u5171"+f.records.length.toString()+"\u7b46\u8a18\u9304")}0<f.offset?a.prev.removeAttr("disabled"):a.prev.attr("disabled","disabled");f.offset+(c==n.length?
c:n.length)<f.records.length?a.next.removeAttr("disabled"):a.next.attr("disabled","disabled")},G=n=>{O(e,n).then(g=>{f=g;q();x(e,h,{},f.records)}).catch(()=>{f={offset:0,records:[]};q();x(e,h,{},f.records)})};switch(d.type){case "create":case "edit":m.append(kb.create("div").addClass("kb-linkage-container-footer").append(a.total).append(a.reload).append(a.open).append(a.edit).append(a.prev).append(a.next).append(a.copy).append(a.submit).append(a.cancel));break;case "detail":m.append(kb.create("div").addClass("kb-linkage-container-footer").append(a.total).append(a.reload).append(a.open).append(a.edit).append(a.prev).append(a.next).append(a.submit).append(a.cancel))}e.editable.value.includes("editable")||
a.edit.addClass("kb-hidden");((n,g)=>{kintone.events.on(n,g);n.each((r,w)=>{r in d.handlers||(d.handlers[r]=[]);d.handlers[r].push(g)})})(e.criteria.value.reduce((n,g)=>{n.push("app.record.create.change."+g.value.internal.value);n.push("app.record.edit.change."+g.value.internal.value);n.push("mobile.app.record.create.change."+g.value.internal.value);n.push("mobile.app.record.edit.change."+g.value.internal.value);return n},[]),n=>{G(n.record);return n});b.view.fields.each((n,g)=>{kb.event.on("kb.change."+
n,r=>{r.container.elm('[field-id="'+CSS.escape(n)+'"]').attr("edited","edited");return r})});G(u.record)})(kb.view.create(m.addClass("kb-linkage-container"),b,b.view.id,d.mobile).elm(".kb-view"),parseInt(e.limit.value))})({id:e.app.value,disables:[],fields:(b=>{b.$rowId={code:"$rowId",type:"SINGLE_LINE_TEXT",label:"",required:!1,noLabel:!0,placeholder:""};return b})(h.parallelize),view:{id:"linkage_"+e.app.value+"_"+e.container.value,buttons:["delete"],fields:e.mapping.value.map(b=>b.value.external.value),
mode:"viewer"}})}).catch(()=>{})})((d.mobile?kintone.mobile.app.record:kintone.app.record).getSpaceElement(e.container.value).css({width:"max-content"}));k++;k<t.length&&A(k)})(t[k])};A(0);C(u);break;case "index":A=k=>{(e=>{kb.filter.auth(e.user.value,e.organization.value,e.group.value).then(m=>{m&&(e.view.value&&e.view.value!=u.viewId.toString()||kb.button.create(d.mobile,d.type,"kb-linkage-button"+k.toString(),e.label.value,e.message.value,()=>{kb.view.records.get(d.app.id,(d.mobile?kintone.mobile.app:
kintone.app).getQueryCondition()).then(h=>{var b=[];let l=(c,f)=>{kb.field.load(e.app.value).then(a=>{O(e,h[c]).then(q=>{var G=E(e,h[c],q.records);x(e,a,G,q.records);b.push(kb.view.records.transform(G));kb.progressUpdate();c++;c<h.length?l(c,f):f()}).catch(()=>{})}).catch(()=>{})};0!=h.length?(kb.progressStart(h.length),l(0,()=>{kb.view.records.set(d.app.id,{put:b}).then(c=>kb.alert("Done!",()=>window.location.reload(!0))).catch(c=>kb.alert(kb.error.parse(c)))})):kb.alert("There are no records.")}).catch(h=>
kb.alert(kb.error.parse(h)))}));k++;k<t.length&&A(k)}).catch(m=>{k++;k<t.length&&A(k)})})(t[k])},A(0),C(u)}}else C(u)})(JSON.parse(p.tab).map((t,x)=>kb.extend({sIndex:{value:x.toString()}},t.setting)).reduce((t,x)=>{switch(d.type){case "index":x.bulk.value.includes("bulk")&&t.push(x);break;default:t.push(x)}return t},[]))}catch(t){kb.alert(kb.error.parse(t)),C(u)}}).catch(v=>C(u)):C(u)}).catch(p=>C(u))})("mobile"==u.type.split(".").first(),u.type.split(".").slice(-2).first())}))})(kintone.$PLUGIN_ID);
