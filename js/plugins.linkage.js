/*
* FileName "plugins.linkage.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(F){var e={},I=function(m,w){return new Promise(function(G,z){kb.field.load(m.app.value).then(function(t){(function(x){m.criteria.value.some(function(n){return!(n.value.external.value in x.external&&n.value.internal.value in x.internal)})?(kb.alert("No field to linkage was found"),z()):m.mapping.value.some(function(n){return!(n.value.external.value in x.external)})?(kb.alert("No field to linkage was found"),z()):function(n){kb.view.records.get(m.app.value,n).then(function(g){0!=g.length?
function(q,r){G(function(f){f.records.sort(function(b,h){var k=0;m.sort.value.each(function(a,u){var d=null,c=null;switch(t.parallelize[a.value.field.value].type){case "CALC":switch(t.parallelize[a.value.field.value].format){case "NUMBER":case "NUMBER_DIGIT":d=b[a.value.field.value].value?parseFloat(b[a.value.field.value].value):0,c=h[a.value.field.value].value?parseFloat(h[a.value.field.value].value):0}break;case "CATEGORY":case "CHECK_BOX":case "CREATOR":case "FILE":case "GROUP_SELECT":case "MODIFIER":case "MULTI_SELECT":case "ORGANIZATION_SELECT":case "STATUS_ASSIGNEE":case "USER_SELECT":d=
JSON.stringify(b[a.value.field.value].value);c=JSON.stringify(h[a.value.field.value].value);break;case "NUMBER":d=b[a.value.field.value].value?parseFloat(b[a.value.field.value].value):0;c=h[a.value.field.value].value?parseFloat(h[a.value.field.value].value):0;break;default:d=b[a.value.field.value].value,c=h[a.value.field.value].value}switch(a.value.order.value){case "asc":d>c&&(k=1);d<c&&(k=-1);break;case "desc":d>c&&(k=-1),d<c&&(k=1)}if(k)return KB_BREAK});return k});return f}(q.reduce(function(f,
b){Array(r?b[r].value.length:1).fill().map(function(){return{}}).each(function(h,k){h.$id=b.$id;for(var a in t.parallelize)t.parallelize[a].tableCode?t.parallelize[a].tableCode==r&&(h[a]=b[r].value[k].value[a]):h[a]=b[a];f.records.push(h)});return f},{offset:0,records:[]})))}(g.reduce(function(q,r){var f=kb.filter.scan({fields:t.origin},r,n);f&&q.push(f);return q},[]),Array.from(new Set(m.mapping.value.map(function(q){return t.parallelize[q.value.external.value].tableCode}))).join("")):G({offset:0,
records:[]})})["catch"](function(g){kb.alert(kb.error.parse(g));z()})}(m.criteria.value.reduce(function(n,g){n.push(kb.filter.query.create(x.external[g.value.external.value],g.value.operator.value,w[g.value.internal.value]));return n},kb.filter.query.parse(m.filter.value).map(function(n){return x.external[n.field].code+" "+n.operator+" "+n.value})).join(" and "))})({external:t.parallelize,internal:e.fieldInfos.parallelize})})["catch"](function(t){kb.alert(kb.error.parse(t));z()})})};kintone.events.on("app.record.create.show app.record.detail.show app.record.edit.show app.record.index.show mobile.app.record.create.show mobile.app.record.detail.show mobile.app.record.edit.show mobile.app.record.index.show".split(" "),
function(m){return new Promise(function(w,G){(function(z,t){e.mobile=z;e.type=t;kb.config[F].config.get().then(function(x){0!=Object.keys(x).length?kb.field.load(kb.config[F].app,!0).then(function(n){e.app={id:kb.config[F].app,fields:n.origin};e.fieldInfos=n;try{(function(g){if(0!=g.length){var q=function(f,b,h){var k=Array.from(new Set(f.mapping.value.map(function(a){return e.fieldInfos.parallelize[a.value.internal.value].tableCode}))).reduce(function(a,u){b[u].value=[];a[u]={fields:f.mapping.value.filter(function(d){return e.fieldInfos.parallelize[d.value.internal.value].tableCode==
u}),row:kb.record.create(e.fieldInfos.origin[u],!1)};return a},{});h.each(function(a,u){for(var d in k)b[d].value.push(function(c){k[d].fields.each(function(v,A){if(v.value.internal.value in e.fieldInfos.parallelize)switch(e.fieldInfos.parallelize[v.value.internal.value].type){case "lookup":var y=a[v.value.external.value];c[v.value.internal.value]={lookup:!0,search:"search"in y?y.search:"",value:y.value};break;default:c[v.value.internal.value].value=a[v.value.external.value].value}});return{value:c}}(kb.extend({},
k[d].row)))});return b};switch(e.type){case "create":case "edit":case "detail":var r=function(f){(function(b){(function(h){h&&kb.field.load(b.app.value).then(function(k){(function(a){(function(u,d){var c={},v=kb.create("button").addClass("kb-linkage-container-button").html(b.label.value).on("click",function(p){kb.confirm(b.message.value,function(){kb.event.call("kb.action.call",{container:kb.elm("body"),record:q(b,(e.mobile?kintone.mobile.app.record:kintone.app.record).get().record,c.records),mobile:e.mobile,
pattern:"change",fields:function(l){return l.reduce(function(B,D){return B=B.concat(Object.keys(e.fieldInfos.tables[D].fields))},l)}(b.mapping.value.map(function(l){return e.fieldInfos.parallelize[l.value.internal.value].tableCode})),stopPropagation:!0,workplace:"record"}).then(function(l){kb.event.call("kb.style.call",{container:l.container,record:l.record,mobile:l.mobile,pattern:"$id"in l.record?l.record.$id.value?"edit":"create":"create",workplace:l.workplace}).then(function(B){(e.mobile?kintone.mobile.app.record:
kintone.app.record).set({record:B.record})})["catch"](function(){})})["catch"](function(){})})}),A=kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-left").on("click",function(p){c.offset-=d;E()}),y=kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-right").on("click",function(p){c.offset+=d;E()}),J=kb.create("button").addClass("kb-icon kb-icon-reload").on("click",function(p){H((e.mobile?kintone.mobile.app.record:kintone.app.record).get().record)}),C=kb.create("span").addClass("kb-linkage-container-monitor").html(""),
E=function(){var p=c.records.slice(c.offset,c.offset+d);u.clearRows();p.each(function(l,B){(function(D){kb.record.set(D.elm("[form-id=form_"+a.id+"]"),a,l).then(function(){D.elm(".kb-view-row-edit").attr("href",kb.record.page.detail(e.mobile,a.id,l.$id.value)).attr("target","_blank");h.parentNode.show()})})(u.addRow())});switch(kb.operator.language){case "en":C.html(c.records.length.toString()+"records in total");break;case "ja":C.html("\u7dcf"+c.records.length.toString()+"\u884c");break;case "zh":C.html("\u5171"+
c.records.length.toString()+"\u6761\u8bb0\u5f55")}0<c.offset?A.removeAttr("disabled"):A.attr("disabled","disabled");c.offset+(d==p.length?d:p.length)<c.records.length?y.removeAttr("disabled"):y.attr("disabled","disabled")},H=function(p){I(b,p).then(function(l){c=l;E()})["catch"](function(){c={offset:0,records:[]};E()})};switch(e.type){case "create":case "edit":h.append(kb.create("div").addClass("kb-linkage-container-footer").append(C).append(J).append(A).append(y).append(v));break;case "detail":h.append(kb.create("div").addClass("kb-linkage-container-footer").append(C).append(J).append(A).append(y))}kintone.events.on(b.criteria.value.reduce(function(p,
l){p.push("app.record.create.change."+l.value.internal.value);p.push("app.record.edit.change."+l.value.internal.value);p.push("mobile.app.record.create.change."+l.value.internal.value);p.push("mobile.app.record.edit.change."+l.value.internal.value);return p},[]),function(p){return H(p.record)});H(m.record)})(kb.view.create(h.addClass("kb-linkage-container"),a,a.view.id,e.mobile).elm(".kb-view"),parseInt(b.limit.value))})({id:b.app.value,disables:[],fields:k.parallelize,view:{id:"linkage_"+b.app.value+
"_"+b.container.value,buttons:["delete"],fields:b.mapping.value.map(function(a){return a.value.external.value}),mode:"viewer"}})})["catch"](function(){})})((e.mobile?kintone.mobile.app.record:kintone.app.record).getSpaceElement(b.container.value));f++;f<g.length&&r(f)})(g[f])};r(0);w(m);break;case "index":r=function(f){(function(b){kb.filter.auth(b.user.value,b.organization.value,b.group.value).then(function(h){h&&(b.view.value&&b.view.value!=m.viewId.toString()||kb.button.create(e.mobile,e.type,
"kb-linkage-button"+f.toString(),b.label.value,b.message.value,function(){kb.view.records.get(e.app.id,(e.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(function(k){var a=[],u=function(d,c){I(b,k[d]).then(function(v){a.push(kb.view.records.transform(q(b,k[d],v.records)));kb.progressUpdate();d++;d<k.length?u(d,c):c()})["catch"](function(){})};0!=k.length?(kb.progressStart(k.length),u(0,function(){kb.view.records.set(e.app.id,{put:a}).then(function(d){return kb.alert("Done!",function(){return window.location.reload(!0)})})["catch"](function(d){return kb.alert(kb.error.parse(d))})})):
kb.alert("There are no records.")})["catch"](function(k){return kb.alert(kb.error.parse(k))})}));f++;f<g.length&&r(f)})["catch"](function(h){f++;f<g.length&&r(f)})})(g[f])},r(0),w(m)}}else w(m)})(JSON.parse(x.tab).map(function(g,q){return kb.extend({sIndex:{value:q.toString()}},g.setting)}).reduce(function(g,q){switch(e.type){case "index":q.bulk.value.includes("bulk")&&g.push(q);break;default:g.push(q)}return g},[]))}catch(g){kb.alert(kb.error.parse(g)),w(m)}})["catch"](function(n){return w(m)}):
w(m)})["catch"](function(x){return w(m)})})("mobile"==m.type.split(".").first(),m.type.split(".").slice(-2).first())})})})(kintone.$PLUGIN_ID);