/*
* FileName "plugins.linkage.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(K=>{var d={handlers:{},stats:{}},O=(w,D)=>new Promise((L,H)=>{kb.field.load(w.app.value).then(A=>{(E=>{w.criteria.value.some(r=>!(r.value.external.value in E.external&&r.value.internal.value in E.internal))?(kb.alert("No field to linkage was found"),H()):w.mapping.value.some(r=>!(r.value.external.value in E.external))?(kb.alert("No field to linkage was found"),H()):(r=>{r.api=r.api.join(" and ");r.url=r.url.join(" and ");kb.view.records.get(w.app.value,r.api).then(x=>{0!=x.length?((v,z,B)=>{L((p=>
{p.records.sort((e,t)=>{var n=0;w.sort.value.each((c,q)=>{switch(A.parallelize[c.value.field.value].type){case "CALC":switch(A.parallelize[c.value.field.value].format){case "NUMBER":case "NUMBER_DIGIT":q=e[c.value.field.value].value?parseFloat(e[c.value.field.value].value):0;var f=t[c.value.field.value].value?parseFloat(t[c.value.field.value].value):0;break;default:q=e[c.value.field.value].value,f=t[c.value.field.value].value}break;case "CATEGORY":case "CHECK_BOX":case "CREATOR":case "FILE":case "GROUP_SELECT":case "MODIFIER":case "MULTI_SELECT":case "ORGANIZATION_SELECT":case "STATUS_ASSIGNEE":case "USER_SELECT":q=
JSON.stringify(e[c.value.field.value].value);f=JSON.stringify(t[c.value.field.value].value);break;case "NUMBER":q=e[c.value.field.value].value?parseFloat(e[c.value.field.value].value):0;f=t[c.value.field.value].value?parseFloat(t[c.value.field.value].value):0;break;default:q=e[c.value.field.value].value,f=t[c.value.field.value].value}switch(c.value.order.value){case "asc":q>f&&(n=1);q<f&&(n=-1);break;case "desc":q>f&&(n=-1),q<f&&(n=1)}if(n)return KB_BREAK});return n});return p})(v.reduce((p,e)=>{Array(B?
e[B].value.length:1).fill().map(()=>({})).each((t,n)=>{t.$id=e.$id;for(var c in A.parallelize)A.parallelize[c].tableCode?A.parallelize[c].tableCode==B&&(t[c]=e[B].value[n].value[c]):"$rowId"!=c?t[c]=e[c]:t.$rowId=B?{value:e[B].value[n].id}:{value:""};p.records.push(t)});return p},{offset:0,origin:z,query:r.url,records:[]})))})(x.reduce((v,z)=>{(z=kb.filter.scan({fields:A.origin},z,r.api))&&v.push(z);return v},[]),x,Array.from(new Set(w.mapping.value.map(v=>A.parallelize[v.value.external.value].tableCode))).join("")):
L({offset:0,records:[]})}).catch(x=>{kb.alert(kb.error.parse(x));H()})})(w.criteria.value.reduce((r,x)=>{r.api.push(kb.filter.query.create(E.external[x.value.external.value],x.value.operator.value,D[x.value.internal.value]));E.external[x.value.external.value].tableCode||r.url.push(r.api.last());return r},kb.filter.query.parse.expand({id:w.app.value,fields:A.origin},w.filter.value).reduce((r,x)=>{r.api.push(x.field+" "+x.operator+" "+x.value);E.external[x.field].tableCode||r.url.push(r.api.last());
return r},{api:[],url:[]})))})({external:A.parallelize,internal:d.fieldInfos.parallelize})}).catch(A=>{kb.alert(kb.error.parse(A));H()})});kintone.events.on("app.record.create.show app.record.detail.show app.record.edit.show app.record.index.show mobile.app.record.create.show mobile.app.record.detail.show mobile.app.record.edit.show mobile.app.record.index.show".split(" "),w=>new Promise((D,L)=>{((H,A)=>{d.mobile=H;d.type=A;for(var E in d.handlers)d.handlers[E].each((r,x)=>{kintone.events.off(E,r)});
kb.config[K].config.get().then(r=>{0!=Object.keys(r).length?kb.field.load(kb.config[K].app,!0).then(x=>{d.app={id:kb.config[K].app,fields:x.origin};d.fieldInfos=x;try{(v=>{if(0!=v.length){var z=(p,e,t)=>{var n=(c=>Array.from(new Set(c.map(q=>d.fieldInfos.parallelize[q.value.internal.value].tableCode))).reduce((q,f)=>{e[f].value=[];q[f]={fields:c.filter(l=>d.fieldInfos.parallelize[l.value.internal.value].tableCode==f),row:kb.record.create(d.fieldInfos.origin[f],!1)};return q},{}))(p.mapping.value.reduce((c,
q)=>{q.value.internal.value in d.fieldInfos.parallelize&&c.push(q);return c},[]));t.each((c,q)=>{for(var f in n)e[f].value.push((l=>{n[f].fields.each((b,y)=>{if(b.value.internal.value in d.fieldInfos.parallelize)switch(d.fieldInfos.parallelize[b.value.internal.value].type){case "lookup":y=c[b.value.external.value];l[b.value.internal.value]={lookup:!0,search:"search"in y?y.search:"",value:y.value};break;default:l[b.value.internal.value].value=c[b.value.external.value].value}});return{value:l}})(kb.extend({},
n[f].row)))});return e};d.mobile&&kb.elm("body").addClass("kb-mobile");switch(d.type){case "create":case "edit":case "detail":var B=p=>{(e=>{(t=>{t&&kb.field.load(e.app.value).then(n=>{(c=>{((q,f)=>{var l={},b={copy:kb.create("button").addClass("kb-linkage-container-button").html(e.label.value).on("click",m=>{kb.confirm(e.message.value,()=>{kb.event.call("kb.action.call",{container:kb.elm("body"),record:z(e,(d.mobile?kintone.mobile.app.record:kintone.app.record).get().record,l.records),mobile:d.mobile,
pattern:"change",fields:(a=>a.reduce((k,g)=>k=k.concat(Object.keys(d.fieldInfos.tables[g].fields)),a))(e.mapping.value.reduce((a,k)=>{k.value.internal.value in d.fieldInfos.parallelize&&a.push(d.fieldInfos.parallelize[k.value.internal.value].tableCode);return a},[])),stopPropagation:!0,workplace:"record"}).then(a=>{kb.event.call("kb.style.call",{container:a.container,record:a.record,mobile:a.mobile,pattern:"$id"in a.record?a.record.$id.value?"edit":"create":"create",workplace:a.workplace}).then(k=>
{kb.event.call("kb.cascade.call",k).then(g=>{(d.mobile?kintone.mobile.app.record:kintone.app.record).set({record:g.record})}).catch(()=>{})}).catch(()=>{})}).catch(()=>{})})}),edit:kb.create("button").addClass("kb-icon kb-icon-edit").on("click",m=>{[b.total,b.reload,b.open,b.edit,b.prev,b.next,b.copy].each((a,k)=>a.addClass("kb-hidden"));[b.submit,b.cancel].each((a,k)=>a.removeClass("kb-hidden"));q.elms(".kb-field").each((a,k)=>a.removeClass("kb-readonly"));(a=>{a=kb.elm(".kb_spread_style_"+CSS.escape(a));
a.parentNode.removeChild(a)})("view_"+c.id+"_"+c.view.id+"_"+location.host.split(".").first());t.parentNode.show()}),submit:kb.create("button").addClass("kb-linkage-container-button").on("click",m=>{var a=q.tr.reduce((g,u,h)=>{g.error||"unsaved"!=u.elm(".kb-scope").attr("unsaved")||(u=kb.record.get(u.elm(".kb-scope"),c),u.error?g.error=!0:g.records["row"+h.toString()]=u.record);return g},{error:!1,records:{}}),k=(g=!1)=>{[b.total,b.reload,b.open,b.edit,b.prev,b.next,b.copy].each((u,h)=>u.removeClass("kb-hidden"));
[b.submit,b.cancel].each((u,h)=>u.addClass("kb-hidden"));g?J((d.mobile?kintone.mobile.app.record:kintone.app.record).get().record):y()};a.error||0==Object.keys(a.records).length?k():kb.confirm(kb.constants.common.message.confirm.submit[kb.operator.language],g=>{if(g)k();else{var u={},h;for(h in a.records)((G,R)=>{var I=G.$id.value,S=G.$rowId.value,M=JSON.parse(JSON.stringify(l.origin.find(C=>C.$id.value==I)||{}));0!=Object.keys(M)&&(I in u||(u[I]=(C=>{var F={id:I,record:{$id:M.$id}};C&&(F.record[C]=
M[C]);return F})(Array.from(new Set(e.mapping.value.map(C=>n.parallelize[C.value.external.value].tableCode))).join(""))),u[I].record=c.view.fields.reduce((C,F)=>{q.tr[R].elm('[field-id="'+CSS.escape(F)+'"]').hasAttribute("edited")&&(P=>{P?C[P].value.each((Q,T)=>{Q.id==S&&(Q.value[F]=G[F])}):C[F]=G[F]})(c.fields[F].tableCode);return C},u[I].record))})(a.records[h],h.replace(/^row/g,""));kb.view.records.set(c.id,{put:Object.values(u)},!1,!0).then(G=>{k(!0)}).catch(G=>{kb.alert(kb.error.parse(G));k()})}},
!0)}).html(kb.constants.common.caption.button.submit[kb.operator.language]).addClass("kb-hidden"),cancel:kb.create("button").addClass("kb-linkage-container-button").on("click",m=>{[b.total,b.reload,b.open,b.edit,b.prev,b.next,b.copy].each((a,k)=>a.removeClass("kb-hidden"));[b.submit,b.cancel].each((a,k)=>a.addClass("kb-hidden"));y()}).html(kb.constants.common.caption.button.cancel[kb.operator.language]).addClass("kb-hidden"),open:kb.create("button").addClass("kb-icon kb-icon-open").on("click",m=>
{window.open(kb.record.page.view(d.mobile,c.id,"20",l.query))}),prev:kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-left").on("click",m=>{l.offset-=f;y()}),next:kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-right").on("click",m=>{l.offset+=f;y()}),reload:kb.create("button").addClass("kb-icon kb-icon-reload").on("click",m=>{J((d.mobile?kintone.mobile.app.record:kintone.app.record).get().record)}),total:kb.create("span").addClass("kb-linkage-container-monitor").html("")},
y=()=>{var m=l.records.slice(l.offset,l.offset+f);q.clearRows();m.each((a,k)=>{(g=>{kb.record.set(g.elm("[form-id=form_"+c.id+"]"),c,a).then(()=>{g.elm(".kb-view-row-edit").attr("href",kb.record.page.detail(d.mobile,c.id,a.$id.value)).attr("target","_blank");k==m.length-1&&t.parentNode.show()})})(q.addRow())});switch(kb.operator.language){case "en":b.total.html(l.records.length.toString()+"records in total");break;case "ja":b.total.html("\u7dcf"+l.records.length.toString()+"\u884c");break;case "zh":b.total.html("\u5171"+
l.records.length.toString()+"\u6761\u8bb0\u5f55");break;case "zh-TW":b.total.html("\u5171"+l.records.length.toString()+"\u7b46\u8a18\u9304")}0<l.offset?b.prev.removeAttr("disabled"):b.prev.attr("disabled","disabled");l.offset+(f==m.length?f:m.length)<l.records.length?b.next.removeAttr("disabled"):b.next.attr("disabled","disabled")},N=()=>{var m={},a=e.mapping.value.reduce((g,u)=>{switch(n.parallelize[u.value.external.value].type){case "CREATED_TIME":case "DATE":case "DATETIME":case "UPDATED_TIME":g[u.value.external.value]=
{max:"",min:""};break;case "NUMBER":g[u.value.external.value]={count:0,sum:"",avg:"",max:"",min:""}}return g},{});l.records.each((g,u)=>{for(var h in g)if(h in n.parallelize)switch(n.parallelize[h].type){case "CREATED_TIME":case "DATE":case "DATETIME":case "UPDATED_TIME":if(h in a&&g[h].value){if(!a[h].max||g[h].value>a[h].max)a[h].max=g[h].value;if(!a[h].min||g[h].value<a[h].min)a[h].min=g[h].value}break;case "NUMBER":if(h in a&&kb.isNumeric(g[h].value)){if(!kb.isNumeric(a[h].max)||Number(g[h].value)>
a[h].max)a[h].max=Number(g[h].value);if(!kb.isNumeric(a[h].min)||Number(g[h].value)<a[h].min)a[h].min=Number(g[h].value);kb.isNumeric(a[h].sum)||(a[h].sum=0);a[h].sum+=Number(g[h].value);a[h].count++}}});for(var k in a)a[k].count&&(a[k].avg=a[k].sum/a[k].count),Object.values(d.stats).filter(g=>g.source==k).each((g,u)=>{u=g.destination;m[u]={type:d.fieldInfos.origin[u].type,value:g.value=a[k][g.method]}});if(["create","edit"].includes(d.type))(g=>{try{g()}catch(h){var u=setInterval(()=>{try{g(),clearInterval(u)}catch(G){}},
500)}})(()=>{0!=Object.keys(m).length&&(d.mobile?kintone.mobile.app.record:kintone.app.record).set({record:m})});else for(k in m)(g=>{d.mobile?g.value.html(m[k].value):g.value.elm("span").html(m[k].value)})(kb.field.get(d.fieldInfos.parallelize[k],d.mobile,d.type))},J=m=>{O(e,m).then(a=>{l=a;y();N()}).catch(()=>{l={offset:0,records:[]};y();N()})};switch(d.type){case "create":case "edit":t.append(kb.create("div").addClass("kb-linkage-container-footer").append(b.total).append(b.reload).append(b.open).append(b.edit).append(b.prev).append(b.next).append(b.copy).append(b.submit).append(b.cancel));
break;case "detail":t.append(kb.create("div").addClass("kb-linkage-container-footer").append(b.total).append(b.reload).append(b.open).append(b.edit).append(b.prev).append(b.next).append(b.submit).append(b.cancel))}e.editable.value.includes("editable")||b.edit.addClass("kb-hidden");((m,a)=>{kintone.events.on(m,a);m.each((k,g)=>{k in d.handlers||(d.handlers[k]=[]);d.handlers[k].push(a)})})(e.criteria.value.reduce((m,a)=>{m.push("app.record.create.change."+a.value.internal.value);m.push("app.record.edit.change."+
a.value.internal.value);m.push("mobile.app.record.create.change."+a.value.internal.value);m.push("mobile.app.record.edit.change."+a.value.internal.value);return m},[]),m=>{J(m.record);return m});c.view.fields.each((m,a)=>{kb.event.on("kb.change."+m,k=>{k.container.elm('[field-id="'+CSS.escape(m)+'"]').attr("edited","edited");return k})});J(w.record)})(kb.view.create(t.addClass("kb-linkage-container"),c,c.view.id,d.mobile).elm(".kb-view"),parseInt(e.limit.value))})({id:e.app.value,disables:[],fields:(c=>
{c.$rowId={code:"$rowId",type:"SINGLE_LINE_TEXT",label:"",required:!1,noLabel:!0,placeholder:""};return c})(n.parallelize),view:{id:"linkage_"+e.app.value+"_"+e.container.value,buttons:["delete"],fields:e.mapping.value.map(c=>c.value.external.value),mode:"viewer"}})}).catch(()=>{})})((d.mobile?kintone.mobile.app.record:kintone.app.record).getSpaceElement(e.container.value).css({width:"max-content"}));p++;p<v.length&&B(p)})(v[p])};v.first().mapping.value.some(p=>!("stats"in p.value))&&(kb.alert(kb.error.config.update("Boost! Linkage")),
v=v.map(p=>{p.mapping.value=p.mapping.value.map(e=>{e.value.stats={value:""};return e});return p}));d.stats={};v.each((p,e)=>{p.mapping.value.each((t,n)=>{n=JSON.parse(t.value.stats.value||"{}");for(var c in n)((q,f)=>{f.value in d.fieldInfos.origin&&(f.value in d.stats||((l,b)=>{kintone.events.on(l,b);l.each((y,N)=>{y in d.handlers||(d.handlers[y]=[]);d.handlers[y].push(b)})})(["app.record.create.change."+f.value,"app.record.edit.change."+f.value,"mobile.app.record.create.change."+f.value,"mobile.app.record.edit.change."+
f.value],l=>{l.record[f.value].value!=d.stats[f.value].value&&(l.record[f.value].value=d.stats[f.value].value);return l}),d.stats[f.value]={destination:f.value,method:q,source:t.value.external.value,value:""})})(c,n[c])})});B(0);D(w);break;case "index":B=p=>{(e=>{kb.filter.auth(e.user.value,e.organization.value,e.group.value).then(t=>{t&&(e.view.value&&e.view.value!=w.viewId.toString()||kb.button.create(d.mobile,d.type,"kb-linkage-button"+p.toString(),e.label.value,e.message.value,()=>{kb.view.records.get(d.app.id,
(d.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(n=>{var c=[];let q=(f,l)=>{O(e,n[f]).then(b=>{c.push(kb.view.records.transform(z(e,n[f],b.records)));kb.progressUpdate();f++;f<n.length?q(f,l):l()}).catch(()=>{})};0!=n.length?(kb.progressStart(n.length),q(0,()=>{kb.view.records.set(d.app.id,{put:c}).then(f=>kb.alert("Done!",()=>window.location.reload(!0))).catch(f=>kb.alert(kb.error.parse(f)))})):kb.alert("There are no records.")}).catch(n=>kb.alert(kb.error.parse(n)))}));p++;p<
v.length&&B(p)}).catch(t=>{p++;p<v.length&&B(p)})})(v[p])},B(0),D(w)}}else D(w)})(JSON.parse(r.tab).map((v,z)=>kb.extend({sIndex:{value:z.toString()}},v.setting)).reduce((v,z)=>{switch(d.type){case "index":z.bulk.value.includes("bulk")&&v.push(z);break;default:v.push(z)}return v},[]))}catch(v){kb.alert(kb.error.parse(v)),D(w)}}).catch(x=>D(w)):D(w)}).catch(r=>D(w))})("mobile"==w.type.split(".").first(),w.type.split(".").slice(-2).first())}))})(kintone.$PLUGIN_ID);
