/*
* FileName "plugins.omail.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(z=>{var b={},B=(d,h,C=!1)=>new Promise((w,r)=>{var n="",t=(f,p)=>{var u=()=>{f++;f<d.length?t(f,p):p()};(a=>{var c=kb.filter.scan(b.app,h,a.condition.value);c?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(x=>{if(x){var v=(m,l,g)=>{"HTML"==a.format.value&&(m=m.replace(/\r/g,"").replace(/\n/g,"<br>"));for(var e in l){var k=l[e].value;e in b.fieldInfos.parallelize&&("HTML"==a.format.value&&"MULTI_LINE_TEXT"==b.fieldInfos.parallelize[e].type&&(k=k.replace(/\r/g,"").replace(/\n/g,
"<br>")),m=m.replace(new RegExp("%"+e+"%","g"),kb.field.stringify(b.fieldInfos.parallelize[e],k," / ",!0)))}for(e in g)k=g[e].value,e in b.fieldInfos.parallelize&&("HTML"==a.format.value&&"MULTI_LINE_TEXT"==b.fieldInfos.parallelize[e].type&&(k=k.replace(/\r/g,"").replace(/\n/g,"<br>")),m=m.replace(new RegExp("%"+e+"%","g"),kb.field.stringify(b.fieldInfos.parallelize[e],k," / ",!0)));return m};(m=>{var l=(g,e)=>{(k=>{var F=(q,y)=>{if(0!=k.attachment.length){var D=!1;window.hasOwnProperty("kb_report_temp")&&
k.attachment[q].fileKey in window.kb_report_temp&&(D=!0);D?(k.attachment[q].data=window.kb_report_temp[k.attachment[q].fileKey],q++,q<k.attachment.length?F(q,y):y()):kb.file.download(k.attachment[q],!0).then(A=>{kb.field.blobToBase64(A,G=>{k.attachment[q].data=G;q++;q<k.attachment.length?F(q,y):y()})}).catch(A=>{kb.alert(kb.error.parse(A));r()})}else y()};F(0,()=>{kb.encrypt(JSON.stringify(k.data),n).then(q=>{var y=fetch,D="https://api.kintone-booster.com/mail/oauth/"+kb.operator.language,A=JSON,
G=A.stringify;k.data=q.data;k.iv=q.iv;k.tag=q.tag;y(D,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:G.call(A,k)}).then(E=>{E.json().then(H=>{switch(E.status){case 200:g++;g<m.length?l(g,e):e();break;default:kb.alert(kb.error.parse(H)),r()}})}).catch(E=>{kb.alert(kb.error.parse(E));r()})}).catch(q=>{r()})})})(m[g])};0!=m.length?l(0,()=>{try{a.formula.value.map(g=>g.value).each((g,e)=>{g.field.value in b.fieldInfos.parallelize&&(e=b.fieldInfos.parallelize[g.field.value],e.tableCode||
(c[e.code].value=kb.formula.calculate(g,c,c,h,b.fieldInfos.parallelize),e.lookup&&(c[e.code].lookup=!0),g=c.$id.value,g in b.formulaRecords||(b.formulaRecords[g]={$id:{value:g}}),b.formulaRecords[g][e.code]=c[e.code]))}),u()}catch(g){kb.alert(kb.error.parse(g)),r()}}):u()})((()=>{var m=[];(b.fieldInfos.parallelize[a.to.value].tableCode?c[b.fieldInfos.parallelize[a.to.value].tableCode].value:[{value:c}]).each((l,g)=>{l.value[a.to.value].value&&m.push({data:{client_id:a.client_id.value,client_secret:a.client_secret.value,
author:a.author.value,sender:a.sender.value,subdomain:location.host.split(".")[0],provider:(e=>{e="";switch(a.provider.value){case "GMail":e="google";break;case "Exchange Online":e="microsoft"}return e})(a.provider.value),to:l.value[a.to.value].value,cc:v(a.cc.value,c,b.fieldInfos.parallelize[a.to.value].tableCode?l.value:{}),bcc:v(a.bcc.value,c,b.fieldInfos.parallelize[a.to.value].tableCode?l.value:{}),html:"HTML"==a.format.value},subject:v(a.subject.value,c,b.fieldInfos.parallelize[a.to.value].tableCode?
l.value:{}),body:v(a.body.value,c,b.fieldInfos.parallelize[a.to.value].tableCode?l.value:{}),attachment:(()=>{var e=[];a.attachment.value&&a.attachment.value in b.fieldInfos.parallelize&&(e=(b.fieldInfos.parallelize[a.attachment.value].tableCode?l.value:c)[a.attachment.value].value);return e})()})});return m})())}else u()}).catch(x=>{kb.alert(kb.error.parse(x));r()}):u()})(d[f])};fetch("https://api.kintone-booster.com/mail/oauth/"+kb.operator.language,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(f=>
{f.json().then(p=>{switch(f.status){case 200:n=p.passphrase;C||kb.loadStart();t(0,()=>{C||kb.loadEnd();w()});break;default:kb.alert(kb.error.parse(p)),r()}})}).catch(f=>{kb.alert(kb.error.parse(f));r()})});kintone.events.on("app.record.create.submit.success app.record.detail.process.proceed app.record.detail.show app.record.edit.submit.success app.record.index.show mobile.app.record.create.submit.success mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.submit.success mobile.app.record.index.show".split(" "),
d=>new Promise((h,C)=>{((w,r)=>{b.mobile=w;b.type=r;kb.config[z].config.get().then(n=>{0!=Object.keys(n).length?kb.field.load(kb.config[z].app,!0).then(t=>{b.app={id:kb.config[z].app,fields:t.origin};b.fieldInfos=t;b.formulaRecords={};try{(f=>{if(0!=f.length){var p=a=>{["process"].includes(b.type)||0==Object.keys(b.formulaRecords).length?a():kb.view.records.set(b.app.id,{put:Object.values(b.formulaRecords).map(c=>kb.view.records.transform(c))},!1).then(c=>a()).catch(c=>kb.alert(kb.error.parse(c)))};
"formula"in f.first()||(kb.alert(kb.error.config.update("Boost! OAuth Mail")),f=f.map(a=>{a.formula={value:[]};return a}));switch(b.type){case "create":case "edit":B(f,d.record).then(a=>p(()=>h(d))).catch(()=>{});break;case "process":(a=>{0!=a.length?B(a,d.record).then(c=>p(()=>h(d))).catch(()=>{}):h(d)})(f.filter(a=>a.action.value==d.action.value+":"+d.status.value+":"+d.nextStatus.value));break;case "detail":var u=a=>{(c=>{kb.filter.scan(b.app,d.record,c.condition.value)?kb.filter.auth(c.user.value,
c.organization.value,c.group.value).then(x=>{x&&kb.button.create(b.mobile,b.type,"kb-mail-button"+a.toString(),c.label.value,c.message.value,()=>B([c],d.record).then(v=>p(()=>kb.alert("Done!",()=>window.location.reload(!0)))).catch(()=>{}));a++;a<f.length&&u(a)}).catch(x=>{a++;a<f.length&&u(a)}):(a++,a<f.length&&u(a))})(f[a])};u(0);h(d);break;case "index":u=a=>{(c=>{kb.filter.auth(c.user.value,c.organization.value,c.group.value).then(x=>{x&&(c.view.value&&c.view.value!=d.viewId.toString()||kb.button.create(b.mobile,
b.type,"kb-mail-button"+a.toString(),c.label.value,c.message.value,()=>{kb.view.records.get(b.app.id,(b.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(v=>{let m=(l,g)=>{B([c],v[l],!0).then(e=>{kb.progressUpdate();l++;l<v.length?m(l,g):g()}).catch(()=>{})};0!=v.length?(kb.progressStart(v.length),m(0,()=>p(()=>kb.alert("Done!",()=>window.location.reload(!0))))):kb.alert("There are no records.")}).catch(v=>kb.alert(kb.error.parse(v)))}));a++;a<f.length&&u(a)}).catch(x=>{a++;a<f.length&&
u(a)})})(f[a])},u(0),h(d)}}else h(d)})(JSON.parse(n.tab).map((f,p)=>kb.extend({sIndex:{value:p.toString()}},f.setting)).reduce((f,p)=>{(b.mobile?["all","both","mobile"]:["all","both","pc"]).includes(p.device.value)&&p.event.value.includes(b.type)&&f.push(p);return f},[]))}catch(f){kb.alert(kb.error.parse(f)),h(d)}}).catch(t=>h(d)):h(d)}).catch(n=>h(d))})("mobile"==d.type.split(".").first(),(w=>{switch(w){case "submit":w=d.type.split(".").slice(-3).first()}return w})(d.type.split(".").slice(-2).first()))}));
kb.event.on("kb.omail.call",d=>new Promise((h,C)=>{kb.config[z].config.get().then(w=>{0!=Object.keys(w).length?kb.field.load(kb.config[z].app,!0).then(r=>{b.app={id:kb.config[z].app,fields:r.origin};b.fieldInfos=r;try{(n=>{0!=n.length?B(n,d.record,!0).then(t=>h(d)).catch(()=>h(d)):h(d)})(JSON.parse(w.tab).map((n,t)=>kb.extend({sIndex:{value:t.toString()}},n.setting)).reduce((n,t)=>{(d.mobile?["all","both","mobile"]:["all","both","pc"]).includes(t.device.value)&&t.event.value.includes(d.pattern)&&
n.push(t);return n},[]))}catch(n){kb.alert(kb.error.parse(n)),h(d)}}).catch(r=>h(d)):h(d)}).catch(w=>h(d))}))})(kintone.$PLUGIN_ID);
