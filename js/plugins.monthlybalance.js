/*
* FileName "plugins.monthlybalance.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(y=>{var h={},D=(g,q)=>new Promise((B,C)=>{var x=[...Array.from({length:12},(p,e)=>g["month"+(e+1).toString().padStart(2,"0")].value),g.carryover.value],w=(p,e)=>{var n=(f,k)=>{(a=>{kb.progressStart(0,(()=>{var d="";switch(kb.operator.language){case "en":d="Registering "+a.name+" data.";break;case "ja":d=a.name+"\u306e\u30c7\u30fc\u30bf\u3092\u767b\u9332\u3057\u3066\u3044\u307e\u3059\u3002";break;case "zh":d="\u6b63\u5728\u767b\u8bb0"+a.name+"\u6570\u636e\u3002";break;case "zh-TW":d="\u6b63\u5728\u767b\u9304"+
a.name+"\u8cc7\u6599\u3002"}return d})());(d=>{kb.view.records.get(a.id,(()=>{var b=[],c=m=>a.isTimeStamp?(m.getTime()/1E3).toString():a.isDateTime?m.toISOString():m.format("Y-m-d");b.push(a.date+(a.fieldInfos.parallelize[a.date].tableCode?' not in ("")':'!=""'));b.push(a.date+'>"'+c(d.start)+'"');b.push(a.date+'<"'+c(d.end)+'"');return b.join(" and ")})()).then(b=>{d.start=a.isDateTime?d.start.toISOString():d.start.format("Y-m-d");d.end=a.isDateTime?d.end.toISOString():d.end.format("Y-m-d");kb.popups.progress.max=
b.length;b.each((c,m)=>{var l=kb.filter.scan({id:a.id,fields:a.fieldInfos.origin},c,a.filter);if(l){var r=[];(t=>{t?r=l[t].value.reduce((v,u)=>{g.criteria.value.each((z,A)=>{a.criteria[A]in u.value||(u.value[a.criteria[A]]={value:l[a.criteria[A]].value})});a.date in u.value||(u.value[a.date]={value:l[a.date].value});v.push(u.value);return v},[]):r.push(l)})(a.fieldInfos.parallelize[a.amount].tableCode);r.each((t,v)=>{t[a.date].value>d.start&&t[a.date].value<d.end&&((u,z)=>{u in p&&(p[u][z].value+=
Number(t[a.amount].value||0)*("add"==a.operation?1:-1))})(a.criteria.map(u=>t[u].value).join("_"),g["month"+((new Date(t[a.date].value)).getMonth()+1).toString().padStart(2,"0")].value)})}kb.progressUpdate()});f++;f<g.source.value.length?n(f,k):k(p)}).catch(b=>kb.alert(kb.error.parse(b)))})({start:(d=>a.isDateTime?d.calc("-1 second").calc(kb.timezoneOffset()+" hour"):d.calc("-1 day"))(new Date(q+"-01-01")),end:(d=>a.isDateTime?d.calc("1 day").calc(kb.timezoneOffset()+" hour"):d.calc("1 day"))(new Date(q+
"-12-31"))})})(h.appInfos[g.source.value[f].value.app.value])};kb.progressStart(0,(()=>{var f="";switch(kb.operator.language){case "en":f="Registering carryover balance data.";break;case "ja":f="\u7e70\u308a\u8d8a\u3057\u6b8b\u30c7\u30fc\u30bf\u3092\u767b\u9332\u3057\u3066\u3044\u307e\u3059\u3002";break;case "zh":f="\u6b63\u5728\u767b\u8bb0\u7ed3\u8f6c\u4f59\u989d\u6570\u636e\u3002";break;case "zh-TW":f="\u6b63\u5728\u767b\u9304\u7d50\u8f49\u9918\u984d\u8cc7\u6599\u3002"}return f})());(f=>{kb.view.records.get(h.app.id,
g.year.value+"="+(parseInt(q)-1).toString()).then(k=>{kb.popups.progress.max=k.length;k.each((a,d)=>{(b=>{b in p&&(p[b][g.carryover.value]={value:x.reduce((c,m)=>c+Number(a[m].value||0),0)})})(g.criteria.value.map(b=>a[b.value.field.value].value).join("_"));kb.progressUpdate()});f(p)}).catch(k=>kb.alert(kb.error.parse(k)))})(f=>{n(0,k=>e(Object.values(k)))})};(p=>{var e=(f,k)=>{kb.view.records.get(h.app.id,g.year.value+"="+q).then(a=>{kb.popups.progress.max=a.length;a.each((d,b)=>{(c=>{c in f&&(f[c].$id=
{value:d.$id.value})})(g.criteria.value.map(c=>d[c.value.field.value].value).join("_"));kb.progressUpdate()});k(f)}).catch(a=>kb.alert(kb.error.parse(a)))},n=(f,k,a)=>{var d=()=>{kb.progressUpdate();f++;f<k.length?n(f,k,a):(kb.progressStart(0,(()=>{var b="";switch(kb.operator.language){case "en":b="Creating records for registration.";break;case "ja":b="\u767b\u9332\u7528\u30ec\u30b3\u30fc\u30c9\u3092\u4f5c\u6210\u3057\u3066\u3044\u307e\u3059\u3002";break;case "zh":b="\u6b63\u5728\u521b\u5efa\u7528\u4e8e\u6ce8\u518c\u7684\u8bb0\u5f55\u3002";
break;case "zh-TW":b="\u6b63\u5728\u5efa\u7acb\u7528\u65bc\u8a3b\u518a\u7684\u8a18\u9304\u3002"}return b})()),a(((b,c)=>{kb.popups.progress.max=c.length;return c.reduce((m,l)=>{m[l.join("_")]=(r=>{l.each((t,v)=>r[b[v]]={value:t});r[g.year.value]={value:q};x.each(t=>r[t]={value:0});return r})({});kb.progressUpdate();return m},{})})(k.map(b=>b.field),k.map(b=>b.values).reduce((b,c)=>{var m=[],l;for(l of b)for(var r of c)m.push([...l,r]);return m},[[]]))))};(b=>{(c=>{switch(c.type){case "DROP_DOWN":case "RADIO_BUTTON":b.values=
Object.values(c.options).reduce((m,l)=>{m[l.index]=l.label;return m},[]);d();break;case "NUMBER":case "SINGLE_LINE_TEXT":c.lookup?kb.view.records.get(c.lookup.relatedApp.app,c.lookup.filterCond,c.lookup.sort||"$id asc").then(m=>{b.values=Array.from(new Set(m.map(l=>l[c.lookup.relatedKeyField].value)));d()}).catch(m=>kb.alert(kb.error.parse(m))):kb.alert("No identifier field to monthlybalance was found")}})(h.fieldInfos.parallelize[b.field])})(k[f])};kb.progressStart(g.criteria.value.length,(()=>{var f=
"";switch(kb.operator.language){case "en":f="Downloading identifier field data.";break;case "ja":f="\u8b58\u5225\u30d5\u30a3\u30fc\u30eb\u30c9\u30c7\u30fc\u30bf\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u3044\u307e\u3059\u3002";break;case "zh":f="\u6b63\u5728\u4e0b\u8f7d\u8bc6\u522b\u5b57\u6bb5\u6570\u636e\u3002";break;case "zh-TW":f="\u6b63\u5728\u4e0b\u8f09\u8b58\u5225\u6b04\u4f4d\u8cc7\u6599\u3002"}return f})());n(0,g.criteria.value.map(f=>({field:f.value.field.value,values:[]})),f=>
{kb.progressStart(0,(()=>{var k="";switch(kb.operator.language){case "en":k="Checking registered records.";break;case "ja":k="\u767b\u9332\u6e08\u30ec\u30b3\u30fc\u30c9\u3092\u8abf\u3079\u3066\u3044\u307e\u3059\u3002";break;case "zh":k="\u6b63\u5728\u68c0\u67e5\u5df2\u6ce8\u518c\u7684\u8bb0\u5f55\u3002";break;case "zh-TW":k="\u6b63\u5728\u6aa2\u67e5\u5df2\u8a3b\u518a\u7684\u8a18\u9304\u3002"}return k})());e(f,k=>p(k))})})(p=>{w(p,e=>{B({records:{post:e.filter(n=>!("$id"in n)),put:e.reduce((n,f)=>
{"$id"in f&&n.push({id:f.$id.value,record:f});return n},[])}})})})});kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],g=>new Promise((q,B)=>{((C,x)=>{h.mobile=C;h.type=x;kb.config[y].config.get().then(w=>{0!=Object.keys(w).length?kb.field.load(kb.config[y].app,!0).then(p=>{h.app={id:kb.config[y].app,fields:p.origin};h.fieldInfos=p;try{(e=>{e?[...e.criteria.value.map(n=>n.value.field.value),e.year.value,e.month01.value,e.month02.value,e.month03.value,e.month04.value,e.month05.value,
e.month06.value,e.month07.value,e.month08.value,e.month09.value,e.month10.value,e.month11.value,e.month12.value,e.carryover.value].some(n=>!(n in p.parallelize))?(kb.alert("No field to monthlybalance was found"),q(g)):(e.source.value=e.source.value.map(n=>{n.value.fields.value=JSON.parse(n.value.fields.value);return n}),kb.filter.auth(e.user.value,e.organization.value,e.group.value).then(n=>{n&&(e.view.value&&e.view.value!=g.viewId.toString()||kb.apps.load().then(f=>{var k=(a,d)=>{(b=>{(c=>{c?kb.field.load(c.appId).then(m=>
{(l=>[...l.criteria.value.map(r=>r.value.field.value),l.date.value,l.amount.value])(b.value.fields.value).some(l=>!(l in m.parallelize))?(kb.alert("No field to monthlybalance was found"),q(g)):(h.appInfos[c.appId]={id:c.appId,name:c.name,fieldInfos:m,criteria:b.value.fields.value.criteria.value.map(l=>l.value.field.value),filter:b.value.fields.value.filter.value,date:b.value.fields.value.date.value,amount:b.value.fields.value.amount.value,operation:b.value.fields.value.operation.value,isDateTime:!1,
isTimeStamp:!1},(l=>{switch(l.type){case "CALC":switch(l.format){case "DATE":h.appInfos[c.appId].isDateTime=!1;break;case "DATETIME":h.appInfos[c.appId].isDateTime=!0}h.appInfos[c.appId].isTimeStamp=!0;break;case "DATE":h.appInfos[c.appId].isDateTime=!1;h.appInfos[c.appId].isTimeStamp=!1;break;case "DATETIME":h.appInfos[c.appId].isDateTime=!0;h.appInfos[c.appId].isTimeStamp=!1;break;default:h.appInfos[c.appId].isDateTime=!1,h.appInfos[c.appId].isTimeStamp=!1}})(m.parallelize[b.value.fields.value.date.value]),
a++,a<e.source.value.length?k(a,d):d())}).catch(m=>{kb.alert(kb.error.parse(m));q(g)}):(kb.alert("No app to monthlybalance was found"),q(g))})(f.find(c=>c.appId==b.value.app.value))})(e.source.value[a])};h.appInfos={};h.appInfos[h.app.id]={id:h.app.id,name:f.find(a=>a.appId==h.app.id).name,fieldInfos:p};k(0,()=>{(a=>{a.elm(".kb-monthlybalance-operation")||(d=>{a.addClass("kb-scope").attr("form-id","form_"+d.id).append(kb.create("div").addClass("kb-monthlybalance-operation"+(h.mobile?" kb-mobile":
"")).append(kb.field.activate(kb.field.create(d.fields.year).addClass("kb-year"),d)));kb.record.set(a,d,{year:{value:(new Date).getFullYear().toString()}})})({id:"MonthlyBalance",fields:{year:{code:"year",type:"DROP_DOWN",label:"",required:!1,noLabel:!0,options:(()=>{var d=[],b=(new Date).getFullYear()+9;(19).each(c=>{d.push({index:c,label:(b-c).toString()})});return d})()}}});kb.button.create(h.mobile,h.type,"kb-monthlybalance-button",e.label.value,e.message.value,()=>{D(e,a.elm(".kb-year").elm("select").val()).then(d=>
{kb.view.records.set(h.app.id,d.records,!0).then(b=>kb.alert("Done!",()=>window.location.reload(!0))).catch(b=>kb.alert(kb.error.parse(b)))}).catch(()=>{})})})(h.mobile?kintone.mobile.app.getHeaderSpaceElement():kintone.app.getHeaderMenuSpaceElement())})}));q(g)}).catch(n=>q(g))):q(g)})(JSON.parse(w.flat))}catch(e){kb.alert(kb.error.parse(e)),q(g)}}).catch(p=>q(g)):q(g)}).catch(w=>q(g))})("mobile"==g.type.split(".").first(),g.type.split(".").slice(-2).first())}))})(kintone.$PLUGIN_ID);
