/*
* FileName "plugins.upsert.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(N){var q={},M=function(h,v,y){y=void 0===y?!1:y;return new Promise(function(F,z){var I=function(C,m){var n=function(){C++;y||kb.progressStart(h.length);C<h.length?I(C,m):m()};(function(c){var f=kb.filter.scan(q.app,v,c.condition.value);f?kb.filter.auth(c.user.value,c.organization.value,c.group.value).then(function(A){A?kb.field.load(c.app.value).then(function(w){var D={id:c.app.value,fields:w.origin};(function(p){var G=[],K=[],P=[],H={},B=1,L=1,E=0,J=0,O=function(){var k=[],t={field:function(b,
d){var l=null;if(b.tableCode)if(f[b.tableCode].value.length>d)l=f[b.tableCode].value[d].value[b.code];else switch(b.type){case "CHECK_BOX":case "FILE":case "GROUP_SELECT":case "MULTI_SELECT":case "ORGANIZATION_SELECT":case "USER_SELECT":l={value:[]};break;case "RADIO_BUTTON":(function(a){l={value:0!=a.length?a.reduce(function(g,e){g[e.index]=e;return g},Array(a.length).fill("")).first().label:""}})(Object.values(b.options));break;default:l={value:""}}else l=f[b.code];return kb.extend({type:b.type},
l)},record:function(b){L.each(function(d){var l=function(a){var g=kb.filter.scan(D,b,a.query);if(!g&&"upsert"==c.pattern.value){for(var e in a.rows)0==kb.filter.result[e].value.length&&(b[e].value.push({value:kb.extend({},a.rows[e])}),kb.filter.result[e]={value:[b[e].value.last()]});g=kb.filter.result}return g}(function(){var a={rows:{},query:[]};J=d;G.each(function(g,e){g.external.tableCode&&(g.external.tableCode in a.rows||(a.rows[g.external.tableCode]=kb.record.create(D.fields[g.external.tableCode],
!1)),a.rows[g.external.tableCode][g.external.code]=r(g.external,t.field(g.internal,J)),a.query.push(kb.filter.query.create(g.external,g.operator,t.field(g.internal,J))))});K.each(function(g,e){g.field.tableCode&&a.query.push(g.field.code+" "+g.operator+" "+g.value)});a.query=a.query.join(" and ");return a}());l&&P.each(function(a,g){a.external.tableCode?a.external.tableCode in H?(b[a.external.tableCode]={value:H[a.external.tableCode]},H[a.external.tableCode].each(function(e,x){e.value[a.external.code]=
r(a.external,t.field(a.internal,x));"FILE"==a.external.type&&e.value[a.external.code].value&&Array.prototype.push.apply(k,e.value[a.external.code].value)})):l[a.external.tableCode].value.each(function(e,x){e.value[a.external.code]=r(a.external,t.field(a.internal,J));"FILE"==a.external.type&&e.value[a.external.code].value&&Array.prototype.push.apply(k,e.value[a.external.code].value)}):(b[a.external.code]=r(a.external,t.field(a.internal,E)),"FILE"==a.external.type&&b[a.external.code].value&&Array.prototype.push.apply(k,
b[a.external.code].value))})});return b}},r=function(b,d){return b.lookup?kb.extend({lookup:!0},d):d},u=function(b){b.each(function(d,l){c.formula.value.each(function(a,g){a.value.field.value in p.external&&function(e){e.tableCode?d[e.tableCode].value.each(function(x,Q){x.value[e.code].value=kb.formula.calculate(a.value,x.value,d,d,p.external);e.lookup&&(x.value[e.code].lookup=!0)}):(d[e.code].value=kb.formula.calculate(a.value,d,d,d,p.external),e.lookup&&(d[e.code].lookup=!0))}(p.external[a.value.field.value])})});
return b};"insert"==c.pattern.value?function(b){kb.file.clone(k,!0).then(function(){kb.view.records.set(c.app.value,{post:b},y).then(function(d){E++;E<B?O():n()})["catch"](function(d){kb.alert(kb.error.parse(d));z()})})}(u([t.record(kb.record.create(D))])):kb.view.records.get(c.app.value,function(){var b=[];G.each(function(d,l){d.external.tableCode||b.push(kb.filter.query.create(d.external,d.operator,t.field(d.internal,E)))});K.each(function(d,l){d.field.tableCode||b.push(d.field.code+" "+d.operator+
" "+d.value)});return b.join(" and ")}()).then(function(b){b=function(d){var l=[];0!=d.length?l=d.map(function(a){return t.record(a)}):"upsert"==c.pattern.value&&function(a){l.push(t.record(function(){var g=kb.record.create(D);a.each(function(e,x){e.external.tableCode?g[e.external.tableCode]={value:[]}:g[e.external.code]=r(e.external,t.field(e.internal,E))});return g}()))}(G.filter(function(a){return!kb.field.reserved.includes(a.external.type)}));return u(l)}(b);kb.file.clone(k,!0).then(function(){kb.view.records.set(c.app.value,
{post:b.filter(function(d){return!d.$id.value}),put:b.reduce(function(d,l){if(l.$id.value){var a=d.push,g=l.$id.value,e={},x;for(x in l)kb.field.reserved.includes(l[x].type)||(e[x]=l[x]);a.call(d,{id:g,record:e})}return d},[])},y).then(function(d){E++;E<B?O():n()})["catch"](function(d){kb.alert(kb.error.parse(d));z()})})})["catch"](function(b){kb.alert(kb.error.parse(b));z()})};c.mapping.value.some(function(k){return!(k.value.external.value in p.external&&k.value.internal.value in p.internal)})?(kb.alert("No field to transfer was found"),
z()):c.criteria.value.some(function(k){return!(k.value.external.value in p.external&&k.value.internal.value in p.internal)})?(kb.alert("No field to transfer was found"),z()):(c.mapping.value.each(function(k,t){(function(r,u){r.tableCode?H[r.tableCode]=function(b){b=b?b.length:1;u.tableCode&&(b=b<f[u.tableCode].value.length?f[u.tableCode].value.length:b);return Array(b).fill().map(function(){return{value:kb.record.create(D.fields[r.tableCode],!1)}})}(H[r.tableCode]):u.tableCode&&(B=0==f[u.tableCode].value.length?
0:B<f[u.tableCode].value.length?f[u.tableCode].value.length:B);P.push({external:r,internal:u})})(p.external[k.value.external.value],p.internal[k.value.internal.value])}),c.criteria.value.each(function(k,t){var r=p.external[k.value.external.value],u=k.value.operator.value,b=p.internal[k.value.internal.value];r.tableCode?(r.tableCode in H&&delete H[r.tableCode],b.tableCode&&(L=L<f[b.tableCode].value.length?f[b.tableCode].value.length:L)):b.tableCode&&(B=0==f[b.tableCode].value.length?0:B<f[b.tableCode].value.length?
f[b.tableCode].value.length:B);G.push({external:r,operator:u,internal:b})}),kb.filter.query.parse(c.filter.value).each(function(k,t){K.push({field:p.external[k.field],operator:k.operator,value:k.value})}),0!=B?(J=E=0,O()):n())})({external:w.parallelize,internal:q.fieldInfos.parallelize})})["catch"](function(w){kb.alert(kb.error.parse(w));z()}):n()})["catch"](function(A){kb.alert(kb.error.parse(A));z()}):n()})(h[C])};y||kb.progressStart(h.length);I(0,function(){y||kb.progressEnd();F()})})};kintone.events.on("app.record.create.submit.success app.record.detail.process.proceed app.record.detail.show app.record.edit.submit.success app.record.index.show mobile.app.record.create.submit.success mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.submit.success mobile.app.record.index.show".split(" "),
function(h){return new Promise(function(v,y){(function(F,z){q.mobile=F;q.type=z;kb.config[N].config.get().then(function(I){0!=Object.keys(I).length?kb.field.load(kb.config[N].app,!0).then(function(C){q.app={id:kb.config[N].app,fields:C.origin};q.fieldInfos=C;try{(function(m){if(0!=m.length)switch(q.type){case "create":case "edit":M(m,h.record).then(function(c){return v(h)})["catch"](function(){});break;case "process":(function(c){0!=c.length?M(c,h.record).then(function(f){return v(h)})["catch"](function(){}):
v(h)})(m.filter(function(c){return c.action.value==h.action.value+":"+h.status.value+":"+h.nextStatus.value}));break;case "detail":var n=function(c){(function(f){kb.filter.scan(q.app,h.record,f.condition.value)?kb.filter.auth(f.user.value,f.organization.value,f.group.value).then(function(A){A&&kb.button.create(q.mobile,q.type,"kb-upsert-button"+c.toString(),f.label.value,f.message.value,function(){return M([f],h.record).then(function(w){return kb.alert("Done!")})["catch"](function(){})});c++;c<m.length&&
n(c)})["catch"](function(A){c++;c<m.length&&n(c)}):(c++,c<m.length&&n(c))})(m[c])};n(0);v(h);break;case "index":n=function(c){(function(f){kb.filter.auth(f.user.value,f.organization.value,f.group.value).then(function(A){A&&(f.view.value&&f.view.value!=h.viewId.toString()||kb.button.create(q.mobile,q.type,"kb-upsert-button"+c.toString(),f.label.value,f.message.value,function(){kb.view.records.get(q.app.id,(q.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(function(w){var D=function(p,
G){M([f],w[p],!0).then(function(K){kb.progressUpdate();p++;p<w.length?D(p,G):G()})["catch"](function(){})};0!=w.length?(kb.progressStart(w.length),D(0,function(){return kb.alert("Done!")})):kb.alert("There are no records.")})["catch"](function(w){return kb.alert(kb.error.parse(w))})}));c++;c<m.length&&n(c)})["catch"](function(A){c++;c<m.length&&n(c)})})(m[c])},n(0),v(h)}else v(h)})(JSON.parse(I.tab).reduce(function(m,n){(q.mobile?["both","mobile"]:["both","pc"]).includes(n.setting.device.value)&&
n.setting.event.value.includes(q.type)&&m.push(n.setting);return m},[]))}catch(m){kb.alert(kb.error.parse(m)),v(h)}})["catch"](function(C){return v(h)}):v(h)})["catch"](function(I){return v(h)})})("mobile"==h.type.split(".").first(),function(F){switch(F){case "submit":F=h.type.split(".").slice(-3).first()}return F}(h.type.split(".").slice(-2).first()))})})})(kintone.$PLUGIN_ID);