/*
* FileName "plugins.upsert.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(M){var m={},L=function(g,w,z){z=void 0===z?!1:z;return new Promise(function(F,A){var H=function(C,n){var r=function(){C++;z||kb.progressStart(g.length);C<g.length?H(C,n):n()};(function(c){var h=kb.filter.scan(m.app,w,c.condition.value);h?kb.filter.auth(c.user.value,c.organization.value,c.group.value).then(function(t){t?kb.field.load(c.app.value).then(function(D){var y={id:c.app.value,fields:D.origin};(function(p){var I=[],N=[],P=[],G={},B=1,K=1,E=0,J=0,O=function(){var k=[],u={field:function(b,
d){var l=null;if(b.tableCode)if(h[b.tableCode].value.length>d)l=h[b.tableCode].value[d].value[b.code];else switch(b.type){case "CHECK_BOX":case "FILE":case "GROUP_SELECT":case "MULTI_SELECT":case "ORGANIZATION_SELECT":case "USER_SELECT":l={value:[]};break;case "RADIO_BUTTON":(function(a){l={value:0!=a.length?a.reduce(function(f,e){f[e.index]=e;return f},Array(a.length).fill("")).first().label:""}})(Object.values(b.options));break;default:l={value:""}}else l=h[b.code];return kb.extend({type:b.type},
l)},record:function(b){K.each(function(d){var l=function(a){var f=kb.filter.scan(y,b,a.query);if(!f&&"upsert"==c.pattern.value){for(var e in a.rows)0==kb.filter.result[e].value.length&&(b[e].value.push({value:kb.extend({},a.rows[e])}),kb.filter.result[e]={value:[b[e].value.last()]});f=kb.filter.result}return f}(function(){var a={rows:{},query:[]};J=d;I.each(function(f,e){f.external.tableCode&&(f.external.tableCode in a.rows||(a.rows[f.external.tableCode]=kb.record.create(y.fields[f.external.tableCode],
!1)),a.rows[f.external.tableCode][f.external.code]=q(f.external,u.field(f.internal,J)),a.query.push(kb.filter.query.create(f.external,f.operator,u.field(f.internal,J))))});N.each(function(f,e){f.field.tableCode&&a.query.push(f.field.code+" "+f.operator+" "+f.value)});a.query=a.query.join(" and ");return a}());l&&P.each(function(a,f){a.external.tableCode?a.external.tableCode in G?(b[a.external.tableCode]={value:G[a.external.tableCode]},G[a.external.tableCode].each(function(e,x){e.value[a.external.code]=
q(a.external,u.field(a.internal,x));"FILE"==a.external.type&&e.value[a.external.code].value&&Array.prototype.push.apply(k,e.value[a.external.code].value)})):l[a.external.tableCode].value.each(function(e,x){e.value[a.external.code]=q(a.external,u.field(a.internal,J));"FILE"==a.external.type&&e.value[a.external.code].value&&Array.prototype.push.apply(k,e.value[a.external.code].value)}):(b[a.external.code]=q(a.external,u.field(a.internal,E)),"FILE"==a.external.type&&b[a.external.code].value&&Array.prototype.push.apply(k,
b[a.external.code].value))})});return b}},q=function(b,d){return b.lookup?kb.extend({lookup:!0},d):d},v=function(b){b.each(function(d,l){c.formula.value.each(function(a,f){a.value.field.value in p.external&&function(e){e.tableCode?d[e.tableCode].value.each(function(x,Q){x.value[e.code].value=kb.formula.calculate(a.value,x.value,d,d,p.external);e.lookup&&(x.value[e.code].lookup=!0)}):(d[e.code].value=kb.formula.calculate(a.value,d,d,d,p.external),e.lookup&&(d[e.code].lookup=!0))}(p.external[a.value.field.value])})});
return b};"insert"==c.pattern.value?function(b){kb.file.clone(k,!0).then(function(){kb.view.records.set(c.app.value,{post:b},z).then(function(d){E++;E<B?O():r()})["catch"](function(d){kb.alert(kb.error.parse(d));A()})})}(v([u.record(kb.record.create(y))])):kb.view.records.get(c.app.value,function(){var b=[];I.each(function(d,l){d.external.tableCode||b.push(kb.filter.query.create(d.external,d.operator,u.field(d.internal,E)))});N.each(function(d,l){d.field.tableCode||b.push(d.field.code+" "+d.operator+
" "+d.value)});return b.join(" and ")}()).then(function(b){b=function(d){var l=[];0!=d.length?l=d.map(function(a){return u.record(a)}):"upsert"==c.pattern.value&&function(a){l.push(u.record(function(){var f=kb.record.create(y);a.each(function(e,x){e.external.tableCode?f[e.external.tableCode]={value:[]}:f[e.external.code]=q(e.external,u.field(e.internal,E))});return f}()))}(I.filter(function(a){return!kb.field.reserved.includes(a.external.type)}));return v(l)}(b);kb.file.clone(k,!0).then(function(){kb.view.records.set(c.app.value,
{post:b.filter(function(d){return!d.$id.value}),put:b.reduce(function(d,l){if(l.$id.value){var a=d.push,f=l.$id.value,e={},x;for(x in l)kb.field.reserved.includes(l[x].type)||(e[x]=l[x]);a.call(d,{id:f,record:e})}return d},[])},z).then(function(d){E++;E<B?O():r()})["catch"](function(d){kb.alert(kb.error.parse(d));A()})})})["catch"](function(b){kb.alert(kb.error.parse(b));A()})};c.mapping.value.some(function(k){return!(k.value.external.value in p.external&&k.value.internal.value in p.internal)})?(kb.alert("No field to transfer was found"),
A()):c.criteria.value.some(function(k){return!(k.value.external.value in p.external&&k.value.internal.value in p.internal)})?(kb.alert("No field to transfer was found"),A()):(c.mapping.value.each(function(k,u){(function(q,v){q.tableCode?G[q.tableCode]=function(b){b=b?b.length:1;v.tableCode&&(b=b<h[v.tableCode].value.length?h[v.tableCode].value.length:b);return Array(b).fill().map(function(){return{value:kb.record.create(y.fields[q.tableCode],!1)}})}(G[q.tableCode]):v.tableCode&&(B=0==h[v.tableCode].value.length?
0:B<h[v.tableCode].value.length?h[v.tableCode].value.length:B);P.push({external:q,internal:v})})(p.external[k.value.external.value],p.internal[k.value.internal.value])}),c.criteria.value.each(function(k,u){var q=p.external[k.value.external.value],v=k.value.operator.value,b=p.internal[k.value.internal.value];q.tableCode?(q.tableCode in G&&delete G[q.tableCode],b.tableCode&&(K=K<h[b.tableCode].value.length?h[b.tableCode].value.length:K)):b.tableCode&&(B=0==h[b.tableCode].value.length?0:B<h[b.tableCode].value.length?
h[b.tableCode].value.length:B);I.push({external:q,operator:v,internal:b})}),kb.filter.query.parse(c.filter.value).each(function(k,u){N.push({field:p.external[k.field],operator:k.operator,value:k.value})}),0!=B?(J=E=0,O()):r())})({external:D.parallelize,internal:m.fieldInfos.parallelize})})["catch"](function(D){kb.alert(kb.error.parse(D));A()}):r()})["catch"](function(t){kb.alert(kb.error.parse(t));A()}):r()})(g[C])};z||kb.progressStart(g.length);H(0,function(){z||kb.progressEnd();F()})})};kintone.events.on("app.record.create.submit.success app.record.detail.process.proceed app.record.detail.show app.record.edit.submit.success app.record.index.show mobile.app.record.create.submit.success mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.submit.success mobile.app.record.index.show".split(" "),
function(g){return new Promise(function(w,z){(function(F,A){m.mobile=F;m.type=A;kb.config[M].config.get().then(function(H){0!=Object.keys(H).length?kb.field.load(kb.config[M].app,!0).then(function(C){m.app={id:kb.config[M].app,fields:C.origin};m.fieldInfos=C;try{(function(n){if(0!=n.length)switch(m.type){case "create":case "edit":L(n,g.record).then(function(c){return w(g)})["catch"](function(){});break;case "process":(function(c){0!=c.length?L(c,g.record).then(function(h){return w(g)})["catch"](function(){}):
w(g)})(n.filter(function(c){return c.action.value==g.action.value+":"+g.status.value+":"+g.nextStatus.value}));break;case "detail":var r=function(c){(function(h){kb.filter.scan(m.app,g.record,h.condition.value)?kb.filter.auth(h.user.value,h.organization.value,h.group.value).then(function(t){t&&kb.button.create(m.mobile,m.type,"kb-upsert-button"+c.toString(),h.label.value,h.message.value,function(){return L([h],g.record).then(function(D){return kb.alert("Done!")})["catch"](function(){})});c++;c<n.length&&
r(c)})["catch"](function(t){c++;c<n.length&&r(c)}):(c++,c<n.length&&r(c))})(n[c])};r(0);w(g);break;case "index":n.each(function(c,h){c.view.value&&c.view.value!=g.viewId.toString()||kb.button.create(m.mobile,m.type,"kb-upsert-button"+h.toString(),c.label.value,c.message.value,function(){kb.view.records.get(m.app.id,(m.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(function(t){var D=function(y,p){L([c],t[y],!0).then(function(I){kb.progressUpdate();y++;y<t.length?D(y,p):p()})["catch"](function(){})};
0!=t.length?(kb.progressStart(t.length),D(0,function(){return kb.alert("Done!")})):kb.alert("There are no records.")})["catch"](function(t){return kb.alert(kb.error.parse(t))})})}),w(g)}else w(g)})(JSON.parse(H.tab).reduce(function(n,r){(m.mobile?["both","mobile"]:["both","pc"]).includes(r.setting.device.value)&&r.setting.event.value.includes(m.type)&&n.push(r.setting);return n},[]))}catch(n){kb.alert(kb.error.parse(n)),w(g)}})["catch"](function(C){return w(g)}):w(g)})["catch"](function(H){return w(g)})})("mobile"==
g.type.split(".").first(),function(F){switch(F){case "submit":F=g.type.split(".").slice(-3).first()}return F}(g.type.split(".").slice(-2).first()))})})})(kintone.$PLUGIN_ID);