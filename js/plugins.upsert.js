/*
* FileName "plugins.upsert.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(M){var p={},L=function(f,v,x){x=void 0===x?!1:x;return new Promise(function(E,y){var G=function(B,r){var g=function(){B++;x||kb.progressStart(f.length);B<f.length?G(B,r):r()};(function(h){var k=kb.filter.scan(p.app,v,h.condition.value);k?kb.filter.auth(h.user.value,h.organization.value,h.group.value).then(function(H){H?kb.field.load(h.app.value).then(function(z){var C={id:h.app.value,fields:z.origin};(function(q){var J=[],N=[],P=[],F={},A=1,K=1,D=0,I=0,O=function(){var l=[],t={field:function(b,
c){var m=null;if(b.tableCode)if(k[b.tableCode].value.length>c)m=k[b.tableCode].value[c].value[b.code];else switch(b.type){case "CHECK_BOX":case "FILE":case "GROUP_SELECT":case "MULTI_SELECT":case "ORGANIZATION_SELECT":case "USER_SELECT":m={value:[]};break;case "RADIO_BUTTON":(function(a){m={value:0!=a.length?a.reduce(function(e,d){e[d.index]=d;return e},Array(a.length).fill("")).first().label:""}})(Object.values(b.options));break;default:m={value:""}}else m=k[b.code];return kb.extend({type:b.type},
m)},record:function(b){K.each(function(c){var m=function(a){var e=kb.filter.scan(C,b,a.query);if(!e&&"upsert"==h.pattern.value){for(var d in a.rows)0==kb.filter.result[d].value.length&&(b[d].value.push({value:kb.extend({},a.rows[d])}),kb.filter.result[d]={value:[b[d].value.last()]});e=kb.filter.result}return e}(function(){var a={rows:{},query:[]};I=c;J.each(function(e,d){e.external.tableCode&&(e.external.tableCode in a.rows||(a.rows[e.external.tableCode]=kb.record.create(C.fields[e.external.tableCode],
!1)),a.rows[e.external.tableCode][e.external.code]=n(e.external,t.field(e.internal,I)),a.query.push(kb.filter.query.create(e.external,e.operator,t.field(e.internal,I))))});N.each(function(e,d){e.field.tableCode&&a.query.push(e.field.code+" "+e.operator+" "+e.value)});a.query=a.query.join(" and ");return a}());m&&P.each(function(a,e){a.external.tableCode?a.external.tableCode in F?(b[a.external.tableCode]={value:F[a.external.tableCode]},F[a.external.tableCode].each(function(d,w){d.value[a.external.code]=
n(a.external,t.field(a.internal,w));"FILE"==a.external.type&&d.value[a.external.code].value&&Array.prototype.push.apply(l,d.value[a.external.code].value)})):m[a.external.tableCode].value.each(function(d,w){d.value[a.external.code]=n(a.external,t.field(a.internal,I));"FILE"==a.external.type&&d.value[a.external.code].value&&Array.prototype.push.apply(l,d.value[a.external.code].value)}):(b[a.external.code]=n(a.external,t.field(a.internal,D)),"FILE"==a.external.type&&b[a.external.code].value&&Array.prototype.push.apply(l,
b[a.external.code].value))})});return b}},n=function(b,c){return b.lookup?kb.extend({lookup:!0},c):c},u=function(b){b.each(function(c,m){h.formula.value.each(function(a,e){a.value.field.value in q.external&&function(d){d.tableCode?c[d.tableCode].value.each(function(w,Q){w.value[d.code].value=kb.formula.calculate(a.value,w.value,c,c,q.external);d.lookup&&(w.value[d.code].lookup=!0)}):(c[d.code].value=kb.formula.calculate(a.value,c,c,c,q.external),d.lookup&&(c[d.code].lookup=!0))}(q.external[a.value.field.value])})});
return b};"insert"==h.pattern.value?function(b){kb.file.clone(l,!0).then(function(){kb.view.records.set(h.app.value,{post:b},x).then(function(c){D++;D<A?O():g()})["catch"](function(c){kb.alert(kb.error.parse(c));y()})})}(u([t.record(kb.record.create(C))])):kb.view.records.get(h.app.value,function(){var b=[];J.each(function(c,m){c.external.tableCode||b.push(kb.filter.query.create(c.external,c.operator,t.field(c.internal,D)))});N.each(function(c,m){c.field.tableCode||b.push(c.field.code+" "+c.operator+
" "+c.value)});return b.join(" and ")}()).then(function(b){b=function(c){var m=[];0!=c.length?m=c.map(function(a){return t.record(a)}):"upsert"==h.pattern.value&&function(a){m.push(t.record(function(){var e=kb.record.create(C);a.each(function(d,w){d.external.tableCode?e[d.external.tableCode]={value:[]}:e[d.external.code]=n(d.external,t.field(d.internal,D))});return e}()))}(J.filter(function(a){return!kb.field.reserved.includes(a.external.type)}));return u(m)}(b);kb.file.clone(l,!0).then(function(){kb.view.records.set(h.app.value,
{post:b.filter(function(c){return!c.$id.value}),put:b.reduce(function(c,m){if(m.$id.value){var a=c.push,e=m.$id.value,d={},w;for(w in m)kb.field.reserved.includes(m[w].type)||(d[w]=m[w]);a.call(c,{id:e,record:d})}return c},[])},x).then(function(c){D++;D<A?O():g()})["catch"](function(c){kb.alert(kb.error.parse(c));y()})})})["catch"](function(b){kb.alert(kb.error.parse(b));y()})};h.mapping.value.some(function(l){return!(l.value.external.value in q.external&&l.value.internal.value in q.internal)})?(kb.alert("No field to transfer was found"),
y()):h.criteria.value.some(function(l){return!(l.value.external.value in q.external&&l.value.internal.value in q.internal)})?(kb.alert("No field to transfer was found"),y()):(h.mapping.value.each(function(l,t){(function(n,u){n.tableCode?F[n.tableCode]=function(b){b=b?b.length:1;u.tableCode&&(b=b<k[u.tableCode].value.length?k[u.tableCode].value.length:b);return Array(b).fill().map(function(){return{value:kb.record.create(C.fields[n.tableCode],!1)}})}(F[n.tableCode]):u.tableCode&&(A=0==k[u.tableCode].value.length?
0:A<k[u.tableCode].value.length?k[u.tableCode].value.length:A);P.push({external:n,internal:u})})(q.external[l.value.external.value],q.internal[l.value.internal.value])}),h.criteria.value.each(function(l,t){var n=q.external[l.value.external.value],u=l.value.operator.value,b=q.internal[l.value.internal.value];n.tableCode?(n.tableCode in F&&delete F[n.tableCode],b.tableCode&&(K=K<k[b.tableCode].value.length?k[b.tableCode].value.length:K)):b.tableCode&&(A=0==k[b.tableCode].value.length?0:A<k[b.tableCode].value.length?
k[b.tableCode].value.length:A);J.push({external:n,operator:u,internal:b})}),kb.filter.query.parse(h.filter.value).each(function(l,t){N.push({field:q.external[l.field],operator:l.operator,value:l.value})}),0!=A?(I=D=0,O()):g())})({external:z.parallelize,internal:p.fieldInfos.parallelize})})["catch"](function(z){kb.alert(kb.error.parse(z));y()}):g()})["catch"](function(H){kb.alert(kb.error.parse(H));y()}):g()})(f[B])};x||kb.progressStart(f.length);G(0,function(){x||kb.progressEnd();E()})})};kintone.events.on("app.record.create.submit.success app.record.detail.process.proceed app.record.detail.show app.record.edit.submit.success app.record.index.show mobile.app.record.create.submit.success mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.submit.success mobile.app.record.index.show".split(" "),
function(f){return new Promise(function(v,x){(function(E,y){p.mobile=E;p.type=y;kb.config[M].config.get().then(function(G){0!=Object.keys(G).length?kb.field.load(kb.config[M].app,!0).then(function(B){p.app={id:kb.config[M].app,fields:B.origin};p.fieldInfos=B;try{(function(r){if(0!=r.length)switch(p.type){case "create":case "edit":L(r,f.record).then(function(g){return v(f)})["catch"](function(){});break;case "process":(function(g){0!=g.length?L(g,f.record).then(function(h){return v(f)})["catch"](function(){}):
v(f)})(r.filter(function(g){return g.action.value==f.action.value+":"+f.status.value+":"+f.nextStatus.value}));break;case "detail":r.each(function(g,h){kb.button.create(p.mobile,p.type,"kb-upsert-button"+h.toString(),g.label.value,g.message.value,function(){return L([g],f.record).then(function(k){return kb.alert("Done!")})["catch"](function(){})})});v(f);break;case "index":r.each(function(g,h){g.view.value&&g.view.value!=f.viewId.toString()||kb.button.create(p.mobile,p.type,"kb-upsert-button"+h.toString(),
g.label.value,g.message.value,function(){kb.view.records.get(p.app.id,(p.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(function(k){var H=function(z,C){L([g],k[z],!0).then(function(q){kb.progressUpdate();z++;z<k.length?H(z,C):C()})["catch"](function(){})};0!=k.length?(kb.progressStart(k.length),H(0,function(){return kb.alert("Done!")})):kb.alert("There are no records.")})["catch"](function(k){return kb.alert(kb.error.parse(k))})})}),v(f)}else v(f)})(JSON.parse(G.tab).reduce(function(r,
g){(p.mobile?["both","mobile"]:["both","pc"]).includes(g.setting.device.value)&&g.setting.event.value.includes(p.type)&&r.push(g.setting);return r},[]))}catch(r){kb.alert(kb.error.parse(r)),v(f)}})["catch"](function(B){return v(f)}):v(f)})["catch"](function(G){return v(f)})})("mobile"==f.type.split(".").first(),function(E){switch(E){case "submit":E=f.type.split(".").slice(-3).first()}return E}(f.type.split(".").slice(-2).first()))})})})(kintone.$PLUGIN_ID);