/*
* FileName "plugins.upsert.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(I=>{var p={},L=(e,l,J=!1)=>new Promise((z,v)=>{var t=(u,m)=>{var n=()=>{u++;u<e.length?t(u,m):m()};(c=>{var f=kb.filter.scan(p.app,l,c.condition.value);f?kb.filter.auth(c.user.value,c.organization.value,c.group.value).then(B=>{B?kb.field.load(c.app.value).then(x=>{var D={id:c.app.value,fields:x.origin};(q=>{var F=[],M=[],P=[],G={},C=1,N=1,E=0,K=0,O=()=>{var g=[],r={field:(d,b)=>{b=d.tableCode?f[d.tableCode].value.length>b?f[d.tableCode].value[b].value[d.code]:kb.record.create({fields:{empty:mapping.internal}}).empty:
f[d.code];return kb.extend({type:d.type},b)},record:d=>{N.each(b=>{var y=(a=>{var k=kb.filter.scan(D,d,a.query);if(!k&&"upsert"==c.pattern.value){for(var h in a.rows)0==kb.filter.result[h].value.length&&(d[h].value.push({value:kb.extend({},a.rows[h])}),kb.filter.result[h]={value:[d[h].value.last()]});k=kb.filter.result}return k})((()=>{var a={rows:{},query:[]};K=b;F.each((k,h)=>{k.external.tableCode&&(k.external.tableCode in a.rows||(a.rows[k.external.tableCode]=kb.record.create(D.fields[k.external.tableCode],
!1)),a.rows[k.external.tableCode][k.external.code]=w(k.external,r.field(k.internal,K)),a.query.push(kb.filter.query.create(k.external,k.operator,r.field(k.internal,K))))});M.each((k,h)=>{k.field.tableCode&&a.query.push(k.field.code+" "+k.operator+" "+k.value)});a.query=a.query.join(" and ");return a})());y&&P.each((a,k)=>{a.external.tableCode?a.external.tableCode in G?(d[a.external.tableCode]={value:G[a.external.tableCode]},G[a.external.tableCode].each((h,H)=>{h.value[a.external.code]=w(a.external,
r.field(a.internal,H));"FILE"==a.external.type&&h.value[a.external.code].value&&Array.prototype.push.apply(g,h.value[a.external.code].value)})):y[a.external.tableCode].value.each((h,H)=>{h.value[a.external.code]=w(a.external,r.field(a.internal,K));"FILE"==a.external.type&&h.value[a.external.code].value&&Array.prototype.push.apply(g,h.value[a.external.code].value)}):(d[a.external.code]=w(a.external,r.field(a.internal,E)),"FILE"==a.external.type&&d[a.external.code].value&&Array.prototype.push.apply(g,
d[a.external.code].value))})});return d}},w=(d,b)=>{switch(d.type){case "CHECK_BOX":case "FILE":case "GROUP_SELECT":case "MULTI_SELECT":case "ORGANIZATION_SELECT":case "USER_SELECT":Array.isArray(b.value)||(b.value=[b.value])}b.type=d.type;return d.lookup?kb.extend({lookup:!0},b):b},A=d=>{d.each((b,y)=>{c.formula.value.each((a,k)=>{a.value.field.value in q.external&&(h=>{h.tableCode?b[h.tableCode].value.each((H,Q)=>{H.value[h.code].value=kb.formula.calculate(a.value,H.value,b,b,q.external);h.lookup&&
(H.value[h.code].lookup=!0)}):(b[h.code].value=kb.formula.calculate(a.value,b,b,b,q.external),h.lookup&&(b[h.code].lookup=!0))})(q.external[a.value.field.value])})});return d};"insert"==c.pattern.value?(d=>{kb.file.clone(g,!0).then(()=>{kb.view.records.set(c.app.value,{post:d},J).then(b=>{E++;E<C?O():n()}).catch(b=>{kb.alert(kb.error.parse(b));v()})})})(A([r.record(kb.record.create(D))])):kb.view.records.get(c.app.value,(()=>{var d=[];F.each((b,y)=>{b.external.tableCode||d.push(kb.filter.query.create(b.external,
b.operator,r.field(b.internal,E)))});M.each((b,y)=>{b.field.tableCode||d.push(b.field.code+" "+b.operator+" "+b.value)});return d.join(" and ")})()).then(d=>{d=(b=>{var y=[];0!=b.length?y=b.map(a=>r.record(a)):"upsert"==c.pattern.value&&(a=>{y.push(r.record((()=>{var k=kb.record.create(D);a.each((h,H)=>{h.external.tableCode?k[h.external.tableCode]={value:[]}:k[h.external.code]=w(h.external,r.field(h.internal,E))});return k})()))})(F.filter(a=>!kb.field.reserved.includes(a.external.type)));return A(y)})(d);
kb.file.clone(g,!0).then(()=>{kb.view.records.set(c.app.value,{post:d.filter(b=>!b.$id.value),put:d.reduce((b,y)=>{y.$id.value&&b.push(kb.view.records.transform(y));return b},[])},J).then(b=>{E++;E<C?O():n()}).catch(b=>{kb.alert(kb.error.parse(b));v()})})}).catch(d=>{kb.alert(kb.error.parse(d));v()})};c.mapping.value.some(g=>!(g.value.external.value in q.external&&g.value.internal.value in q.internal))?(kb.alert("No field to transfer was found"),v()):c.criteria.value.some(g=>!(g.value.external.value in
q.external&&g.value.internal.value in q.internal))?(kb.alert("No field to transfer was found"),v()):(c.mapping.value.each((g,r)=>{((w,A)=>{w.tableCode?G[w.tableCode]=(d=>{d=d?d.length:1;A.tableCode&&(d=d<f[A.tableCode].value.length?f[A.tableCode].value.length:d);return Array(d).fill().map(()=>({value:kb.record.create(D.fields[w.tableCode],!1)}))})(G[w.tableCode]):A.tableCode&&(C=0==f[A.tableCode].value.length?0:C<f[A.tableCode].value.length?f[A.tableCode].value.length:C);P.push({external:w,internal:A})})(q.external[g.value.external.value],
q.internal[g.value.internal.value])}),c.criteria.value.each((g,r)=>{r=q.external[g.value.external.value];var w=g.value.operator.value;g=q.internal[g.value.internal.value];r.tableCode?(r.tableCode in G&&delete G[r.tableCode],g.tableCode&&(N=N<f[g.tableCode].value.length?f[g.tableCode].value.length:N)):g.tableCode&&(C=0==f[g.tableCode].value.length?0:C<f[g.tableCode].value.length?f[g.tableCode].value.length:C);F.push({external:r,operator:w,internal:g})}),kb.filter.query.parse(c.filter.value).each((g,
r)=>{M.push({field:q.external[g.field],operator:g.operator,value:g.value})}),0!=C?(K=E=0,O()):n())})({external:x.parallelize,internal:p.fieldInfos.parallelize})}).catch(x=>{kb.alert(kb.error.parse(x));v()}):n()}).catch(B=>{kb.alert(kb.error.parse(B));v()}):n()})(e[u])};J||kb.loadStart();t(0,()=>{J||kb.loadEnd();z()})});kintone.events.on("app.record.create.submit.success app.record.detail.process.proceed app.record.detail.show app.record.edit.submit.success app.record.index.show mobile.app.record.create.submit.success mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.submit.success mobile.app.record.index.show".split(" "),
e=>new Promise((l,J)=>{((z,v)=>{p.mobile=z;p.type=v;kb.config[I].config.get().then(t=>{0!=Object.keys(t).length?kb.field.load(kb.config[I].app,!0).then(u=>{p.app={id:kb.config[I].app,fields:u.origin};p.fieldInfos=u;try{(m=>{if(0!=m.length)switch(p.type){case "create":case "edit":L(m,e.record).then(c=>l(e)).catch(()=>{});break;case "process":(c=>{0!=c.length?L(c,e.record).then(f=>l(e)).catch(()=>{}):l(e)})(m.filter(c=>c.action.value==e.action.value+":"+e.status.value+":"+e.nextStatus.value));break;
case "detail":var n=c=>{(f=>{kb.filter.scan(p.app,e.record,f.condition.value)?kb.filter.auth(f.user.value,f.organization.value,f.group.value).then(B=>{B&&kb.button.create(p.mobile,p.type,"kb-upsert-button"+c.toString(),f.label.value,f.message.value,()=>L([f],e.record).then(x=>kb.alert("Done!")).catch(()=>{}));c++;c<m.length&&n(c)}).catch(B=>{c++;c<m.length&&n(c)}):(c++,c<m.length&&n(c))})(m[c])};n(0);l(e);break;case "index":n=c=>{(f=>{kb.filter.auth(f.user.value,f.organization.value,f.group.value).then(B=>
{B&&(f.view.value&&f.view.value!=e.viewId.toString()||kb.button.create(p.mobile,p.type,"kb-upsert-button"+c.toString(),f.label.value,f.message.value,()=>{kb.view.records.get(p.app.id,(p.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(x=>{let D=(q,F)=>{L([f],x[q],!0).then(M=>{kb.progressUpdate();q++;q<x.length?D(q,F):F()}).catch(()=>{})};0!=x.length?(kb.progressStart(x.length),D(0,()=>kb.alert("Done!"))):kb.alert("There are no records.")}).catch(x=>kb.alert(kb.error.parse(x)))}));
c++;c<m.length&&n(c)}).catch(B=>{c++;c<m.length&&n(c)})})(m[c])},n(0),l(e)}else l(e)})(JSON.parse(t.tab).map((m,n)=>kb.extend({sIndex:{value:n.toString()}},m.setting)).reduce((m,n)=>{(p.mobile?["all","both","mobile"]:["all","both","pc"]).includes(n.device.value)&&n.event.value.includes(p.type)&&m.push(n);return m},[]))}catch(m){kb.alert(kb.error.parse(m)),l(e)}}).catch(u=>l(e)):l(e)}).catch(t=>l(e))})("mobile"==e.type.split(".").first(),(z=>{switch(z){case "submit":z=e.type.split(".").slice(-3).first()}return z})(e.type.split(".").slice(-2).first()))}));
kb.event.on("kb.upsert.call",e=>new Promise((l,J)=>{kb.config[I].config.get().then(z=>{0!=Object.keys(z).length?kb.field.load(kb.config[I].app,!0).then(v=>{p.app={id:kb.config[I].app,fields:v.origin};p.fieldInfos=v;try{(t=>{0!=t.length?L(t,e.record,!0).then(u=>l(e)).catch(()=>l(e)):l(e)})(JSON.parse(z.tab).map((t,u)=>kb.extend({sIndex:{value:u.toString()}},t.setting)).reduce((t,u)=>{(e.mobile?["all","both","mobile"]:["all","both","pc"]).includes(u.device.value)&&u.event.value.includes(e.pattern)&&
t.push(u);return t},[]))}catch(t){kb.alert(kb.error.parse(t)),l(e)}}).catch(v=>l(e)):l(e)}).catch(z=>l(e))}))})(kintone.$PLUGIN_ID);