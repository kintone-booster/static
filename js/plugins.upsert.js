/*
* FileName "plugins.upsert.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(N){var q={},M=function(h,v,x){x=void 0===x?!1:x;return new Promise(function(E,y){var I=function(B,m){var n=function(){B++;x||kb.progressStart(h.length);B<h.length?I(B,m):m()};(function(c){var f=kb.filter.scan(q.app,v,c.condition.value);f?kb.filter.auth(c.user.value,c.organization.value,c.group.value).then(function(z){z?kb.field.load(c.app.value).then(function(w){var C={id:c.app.value,fields:w.origin};(function(p){var F=[],K=[],P=[],G={},A=1,L=1,D=0,J=0,O=function(){var k=[],t={field:function(a,
d){var l=null;if(a.tableCode)if(f[a.tableCode].value.length>d)l=f[a.tableCode].value[d].value[a.code];else switch(a.type){case "CHECK_BOX":case "FILE":case "GROUP_SELECT":case "MULTI_SELECT":case "ORGANIZATION_SELECT":case "USER_SELECT":l={value:[]};break;case "RADIO_BUTTON":(function(b){l={value:0!=b.length?b.reduce(function(g,e){g[e.index]=e;return g},Array(b.length).fill("")).first().label:""}})(Object.values(a.options));break;default:l={value:""}}else l=f[a.code];return kb.extend({type:a.type},
l)},record:function(a){L.each(function(d){var l=function(b){var g=kb.filter.scan(C,a,b.query);if(!g&&"upsert"==c.pattern.value){for(var e in b.rows)0==kb.filter.result[e].value.length&&(a[e].value.push({value:kb.extend({},b.rows[e])}),kb.filter.result[e]={value:[a[e].value.last()]});g=kb.filter.result}return g}(function(){var b={rows:{},query:[]};J=d;F.each(function(g,e){g.external.tableCode&&(g.external.tableCode in b.rows||(b.rows[g.external.tableCode]=kb.record.create(C.fields[g.external.tableCode],
!1)),b.rows[g.external.tableCode][g.external.code]=r(g.external,t.field(g.internal,J)),b.query.push(kb.filter.query.create(g.external,g.operator,t.field(g.internal,J))))});K.each(function(g,e){g.field.tableCode&&b.query.push(g.field.code+" "+g.operator+" "+g.value)});b.query=b.query.join(" and ");return b}());l&&P.each(function(b,g){b.external.tableCode?b.external.tableCode in G?(a[b.external.tableCode]={value:G[b.external.tableCode]},G[b.external.tableCode].each(function(e,H){e.value[b.external.code]=
r(b.external,t.field(b.internal,H));"FILE"==b.external.type&&e.value[b.external.code].value&&Array.prototype.push.apply(k,e.value[b.external.code].value)})):l[b.external.tableCode].value.each(function(e,H){e.value[b.external.code]=r(b.external,t.field(b.internal,J));"FILE"==b.external.type&&e.value[b.external.code].value&&Array.prototype.push.apply(k,e.value[b.external.code].value)}):(a[b.external.code]=r(b.external,t.field(b.internal,D)),"FILE"==b.external.type&&a[b.external.code].value&&Array.prototype.push.apply(k,
a[b.external.code].value))})});return a}},r=function(a,d){return a.lookup?kb.extend({lookup:!0},d):d},u=function(a){a.each(function(d,l){c.formula.value.each(function(b,g){b.value.field.value in p.external&&function(e){e.tableCode?d[e.tableCode].value.each(function(H,Q){H.value[e.code].value=kb.formula.calculate(b.value,H.value,d,d,p.external);e.lookup&&(H.value[e.code].lookup=!0)}):(d[e.code].value=kb.formula.calculate(b.value,d,d,d,p.external),e.lookup&&(d[e.code].lookup=!0))}(p.external[b.value.field.value])})});
return a};"insert"==c.pattern.value?function(a){kb.file.clone(k,!0).then(function(){kb.view.records.set(c.app.value,{post:a},x).then(function(d){D++;D<A?O():n()})["catch"](function(d){kb.alert(kb.error.parse(d));y()})})}(u([t.record(kb.record.create(C))])):kb.view.records.get(c.app.value,function(){var a=[];F.each(function(d,l){d.external.tableCode||a.push(kb.filter.query.create(d.external,d.operator,t.field(d.internal,D)))});K.each(function(d,l){d.field.tableCode||a.push(d.field.code+" "+d.operator+
" "+d.value)});return a.join(" and ")}()).then(function(a){a=function(d){var l=[];0!=d.length?l=d.map(function(b){return t.record(b)}):"upsert"==c.pattern.value&&function(b){l.push(t.record(function(){var g=kb.record.create(C);b.each(function(e,H){e.external.tableCode?g[e.external.tableCode]={value:[]}:g[e.external.code]=r(e.external,t.field(e.internal,D))});return g}()))}(F.filter(function(b){return!kb.field.reserved.includes(b.external.type)}));return u(l)}(a);kb.file.clone(k,!0).then(function(){kb.view.records.set(c.app.value,
{post:a.filter(function(d){return!d.$id.value}),put:a.reduce(function(d,l){l.$id.value&&d.push(kb.view.records.transform(l));return d},[])},x).then(function(d){D++;D<A?O():n()})["catch"](function(d){kb.alert(kb.error.parse(d));y()})})})["catch"](function(a){kb.alert(kb.error.parse(a));y()})};c.mapping.value.some(function(k){return!(k.value.external.value in p.external&&k.value.internal.value in p.internal)})?(kb.alert("No field to transfer was found"),y()):c.criteria.value.some(function(k){return!(k.value.external.value in
p.external&&k.value.internal.value in p.internal)})?(kb.alert("No field to transfer was found"),y()):(c.mapping.value.each(function(k,t){(function(r,u){r.tableCode?G[r.tableCode]=function(a){a=a?a.length:1;u.tableCode&&(a=a<f[u.tableCode].value.length?f[u.tableCode].value.length:a);return Array(a).fill().map(function(){return{value:kb.record.create(C.fields[r.tableCode],!1)}})}(G[r.tableCode]):u.tableCode&&(A=0==f[u.tableCode].value.length?0:A<f[u.tableCode].value.length?f[u.tableCode].value.length:
A);P.push({external:r,internal:u})})(p.external[k.value.external.value],p.internal[k.value.internal.value])}),c.criteria.value.each(function(k,t){var r=p.external[k.value.external.value],u=k.value.operator.value,a=p.internal[k.value.internal.value];r.tableCode?(r.tableCode in G&&delete G[r.tableCode],a.tableCode&&(L=L<f[a.tableCode].value.length?f[a.tableCode].value.length:L)):a.tableCode&&(A=0==f[a.tableCode].value.length?0:A<f[a.tableCode].value.length?f[a.tableCode].value.length:A);F.push({external:r,
operator:u,internal:a})}),kb.filter.query.parse(c.filter.value).each(function(k,t){K.push({field:p.external[k.field],operator:k.operator,value:k.value})}),0!=A?(J=D=0,O()):n())})({external:w.parallelize,internal:q.fieldInfos.parallelize})})["catch"](function(w){kb.alert(kb.error.parse(w));y()}):n()})["catch"](function(z){kb.alert(kb.error.parse(z));y()}):n()})(h[B])};x||kb.progressStart(h.length);I(0,function(){x||kb.progressEnd();E()})})};kintone.events.on("app.record.create.submit.success app.record.detail.process.proceed app.record.detail.show app.record.edit.submit.success app.record.index.show mobile.app.record.create.submit.success mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.submit.success mobile.app.record.index.show".split(" "),
function(h){return new Promise(function(v,x){(function(E,y){q.mobile=E;q.type=y;kb.config[N].config.get().then(function(I){0!=Object.keys(I).length?kb.field.load(kb.config[N].app,!0).then(function(B){q.app={id:kb.config[N].app,fields:B.origin};q.fieldInfos=B;try{(function(m){if(0!=m.length)switch(q.type){case "create":case "edit":M(m,h.record).then(function(c){return v(h)})["catch"](function(){});break;case "process":(function(c){0!=c.length?M(c,h.record).then(function(f){return v(h)})["catch"](function(){}):
v(h)})(m.filter(function(c){return c.action.value==h.action.value+":"+h.status.value+":"+h.nextStatus.value}));break;case "detail":var n=function(c){(function(f){kb.filter.scan(q.app,h.record,f.condition.value)?kb.filter.auth(f.user.value,f.organization.value,f.group.value).then(function(z){z&&kb.button.create(q.mobile,q.type,"kb-upsert-button"+c.toString(),f.label.value,f.message.value,function(){return M([f],h.record).then(function(w){return kb.alert("Done!")})["catch"](function(){})});c++;c<m.length&&
n(c)})["catch"](function(z){c++;c<m.length&&n(c)}):(c++,c<m.length&&n(c))})(m[c])};n(0);v(h);break;case "index":n=function(c){(function(f){kb.filter.auth(f.user.value,f.organization.value,f.group.value).then(function(z){z&&(f.view.value&&f.view.value!=h.viewId.toString()||kb.button.create(q.mobile,q.type,"kb-upsert-button"+c.toString(),f.label.value,f.message.value,function(){kb.view.records.get(q.app.id,(q.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(function(w){var C=function(p,
F){M([f],w[p],!0).then(function(K){kb.progressUpdate();p++;p<w.length?C(p,F):F()})["catch"](function(){})};0!=w.length?(kb.progressStart(w.length),C(0,function(){return kb.alert("Done!")})):kb.alert("There are no records.")})["catch"](function(w){return kb.alert(kb.error.parse(w))})}));c++;c<m.length&&n(c)})["catch"](function(z){c++;c<m.length&&n(c)})})(m[c])},n(0),v(h)}else v(h)})(JSON.parse(I.tab).reduce(function(m,n){(q.mobile?["both","mobile"]:["both","pc"]).includes(n.setting.device.value)&&
n.setting.event.value.includes(q.type)&&m.push(n.setting);return m},[]))}catch(m){kb.alert(kb.error.parse(m)),v(h)}})["catch"](function(B){return v(h)}):v(h)})["catch"](function(I){return v(h)})})("mobile"==h.type.split(".").first(),function(E){switch(E){case "submit":E=h.type.split(".").slice(-3).first()}return E}(h.type.split(".").slice(-2).first()))})})})(kintone.$PLUGIN_ID);