/*
* FileName "plugins.upsert.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(I=>{var t={},K=(e,m,J=!1)=>new Promise((A,w)=>{var u=(v,n)=>{var p=()=>{v++;v<e.length?u(v,n):n()};(b=>{var h=kb.filter.scan(t.app,m,b.condition.value);h?kb.filter.auth(b.user.value,b.organization.value,b.group.value).then(B=>{B?kb.field.load(b.app.value).then(x=>{var C={id:b.app.value,fields:x.origin};(q=>{var F=[],L=[],N=[],G={},D={table:"",index:g=>D.table&&D.table==g.tableCode?r.progress.record:r.progress.row},r={record:1,row:1,progress:{record:0,row:0}},M=()=>{var g=[],l={field:(d,c)=>{c=d.tableCode?
h[d.tableCode].value.length>c?h[d.tableCode].value[c].value[d.code]:kb.record.create({fields:{empty:mapping.internal}}).empty:h[d.code];return kb.extend({type:d.type},c)},record:d=>{r.row.each(c=>{var z=(a=>{var k=kb.filter.scan(C,d,a.query);if(!k&&"upsert"==b.pattern.value){for(var f in a.rows)0==kb.filter.result[f].value.length&&(d[f].value.push({value:kb.extend({},a.rows[f])}),kb.filter.result[f]={value:[d[f].value.last()]});k=kb.filter.result}return k})((()=>{var a={rows:{},query:[]};r.progress.row=
c;F.each((k,f)=>{k.external.tableCode&&(k.external.tableCode in a.rows||(a.rows[k.external.tableCode]=kb.record.create(C.fields[k.external.tableCode],!1)),f=l.field(k.internal,D.index(k.internal)),["=","in"].includes(k.operator.trim())&&(a.rows[k.external.tableCode][k.external.code]=y(k.external,f)),a.query.push(kb.filter.query.create(k.external,k.operator,f)))});L.each((k,f)=>{k.field.tableCode&&a.query.push(k.field.code+" "+k.operator+" "+k.value)});a.query=a.query.join(" and ");return a})());z&&
N.each((a,k)=>{a.external.tableCode?a.external.tableCode in G?(d[a.external.tableCode]={value:G[a.external.tableCode]},G[a.external.tableCode].each((f,H)=>{f.value[a.external.code]=y(a.external,l.field(a.internal,H));"FILE"==a.external.type&&f.value[a.external.code].value&&Array.prototype.push.apply(g,f.value[a.external.code].value)})):z[a.external.tableCode].value.each((f,H)=>{f.value[a.external.code]=y(a.external,l.field(a.internal,D.index(a.internal)));"FILE"==a.external.type&&f.value[a.external.code].value&&
Array.prototype.push.apply(g,f.value[a.external.code].value)}):(d[a.external.code]=y(a.external,l.field(a.internal,r.progress.record)),"FILE"==a.external.type&&d[a.external.code].value&&Array.prototype.push.apply(g,d[a.external.code].value))})});return d}},y=(d,c)=>{switch(d.type){case "CHECK_BOX":case "FILE":case "GROUP_SELECT":case "MULTI_SELECT":case "ORGANIZATION_SELECT":case "USER_SELECT":Array.isArray(c.value)||(c.value=[c.value])}c.type=d.type;return d.lookup?kb.extend({lookup:!0},c):c},E=
d=>{d.each((c,z)=>{b.formula.value.each((a,k)=>{a.value.field.value in q.external&&(f=>{f.tableCode?c[f.tableCode].value.each((H,O)=>{H.value[f.code].value=kb.formula.calculate(a.value,H.value,c,c,q.external);f.lookup&&(H.value[f.code].lookup=!0)}):(c[f.code].value=kb.formula.calculate(a.value,c,c,c,q.external),f.lookup&&(c[f.code].lookup=!0))})(q.external[a.value.field.value])})});return d};"insert"==b.pattern.value?(d=>{kb.file.clone(g,!0).then(()=>{kb.view.records.set(b.app.value,{post:d},J).then(c=>
{r.progress.record++;r.progress.record<r.record?M():p()}).catch(c=>{kb.alert(kb.error.parse(c));w()})})})(E([l.record(kb.record.create(C))])):kb.view.records.get(b.app.value,(()=>{var d=[];F.each((c,z)=>{c.external.tableCode||d.push(kb.filter.query.create(c.external,c.operator,l.field(c.internal,r.progress.record)))});L.each((c,z)=>{c.field.tableCode||d.push(c.field.code+" "+c.operator+" "+c.value)});return d.join(" and ")})()).then(d=>{d=(c=>{var z=[];0!=c.length?z=c.map(a=>l.record(a)):"upsert"==
b.pattern.value&&(a=>{z.push(l.record((()=>{var k=kb.record.create(C);a.each((f,H)=>{f.external.tableCode?k[f.external.tableCode]={value:[]}:["=","in"].includes(f.operator.trim())&&(k[f.external.code]=y(f.external,l.field(f.internal,r.progress.record)))});return k})()))})(F.filter(a=>!kb.field.reserved.includes(a.external.type)));return E(z)})(d);kb.file.clone(g,!0).then(()=>{kb.view.records.set(b.app.value,{post:d.filter(c=>!c.$id.value),put:d.reduce((c,z)=>{z.$id.value&&c.push(kb.view.records.transform(z));
return c},[])},J).then(c=>{r.progress.record++;r.progress.record<r.record?M():p()}).catch(c=>{kb.alert(kb.error.parse(c));w()})})}).catch(d=>{kb.alert(kb.error.parse(d));w()})};b.mapping.value.some(g=>!(g.value.external.value in q.external&&g.value.internal.value in q.internal))?(kb.alert("No field to transfer was found"),w()):b.criteria.value.some(g=>!(g.value.external.value in q.external&&g.value.internal.value in q.internal))?(kb.alert("No field to transfer was found"),w()):([...b.mapping.value,
...b.criteria.value].each((g,l)=>{l=q.internal[g.value.internal.value];!q.external[g.value.external.value].tableCode&&l.tableCode&&(D.table=l.tableCode,r.record=0==h[l.tableCode].value.length?0:h[l.tableCode].value.length)}),b.mapping.value.each((g,l)=>{((y,E)=>{y.tableCode&&(D.table&&D.table==E.tableCode||(G[y.tableCode]=(d=>{d=d?d.length:1;E.tableCode&&(d=d<h[E.tableCode].value.length?h[E.tableCode].value.length:d);return Array(d).fill().map(()=>({value:kb.record.create(C.fields[y.tableCode],!1)}))})(G[y.tableCode])));
N.push({external:y,internal:E})})(q.external[g.value.external.value],q.internal[g.value.internal.value])}),b.criteria.value.each((g,l)=>{l=q.external[g.value.external.value];var y=g.value.operator.value;g=q.internal[g.value.internal.value];l.tableCode&&(l.tableCode in G&&delete G[l.tableCode],!D.table&&g.tableCode&&(r.row=r.row<h[g.tableCode].value.length?h[g.tableCode].value.length:r.row));F.push({external:l,operator:y,internal:g})}),kb.filter.query.parse.expand({id:b.app.value,fields:x.origin},
b.filter.value).each((g,l)=>{L.push({field:q.external[g.field],operator:g.operator,value:g.value})}),0!=r.record?(r.progress.record=0,r.progress.row=0,M()):p())})({external:x.parallelize,internal:t.fieldInfos.parallelize})}).catch(x=>{kb.alert(kb.error.parse(x));w()}):p()}).catch(B=>{kb.alert(kb.error.parse(B));w()}):p()})(e[v])};J||kb.loadStart();u(0,()=>{J||kb.loadEnd();A()})});kintone.events.on("app.record.create.submit.success app.record.detail.process.proceed app.record.detail.show app.record.edit.submit.success app.record.index.show mobile.app.record.create.submit.success mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.submit.success mobile.app.record.index.show".split(" "),
e=>new Promise((m,J)=>{((A,w)=>{t.mobile=A;t.type=w;kb.config[I].config.get().then(u=>{0!=Object.keys(u).length?kb.field.load(kb.config[I].app,!0).then(v=>{t.app={id:kb.config[I].app,fields:v.origin};t.fieldInfos=v;try{(n=>{if(0!=n.length)switch(t.type){case "create":case "edit":K(n,e.record).then(b=>m(e)).catch(()=>{});break;case "process":(b=>{0!=b.length?K(b,e.record).then(h=>m(e)).catch(()=>{}):m(e)})(n.filter(b=>b.action.value==e.action.value+":"+e.status.value+":"+e.nextStatus.value));break;
case "detail":var p=b=>{(h=>{kb.filter.scan(t.app,e.record,h.condition.value)?kb.filter.auth(h.user.value,h.organization.value,h.group.value).then(B=>{B&&kb.button.create(t.mobile,t.type,"kb-upsert-button"+b.toString(),h.label.value,h.message.value,()=>K([h],e.record).then(x=>kb.alert("Done!")).catch(()=>{}));b++;b<n.length&&p(b)}).catch(B=>{b++;b<n.length&&p(b)}):(b++,b<n.length&&p(b))})(n[b])};p(0);m(e);break;case "index":p=b=>{(h=>{kb.filter.auth(h.user.value,h.organization.value,h.group.value).then(B=>
{B&&(h.view.value&&h.view.value!=e.viewId.toString()||kb.button.create(t.mobile,t.type,"kb-upsert-button"+b.toString(),h.label.value,h.message.value,()=>{kb.view.records.get(t.app.id,(t.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(x=>{let C=(q,F)=>{K([h],x[q],!0).then(L=>{kb.progressUpdate();q++;q<x.length?C(q,F):F()}).catch(()=>{})};0!=x.length?(kb.progressStart(x.length),C(0,()=>kb.alert("Done!"))):kb.alert("There are no records.")}).catch(x=>kb.alert(kb.error.parse(x)))}));
b++;b<n.length&&p(b)}).catch(B=>{b++;b<n.length&&p(b)})})(n[b])},p(0),m(e)}else m(e)})(JSON.parse(u.tab).map((n,p)=>kb.extend({sIndex:{value:p.toString()}},n.setting)).reduce((n,p)=>{(t.mobile?["all","both","mobile"]:["all","both","pc"]).includes(p.device.value)&&p.event.value.includes(t.type)&&n.push(p);return n},[]))}catch(n){kb.alert(kb.error.parse(n)),m(e)}}).catch(v=>m(e)):m(e)}).catch(u=>m(e))})("mobile"==e.type.split(".").first(),(A=>{switch(A){case "submit":A=e.type.split(".").slice(-3).first()}return A})(e.type.split(".").slice(-2).first()))}));
kb.event.on("kb.upsert.call",e=>new Promise((m,J)=>{kb.config[I].config.get().then(A=>{0!=Object.keys(A).length?kb.field.load(kb.config[I].app,!0).then(w=>{t.app={id:kb.config[I].app,fields:w.origin};t.fieldInfos=w;try{(u=>{0!=u.length?K(u,e.record,!0).then(v=>m(e)).catch(()=>m(e)):m(e)})(JSON.parse(A.tab).map((u,v)=>kb.extend({sIndex:{value:v.toString()}},u.setting)).reduce((u,v)=>{(e.mobile?["all","both","mobile"]:["all","both","pc"]).includes(v.device.value)&&v.event.value.includes(e.pattern)&&
u.push(v);return u},[]))}catch(u){kb.alert(kb.error.parse(u)),m(e)}}).catch(w=>m(e)):m(e)}).catch(A=>m(e))}))})(kintone.$PLUGIN_ID);
