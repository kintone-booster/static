/*
* FileName "plugins.upsert.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(J){var k={},L=function(e,m,B){B=void 0===B?!1:B;return new Promise(function(A,w){var r=function(u,n){var p=function(){u++;u<e.length?r(u,n):n()};(function(c){var f=kb.filter.scan(k.app,m,c.condition.value);f?kb.filter.auth(c.user.value,c.organization.value,c.group.value).then(function(C){C?kb.field.load(c.app.value).then(function(z){var E={id:c.app.value,fields:z.origin};(function(q){var G=[],M=[],P=[],H={},D=1,N=1,F=0,K=0,O=function(){var l=[],x={field:function(a,d){var v=a.tableCode?f[a.tableCode].value.length>
d?f[a.tableCode].value[d].value[a.code]:kb.record.create({fields:{empty:mapping.internal}}).empty:f[a.code];return kb.extend({type:a.type},v)},record:function(a){N.each(function(d){var v=function(b){var h=kb.filter.scan(E,a,b.query);if(!h&&"upsert"==c.pattern.value){for(var g in b.rows)0==kb.filter.result[g].value.length&&(a[g].value.push({value:kb.extend({},b.rows[g])}),kb.filter.result[g]={value:[a[g].value.last()]});h=kb.filter.result}return h}(function(){var b={rows:{},query:[]};K=d;G.each(function(h,
g){h.external.tableCode&&(h.external.tableCode in b.rows||(b.rows[h.external.tableCode]=kb.record.create(E.fields[h.external.tableCode],!1)),b.rows[h.external.tableCode][h.external.code]=t(h.external,x.field(h.internal,K)),b.query.push(kb.filter.query.create(h.external,h.operator,x.field(h.internal,K))))});M.each(function(h,g){h.field.tableCode&&b.query.push(h.field.code+" "+h.operator+" "+h.value)});b.query=b.query.join(" and ");return b}());v&&P.each(function(b,h){b.external.tableCode?b.external.tableCode in
H?(a[b.external.tableCode]={value:H[b.external.tableCode]},H[b.external.tableCode].each(function(g,I){g.value[b.external.code]=t(b.external,x.field(b.internal,I));"FILE"==b.external.type&&g.value[b.external.code].value&&Array.prototype.push.apply(l,g.value[b.external.code].value)})):v[b.external.tableCode].value.each(function(g,I){g.value[b.external.code]=t(b.external,x.field(b.internal,K));"FILE"==b.external.type&&g.value[b.external.code].value&&Array.prototype.push.apply(l,g.value[b.external.code].value)}):
(a[b.external.code]=t(b.external,x.field(b.internal,F)),"FILE"==b.external.type&&a[b.external.code].value&&Array.prototype.push.apply(l,a[b.external.code].value))})});return a}},t=function(a,d){switch(a.type){case "CHECK_BOX":case "FILE":case "GROUP_SELECT":case "MULTI_SELECT":case "ORGANIZATION_SELECT":case "USER_SELECT":Array.isArray(d.value)||(d.value=[d.value])}d.type=a.type;return a.lookup?kb.extend({lookup:!0},d):d},y=function(a){a.each(function(d,v){c.formula.value.each(function(b,h){b.value.field.value in
q.external&&function(g){g.tableCode?d[g.tableCode].value.each(function(I,Q){I.value[g.code].value=kb.formula.calculate(b.value,I.value,d,d,q.external);g.lookup&&(I.value[g.code].lookup=!0)}):(d[g.code].value=kb.formula.calculate(b.value,d,d,d,q.external),g.lookup&&(d[g.code].lookup=!0))}(q.external[b.value.field.value])})});return a};"insert"==c.pattern.value?function(a){kb.file.clone(l,!0).then(function(){kb.view.records.set(c.app.value,{post:a},B).then(function(d){F++;F<D?O():p()})["catch"](function(d){kb.alert(kb.error.parse(d));
w()})})}(y([x.record(kb.record.create(E))])):kb.view.records.get(c.app.value,function(){var a=[];G.each(function(d,v){d.external.tableCode||a.push(kb.filter.query.create(d.external,d.operator,x.field(d.internal,F)))});M.each(function(d,v){d.field.tableCode||a.push(d.field.code+" "+d.operator+" "+d.value)});return a.join(" and ")}()).then(function(a){a=function(d){var v=[];0!=d.length?v=d.map(function(b){return x.record(b)}):"upsert"==c.pattern.value&&function(b){v.push(x.record(function(){var h=kb.record.create(E);
b.each(function(g,I){g.external.tableCode?h[g.external.tableCode]={value:[]}:h[g.external.code]=t(g.external,x.field(g.internal,F))});return h}()))}(G.filter(function(b){return!kb.field.reserved.includes(b.external.type)}));return y(v)}(a);kb.file.clone(l,!0).then(function(){kb.view.records.set(c.app.value,{post:a.filter(function(d){return!d.$id.value}),put:a.reduce(function(d,v){v.$id.value&&d.push(kb.view.records.transform(v));return d},[])},B).then(function(d){F++;F<D?O():p()})["catch"](function(d){kb.alert(kb.error.parse(d));
w()})})})["catch"](function(a){kb.alert(kb.error.parse(a));w()})};c.mapping.value.some(function(l){return!(l.value.external.value in q.external&&l.value.internal.value in q.internal)})?(kb.alert("No field to transfer was found"),w()):c.criteria.value.some(function(l){return!(l.value.external.value in q.external&&l.value.internal.value in q.internal)})?(kb.alert("No field to transfer was found"),w()):(c.mapping.value.each(function(l,x){(function(t,y){t.tableCode?H[t.tableCode]=function(a){a=a?a.length:
1;y.tableCode&&(a=a<f[y.tableCode].value.length?f[y.tableCode].value.length:a);return Array(a).fill().map(function(){return{value:kb.record.create(E.fields[t.tableCode],!1)}})}(H[t.tableCode]):y.tableCode&&(D=0==f[y.tableCode].value.length?0:D<f[y.tableCode].value.length?f[y.tableCode].value.length:D);P.push({external:t,internal:y})})(q.external[l.value.external.value],q.internal[l.value.internal.value])}),c.criteria.value.each(function(l,x){var t=q.external[l.value.external.value],y=l.value.operator.value,
a=q.internal[l.value.internal.value];t.tableCode?(t.tableCode in H&&delete H[t.tableCode],a.tableCode&&(N=N<f[a.tableCode].value.length?f[a.tableCode].value.length:N)):a.tableCode&&(D=0==f[a.tableCode].value.length?0:D<f[a.tableCode].value.length?f[a.tableCode].value.length:D);G.push({external:t,operator:y,internal:a})}),kb.filter.query.parse(c.filter.value).each(function(l,x){M.push({field:q.external[l.field],operator:l.operator,value:l.value})}),0!=D?(K=F=0,O()):p())})({external:z.parallelize,internal:k.fieldInfos.parallelize})})["catch"](function(z){kb.alert(kb.error.parse(z));
w()}):p()})["catch"](function(C){kb.alert(kb.error.parse(C));w()}):p()})(e[u])};B||kb.loadStart();r(0,function(){B||kb.loadEnd();A()})})};kintone.events.on("app.record.create.submit.success app.record.detail.process.proceed app.record.detail.show app.record.edit.submit.success app.record.index.show mobile.app.record.create.submit.success mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.submit.success mobile.app.record.index.show".split(" "),function(e){return new Promise(function(m,
B){(function(A,w){k.mobile=A;k.type=w;kb.config[J].config.get().then(function(r){0!=Object.keys(r).length?kb.field.load(kb.config[J].app,!0).then(function(u){k.app={id:kb.config[J].app,fields:u.origin};k.fieldInfos=u;try{(function(n){if(0!=n.length)switch(k.type){case "create":case "edit":L(n,e.record).then(function(c){return m(e)})["catch"](function(){});break;case "process":(function(c){0!=c.length?L(c,e.record).then(function(f){return m(e)})["catch"](function(){}):m(e)})(n.filter(function(c){return c.action.value==
e.action.value+":"+e.status.value+":"+e.nextStatus.value}));break;case "detail":var p=function(c){(function(f){kb.filter.scan(k.app,e.record,f.condition.value)?kb.filter.auth(f.user.value,f.organization.value,f.group.value).then(function(C){C&&kb.button.create(k.mobile,k.type,"kb-upsert-button"+c.toString(),f.label.value,f.message.value,function(){return L([f],e.record).then(function(z){return kb.alert("Done!")})["catch"](function(){})});c++;c<n.length&&p(c)})["catch"](function(C){c++;c<n.length&&
p(c)}):(c++,c<n.length&&p(c))})(n[c])};p(0);m(e);break;case "index":p=function(c){(function(f){kb.filter.auth(f.user.value,f.organization.value,f.group.value).then(function(C){C&&(f.view.value&&f.view.value!=e.viewId.toString()||kb.button.create(k.mobile,k.type,"kb-upsert-button"+c.toString(),f.label.value,f.message.value,function(){kb.view.records.get(k.app.id,(k.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(function(z){var E=function(q,G){L([f],z[q],!0).then(function(M){kb.progressUpdate();
q++;q<z.length?E(q,G):G()})["catch"](function(){})};0!=z.length?(kb.progressStart(z.length),E(0,function(){return kb.alert("Done!")})):kb.alert("There are no records.")})["catch"](function(z){return kb.alert(kb.error.parse(z))})}));c++;c<n.length&&p(c)})["catch"](function(C){c++;c<n.length&&p(c)})})(n[c])},p(0),m(e)}else m(e)})((k.config?k.config:k.config=JSON.parse(r.tab)).map(function(n,p){return kb.extend({sIndex:{value:p.toString()}},n)}).reduce(function(n,p){(k.mobile?["both","mobile"]:["both",
"pc"]).includes(p.setting.device.value)&&p.setting.event.value.includes(k.type)&&n.push(p.setting);return n},[]))}catch(n){kb.alert(kb.error.parse(n)),m(e)}})["catch"](function(u){return m(e)}):m(e)})["catch"](function(r){return m(e)})})("mobile"==e.type.split(".").first(),function(A){switch(A){case "submit":A=e.type.split(".").slice(-3).first()}return A}(e.type.split(".").slice(-2).first()))})});kb.event.on("kb.upsert.call",function(e){return new Promise(function(m,B){kb.config[J].config.get().then(function(A){0!=
Object.keys(A).length?kb.field.load(kb.config[J].app,!0).then(function(w){k.app={id:kb.config[J].app,fields:w.origin};k.fieldInfos=w;try{(function(r){0!=r.length?L(r,e.record,!0).then(function(u){return m(e)})["catch"](function(){return m(e)}):m(e)})((k.config?k.config:k.config=JSON.parse(A.tab)).map(function(r,u){return kb.extend({sIndex:{value:u.toString()}},r)}).reduce(function(r,u){(e.mobile?["both","mobile"]:["both","pc"]).includes(u.setting.device.value)&&u.setting.event.value.includes(e.pattern)&&
r.push(u.setting);return r},[]))}catch(r){kb.alert(kb.error.parse(r)),m(e)}})["catch"](function(w){return m(e)}):m(e)})["catch"](function(A){return m(e)})})})})(kintone.$PLUGIN_ID);