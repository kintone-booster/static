/*
* FileName "plugins.action.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(K=>{var b={},M=(d,l,D,L)=>new Promise((I,u)=>{var C=JSON.stringify(kb.record.simplify({fields:b.fieldInfos.origin},l)),p=(e,f)=>{var k=()=>{e++;e<d.length?p(e,f):f()};(a=>{var w=kb.filter.scan(b.app,l,a.condition.value);w?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(H=>{if(H){var J={clear:y=>{try{a.clear.value.map(c=>c.value).each((c,z)=>{c.table.value in b.fieldInfos.tables&&(l[c.table.value].value=l[c.table.value].value.filter(x=>!w[c.table.value].value.includes(x)),
w[c.table.value].value=[])}),y()}catch(c){kb.alert(kb.error.parse(c)),u()}},fill:y=>{try{a.fill.value.map(c=>c.value).each((c,z)=>{c.table.value in b.fieldInfos.tables&&(x=>{x=kb.isNumeric(x)?parseInt(x)-w[c.table.value].value.length:0;0<x&&Array(x).fill().map(()=>kb.record.create(b.fieldInfos.origin[c.table.value],!1)).each((A,q)=>{l[c.table.value]==w[c.table.value]?l[c.table.value].value.push({value:A}):(l[c.table.value].value.push({value:A}),w[c.table.value].value.push({value:A}))})})(kb.formula.calculate({field:{value:Object.values(b.fieldInfos.parallelize).first().code},
formula:c.range},w,w,l,b.fieldInfos.parallelize))}),y()}catch(c){kb.alert(kb.error.parse(c)),u()}},formula:y=>{try{a.formula.value.map(c=>c.value).each((c,z)=>{c.field.value in b.fieldInfos.parallelize&&(x=>{x.tableCode?w[x.tableCode].value.each((A,q)=>{A.value[x.code].value=kb.formula.calculate(c,A.value,w,l,b.fieldInfos.parallelize);"lookup"==x.type&&(A.value[x.code].lookup=!0)}):(w[x.code].value=kb.formula.calculate(c,w,w,l,b.fieldInfos.parallelize),"lookup"==x.type&&(w[x.code].lookup=!0))})(b.fieldInfos.parallelize[c.field.value])}),
y()}catch(c){kb.alert(kb.error.parse(c)),u()}},lookup:y=>{try{a.lookupApp.value?kb.field.load(a.lookupApp.value).then(c=>{(z=>{var x=[],A=[],q=(r,t)=>{var m=(h,n)=>h.lookup?kb.extend({lookup:!0,type:h.type},n):kb.extend({type:h.type},n);kb.view.records.get(a.lookupApp.value,t.query,t.sort).then(h=>{0!=h.length?(n=>{a.lookupLimited.value.includes("limited")||1==h.length?n(h.first()):b.picker.show({app:a.lookupApp.value,query:t.query,sort:t.sort,picker:x.reduce((v,g)=>{v[g.external.code]=g.external;
return v},{})},v=>n(v))})(n=>{x.each((v,g)=>{if(a.lookupOverwrite.value.includes("overwrite")||kb.field.isEmpty(t.record[v.internal.code].value))t.record[v.internal.code]=m(v.internal,n[v.external.code])});r++;r<A.length?q(r,A[r]):(D.latest.action[a.sIndex.value].lookup=B(),y())}):(a.lookupReset.value.includes("reset")&&x.each((n,v)=>{t.record[n.internal.code]=m(n.internal,kb.record.create({fields:{empty:n.internal}}).empty)}),r++,r<A.length?q(r,A[r]):(D.latest.action[a.sIndex.value].lookup=B(),y()))}).catch(h=>
{kb.alert(kb.error.parse(h));u()})},B=()=>(r=>JSON.stringify(A.reduce((t,m)=>{t.push(m.query);t.push(kb.record.simplify({fields:r},m.record));return t},[])))(x.reduce((r,t)=>{r[t.internal.code]=t.internal;return r},{}));a.lookupCriteria.value.some(r=>!(r.value.external.value in z.external&&r.value.internal.value in z.internal))?(kb.alert("No field to lookup was found"),u()):a.lookupMapping.value.some(r=>!(r.value.external.value in z.external&&r.value.internal.value in z.internal))?(kb.alert("No field to lookup was found"),
u()):(x=a.lookupMapping.value.map(r=>({external:z.external[r.value.external.value],internal:z.internal[r.value.internal.value]})),A=(r=>r.map(t=>({query:a.lookupCriteria.value.reduce((m,h)=>{var n=z.external[h.value.external.value],v=h.value.operator.value;h=z.internal[h.value.internal.value];var g=h.tableCode?t.value:l;a.lookupIgnore.value.includes("ignore")&&kb.field.isEmpty(g[h.code].value)||m.push(kb.filter.query.create(n,v,g[h.code]));return m},kb.filter.query.parse.expand({id:a.lookupApp.value,
fields:c.origin},a.lookupFilter.value).map(m=>m.field+" "+m.operator+" "+m.value)).join(" and "),sort:(0!=a.lookupSort.value.length?a.lookupSort.value.map(m=>m.value.field.value+" "+m.value.order.value):["$id asc"]).join(","),record:t.value})))((r=>r?w[r].value:[{value:l}])(Array.from(new Set(x.map(r=>r.internal.tableCode))).first())),0!=A.length?D.latest.action[a.sIndex.value].lookup&&D.latest.action[a.sIndex.value].lookup==B()?y():q(0,A.first()):y())})({external:c.origin,internal:b.fieldInfos.parallelize})}).catch(c=>
{kb.alert(kb.error.parse(c));u()}):y()}catch(c){kb.alert(kb.error.parse(c)),u()}},user:y=>{try{a.userSource.value?(c=>{0==kb.roleSet.user.length?kb.roleSet.load().then(()=>c()):c()})(()=>{var c=[],z=[],x=(q,B)=>{(t=>{c.each((m,h)=>{if(m.isCustom)switch(m.field.type){case "USER_SELECT":m.value=t.reduce((n,v)=>{"customItemValues"in v&&(g=>{0!=g.length&&(E=>{(F=>{0!=F.length&&(n.some(G=>G.code==F.first().info.code)||n.push({code:F.first().info.code,name:F.first().info.name}))})(kb.roleSet.user.filter(F=>
F.info.id==E))})(g.first().value)})(v.customItemValues.filter(g=>g.code==m.item));return Array.from(new Set(n)).filter(g=>g)},[]);break;default:m.value=t.reduce((n,v)=>{"customItemValues"in v&&(g=>{0!=g.length&&n.push(g.first().value)})(v.customItemValues.filter(g=>g.code==m.item));return Array.from(new Set(n)).filter(g=>g)},[]).join(",")}else switch(m.item){case "groups":case "organizations":m.value=t.map(n=>n.code);break;case "primaryOrganization":m.value=t.reduce((n,v)=>{m.item in v&&(g=>{0!=g.length&&
(n.some(E=>E.code==g.first().info.code)||n.push({code:g.first().info.code,name:g.first().info.name}))})(kb.roleSet.organization.filter(g=>g.info.id==v[m.item]));return n},[]);break;default:m.value=t.reduce((n,v)=>{m.item in v&&n.push(v[m.item]);return Array.from(new Set(n)).filter(g=>g)},[]).join(",")}})})(B[a.userSource.value].value.reduce((t,m)=>{(h=>{0!=h.length&&t.push(h.first().info)})(kb.roleSet.user.filter(h=>h.info.code==m.code));return t},[]));var r=(t,m)=>{((h,n)=>{var v=(g,E,F)=>{switch(h.item){case "groups":kintone.api(kintone.api.url("/v1/user/groups",
!0),"GET",{code:h.value[g]}).then(G=>{G.groups&&(E=E.concat(G.groups.map(N=>({code:N.code,name:N.name}))),g++,g<h.value.length?v(g,E,F):F(E))}).catch(G=>{kb.alert(kb.error.parse(G));u()});break;case "organizations":kintone.api(kintone.api.url("/v1/user/organizations",!0),"GET",{code:h.value[g]}).then(G=>{G.organizationTitles&&(E=E.concat(G.organizationTitles.map(N=>({code:N.organization.code,name:N.organization.name}))),g++,g<h.value.length?v(g,E,F):F(E))}).catch(G=>{kb.alert(kb.error.parse(G));u()})}};
a.userOverwrite.value.includes("overwrite")||kb.field.isEmpty(B[h.field.code].value)||n();switch(h.item){case "groups":case "organizations":0!=h.value.length?v(0,[],g=>{B[h.field.code].value=g;n()}):(B[h.field.code].value=h.value,n());break;default:B[h.field.code].value=h.value,n()}})(c[t],()=>{t++;t<c.length?r(t,m):m()})};r(0,()=>{q++;q<z.length?x(q,z[q]):(D.latest.action[a.sIndex.value].user=A(),y())})},A=()=>(q=>JSON.stringify(z.map(B=>kb.record.simplify({fields:q},B))))(c.reduce((q,B)=>{q[B.field.code]=
B.field;return q},(q=>{var B={};B[q]=b.fieldInfos.parallelize[q];return B})(a.userSource.value)));a.userCustomItem.value.some(q=>!(q.value.field.value in b.fieldInfos.parallelize))?(kb.alert("No field to user informations was found"),u()):a.userMapping.value.some(q=>!(q.value.field.value in b.fieldInfos.parallelize))?(kb.alert("No field to user informations was found"),u()):(a.userCustomItem.value.each((q,B)=>{c.push({isCustom:!0,item:q.value.item.value,field:b.fieldInfos.parallelize[q.value.field.value],
value:[]})}),a.userMapping.value.each((q,B)=>{c.push({isCustom:!1,item:q.value.item.value,field:b.fieldInfos.parallelize[q.value.field.value],value:[]})}),a.userPrimaryOrganization.value&&a.userPrimaryOrganization.value in b.fieldInfos.parallelize&&c.push({isCustom:!1,item:"primaryOrganization",field:b.fieldInfos.parallelize[a.userPrimaryOrganization.value],value:[]}),a.userOrganization.value&&a.userOrganization.value in b.fieldInfos.parallelize&&c.push({isCustom:!1,item:"organizations",field:b.fieldInfos.parallelize[a.userOrganization.value],
value:[]}),a.userGroup.value&&a.userGroup.value in b.fieldInfos.parallelize&&c.push({isCustom:!1,item:"groups",field:b.fieldInfos.parallelize[a.userGroup.value],value:[]}),z=(q=>q?w[q].value:[{value:l}])(b.fieldInfos.parallelize[a.userSource.value].tableCode).map(q=>q.value),0!=z.length?D.latest.action[a.sIndex.value].user&&D.latest.action[a.sIndex.value].user==A()?y():0!=c.length?x(0,z.first()):y():y())}):y()}catch(c){kb.alert(kb.error.parse(c)),u()}}};J.clear(()=>{J.fill(()=>{J.formula(()=>{J.lookup(()=>
{J.user(()=>{k()})})})})})}else k()}).catch(H=>{kb.alert(kb.error.parse(H));u()}):k()})((a=>{D.latest?D.latest.action||(D.latest.action={}):D.latest={action:{}};a.sIndex.value in D.latest.action||(D.latest.action[a.sIndex.value]={lookup:"[]",user:"[]"});return a})(d[e]))};p(0,()=>{I({record:l,performed:C!=JSON.stringify(kb.record.simplify({fields:b.fieldInfos.origin},l))})})});kintone.events.on("app.record.create.show app.record.detail.process.proceed app.record.detail.show app.record.edit.show app.record.index.show mobile.app.record.create.show mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.show mobile.app.record.index.show".split(" "),
d=>new Promise((l,D)=>{((L,I)=>{b.mobile=L;b.type=I;kb.config[K].config.get().then(u=>{0!=Object.keys(u).length?kb.field.load(kb.config[K].app,!0).then(C=>{b.app={id:kb.config[K].app,fields:C.origin};b.fieldInfos=C;b.picker=new KintoneBoosterRecordPicker("record");try{["create","edit","reuse"].includes(b.type)&&(p=>{if(0!=p.length)b.latest={record:"",time:null},kintone.events.on(C.changes.reduce((e,f)=>{e.push("app.record.create.change."+f);e.push("app.record.edit.change."+f);e.push("mobile.app.record.create.change."+
f);e.push("mobile.app.record.edit.change."+f);return e},[]),e=>{var f=p.filter(k=>(a=>!a.first()||a.includes(e.type.split(".").last()))(k.triggers.value.map(a=>a.value.field.value)));if((()=>{var k=!0;b.latest.record&&(k=!1,b.latest.record==JSON.stringify(kb.record.simplify({fields:C.origin},e.record))?b.latest={record:"",time:null}:b.latest.time<(new Date).getTime()-5E3&&(b.latest={record:"",time:null},k=!0));k&&["DATETIME","TIME"].includes(e.changes.field.type)&&(a=>{a&&(Array.isArray(a)?a:[a]).each((w,
H)=>{w.elm(".control-errors-content-gaia")&&(k=!1)})})(kb.field.get(C.parallelize[e.type.split(".").last()],b.mobile,b.type));return k})()){if(0!=f.length)return M(f,e.record,kb.elm("body"),"record").then(k=>{kb.event.call("kb.style.call",{container:kb.elm("body"),record:e.record,mobile:b.mobile,pattern:"reuse"==b.type?"create":b.type,workplace:"record"}).then(a=>{if(k.performed||a.performed)b.latest=k.performed?{record:JSON.stringify(kb.record.simplify({fields:C.origin},a.record)),time:(new Date).getTime()}:
{record:"",time:null},(b.mobile?kintone.mobile.app.record:kintone.app.record).set(e)}).catch(()=>{})}).catch(()=>{}),e;kb.event.call("kb.style.call",{container:kb.elm("body"),record:e.record,mobile:b.mobile,pattern:"reuse"==b.type?"create":b.type,workplace:"record"}).then(k=>{k.performed&&(b.latest={record:"",time:null},(b.mobile?kintone.mobile.app.record:kintone.app.record).set(e))}).catch(()=>{})}}),kb.event.on("kb.action.installed",e=>({installed:!0}));else kb.event.on("kb.action.installed",e=>
({installed:!1}))})(JSON.parse(u.tab).map((p,e)=>kb.extend({sIndex:{value:e.toString()}},p.setting)).reduce((p,e)=>{(b.mobile?["all","both","mobile"]:["all","both","pc"]).includes(e.device.value)&&e.event.value.includes("change")&&p.push(e);return p},[])),(p=>{if(0!=p.length)switch(b.type){case "create":case "edit":case "reuse":M(p,d.record,kb.elm("body"),"record").then(f=>l(d)).catch(()=>{});break;case "process":(f=>{0!=f.length?M(f,d.record,kb.elm("body"),"record").then(k=>l(d)).catch(()=>{}):l(d)})(p.filter(f=>
f.action.value==d.action.value+":"+d.status.value+":"+d.nextStatus.value));break;case "detail":var e=f=>{(k=>{kb.filter.scan(b.app,d.record,k.condition.value)?kb.filter.auth(k.user.value,k.organization.value,k.group.value).then(a=>{a&&kb.button.create(b.mobile,b.type,"kb-action-button"+f.toString(),k.label.value,k.message.value,()=>{M([k],d.record,kb.elm("body"),"record").then(w=>{kb.view.records.set(b.app.id,{put:[kb.view.records.transform(w.record)]}).then(H=>kb.alert("Done!",()=>window.location.reload(!0))).catch(H=>
kb.alert(kb.error.parse(H)))}).catch(()=>{})});f++;f<p.length&&e(f)}).catch(a=>{f++;f<p.length&&e(f)}):(f++,f<p.length&&e(f))})(p[f])};e(0);l(d);break;case "index":e=f=>{(k=>{kb.filter.auth(k.user.value,k.organization.value,k.group.value).then(a=>{a&&(k.view.value&&k.view.value!=d.viewId.toString()||kb.button.create(b.mobile,b.type,"kb-action-button"+f.toString(),k.label.value,k.message.value,()=>{kb.view.records.get(b.app.id,(b.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(w=>
{var H=[];let J=(y,c)=>{M([k],w[y],kb.create("div"),"record").then(z=>{z.performed&&H.push(kb.view.records.transform(z.record));kb.progressUpdate();y++;y<w.length?J(y,c):c()}).catch(()=>{})};0!=w.length?(kb.progressStart(w.length),J(0,()=>{kb.view.records.set(b.app.id,{put:H}).then(y=>kb.alert("Done!",()=>window.location.reload(!0))).catch(y=>kb.alert(kb.error.parse(y)))})):kb.alert("There are no records.")}).catch(w=>kb.alert(kb.error.parse(w)))}));f++;f<p.length&&e(f)}).catch(a=>{f++;f<p.length&&
e(f)})})(p[f])},e(0),l(d)}else l(d)})(JSON.parse(u.tab).map((p,e)=>kb.extend({sIndex:{value:e.toString()}},p.setting)).reduce((p,e)=>{(b.mobile?["all","both","mobile"]:["all","both","pc"]).includes(e.device.value)&&e.event.value.includes(b.type)&&p.push(e);return p},[]))}catch(p){kb.alert(kb.error.parse(p)),l(d)}}).catch(C=>l(d)):l(d)}).catch(u=>l(d))})("mobile"==d.type.split(".").first(),d.reuse?"reuse":d.type.split(".").slice(-2).first())}));kb.event.on("kb.action.call",d=>new Promise((l,D)=>{kb.config[K].config.get().then(L=>
{0!=Object.keys(L).length?kb.field.load(kb.config[K].app,!0).then(I=>{b.app={id:kb.config[K].app,fields:I.origin};b.fieldInfos=I;b.picker=new KintoneBoosterRecordPicker("record");try{(u=>{if(0!=u.length){var C=(()=>{var p=u;"change"==d.pattern&&(p=u.filter(e=>(f=>"fields"in d?!f.first()||d.fields.some(k=>f.includes(k)):!f.first()||f.includes(d.field))(e.triggers.value.map(f=>f.value.field.value))));return p})();0!=C.length?M(C,d.record,d.container,d.workplace?d.workplace:"record").then(p=>{d.stopPropagation&&
(b.latest={record:JSON.stringify(kb.record.simplify({fields:I.origin},d.record)),time:(new Date).getTime()});d.performed=p.performed;l(d)}).catch(()=>l(d)):l(d)}else l(d)})(JSON.parse(L.tab).map((u,C)=>kb.extend({sIndex:{value:C.toString()}},u.setting)).reduce((u,C)=>{(d.mobile?["all","both","mobile"]:["all","both","pc"]).includes(C.device.value)&&C.event.value.includes(d.pattern)&&u.push(C);return u},[]))}catch(u){kb.alert(kb.error.parse(u)),l(d)}}).catch(I=>l(d)):l(d)}).catch(L=>l(d))}))})(kintone.$PLUGIN_ID);