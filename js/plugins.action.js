/*
* FileName "plugins.action.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(u){var c={},v=function(b,f,y){var r=!1;return new Promise(function(t,m){var p=function(g,d){var a=function(){g++;silent||kb.progressUpdate();g<b.length?p(g,d):d()};(function(e){var l=kb.filter.scan(c.app,f,e.condition.value);l?kb.filter.auth(e.user.value,e.organization.value,e.group.value).then(function(n){n&&(e.clear.value.each(function(h,w){h.table.value in c.fieldInfos.tables&&(f[h.table.value].value=f[h.table.value].value.filter(function(k){return!l[h.table.value].value.includes(k)}),
l[h.table.value].value=[],r=!0)}),e.fill.value.each(function(h,w){h.table.value in c.fieldInfos.tables&&(function(k){k=kb.isNumeric(k)?parseInt(k)-l[h.table.value].value.length:0;0<k&&Array(k).fill().map(function(){return kb.record.create(c.fieldInfos.origin[h.table.value],!1)}).each(function(q,x){f[h.table.value]==l[h.table.value]?f[h.table.value].value.push(q):(f[h.table.value].value.push(q),l[h.table.value].value.push(q))})}(kb.formula.calculate({field:"__id",formula:h.range.value},l,l,f,c.fieldInfos.parallelize)),
r=!0)}),e.formula.value.each(function(h,w){h.field.value in c.fieldInfos.parallelize&&function(k){k.tableCode?l[k.tableCode].value.each(function(q,x){q[k.code].value=kb.formula.calculate(h,q,l,f,c.fieldInfos.parallelize);"lookup"==k.type&&(q[k.code].lookup=!0)}):(l[k.code].value=kb.formula.calculate(h,l,l,f,c.fieldInfos.parallelize),"lookup"==k.type&&(l[k.code].lookup=!0));actions.call=!0}(c.fieldInfos.parallelize[h.field.value])}));a()})["catch"](function(n){kb.alert(kb.error.parse(n));m()}):a()})(b[g])};
silent||kb.progressStart(b.length);p(0,function(){silent||kb.progressEnd();t({record:f,performed:r})})})};kintone.events.on("app.record.create.show app.record.detail.process.proceed app.record.detail.show app.record.edit.show app.record.index.show mobile.app.record.create.show mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.show mobile.app.record.index.show".split(" "),function(b){return new Promise(function(f,y){(function(r,t){c.mobile=r;c.type=t;kb.config[u].config.get().then(function(m){0!=
Object.keys(m).length?kb.field.load(kb.config[u].app,!0).then(function(p){c.app={id:kb.config[u].app,fields:p.origin};c.fieldInfos=p;try{["create","edit"].includes(c.type)&&function(g){if(0!=g.length)kintone.events.on(p.changes.reduce(function(d,a){d.push("app.record.create.change."+a);d.push("app.record.edit.change."+a);d.push("mobile.app.record.create.change."+a);d.push("mobile.app.record.edit.change."+a);return d},[]),function(d){if(function(){var a=!0;["DATETIME","TIME"].includes(d.changes.field.type)&&
function(e){e&&(Array.isArray(e)?e:[e]).each(function(l,n){l.elm(".control-errors-content-gaia")&&(a=!1)})}(kb.field.get(c.fieldInfos.parallelize[d.type.split(".").last()],c.mobile,c.type));return a}())return v(g,d.record,"record").then(function(a){a.performed&&(c.mobile?kintone.mobile.app.record:kintone.app.record).set(d)})["catch"](function(){}),d});else f(b)}(JSON.parse(m.tab).reduce(function(g,d){(c.mobile?["both","mobile"]:["both","pc"]).includes(d.setting.device.value)&&d.setting.event.value.includes("change")&&
g.push(d.setting);return g},[])),function(g){if(0!=g.length)switch(c.type){case "create":case "edit":v(g,b.record,"record").then(function(a){return f(b)})["catch"](function(){});break;case "process":(function(a){0!=a.length?v(a,b.record,"record").then(function(e){return f(b)})["catch"](function(){}):f(b)})(g.filter(function(a){return a.action.value==b.action.value+":"+b.status.value+":"+b.nextStatus.value}));break;case "detail":var d=function(a){(function(e){kb.filter.scan(c.app,b.record,e.condition.value)?
kb.filter.auth(e.user.value,e.organization.value,e.group.value).then(function(l){l&&kb.button.create(c.mobile,c.type,"kb-action-button"+a.toString(),e.label.value,e.message.value,function(){v([e],b.record,"record").then(function(n){kb.view.records.set(c.app.id,{put:[kb.view.records.transform(n.record)]}).then(function(h){return kb.alert("Done!",function(){return window.location.reload(!0)})})["catch"](function(h){return kb.alert(kb.error.parse(h))})})["catch"](function(){})});a++;a<g.length&&d(a)})["catch"](function(l){a++;
a<g.length&&d(a)}):(a++,a<g.length&&d(a))})(g[a])};d(0);f(b);break;case "index":d=function(a){(function(e){kb.filter.auth(e.user.value,e.organization.value,e.group.value).then(function(l){l&&(e.view.value&&e.view.value!=b.viewId.toString()||kb.button.create(c.mobile,c.type,"kb-action-button"+a.toString(),e.label.value,e.message.value,function(){kb.view.records.get(c.app.id,(c.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(function(n){var h=[],w=function(k,q){v([e],n[k],"record").then(function(x){x.performed&&
h.push(kb.view.records.transform(x.record));kb.progressUpdate();k++;k<n.length?w(k,q):q()})["catch"](function(){})};0!=n.length?(kb.progressStart(n.length),w(0,function(){kb.view.records.set(c.app.id,{put:h}).then(function(k){return kb.alert("Done!",function(){return window.location.reload(!0)})})["catch"](function(k){return kb.alert(kb.error.parse(k))})})):kb.alert("There are no records.")})["catch"](function(n){return kb.alert(kb.error.parse(n))})}));a++;a<g.length&&d(a)})["catch"](function(l){a++;
a<g.length&&d(a)})})(g[a])},d(0),f(b)}else f(b)}(JSON.parse(m.tab).reduce(function(g,d){(c.mobile?["both","mobile"]:["both","pc"]).includes(d.setting.device.value)&&d.setting.event.value.includes(c.type)&&g.push(d.setting);return g},[]))}catch(g){kb.alert(kb.error.parse(g)),f(b)}})["catch"](function(p){return f(b)}):f(b)})["catch"](function(m){return f(b)})})("mobile"==b.type.split(".").first(),b.type.split(".").slice(-2).first())})});kb.event.on("kb.action.call",function(b){return new Promise(function(f,
y){kb.config[u].config.get().then(function(r){0!=Object.keys(r).length?kb.field.load(kb.config[u].app,!0).then(function(t){c.app={id:kb.config[u].app,fields:t.origin};c.fieldInfos=t;try{(function(m){0!=m.length?v(m,b.record,b.workplace?b.workplace:"record").then(function(p){return f(b)})["catch"](function(){}):f(b)})(JSON.parse(r.tab).reduce(function(m,p){(b.mobile?["both","mobile"]:["both","pc"]).includes(p.setting.device.value)&&p.setting.page.value.includes(b.pattern)&&m.push(p.setting);return m},
[]))}catch(m){kb.alert(kb.error.parse(m)),f(b)}})["catch"](function(t){return f(b)}):f(b)})["catch"](function(r){return f(b)})})})})(kintone.$PLUGIN_ID);