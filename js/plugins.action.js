/*
* FileName "plugins.action.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(K){var b={},M=function(d,f,D,L){return new Promise(function(J,u){var C=JSON.stringify(kb.record.simplify({fields:b.fieldInfos.origin},f)),v=function(p,g){var h=function(){p++;p<d.length?v(p,g):g()};(function(a){if(a.lookupApp){var m=kb.filter.scan(b.app,f,a.condition.value);m?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(function(F){if(F){var I={clear:function(y){try{a.clear.value.map(function(c){return c.value}).each(function(c,z){c.table.value in b.fieldInfos.tables&&
(f[c.table.value].value=f[c.table.value].value.filter(function(x){return!m[c.table.value].value.includes(x)}),m[c.table.value].value=[])}),y()}catch(c){kb.alert(kb.error.parse(c)),u()}},fill:function(y){try{a.fill.value.map(function(c){return c.value}).each(function(c,z){c.table.value in b.fieldInfos.tables&&function(x){x=kb.isNumeric(x)?parseInt(x)-m[c.table.value].value.length:0;0<x&&Array(x).fill().map(function(){return kb.record.create(b.fieldInfos.origin[c.table.value],!1)}).each(function(A,
n){f[c.table.value]==m[c.table.value]?f[c.table.value].value.push({value:A}):(f[c.table.value].value.push({value:A}),m[c.table.value].value.push({value:A}))})}(kb.formula.calculate({field:{value:Object.values(b.fieldInfos.parallelize).first().code},formula:c.range},m,m,f,b.fieldInfos.parallelize))}),y()}catch(c){kb.alert(kb.error.parse(c)),u()}},formula:function(y){try{a.formula.value.map(function(c){return c.value}).each(function(c,z){c.field.value in b.fieldInfos.parallelize&&function(x){x.tableCode?
m[x.tableCode].value.each(function(A,n){A.value[x.code].value=kb.formula.calculate(c,A.value,m,f,b.fieldInfos.parallelize);"lookup"==x.type&&(A.value[x.code].lookup=!0)}):(m[x.code].value=kb.formula.calculate(c,m,m,f,b.fieldInfos.parallelize),"lookup"==x.type&&(m[x.code].lookup=!0))}(b.fieldInfos.parallelize[c.field.value])}),y()}catch(c){kb.alert(kb.error.parse(c)),u()}},lookup:function(y){try{a.lookupApp.value?kb.field.load(a.lookupApp.value).then(function(c){(function(z){var x=[],A=[],n=function(q,
r){var k=function(t,l){return t.lookup?kb.extend({lookup:!0},l):l};kb.view.records.get(a.lookupApp.value,r.query,r.sort).then(function(t){0!=t.length?function(l){a.lookupLimited.value.includes("limited")||1==t.length?l(t.first()):b.picker.show({app:a.lookupApp.value,query:r.query,sort:r.sort,picker:x.reduce(function(w,e){w[e.external.code]=e.external;return w},{})},function(w){return l(w)})}(function(l){x.each(function(w,e){if(a.lookupOverwrite.value.includes("overwrite")||kb.field.isEmpty(r.record[w.internal.code].value))r.record[w.internal.code]=
k(w.internal,l[w.external.code])});q++;q<A.length?n(q,A[q]):(D.latest.action[a.sIndex.value].lookup=B(),y())}):(a.lookupReset.value.includes("reset")&&x.each(function(l,w){r.record[l.internal.code]=k(l.internal,kb.record.create({fields:{empty:l.internal}}).empty)}),q++,q<A.length?n(q,A[q]):(D.latest.action[a.sIndex.value].lookup=B(),y()))})["catch"](function(t){kb.alert(kb.error.parse(t));u()})},B=function(){return function(q){return JSON.stringify(A.reduce(function(r,k){r.push(k.query);r.push(kb.record.simplify({fields:q},
k.record));return r},[]))}(x.reduce(function(q,r){q[r.internal.code]=r.internal;return q},{}))};a.lookupCriteria.value.some(function(q){return!(q.value.external.value in z.external&&q.value.internal.value in z.internal)})?(kb.alert("No field to lookup was found"),u()):a.lookupMapping.value.some(function(q){return!(q.value.external.value in z.external&&q.value.internal.value in z.internal)})?(kb.alert("No field to lookup was found"),u()):(x=a.lookupMapping.value.map(function(q){return{external:z.external[q.value.external.value],
internal:z.internal[q.value.internal.value]}}),A=function(q){return q.map(function(r){return{query:a.lookupCriteria.value.reduce(function(k,t){var l=z.external[t.value.external.value],w=t.value.operator.value,e=z.internal[t.value.internal.value];var E=e.tableCode?r.value:f;a.lookupIgnore.value.includes("ignore")&&kb.field.isEmpty(E[e.code].value)||k.push(kb.filter.query.create(l,w,E[e.code]));return k},kb.filter.query.parse(a.lookupFilter.value).map(function(k){return z.external[k.field].code+" "+
k.operator+" "+k.value})).join(" and "),sort:(0!=a.lookupSort.value.length?a.lookupSort.value.map(function(k){return k.value.field.value+" "+k.value.order.value}):["$id asc"]).join(","),record:r.value}})}(function(q){return q?m[q].value:[{value:f}]}(Array.from(new Set(x.map(function(q){return q.internal.tableCode}))).first())),0!=A.length?D.latest.action[a.sIndex.value].lookup&&D.latest.action[a.sIndex.value].lookup==B()?y():n(0,A.first()):y())})({external:c.origin,internal:b.fieldInfos.parallelize})})["catch"](function(c){kb.alert(kb.error.parse(c));
u()}):y()}catch(c){kb.alert(kb.error.parse(c)),u()}},user:function(y){try{a.userSource.value?function(c){0==kb.roleSet.user.length?kb.roleSet.load().then(function(){return c()}):c()}(function(){var c=[],z=[],x=function(n,B){(function(r){c.each(function(k,t){if(k.isCustom)switch(k.field.type){case "USER_SELECT":k.value=r.reduce(function(l,w){"customItemValues"in w&&function(e){0!=e.length&&function(E){(function(G){0!=G.length&&(l.some(function(H){return H.code==G.first().info.code})||l.push({code:G.first().info.code,
name:G.first().info.name}))})(kb.roleSet.user.filter(function(G){return G.info.id==E}))}(e.first().value)}(w.customItemValues.filter(function(e){return e.code==k.item}));return Array.from(new Set(l)).filter(function(e){return e})},[]);break;default:k.value=r.reduce(function(l,w){"customItemValues"in w&&function(e){0!=e.length&&l.push(e.first().value)}(w.customItemValues.filter(function(e){return e.code==k.item}));return Array.from(new Set(l)).filter(function(e){return e})},[]).join(",")}else switch(k.item){case "groups":case "organizations":k.value=
r.map(function(l){return l.code});break;case "primaryOrganization":k.value=r.reduce(function(l,w){k.item in w&&function(e){0!=e.length&&(l.some(function(E){return E.code==e.first().info.code})||l.push({code:e.first().info.code,name:e.first().info.name}))}(kb.roleSet.organization.filter(function(e){return e.info.id==w[k.item]}));return l},[]);break;default:k.value=r.reduce(function(l,w){k.item in w&&l.push(w[k.item]);return Array.from(new Set(l)).filter(function(e){return e})},[]).join(",")}})})(B[a.userSource.value].value.reduce(function(r,
k){(function(t){0!=t.length&&r.push(t.first().info)})(kb.roleSet.user.filter(function(t){return t.info.code==k.code}));return r},[]));var q=function(r,k){(function(t,l){var w=function(e,E,G){switch(t.item){case "groups":kintone.api(kintone.api.url("/v1/user/groups",!0),"GET",{code:t.value[e]}).then(function(H){H.groups&&(E=E.concat(H.groups.map(function(N){return{code:N.code,name:N.name}})),e++,e<t.value.length?w(e,E,G):G(E))})["catch"](function(H){kb.alert(kb.error.parse(H));u()});break;case "organizations":kintone.api(kintone.api.url("/v1/user/organizations",
!0),"GET",{code:t.value[e]}).then(function(H){H.organizationTitles&&(E=E.concat(H.organizationTitles.map(function(N){return{code:N.organization.code,name:N.organization.name}})),e++,e<t.value.length?w(e,E,G):G(E))})["catch"](function(H){kb.alert(kb.error.parse(H));u()})}};a.userOverwrite.value.includes("overwrite")||kb.field.isEmpty(B[t.field.code].value)||l();switch(t.item){case "groups":case "organizations":0!=t.value.length?w(0,[],function(e){B[t.field.code].value=e;l()}):(B[t.field.code].value=
t.value,l());break;default:B[t.field.code].value=t.value,l()}})(c[r],function(){r++;r<c.length?q(r,k):k()})};q(0,function(){n++;n<z.length?x(n,z[n]):(D.latest.action[a.sIndex.value].user=A(),y())})},A=function(){return function(n){return JSON.stringify(z.map(function(B){return kb.record.simplify({fields:n},B)}))}(c.reduce(function(n,B){n[B.field.code]=B.field;return n},function(n){var B={};B[n]=b.fieldInfos.parallelize[n];return B}(a.userSource.value)))};a.userCustomItem.value.some(function(n){return!(n.value.field.value in
b.fieldInfos.parallelize)})?(kb.alert("No field to user informations was found"),u()):a.userMapping.value.some(function(n){return!(n.value.field.value in b.fieldInfos.parallelize)})?(kb.alert("No field to user informations was found"),u()):(a.userCustomItem.value.each(function(n,B){c.push({isCustom:!0,item:n.value.item.value,field:b.fieldInfos.parallelize[n.value.field.value],value:[]})}),a.userMapping.value.each(function(n,B){c.push({isCustom:!1,item:n.value.item.value,field:b.fieldInfos.parallelize[n.value.field.value],
value:[]})}),a.userPrimaryOrganization.value&&a.userPrimaryOrganization.value in b.fieldInfos.parallelize&&c.push({isCustom:!1,item:"primaryOrganization",field:b.fieldInfos.parallelize[a.userPrimaryOrganization.value],value:[]}),a.userOrganization.value&&a.userOrganization.value in b.fieldInfos.parallelize&&c.push({isCustom:!1,item:"organizations",field:b.fieldInfos.parallelize[a.userOrganization.value],value:[]}),a.userGroup.value&&a.userGroup.value in b.fieldInfos.parallelize&&c.push({isCustom:!1,
item:"groups",field:b.fieldInfos.parallelize[a.userGroup.value],value:[]}),z=function(n){return n?m[n].value:[{value:f}]}(b.fieldInfos.parallelize[a.userSource.value].tableCode).map(function(n){return n.value}),0!=z.length?D.latest.action[a.sIndex.value].user&&D.latest.action[a.sIndex.value].user==A()?y():0!=c.length?x(0,z.first()):y():y())}):y()}catch(c){kb.alert(kb.error.parse(c)),u()}}};I.clear(function(){I.fill(function(){I.formula(function(){I.lookup(function(){I.user(function(){h()})})})})})}else h()})["catch"](function(F){kb.alert(kb.error.parse(F));
u()}):h()}else kb.alert(kb.error.config.update("Boost! Action")),J({record:f,performed:!1}),g()})(function(a){D.latest?D.latest.action||(D.latest.action={}):D.latest={action:{}};a.sIndex.value in D.latest.action||(D.latest.action[a.sIndex.value]={lookup:"[]",user:"[]"});return a}(d[p]))};v(0,function(){J({record:f,performed:C!=JSON.stringify(kb.record.simplify({fields:b.fieldInfos.origin},f))})})})};kintone.events.on("app.record.create.show app.record.detail.process.proceed app.record.detail.show app.record.edit.show app.record.index.show mobile.app.record.create.show mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.show mobile.app.record.index.show".split(" "),
function(d){return new Promise(function(f,D){(function(L,J){b.mobile=L;b.type=J;kb.config[K].config.get().then(function(u){0!=Object.keys(u).length?kb.field.load(kb.config[K].app,!0).then(function(C){b.app={id:kb.config[K].app,fields:C.origin};b.fieldInfos=C;b.picker=new KintoneBoosterRecordPicker("record");try{["create","edit","reuse"].includes(b.type)&&function(v){if(0!=v.length){var p="",g=null;kintone.events.on(C.changes.reduce(function(h,a){h.push("app.record.create.change."+a);h.push("app.record.edit.change."+
a);h.push("mobile.app.record.create.change."+a);h.push("mobile.app.record.edit.change."+a);return h},[]),function(h){if(function(){var a=!0;p&&(a=!1,p==JSON.stringify(kb.record.simplify({fields:C.origin},h.record))?(p="",g=null):g<(new Date).getTime()-5E3&&(p="",g=null,a=!0));a&&["DATETIME","TIME"].includes(h.changes.field.type)&&function(m){m&&(Array.isArray(m)?m:[m]).each(function(F,I){F.elm(".control-errors-content-gaia")&&(a=!1)})}(kb.field.get(C.parallelize[h.type.split(".").last()],b.mobile,
b.type));return a}())return M(v,h.record,kb.elm("body"),"record").then(function(a){kb.event.call("kb.style.call",{container:kb.elm("body"),record:h.record,mobile:b.mobile,pattern:"reuse"==b.type?"create":b.type,workplace:"record"}).then(function(m){if(a.performed||m.performed)a.performed?(p=JSON.stringify(kb.record.simplify({fields:C.origin},m.record)),g=(new Date).getTime()):(p="",g=null),(b.mobile?kintone.mobile.app.record:kintone.app.record).set(h)})["catch"](function(){})})["catch"](function(){}),
h})}else f(d)}((b.config?b.config:b.config=JSON.parse(u.tab)).map(function(v,p){return kb.extend({sIndex:{value:p.toString()}},v)}).reduce(function(v,p){(b.mobile?["both","mobile"]:["both","pc"]).includes(p.setting.device.value)&&p.setting.event.value.includes("change")&&v.push(p.setting);return v},[])),function(v){if(0!=v.length)switch(b.type){case "create":case "edit":case "reuse":M(v,d.record,kb.elm("body"),"record").then(function(g){return f(d)})["catch"](function(){});break;case "process":(function(g){0!=
g.length?M(g,d.record,kb.elm("body"),"record").then(function(h){return f(d)})["catch"](function(){}):f(d)})(v.filter(function(g){return g.action.value==d.action.value+":"+d.status.value+":"+d.nextStatus.value}));break;case "detail":var p=function(g){(function(h){kb.filter.scan(b.app,d.record,h.condition.value)?kb.filter.auth(h.user.value,h.organization.value,h.group.value).then(function(a){a&&kb.button.create(b.mobile,b.type,"kb-action-button"+g.toString(),h.label.value,h.message.value,function(){M([h],
d.record,kb.elm("body"),"record").then(function(m){kb.view.records.set(b.app.id,{put:[kb.view.records.transform(m.record)]}).then(function(F){return kb.alert("Done!",function(){return window.location.reload(!0)})})["catch"](function(F){return kb.alert(kb.error.parse(F))})})["catch"](function(){})});g++;g<v.length&&p(g)})["catch"](function(a){g++;g<v.length&&p(g)}):(g++,g<v.length&&p(g))})(v[g])};p(0);f(d);break;case "index":p=function(g){(function(h){kb.filter.auth(h.user.value,h.organization.value,
h.group.value).then(function(a){a&&(h.view.value&&h.view.value!=d.viewId.toString()||kb.button.create(b.mobile,b.type,"kb-action-button"+g.toString(),h.label.value,h.message.value,function(){kb.view.records.get(b.app.id,(b.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(function(m){var F=[],I=function(y,c){M([h],m[y],kb.create("div"),"record").then(function(z){z.performed&&F.push(kb.view.records.transform(z.record));kb.progressUpdate();y++;y<m.length?I(y,c):c()})["catch"](function(){})};
0!=m.length?(kb.progressStart(m.length),I(0,function(){kb.view.records.set(b.app.id,{put:F}).then(function(y){return kb.alert("Done!",function(){return window.location.reload(!0)})})["catch"](function(y){return kb.alert(kb.error.parse(y))})})):kb.alert("There are no records.")})["catch"](function(m){return kb.alert(kb.error.parse(m))})}));g++;g<v.length&&p(g)})["catch"](function(a){g++;g<v.length&&p(g)})})(v[g])},p(0),f(d)}else f(d)}((b.config?b.config:b.config=JSON.parse(u.tab)).map(function(v,p){return kb.extend({sIndex:{value:p.toString()}},
v)}).reduce(function(v,p){(b.mobile?["both","mobile"]:["both","pc"]).includes(p.setting.device.value)&&p.setting.event.value.includes(b.type)&&v.push(p.setting);return v},[]))}catch(v){kb.alert(kb.error.parse(v)),f(d)}})["catch"](function(C){return f(d)}):f(d)})["catch"](function(u){return f(d)})})("mobile"==d.type.split(".").first(),d.reuse?"reuse":d.type.split(".").slice(-2).first())})});kb.event.on("kb.action.call",function(d){return new Promise(function(f,D){kb.config[K].config.get().then(function(L){0!=
Object.keys(L).length?kb.field.load(kb.config[K].app,!0).then(function(J){b.app={id:kb.config[K].app,fields:J.origin};b.fieldInfos=J;b.picker=new KintoneBoosterRecordPicker("record");try{(function(u){0!=u.length?M(u,d.record,d.container,d.workplace?d.workplace:"record").then(function(C){d.performed=C.performed;f(d)})["catch"](function(){return f(d)}):f(d)})((b.config?b.config:b.config=JSON.parse(L.tab)).map(function(u,C){return kb.extend({sIndex:{value:C.toString()}},u)}).reduce(function(u,C){(d.mobile?
["both","mobile"]:["both","pc"]).includes(C.setting.device.value)&&C.setting.event.value.includes(d.pattern)&&u.push(C.setting);return u},[]))}catch(u){kb.alert(kb.error.parse(u)),f(d)}})["catch"](function(J){return f(d)}):f(d)})["catch"](function(L){return f(d)})})});kb.event.on("kb.action.installed",function(d){return{installed:b.config.some(function(f){return(d.mobile?["both","mobile"]:["both","pc"]).includes(f.setting.device.value)&&f.setting.event.value.includes("change")})}})})(kintone.$PLUGIN_ID);