/*
* FileName "plugins.action.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(K){var b={},L=function(d,f,N){var I=!1;return new Promise(function(J,u){var C=function(v,x){var l=JSON.stringify(kb.record.simplify({fields:b.fieldInfos.origin},f)),g=function(){l!=JSON.stringify(kb.record.simplify({fields:b.fieldInfos.origin},f))&&(I=!0);v++;v<d.length?C(v,x):x()};(function(a){var m=kb.filter.scan(b.app,f,a.condition.value);m?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(function(E){if(E){var H={clear:function(y){try{a.clear.value.map(function(c){return c.value}).each(function(c,
z){c.table.value in b.fieldInfos.tables&&(f[c.table.value].value=f[c.table.value].value.filter(function(w){return!m[c.table.value].value.includes(w)}),m[c.table.value].value=[])}),y()}catch(c){kb.alert(kb.error.parse(c)),u()}},fill:function(y){try{a.fill.value.map(function(c){return c.value}).each(function(c,z){c.table.value in b.fieldInfos.tables&&function(w){w=kb.isNumeric(w)?parseInt(w)-m[c.table.value].value.length:0;0<w&&Array(w).fill().map(function(){return kb.record.create(b.fieldInfos.origin[c.table.value],
!1)}).each(function(A,n){f[c.table.value]==m[c.table.value]?f[c.table.value].value.push({value:A}):(f[c.table.value].value.push({value:A}),m[c.table.value].value.push({value:A}))})}(kb.formula.calculate({field:{value:Object.values(b.fieldInfos.parallelize).first().code},formula:c.range},m,m,f,b.fieldInfos.parallelize))}),y()}catch(c){kb.alert(kb.error.parse(c)),u()}},formula:function(y){try{a.formula.value.map(function(c){return c.value}).each(function(c,z){c.field.value in b.fieldInfos.parallelize&&
function(w){w.tableCode?m[w.tableCode].value.each(function(A,n){A.value[w.code].value=kb.formula.calculate(c,A.value,m,f,b.fieldInfos.parallelize);"lookup"==w.type&&(A.value[w.code].lookup=!0)}):(m[w.code].value=kb.formula.calculate(c,m,m,f,b.fieldInfos.parallelize),"lookup"==w.type&&(m[w.code].lookup=!0))}(b.fieldInfos.parallelize[c.field.value])}),y()}catch(c){kb.alert(kb.error.parse(c)),u()}},lookup:function(y){try{a.lookupApp.value?kb.field.load(a.lookupApp.value).then(function(c){(function(z){var w=
[],A=[],n=function(p,q){var h=function(r,k){return r.lookup?kb.extend({lookup:!0},k):k};kb.view.records.get(a.lookupApp.value,q.query,q.sort).then(function(r){0!=r.length?function(k){a.lookupLimited.value.includes("limited")||1==r.length?k(r.first()):b.picker.show({app:a.lookupApp.value,query:q.query,sort:q.sort,picker:w.reduce(function(t,e){t[e.external.code]=e.external;return t},{})},function(t){return k(t)})}(function(k){w.each(function(t,e){if(a.lookupOverwrite.value.includes("overwrite")||kb.field.isEmpty(q.record[t.internal.code].value))q.record[t.internal.code]=
h(t.internal,k[t.external.code])});p++;p<A.length?n(p,A[p]):(a.latest.lookup=B(),y())}):(a.lookupReset.value.includes("reset")&&w.each(function(k,t){q.record[k.internal.code]=h(k.internal,kb.record.create({fields:{empty:k.internal}}).empty)}),p++,p<A.length?n(p,A[p]):(a.latest.lookup=B(),y()))})["catch"](function(r){kb.alert(kb.error.parse(r));u()})},B=function(){return function(p){return JSON.stringify(A.reduce(function(q,h){q.push(h.query);q.push(kb.record.simplify({fields:p},h.record));return q},
[]))}(w.reduce(function(p,q){p[q.internal.code]=q.internal;return p},{}))};a.lookupCriteria.value.some(function(p){return!(p.value.external.value in z.external&&p.value.internal.value in z.internal)})?(kb.alert("No field to lookup was found"),u()):a.lookupMapping.value.some(function(p){return!(p.value.external.value in z.external&&p.value.internal.value in z.internal)})?(kb.alert("No field to lookup was found"),u()):(w=a.lookupMapping.value.map(function(p){return{external:z.external[p.value.external.value],
internal:z.internal[p.value.internal.value]}}),A=function(p){return p.map(function(q){return{query:a.lookupCriteria.value.reduce(function(h,r){var k=z.external[r.value.external.value],t=r.value.operator.value,e=z.internal[r.value.internal.value];var D=e.tableCode?q.value:f;a.lookupIgnore.value.includes("ignore")&&kb.field.isEmpty(D[e.code].value)||h.push(kb.filter.query.create(k,t,D[e.code]));return h},kb.filter.query.parse(a.lookupFilter.value).map(function(h){return z.external[h.field].code+" "+
h.operator+" "+h.value})).join(" and "),sort:(0!=a.lookupSort.value.length?a.lookupSort.value.map(function(h){return h.value.field.value+" "+h.value.order.value}):["$id asc"]).join(","),record:q.value}})}(function(p){return p?m[p].value:[{value:f}]}(Array.from(new Set(w.map(function(p){return p.internal.tableCode}))).first())),0!=A.length?a.latest.lookup&&a.latest.lookup==B()?y():n(0,A.first()):y())})({external:c.origin,internal:b.fieldInfos.parallelize})})["catch"](function(c){kb.alert(kb.error.parse(c));
u()}):y()}catch(c){kb.alert(kb.error.parse(c)),u()}},user:function(y){try{a.userSource.value?function(c){0==kb.roleSet.user.length?kb.roleSet.load().then(function(){return c()}):c()}(function(){var c=[],z=[],w=function(n,B){(function(q){c.each(function(h,r){if(h.isCustom)switch(h.field.type){case "USER_SELECT":h.value=q.reduce(function(k,t){"customItemValues"in t&&function(e){0!=e.length&&function(D){(function(F){0!=F.length&&(k.some(function(G){return G.code==F.first().info.code})||k.push({code:F.first().info.code,
name:F.first().info.name}))})(kb.roleSet.user.filter(function(F){return F.info.id==D}))}(e.first().value)}(t.customItemValues.filter(function(e){return e.code==h.item}));return Array.from(new Set(k)).filter(function(e){return e})},[]);break;default:h.value=q.reduce(function(k,t){"customItemValues"in t&&function(e){0!=e.length&&k.push(e.first().value)}(t.customItemValues.filter(function(e){return e.code==h.item}));return Array.from(new Set(k)).filter(function(e){return e})},[]).join(",")}else switch(h.item){case "groups":case "organizations":h.value=
q.map(function(k){return k.code});break;case "primaryOrganization":h.value=q.reduce(function(k,t){h.item in t&&function(e){0!=e.length&&(k.some(function(D){return D.code==e.first().info.code})||k.push({code:e.first().info.code,name:e.first().info.name}))}(kb.roleSet.organization.filter(function(e){return e.info.id==t[h.item]}));return k},[]);break;default:h.value=q.reduce(function(k,t){h.item in t&&k.push(t[h.item]);return Array.from(new Set(k)).filter(function(e){return e})},[]).join(",")}})})(B[a.userSource.value].value.reduce(function(q,
h){(function(r){0!=r.length&&q.push(r.first().info)})(kb.roleSet.user.filter(function(r){return r.info.code==h.code}));return q},[]));var p=function(q,h){(function(r,k){var t=function(e,D,F){switch(r.item){case "groups":kintone.api(kintone.api.url("/v1/user/groups",!0),"GET",{code:r.value[e]}).then(function(G){G.groups&&(D=D.concat(G.groups.map(function(M){return{code:M.code,name:M.name}})),e++,e<r.value.length?t(e,D,F):F(D))})["catch"](function(G){kb.alert(kb.error.parse(G));u()});break;case "organizations":kintone.api(kintone.api.url("/v1/user/organizations",
!0),"GET",{code:r.value[e]}).then(function(G){G.organizationTitles&&(D=D.concat(G.organizationTitles.map(function(M){return{code:M.organization.code,name:M.organization.name}})),e++,e<r.value.length?t(e,D,F):F(D))})["catch"](function(G){kb.alert(kb.error.parse(G));u()})}};a.userOverwrite.value.includes("overwrite")||kb.field.isEmpty(B[r.field.code].value)||k();switch(r.item){case "groups":case "organizations":0!=r.value.length?t(0,[],function(e){B[r.field.code].value=e;k()}):(B[r.field.code].value=
r.value,k());break;default:B[r.field.code].value=r.value,k()}})(c[q],function(){q++;q<c.length?p(q,h):h()})};p(0,function(){n++;n<z.length?w(n,z[n]):(a.latest.user=A(),y())})},A=function(){return function(n){return JSON.stringify(z.map(function(B){return kb.record.simplify({fields:n},B)}))}(c.reduce(function(n,B){n[B.field.code]=B.field;return n},function(n){var B={};B[n]=b.fieldInfos.parallelize[n];return B}(a.userSource.value)))};a.userCustomItem.value.some(function(n){return!(n.value.field.value in
b.fieldInfos.parallelize)})?(kb.alert("No field to user informations was found"),u()):a.userMapping.value.some(function(n){return!(n.value.field.value in b.fieldInfos.parallelize)})?(kb.alert("No field to user informations was found"),u()):(a.userCustomItem.value.each(function(n,B){c.push({isCustom:!0,item:n.value.item.value,field:b.fieldInfos.parallelize[n.value.field.value],value:[]})}),a.userMapping.value.each(function(n,B){c.push({isCustom:!1,item:n.value.item.value,field:b.fieldInfos.parallelize[n.value.field.value],
value:[]})}),a.userPrimaryOrganization.value&&a.userPrimaryOrganization.value in b.fieldInfos.parallelize&&c.push({isCustom:!1,item:"primaryOrganization",field:b.fieldInfos.parallelize[a.userPrimaryOrganization.value],value:[]}),a.userOrganization.value&&a.userOrganization.value in b.fieldInfos.parallelize&&c.push({isCustom:!1,item:"organizations",field:b.fieldInfos.parallelize[a.userOrganization.value],value:[]}),a.userGroup.value&&a.userGroup.value in b.fieldInfos.parallelize&&c.push({isCustom:!1,
item:"groups",field:b.fieldInfos.parallelize[a.userGroup.value],value:[]}),z=function(n){return n?m[n].value:[{value:f}]}(b.fieldInfos.parallelize[a.userSource.value].tableCode).map(function(n){return n.value}),0!=z.length?a.latest.user&&a.latest.user==A()?y():0!=c.length?w(0,z.first()):y():y())}):y()}catch(c){kb.alert(kb.error.parse(c)),u()}}};H.clear(function(){H.fill(function(){H.formula(function(){H.lookup(function(){H.user(function(){g()})})})})})}else g()})["catch"](function(E){kb.alert(kb.error.parse(E));
u()}):g()})(function(a){a.lookupApp||(kb.alert(kb.error.config.update("Boost! Action")),J({record:f,performed:!1}));a.latest||(a.latest={});return a}(d[v]))};C(0,function(){J({record:f,performed:I})})})};kintone.events.on("app.record.create.show app.record.detail.process.proceed app.record.detail.show app.record.edit.show app.record.index.show mobile.app.record.create.show mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.show mobile.app.record.index.show".split(" "),
function(d){return new Promise(function(f,N){(function(I,J){b.mobile=I;b.type=J;kb.config[K].config.get().then(function(u){0!=Object.keys(u).length?kb.field.load(kb.config[K].app,!0).then(function(C){b.app={id:kb.config[K].app,fields:C.origin};b.fieldInfos=C;b.picker=new KintoneBoosterRecordPicker("record");try{["create","edit","reuse"].includes(b.type)&&function(v){if(0!=v.length){var x="",l=null;kintone.events.on(C.changes.reduce(function(g,a){g.push("app.record.create.change."+a);g.push("app.record.edit.change."+
a);g.push("mobile.app.record.create.change."+a);g.push("mobile.app.record.edit.change."+a);return g},[]),function(g){if(function(){var a=!0;x&&(a=!1,x==JSON.stringify(kb.record.simplify({fields:C.origin},g.record))?(x="",l=null):l<(new Date).getTime()-5E3&&(x="",l=null,a=!0));a&&["DATETIME","TIME"].includes(g.changes.field.type)&&function(m){m&&(Array.isArray(m)?m:[m]).each(function(E,H){E.elm(".control-errors-content-gaia")&&(a=!1)})}(kb.field.get(C.parallelize[g.type.split(".").last()],b.mobile,
b.type));return a}())return L(v,g.record,"record").then(function(a){kb.event.call("kb.style.call",{record:g.record,mobile:b.mobile,pattern:"reuse"==b.type?"create":b.type,workplace:"record"}).then(function(m){if(a.performed||m.performed)x=JSON.stringify(kb.record.simplify({fields:C.origin},m.record)),l=(new Date).getTime(),(b.mobile?kintone.mobile.app.record:kintone.app.record).set(g)})["catch"](function(){})})["catch"](function(){}),g})}else f(d)}((b.config?b.config:b.config=JSON.parse(u.tab)).reduce(function(v,
x){(b.mobile?["both","mobile"]:["both","pc"]).includes(x.setting.device.value)&&x.setting.event.value.includes("change")&&v.push(x.setting);return v},[])),function(v){if(0!=v.length)switch(b.type){case "create":case "edit":case "reuse":L(v,d.record,"record").then(function(l){return f(d)})["catch"](function(){});break;case "process":(function(l){0!=l.length?L(l,d.record,"record").then(function(g){return f(d)})["catch"](function(){}):f(d)})(v.filter(function(l){return l.action.value==d.action.value+
":"+d.status.value+":"+d.nextStatus.value}));break;case "detail":var x=function(l){(function(g){kb.filter.scan(b.app,d.record,g.condition.value)?kb.filter.auth(g.user.value,g.organization.value,g.group.value).then(function(a){a&&kb.button.create(b.mobile,b.type,"kb-action-button"+l.toString(),g.label.value,g.message.value,function(){L([g],d.record,"record").then(function(m){kb.view.records.set(b.app.id,{put:[kb.view.records.transform(m.record)]}).then(function(E){return kb.alert("Done!",function(){return window.location.reload(!0)})})["catch"](function(E){return kb.alert(kb.error.parse(E))})})["catch"](function(){})});
l++;l<v.length&&x(l)})["catch"](function(a){l++;l<v.length&&x(l)}):(l++,l<v.length&&x(l))})(v[l])};x(0);f(d);break;case "index":x=function(l){(function(g){kb.filter.auth(g.user.value,g.organization.value,g.group.value).then(function(a){a&&(g.view.value&&g.view.value!=d.viewId.toString()||kb.button.create(b.mobile,b.type,"kb-action-button"+l.toString(),g.label.value,g.message.value,function(){kb.view.records.get(b.app.id,(b.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(function(m){var E=
[],H=function(y,c){L([g],m[y],"record").then(function(z){z.performed&&E.push(kb.view.records.transform(z.record));kb.progressUpdate();y++;y<m.length?H(y,c):c()})["catch"](function(){})};0!=m.length?(kb.progressStart(m.length),H(0,function(){kb.view.records.set(b.app.id,{put:E}).then(function(y){return kb.alert("Done!",function(){return window.location.reload(!0)})})["catch"](function(y){return kb.alert(kb.error.parse(y))})})):kb.alert("There are no records.")})["catch"](function(m){return kb.alert(kb.error.parse(m))})}));
l++;l<v.length&&x(l)})["catch"](function(a){l++;l<v.length&&x(l)})})(v[l])},x(0),f(d)}else f(d)}((b.config?b.config:b.config=JSON.parse(u.tab)).reduce(function(v,x){(b.mobile?["both","mobile"]:["both","pc"]).includes(x.setting.device.value)&&x.setting.event.value.includes(b.type)&&v.push(x.setting);return v},[]))}catch(v){kb.alert(kb.error.parse(v)),f(d)}})["catch"](function(C){return f(d)}):f(d)})["catch"](function(u){return f(d)})})("mobile"==d.type.split(".").first(),d.reuse?"reuse":d.type.split(".").slice(-2).first())})});
kb.event.on("kb.action.call",function(d){return new Promise(function(f,N){kb.config[K].config.get().then(function(I){0!=Object.keys(I).length?kb.field.load(kb.config[K].app,!0).then(function(J){b.app={id:kb.config[K].app,fields:J.origin};b.fieldInfos=J;b.picker=new KintoneBoosterRecordPicker("record");try{(function(u){0!=u.length?L(u,d.record,d.workplace?d.workplace:"record").then(function(C){d.performed=C.performed;f(d)})["catch"](function(){return f(d)}):f(d)})((b.config?b.config:b.config=JSON.parse(I.tab)).reduce(function(u,
C){(d.mobile?["both","mobile"]:["both","pc"]).includes(C.setting.device.value)&&C.setting.event.value.includes(d.pattern)&&u.push(C.setting);return u},[]))}catch(u){kb.alert(kb.error.parse(u)),f(d)}})["catch"](function(J){return f(d)}):f(d)})["catch"](function(I){return f(d)})})});kb.event.on("kb.action.installed",function(d){return{installed:b.config.some(function(f){return(d.mobile?["both","mobile"]:["both","pc"]).includes(f.setting.device.value)&&f.setting.event.value.includes("change")})}})})(kintone.$PLUGIN_ID);