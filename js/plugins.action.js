/*
* FileName "plugins.action.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(D){var b={},E=function(c,f,G){var x=!1;return new Promise(function(B,q){var t=function(l,m){var d=function(){l++;l<c.length?t(l,m):m()};(function(a){var g=kb.filter.scan(b.app,f,a.condition.value);g?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(function(n){n?(a.clear.value.map(function(e){return e.value}).each(function(e,u){e.table.value in b.fieldInfos.tables&&(f[e.table.value].value=f[e.table.value].value.filter(function(h){return!g[e.table.value].value.includes(h)}),
g[e.table.value].value=[],x=!0)}),a.fill.value.map(function(e){return e.value}).each(function(e,u){e.table.value in b.fieldInfos.tables&&(function(h){h=kb.isNumeric(h)?parseInt(h)-g[e.table.value].value.length:0;0<h&&Array(h).fill().map(function(){return kb.record.create(b.fieldInfos.origin[e.table.value],!1)}).each(function(p,A){f[e.table.value]==g[e.table.value]?f[e.table.value].value.push({value:p}):(f[e.table.value].value.push({value:p}),g[e.table.value].value.push({value:p}))})}(kb.formula.calculate({field:{value:Object.values(b.fieldInfos.parallelize).first().code},
formula:e.range},g,g,f,b.fieldInfos.parallelize)),x=!0)}),a.formula.value.map(function(e){return e.value}).each(function(e,u){e.field.value in b.fieldInfos.parallelize&&function(h){h.tableCode?g[h.tableCode].value.each(function(p,A){p.value[h.code].value=kb.formula.calculate(e,p.value,g,f,b.fieldInfos.parallelize);"lookup"==h.type&&(p.value[h.code].lookup=!0)}):(g[h.code].value=kb.formula.calculate(e,g,g,f,b.fieldInfos.parallelize),"lookup"==h.type&&(g[h.code].lookup=!0));x=!0}(b.fieldInfos.parallelize[e.field.value])}),
a.app.value?kb.field.load(a.app.value).then(function(e){(function(u){var h=[],p=[],A=function(k,r){var v=function(z,w){return z.lookup?kb.extend({lookup:!0},w):w};kb.view.records.get(a.app.value,r.query,r.sort).then(function(z){0!=z.length?function(w){a.limited.value.includes("limited")||1==z.length?w(z.first()):b.picker.show({app:a.app.value,query:r.query,sort:r.sort,picker:h.reduce(function(y,C){y[C.external.code]=C.external;return y},{})},function(y){return w(y)})}(function(w){h.each(function(y,
C){if(a.overwrite.value.includes("overwrite")||kb.field.isEmpty(r.record[y.internal.code].value))r.record[y.internal.code]=v(y.internal,w[y.external.code])});x=!0;k++;k<p.length?A(k,p[k]):(a.latest=F(),d())}):(a.reset.value.includes("reset")&&(h.each(function(w,y){r.record[w.internal.code]=v(w.internal,kb.record.create({fields:{empty:w.internal}}).empty)}),x=!0),k++,k<p.length?A(k,p[k]):(a.latest=F(),d()))})["catch"](function(z){kb.alert(kb.error.parse(z));q()})},F=function(){return function(k){return JSON.stringify(p.reduce(function(r,
v){r.push(v.query);r.push(kb.record.simplify({fields:k},v.record));return r},[]))}(h.reduce(function(k,r){k[r.internal.code]=r.internal;return k},{}))};a.criteria.value.some(function(k){return!(k.value.external.value in u.external&&k.value.internal.value in u.internal)})?(kb.alert("No field to lookup was found"),q()):a.mapping.value.some(function(k){return!(k.value.external.value in u.external&&k.value.internal.value in u.internal)})?(kb.alert("No field to lookup was found"),q()):(h=a.mapping.value.map(function(k){return{external:u.external[k.value.external.value],
internal:u.internal[k.value.internal.value]}}),p=function(k){return k.map(function(r){return{query:a.criteria.value.reduce(function(v,z){var w=u.external[z.value.external.value],y=z.value.operator.value,C=u.internal[z.value.internal.value];var H=C.tableCode?r.value:f;a.ignore.value.includes("ignore")&&kb.field.isEmpty(H[C.code].value)||v.push(kb.filter.query.create(w,y,H[C.code]));return v},kb.filter.query.parse(a.filter.value).map(function(v){return u.external[v.field].code+" "+v.operator+" "+v.value})).join(" and "),
sort:(0!=a.sort.value.length?a.sort.value.map(function(v){return v.value.field.value+" "+v.value.order.value}):["$id asc"]).join(","),record:r.value}})}(function(k){return k?g[k].value:[{value:f}]}(Array.from(new Set(h.map(function(k){return k.internal.tableCode}))).first())),0!=p.length?a.latest&&a.latest==F()?d():A(0,p.first()):d())})({external:e.origin,internal:b.fieldInfos.parallelize})})["catch"](function(e){kb.alert(kb.error.parse(e));q()}):d()):d()})["catch"](function(n){kb.alert(kb.error.parse(n));
q()}):d()})(c[l])};t(0,function(){B({record:f,performed:x})})})};kintone.events.on("app.record.create.show app.record.detail.process.proceed app.record.detail.show app.record.edit.show app.record.index.show mobile.app.record.create.show mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.show mobile.app.record.index.show".split(" "),function(c){return new Promise(function(f,G){(function(x,B){b.mobile=x;b.type=B;kb.config[D].config.get().then(function(q){0!=
Object.keys(q).length?kb.field.load(kb.config[D].app,!0).then(function(t){b.app={id:kb.config[D].app,fields:t.origin};b.fieldInfos=t;b.picker=new KintoneBoosterRecordPicker("record");try{["create","edit","reuse"].includes(b.type)&&function(l){if(0!=l.length){var m="",d=null;kintone.events.on(t.changes.reduce(function(a,g){a.push("app.record.create.change."+g);a.push("app.record.edit.change."+g);a.push("mobile.app.record.create.change."+g);a.push("mobile.app.record.edit.change."+g);return a},[]),function(a){if(function(){var g=
!0;m&&(g=!1,m==JSON.stringify(kb.record.simplify({fields:t.origin},a.record))?(m="",d=null):d<(new Date).getTime()-5E3&&(m="",d=null,g=!0));g&&["DATETIME","TIME"].includes(a.changes.field.type)&&function(n){n&&(Array.isArray(n)?n:[n]).each(function(e,u){e.elm(".control-errors-content-gaia")&&(g=!1)})}(kb.field.get(t.parallelize[a.type.split(".").last()],b.mobile,b.type));return g}())return E(l,a.record,"record").then(function(g){kb.event.call("kb.style.call",{record:a.record,mobile:b.mobile,pattern:"reuse"==
b.type?"create":b.type,workplace:"record"}).then(function(n){if(g.performed||n.performed)m=JSON.stringify(kb.record.simplify({fields:t.origin},n.record)),d=(new Date).getTime(),(b.mobile?kintone.mobile.app.record:kintone.app.record).set(a)})["catch"](function(){})})["catch"](function(){}),a})}else f(c)}((b.config?b.config:b.config=JSON.parse(q.tab)).reduce(function(l,m){(b.mobile?["both","mobile"]:["both","pc"]).includes(m.setting.device.value)&&m.setting.event.value.includes("change")&&l.push(m.setting);
return l},[])),function(l){if(0!=l.length)switch(b.type){case "create":case "edit":case "reuse":E(l,c.record,"record").then(function(d){return f(c)})["catch"](function(){});break;case "process":(function(d){0!=d.length?E(d,c.record,"record").then(function(a){return f(c)})["catch"](function(){}):f(c)})(l.filter(function(d){return d.action.value==c.action.value+":"+c.status.value+":"+c.nextStatus.value}));break;case "detail":var m=function(d){(function(a){kb.filter.scan(b.app,c.record,a.condition.value)?
kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(function(g){g&&kb.button.create(b.mobile,b.type,"kb-action-button"+d.toString(),a.label.value,a.message.value,function(){E([a],c.record,"record").then(function(n){kb.view.records.set(b.app.id,{put:[kb.view.records.transform(n.record)]}).then(function(e){return kb.alert("Done!",function(){return window.location.reload(!0)})})["catch"](function(e){return kb.alert(kb.error.parse(e))})})["catch"](function(){})});d++;d<l.length&&m(d)})["catch"](function(g){d++;
d<l.length&&m(d)}):(d++,d<l.length&&m(d))})(l[d])};m(0);f(c);break;case "index":m=function(d){(function(a){kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(function(g){g&&(a.view.value&&a.view.value!=c.viewId.toString()||kb.button.create(b.mobile,b.type,"kb-action-button"+d.toString(),a.label.value,a.message.value,function(){kb.view.records.get(b.app.id,(b.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(function(n){var e=[],u=function(h,p){E([a],n[h],"record").then(function(A){A.performed&&
e.push(kb.view.records.transform(A.record));kb.progressUpdate();h++;h<n.length?u(h,p):p()})["catch"](function(){})};0!=n.length?(kb.progressStart(n.length),u(0,function(){kb.view.records.set(b.app.id,{put:e}).then(function(h){return kb.alert("Done!",function(){return window.location.reload(!0)})})["catch"](function(h){return kb.alert(kb.error.parse(h))})})):kb.alert("There are no records.")})["catch"](function(n){return kb.alert(kb.error.parse(n))})}));d++;d<l.length&&m(d)})["catch"](function(g){d++;
d<l.length&&m(d)})})(l[d])},m(0),f(c)}else f(c)}((b.config?b.config:b.config=JSON.parse(q.tab)).reduce(function(l,m){(b.mobile?["both","mobile"]:["both","pc"]).includes(m.setting.device.value)&&m.setting.event.value.includes(b.type)&&l.push(m.setting);return l},[]))}catch(l){kb.alert(kb.error.parse(l)),f(c)}})["catch"](function(t){return f(c)}):f(c)})["catch"](function(q){return f(c)})})("mobile"==c.type.split(".").first(),c.reuse?"reuse":c.type.split(".").slice(-2).first())})});kb.event.on("kb.action.call",
function(c){return new Promise(function(f,G){kb.config[D].config.get().then(function(x){0!=Object.keys(x).length?kb.field.load(kb.config[D].app,!0).then(function(B){b.app={id:kb.config[D].app,fields:B.origin};b.fieldInfos=B;b.picker=new KintoneBoosterRecordPicker("record");try{(function(q){0!=q.length?E(q,c.record,c.workplace?c.workplace:"record").then(function(t){c.performed=t.performed;f(c)})["catch"](function(){return f(c)}):f(c)})((b.config?b.config:b.config=JSON.parse(x.tab)).reduce(function(q,
t){(c.mobile?["both","mobile"]:["both","pc"]).includes(t.setting.device.value)&&t.setting.event.value.includes(c.pattern)&&q.push(t.setting);return q},[]))}catch(q){kb.alert(kb.error.parse(q)),f(c)}})["catch"](function(B){return f(c)}):f(c)})["catch"](function(x){return f(c)})})});kb.event.on("kb.action.installed",function(c){return{installed:b.config.some(function(f){return(c.mobile?["both","mobile"]:["both","pc"]).includes(f.setting.device.value)&&f.setting.event.value.includes("change")})}})})(kintone.$PLUGIN_ID);