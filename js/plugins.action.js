/*
* FileName "plugins.action.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(K){var b={},M=function(d,f,E,L){return new Promise(function(J,v){var C=JSON.stringify(kb.record.simplify({fields:b.fieldInfos.origin},f)),y=function(t,g){var h=function(){t++;t<d.length?y(t,g):g()};(function(a){if(a.lookupApp){var m=kb.filter.scan(b.app,f,a.condition.value);m?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(function(F){if(F){var I={clear:function(x){try{a.clear.value.map(function(c){return c.value}).each(function(c,z){c.table.value in b.fieldInfos.tables&&
(f[c.table.value].value=f[c.table.value].value.filter(function(w){return!m[c.table.value].value.includes(w)}),m[c.table.value].value=[])}),x()}catch(c){kb.alert(kb.error.parse(c)),v()}},fill:function(x){try{a.fill.value.map(function(c){return c.value}).each(function(c,z){c.table.value in b.fieldInfos.tables&&function(w){w=kb.isNumeric(w)?parseInt(w)-m[c.table.value].value.length:0;0<w&&Array(w).fill().map(function(){return kb.record.create(b.fieldInfos.origin[c.table.value],!1)}).each(function(A,
n){f[c.table.value]==m[c.table.value]?f[c.table.value].value.push({value:A}):(f[c.table.value].value.push({value:A}),m[c.table.value].value.push({value:A}))})}(kb.formula.calculate({field:{value:Object.values(b.fieldInfos.parallelize).first().code},formula:c.range},m,m,f,b.fieldInfos.parallelize))}),x()}catch(c){kb.alert(kb.error.parse(c)),v()}},formula:function(x){try{a.formula.value.map(function(c){return c.value}).each(function(c,z){c.field.value in b.fieldInfos.parallelize&&function(w){w.tableCode?
m[w.tableCode].value.each(function(A,n){A.value[w.code].value=kb.formula.calculate(c,A.value,m,f,b.fieldInfos.parallelize);"lookup"==w.type&&(A.value[w.code].lookup=!0)}):(m[w.code].value=kb.formula.calculate(c,m,m,f,b.fieldInfos.parallelize),"lookup"==w.type&&(m[w.code].lookup=!0))}(b.fieldInfos.parallelize[c.field.value])}),x()}catch(c){kb.alert(kb.error.parse(c)),v()}},lookup:function(x){try{a.lookupApp.value?kb.field.load(a.lookupApp.value).then(function(c){(function(z){var w=[],A=[],n=function(p,
q){var k=function(r,l){return r.lookup?kb.extend({lookup:!0},l):l};kb.view.records.get(a.lookupApp.value,q.query,q.sort).then(function(r){0!=r.length?function(l){a.lookupLimited.value.includes("limited")||1==r.length?l(r.first()):b.picker.show({app:a.lookupApp.value,query:q.query,sort:q.sort,picker:w.reduce(function(u,e){u[e.external.code]=e.external;return u},{})},function(u){return l(u)})}(function(l){w.each(function(u,e){if(a.lookupOverwrite.value.includes("overwrite")||kb.field.isEmpty(q.record[u.internal.code].value))q.record[u.internal.code]=
k(u.internal,l[u.external.code])});p++;p<A.length?n(p,A[p]):(a.latest[E].lookup=B(),x())}):(a.lookupReset.value.includes("reset")&&w.each(function(l,u){q.record[l.internal.code]=k(l.internal,kb.record.create({fields:{empty:l.internal}}).empty)}),p++,p<A.length?n(p,A[p]):(a.latest[E].lookup=B(),x()))})["catch"](function(r){kb.alert(kb.error.parse(r));v()})},B=function(){return function(p){return JSON.stringify(A.reduce(function(q,k){q.push(k.query);q.push(kb.record.simplify({fields:p},k.record));return q},
[]))}(w.reduce(function(p,q){p[q.internal.code]=q.internal;return p},{}))};a.lookupCriteria.value.some(function(p){return!(p.value.external.value in z.external&&p.value.internal.value in z.internal)})?(kb.alert("No field to lookup was found"),v()):a.lookupMapping.value.some(function(p){return!(p.value.external.value in z.external&&p.value.internal.value in z.internal)})?(kb.alert("No field to lookup was found"),v()):(w=a.lookupMapping.value.map(function(p){return{external:z.external[p.value.external.value],
internal:z.internal[p.value.internal.value]}}),A=function(p){return p.map(function(q){return{query:a.lookupCriteria.value.reduce(function(k,r){var l=z.external[r.value.external.value],u=r.value.operator.value,e=z.internal[r.value.internal.value];var D=e.tableCode?q.value:f;a.lookupIgnore.value.includes("ignore")&&kb.field.isEmpty(D[e.code].value)||k.push(kb.filter.query.create(l,u,D[e.code]));return k},kb.filter.query.parse(a.lookupFilter.value).map(function(k){return z.external[k.field].code+" "+
k.operator+" "+k.value})).join(" and "),sort:(0!=a.lookupSort.value.length?a.lookupSort.value.map(function(k){return k.value.field.value+" "+k.value.order.value}):["$id asc"]).join(","),record:q.value}})}(function(p){return p?m[p].value:[{value:f}]}(Array.from(new Set(w.map(function(p){return p.internal.tableCode}))).first())),0!=A.length?a.latest[E].lookup&&a.latest[E].lookup==B()?x():n(0,A.first()):x())})({external:c.origin,internal:b.fieldInfos.parallelize})})["catch"](function(c){kb.alert(kb.error.parse(c));
v()}):x()}catch(c){kb.alert(kb.error.parse(c)),v()}},user:function(x){try{a.userSource.value?function(c){0==kb.roleSet.user.length?kb.roleSet.load().then(function(){return c()}):c()}(function(){var c=[],z=[],w=function(n,B){(function(q){c.each(function(k,r){if(k.isCustom)switch(k.field.type){case "USER_SELECT":k.value=q.reduce(function(l,u){"customItemValues"in u&&function(e){0!=e.length&&function(D){(function(G){0!=G.length&&(l.some(function(H){return H.code==G.first().info.code})||l.push({code:G.first().info.code,
name:G.first().info.name}))})(kb.roleSet.user.filter(function(G){return G.info.id==D}))}(e.first().value)}(u.customItemValues.filter(function(e){return e.code==k.item}));return Array.from(new Set(l)).filter(function(e){return e})},[]);break;default:k.value=q.reduce(function(l,u){"customItemValues"in u&&function(e){0!=e.length&&l.push(e.first().value)}(u.customItemValues.filter(function(e){return e.code==k.item}));return Array.from(new Set(l)).filter(function(e){return e})},[]).join(",")}else switch(k.item){case "groups":case "organizations":k.value=
q.map(function(l){return l.code});break;case "primaryOrganization":k.value=q.reduce(function(l,u){k.item in u&&function(e){0!=e.length&&(l.some(function(D){return D.code==e.first().info.code})||l.push({code:e.first().info.code,name:e.first().info.name}))}(kb.roleSet.organization.filter(function(e){return e.info.id==u[k.item]}));return l},[]);break;default:k.value=q.reduce(function(l,u){k.item in u&&l.push(u[k.item]);return Array.from(new Set(l)).filter(function(e){return e})},[]).join(",")}})})(B[a.userSource.value].value.reduce(function(q,
k){(function(r){0!=r.length&&q.push(r.first().info)})(kb.roleSet.user.filter(function(r){return r.info.code==k.code}));return q},[]));var p=function(q,k){(function(r,l){var u=function(e,D,G){switch(r.item){case "groups":kintone.api(kintone.api.url("/v1/user/groups",!0),"GET",{code:r.value[e]}).then(function(H){H.groups&&(D=D.concat(H.groups.map(function(N){return{code:N.code,name:N.name}})),e++,e<r.value.length?u(e,D,G):G(D))})["catch"](function(H){kb.alert(kb.error.parse(H));v()});break;case "organizations":kintone.api(kintone.api.url("/v1/user/organizations",
!0),"GET",{code:r.value[e]}).then(function(H){H.organizationTitles&&(D=D.concat(H.organizationTitles.map(function(N){return{code:N.organization.code,name:N.organization.name}})),e++,e<r.value.length?u(e,D,G):G(D))})["catch"](function(H){kb.alert(kb.error.parse(H));v()})}};a.userOverwrite.value.includes("overwrite")||kb.field.isEmpty(B[r.field.code].value)||l();switch(r.item){case "groups":case "organizations":0!=r.value.length?u(0,[],function(e){B[r.field.code].value=e;l()}):(B[r.field.code].value=
r.value,l());break;default:B[r.field.code].value=r.value,l()}})(c[q],function(){q++;q<c.length?p(q,k):k()})};p(0,function(){n++;n<z.length?w(n,z[n]):(a.latest[E].user=A(),x())})},A=function(){return function(n){return JSON.stringify(z.map(function(B){return kb.record.simplify({fields:n},B)}))}(c.reduce(function(n,B){n[B.field.code]=B.field;return n},function(n){var B={};B[n]=b.fieldInfos.parallelize[n];return B}(a.userSource.value)))};a.userCustomItem.value.some(function(n){return!(n.value.field.value in
b.fieldInfos.parallelize)})?(kb.alert("No field to user informations was found"),v()):a.userMapping.value.some(function(n){return!(n.value.field.value in b.fieldInfos.parallelize)})?(kb.alert("No field to user informations was found"),v()):(a.userCustomItem.value.each(function(n,B){c.push({isCustom:!0,item:n.value.item.value,field:b.fieldInfos.parallelize[n.value.field.value],value:[]})}),a.userMapping.value.each(function(n,B){c.push({isCustom:!1,item:n.value.item.value,field:b.fieldInfos.parallelize[n.value.field.value],
value:[]})}),a.userPrimaryOrganization.value&&a.userPrimaryOrganization.value in b.fieldInfos.parallelize&&c.push({isCustom:!1,item:"primaryOrganization",field:b.fieldInfos.parallelize[a.userPrimaryOrganization.value],value:[]}),a.userOrganization.value&&a.userOrganization.value in b.fieldInfos.parallelize&&c.push({isCustom:!1,item:"organizations",field:b.fieldInfos.parallelize[a.userOrganization.value],value:[]}),a.userGroup.value&&a.userGroup.value in b.fieldInfos.parallelize&&c.push({isCustom:!1,
item:"groups",field:b.fieldInfos.parallelize[a.userGroup.value],value:[]}),z=function(n){return n?m[n].value:[{value:f}]}(b.fieldInfos.parallelize[a.userSource.value].tableCode).map(function(n){return n.value}),0!=z.length?a.latest[E].user&&a.latest[E].user==A()?x():0!=c.length?w(0,z.first()):x():x())}):x()}catch(c){kb.alert(kb.error.parse(c)),v()}}};I.clear(function(){I.fill(function(){I.formula(function(){I.lookup(function(){I.user(function(){h()})})})})})}else h()})["catch"](function(F){kb.alert(kb.error.parse(F));
v()}):h()}else kb.alert(kb.error.config.update("Boost! Action")),J({record:f,performed:!1}),g()})(function(a){a.latest||(a.latest={});a.latest[E]=a.latest[E]||{lookup:"[]",user:"[]"};return a}(d[t]))};y(0,function(){J({record:f,performed:C!=JSON.stringify(kb.record.simplify({fields:b.fieldInfos.origin},f))})})})};kintone.events.on("app.record.create.show app.record.detail.process.proceed app.record.detail.show app.record.edit.show app.record.index.show mobile.app.record.create.show mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.show mobile.app.record.index.show".split(" "),
function(d){return new Promise(function(f,E){(function(L,J){b.mobile=L;b.type=J;kb.config[K].config.get().then(function(v){0!=Object.keys(v).length?kb.field.load(kb.config[K].app,!0).then(function(C){b.app={id:kb.config[K].app,fields:C.origin};b.fieldInfos=C;b.picker=new KintoneBoosterRecordPicker("record");try{["create","edit","reuse"].includes(b.type)&&function(y){if(0!=y.length){var t="",g=null;kintone.events.on(C.changes.reduce(function(h,a){h.push("app.record.create.change."+a);h.push("app.record.edit.change."+
a);h.push("mobile.app.record.create.change."+a);h.push("mobile.app.record.edit.change."+a);return h},[]),function(h){if(function(){var a=!0;t&&(a=!1,t==JSON.stringify(kb.record.simplify({fields:C.origin},h.record))?(t="",g=null):g<(new Date).getTime()-5E3&&(t="",g=null,a=!0));a&&["DATETIME","TIME"].includes(h.changes.field.type)&&function(m){m&&(Array.isArray(m)?m:[m]).each(function(F,I){F.elm(".control-errors-content-gaia")&&(a=!1)})}(kb.field.get(C.parallelize[h.type.split(".").last()],b.mobile,
b.type));return a}())return M(y,h.record,kb.elm("body"),"record").then(function(a){kb.event.call("kb.style.call",{container:kb.elm("body"),record:h.record,mobile:b.mobile,pattern:"reuse"==b.type?"create":b.type,workplace:"record"}).then(function(m){if(a.performed||m.performed)a.performed?(t=JSON.stringify(kb.record.simplify({fields:C.origin},m.record)),g=(new Date).getTime()):(t="",g=null),(b.mobile?kintone.mobile.app.record:kintone.app.record).set(h)})["catch"](function(){})})["catch"](function(){}),
h})}else f(d)}((b.config?b.config:b.config=JSON.parse(v.tab)).reduce(function(y,t){(b.mobile?["both","mobile"]:["both","pc"]).includes(t.setting.device.value)&&t.setting.event.value.includes("change")&&y.push(t.setting);return y},[])),function(y){if(0!=y.length)switch(b.type){case "create":case "edit":case "reuse":M(y,d.record,kb.elm("body"),"record").then(function(g){return f(d)})["catch"](function(){});break;case "process":(function(g){0!=g.length?M(g,d.record,kb.elm("body"),"record").then(function(h){return f(d)})["catch"](function(){}):
f(d)})(y.filter(function(g){return g.action.value==d.action.value+":"+d.status.value+":"+d.nextStatus.value}));break;case "detail":var t=function(g){(function(h){kb.filter.scan(b.app,d.record,h.condition.value)?kb.filter.auth(h.user.value,h.organization.value,h.group.value).then(function(a){a&&kb.button.create(b.mobile,b.type,"kb-action-button"+g.toString(),h.label.value,h.message.value,function(){M([h],d.record,kb.elm("body"),"record").then(function(m){kb.view.records.set(b.app.id,{put:[kb.view.records.transform(m.record)]}).then(function(F){return kb.alert("Done!",
function(){return window.location.reload(!0)})})["catch"](function(F){return kb.alert(kb.error.parse(F))})})["catch"](function(){})});g++;g<y.length&&t(g)})["catch"](function(a){g++;g<y.length&&t(g)}):(g++,g<y.length&&t(g))})(y[g])};t(0);f(d);break;case "index":t=function(g){(function(h){kb.filter.auth(h.user.value,h.organization.value,h.group.value).then(function(a){a&&(h.view.value&&h.view.value!=d.viewId.toString()||kb.button.create(b.mobile,b.type,"kb-action-button"+g.toString(),h.label.value,
h.message.value,function(){kb.view.records.get(b.app.id,(b.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(function(m){var F=[],I=function(x,c){M([h],m[x],kb.create("div"),"record").then(function(z){z.performed&&F.push(kb.view.records.transform(z.record));kb.progressUpdate();x++;x<m.length?I(x,c):c()})["catch"](function(){})};0!=m.length?(kb.progressStart(m.length),I(0,function(){kb.view.records.set(b.app.id,{put:F}).then(function(x){return kb.alert("Done!",function(){return window.location.reload(!0)})})["catch"](function(x){return kb.alert(kb.error.parse(x))})})):
kb.alert("There are no records.")})["catch"](function(m){return kb.alert(kb.error.parse(m))})}));g++;g<y.length&&t(g)})["catch"](function(a){g++;g<y.length&&t(g)})})(y[g])},t(0),f(d)}else f(d)}((b.config?b.config:b.config=JSON.parse(v.tab)).reduce(function(y,t){(b.mobile?["both","mobile"]:["both","pc"]).includes(t.setting.device.value)&&t.setting.event.value.includes(b.type)&&y.push(t.setting);return y},[]))}catch(y){kb.alert(kb.error.parse(y)),f(d)}})["catch"](function(C){return f(d)}):f(d)})["catch"](function(v){return f(d)})})("mobile"==
d.type.split(".").first(),d.reuse?"reuse":d.type.split(".").slice(-2).first())})});kb.event.on("kb.action.call",function(d){return new Promise(function(f,E){kb.config[K].config.get().then(function(L){0!=Object.keys(L).length?kb.field.load(kb.config[K].app,!0).then(function(J){b.app={id:kb.config[K].app,fields:J.origin};b.fieldInfos=J;b.picker=new KintoneBoosterRecordPicker("record");try{(function(v){0!=v.length?M(v,d.record,d.container,d.workplace?d.workplace:"record").then(function(C){d.performed=
C.performed;f(d)})["catch"](function(){return f(d)}):f(d)})((b.config?b.config:b.config=JSON.parse(L.tab)).reduce(function(v,C){(d.mobile?["both","mobile"]:["both","pc"]).includes(C.setting.device.value)&&C.setting.event.value.includes(d.pattern)&&v.push(C.setting);return v},[]))}catch(v){kb.alert(kb.error.parse(v)),f(d)}})["catch"](function(J){return f(d)}):f(d)})["catch"](function(L){return f(d)})})});kb.event.on("kb.action.installed",function(d){return{installed:b.config.some(function(f){return(d.mobile?
["both","mobile"]:["both","pc"]).includes(f.setting.device.value)&&f.setting.event.value.includes("change")})}})})(kintone.$PLUGIN_ID);