/*
* FileName "plugins.action.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(K=>{var b={handlers:{}},M=(e,l,D,L)=>new Promise((J,v)=>{var B=JSON.stringify(kb.record.simplify({fields:b.fieldInfos.origin},l)),C=(q,d)=>{var f=()=>{q++;q<e.length?C(q,d):d()};(a=>{var k=kb.filter.scan(b.app,l,a.condition.value);k?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(E=>{if(E){var G={clear:y=>{try{a.clear.value.map(c=>c.value).each((c,x)=>{c.table.value in b.fieldInfos.tables&&(l[c.table.value].value=l[c.table.value].value.filter(u=>!k[c.table.value].value.includes(u)),
k[c.table.value].value=[])}),y()}catch(c){kb.alert(kb.error.parse(c)),v()}},fill:y=>{try{a.fill.value.map(c=>c.value).each((c,x)=>{c.table.value in b.fieldInfos.tables&&(u=>{u=kb.isNumeric(u)?parseInt(u)-k[c.table.value].value.length:0;u>0&&Array(u).fill().map(()=>kb.record.create(b.fieldInfos.origin[c.table.value],!1)).each((z,p)=>{l[c.table.value]==k[c.table.value]?l[c.table.value].value.push({value:z}):(l[c.table.value].value.push({value:z}),k[c.table.value].value.push({value:z}))})})(kb.formula.calculate({field:{value:Object.values(b.fieldInfos.parallelize).first().code},
formula:c.range},k,k,l,b.fieldInfos.parallelize))}),y()}catch(c){kb.alert(kb.error.parse(c)),v()}},formula:y=>{try{a.formula.value.map(c=>c.value).each((c,x)=>{c.field.value in b.fieldInfos.parallelize&&(u=>{u.tableCode?k[u.tableCode].value.each((z,p)=>{z.value[u.code].value=kb.formula.calculate(c,z.value,k,l,b.fieldInfos.parallelize);u.lookup&&(z.value[u.code].lookup=!0)}):(k[u.code].value=kb.formula.calculate(c,k,k,l,b.fieldInfos.parallelize),u.lookup&&(k[u.code].lookup=!0))})(b.fieldInfos.parallelize[c.field.value])}),
y()}catch(c){kb.alert(kb.error.parse(c)),v()}},lookup:y=>{try{a.lookupApp.value?kb.field.load(a.lookupApp.value).then(c=>{(x=>{var u=[],z=[],p=(r,t)=>{var m=(h,n)=>h.lookup?kb.extend({lookup:!0,type:h.type},n):kb.extend({type:h.type},n);kb.view.records.get(a.lookupApp.value,t.query,t.sort).then(h=>{h.length!=0?(n=>{a.lookupLimited.value.includes("limited")||h.length==1?n(h.first()):b.picker.show({app:a.lookupApp.value,query:t.query,sort:t.sort,picker:u.reduce((w,g)=>{w[g.external.code]=g.external;
return w},{})},w=>n(w))})(n=>{u.each((w,g)=>{if(a.lookupOverwrite.value.includes("overwrite")||kb.field.isEmpty(t.record[w.internal.code].value))t.record[w.internal.code]=m(w.internal,n[w.external.code])});r++;r<z.length?p(r,z[r]):(D.latest.action[a.sIndex.value].lookup=A(),y())}):(a.lookupReset.value.includes("reset")&&u.each((n,w)=>{t.record[n.internal.code]=m(n.internal,kb.record.create({fields:{empty:n.internal}}).empty)}),r++,r<z.length?p(r,z[r]):(D.latest.action[a.sIndex.value].lookup=A(),y()))}).catch(h=>
{kb.alert(kb.error.parse(h));v()})},A=()=>(r=>JSON.stringify(z.reduce((t,m)=>{t.push(m.query);t.push(kb.record.simplify({fields:r},m.record));return t},[])))(u.reduce((r,t)=>{r[t.internal.code]=t.internal;return r},{}));a.lookupCriteria.value.some(r=>!(r.value.external.value in x.external&&r.value.internal.value in x.internal))?(kb.alert("No field to lookup was found"),v()):a.lookupMapping.value.some(r=>!(r.value.external.value in x.external&&r.value.internal.value in x.internal))?(kb.alert("No field to lookup was found"),
v()):(u=a.lookupMapping.value.map(r=>({external:x.external[r.value.external.value],internal:x.internal[r.value.internal.value]})),z=(r=>r.map(t=>({query:a.lookupCriteria.value.reduce((m,h)=>{var n=x.external[h.value.external.value],w=h.value.operator.value;h=x.internal[h.value.internal.value];var g=h.tableCode?t.value:l;a.lookupIgnore.value.includes("ignore")&&kb.field.isEmpty(g[h.code].value)||m.push(kb.filter.query.create(n,w,g[h.code]));return m},kb.filter.query.parse.expand({id:a.lookupApp.value,
fields:c.origin},a.lookupFilter.value).map(m=>m.field+" "+m.operator+" "+m.value)).join(" and "),sort:(a.lookupSort.value.length!=0?a.lookupSort.value.map(m=>m.value.field.value+" "+m.value.order.value):["$id asc"]).join(","),record:t.value})))((r=>r?k[r].value:[{value:l}])(Array.from(new Set(u.map(r=>r.internal.tableCode))).first())),z.length!=0?D.latest.action[a.sIndex.value].lookup&&D.latest.action[a.sIndex.value].lookup==A()?y():p(0,z.first()):y())})({external:c.origin,internal:b.fieldInfos.parallelize})}).catch(c=>
{kb.alert(kb.error.parse(c));v()}):y()}catch(c){kb.alert(kb.error.parse(c)),v()}},user:y=>{try{a.userSource.value?(c=>{kb.roleSet.user.length==0?kb.roleSet.load().then(()=>c()):c()})(()=>{var c=[],x=[],u=(p,A)=>{(t=>{c.each((m,h)=>{if(m.isCustom)switch(m.field.type){case "USER_SELECT":m.value=t.reduce((n,w)=>{"customItemValues"in w&&(g=>{g.length!=0&&(F=>{(H=>{H.length!=0&&(n.some(I=>I.code==H.first().info.code)||n.push({code:H.first().info.code,name:H.first().info.name}))})(kb.roleSet.user.filter(H=>
H.info.id==F))})(g.first().value)})(w.customItemValues.filter(g=>g.code==m.item));return Array.from(new Set(n)).filter(g=>g)},[]);break;default:m.value=t.reduce((n,w)=>{"customItemValues"in w&&(g=>{g.length!=0&&n.push(g.first().value)})(w.customItemValues.filter(g=>g.code==m.item));return Array.from(new Set(n)).filter(g=>g)},[]).join(",")}else switch(m.item){case "groups":case "organizations":m.value=t.map(n=>n.code);break;case "primaryOrganization":m.value=t.reduce((n,w)=>{m.item in w&&(g=>{g.length!=
0&&(n.some(F=>F.code==g.first().info.code)||n.push({code:g.first().info.code,name:g.first().info.name}))})(kb.roleSet.organization.filter(g=>g.info.id==w[m.item]));return n},[]);break;default:m.value=t.reduce((n,w)=>{m.item in w&&n.push(w[m.item]);return Array.from(new Set(n)).filter(g=>g)},[]).join(",")}})})(A[a.userSource.value].value.reduce((t,m)=>{(h=>{h.length!=0&&t.push(h.first().info)})(kb.roleSet.user.filter(h=>h.info.code==m.code));return t},[]));var r=(t,m)=>{((h,n)=>{var w=(g,F,H)=>{switch(h.item){case "groups":kintone.api(kintone.api.url("/v1/user/groups",
!0),"GET",{code:h.value[g]}).then(I=>{I.groups&&(F=F.concat(I.groups.map(N=>({code:N.code,name:N.name}))),g++,g<h.value.length?w(g,F,H):H(F))}).catch(I=>{kb.alert(kb.error.parse(I));v()});break;case "organizations":kintone.api(kintone.api.url("/v1/user/organizations",!0),"GET",{code:h.value[g]}).then(I=>{I.organizationTitles&&(F=F.concat(I.organizationTitles.map(N=>({code:N.organization.code,name:N.organization.name}))),g++,g<h.value.length?w(g,F,H):H(F))}).catch(I=>{kb.alert(kb.error.parse(I));v()})}};
a.userOverwrite.value.includes("overwrite")||kb.field.isEmpty(A[h.field.code].value)||n();switch(h.item){case "groups":case "organizations":h.value.length!=0?w(0,[],g=>{A[h.field.code].value=g;n()}):(A[h.field.code].value=h.value,n());break;default:A[h.field.code].value=h.value,n()}})(c[t],()=>{t++;t<c.length?r(t,m):m()})};r(0,()=>{p++;p<x.length?u(p,x[p]):(D.latest.action[a.sIndex.value].user=z(),y())})},z=()=>(p=>JSON.stringify(x.map(A=>kb.record.simplify({fields:p},A))))(c.reduce((p,A)=>{p[A.field.code]=
A.field;return p},(p=>{var A={};A[p]=b.fieldInfos.parallelize[p];return A})(a.userSource.value)));a.userCustomItem.value.some(p=>!(p.value.field.value in b.fieldInfos.parallelize))?(kb.alert("No field to user informations was found"),v()):a.userMapping.value.some(p=>!(p.value.field.value in b.fieldInfos.parallelize))?(kb.alert("No field to user informations was found"),v()):(a.userCustomItem.value.each((p,A)=>{c.push({isCustom:!0,item:p.value.item.value,field:b.fieldInfos.parallelize[p.value.field.value],
value:[]})}),a.userMapping.value.each((p,A)=>{c.push({isCustom:!1,item:p.value.item.value,field:b.fieldInfos.parallelize[p.value.field.value],value:[]})}),a.userPrimaryOrganization.value&&a.userPrimaryOrganization.value in b.fieldInfos.parallelize&&c.push({isCustom:!1,item:"primaryOrganization",field:b.fieldInfos.parallelize[a.userPrimaryOrganization.value],value:[]}),a.userOrganization.value&&a.userOrganization.value in b.fieldInfos.parallelize&&c.push({isCustom:!1,item:"organizations",field:b.fieldInfos.parallelize[a.userOrganization.value],
value:[]}),a.userGroup.value&&a.userGroup.value in b.fieldInfos.parallelize&&c.push({isCustom:!1,item:"groups",field:b.fieldInfos.parallelize[a.userGroup.value],value:[]}),x=(p=>p?k[p].value:[{value:l}])(b.fieldInfos.parallelize[a.userSource.value].tableCode).map(p=>p.value),x.length!=0?D.latest.action[a.sIndex.value].user&&D.latest.action[a.sIndex.value].user==z()?y():c.length!=0?u(0,x.first()):y():y())}):y()}catch(c){kb.alert(kb.error.parse(c)),v()}}};G.clear(()=>{G.fill(()=>{G.formula(()=>{G.lookup(()=>
{G.user(()=>{f()})})})})})}else f()}).catch(E=>{kb.alert(kb.error.parse(E));v()}):f()})((a=>{D.latest?D.latest.action||(D.latest.action={}):D.latest={action:{}};a.sIndex.value in D.latest.action||(D.latest.action[a.sIndex.value]={lookup:"[]",user:"[]"});return a})(e[q]))};C(0,()=>{J({record:l,performed:B!=JSON.stringify(kb.record.simplify({fields:b.fieldInfos.origin},l))})})});kintone.events.on("app.record.create.show app.record.detail.process.proceed app.record.detail.show app.record.edit.show app.record.index.show mobile.app.record.create.show mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.show mobile.app.record.index.show".split(" "),
e=>new Promise((l,D)=>{((L,J)=>{b.mobile=L;b.type=J;for(var v in b.handlers)b.handlers[v].each((B,C)=>{kintone.events.off(v,B)});kb.config[K].config.get().then(B=>{Object.keys(B).length!=0?kb.field.load(kb.config[K].app,!0).then(C=>{b.app={id:kb.config[K].app,fields:C.origin};b.fieldInfos=C;b.picker=new KintoneBoosterRecordPicker("record");try{["create","edit","reuse"].includes(b.type)&&(q=>{if(q.length!=0)b.latest={record:"",time:null},((d,f)=>{kintone.events.on(d,f);d.each((a,k)=>{a in b.handlers||
(b.handlers[a]=[]);b.handlers[a].push(f)})})(C.changes.reduce((d,f)=>{d.push("app.record.create.change."+f);d.push("app.record.edit.change."+f);d.push("mobile.app.record.create.change."+f);d.push("mobile.app.record.edit.change."+f);return d},[]),d=>{var f=q.filter(a=>(k=>!k.first()||k.includes(d.type.split(".").last()))(a.triggers.value.map(k=>k.value.field.value)));if((()=>{var a=!0;b.latest.record&&(a=!1,b.latest.record==JSON.stringify(kb.record.simplify({fields:C.origin},d.record))?b.latest={record:"",
time:null}:b.latest.time<(new Date).getTime()-5E3&&(b.latest={record:"",time:null},a=!0));a&&["DATETIME","TIME"].includes(d.changes.field.type)&&(k=>{k&&(Array.isArray(k)?k:[k]).each((E,G)=>{E.elm(".control-errors-content-gaia")&&(a=!1)})})(kb.field.get(C.parallelize[d.type.split(".").last()],b.mobile,b.type));return a})()){if(f.length!=0)return M(f,d.record,kb.elm("body"),"record").then(a=>{kb.event.call("kb.style.call",{container:kb.elm("body"),record:d.record,mobile:b.mobile,pattern:b.type=="reuse"?
"create":b.type,workplace:"record"}).then(k=>{if(a.performed||k.performed)b.latest=a.performed?{record:JSON.stringify(kb.record.simplify({fields:C.origin},k.record)),time:(new Date).getTime()}:{record:"",time:null},(b.mobile?kintone.mobile.app.record:kintone.app.record).set(d)}).catch(()=>{})}).catch(()=>{}),d;kb.event.call("kb.style.call",{container:kb.elm("body"),record:d.record,mobile:b.mobile,pattern:b.type=="reuse"?"create":b.type,workplace:"record"}).then(a=>{a.performed&&(b.latest={record:"",
time:null},(b.mobile?kintone.mobile.app.record:kintone.app.record).set(d))}).catch(()=>{})}}),kb.event.on("kb.action.installed",d=>({installed:!0}));else kb.event.on("kb.action.installed",d=>({installed:!1}))})(JSON.parse(B.tab).map((q,d)=>kb.extend({sIndex:{value:d.toString()}},q.setting)).reduce((q,d)=>{(b.mobile?["all","both","mobile"]:["all","both","pc"]).includes(d.device.value)&&d.event.value.includes("change")&&q.push(d);return q},[])),(q=>{if(q.length!=0)switch(b.type){case "create":case "edit":case "reuse":M(q,
e.record,kb.elm("body"),"record").then(f=>l(e)).catch(()=>{});break;case "process":(f=>{f.length!=0?M(f,e.record,kb.elm("body"),"record").then(a=>l(e)).catch(()=>{}):l(e)})(q.filter(f=>f.action.value==e.action.value+":"+e.status.value+":"+e.nextStatus.value));break;case "detail":var d=f=>{(a=>{kb.filter.scan(b.app,e.record,a.condition.value)?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(k=>{k&&kb.button.create(b.mobile,b.type,"kb-action-button"+f.toString(),a.label.value,a.message.value,
()=>{M([a],e.record,kb.elm("body"),"record").then(E=>{kb.view.records.set(b.app.id,{put:[kb.view.records.transform(E.record)]}).then(G=>kb.alert("Done!",()=>window.location.reload(!0))).catch(G=>kb.alert(kb.error.parse(G)))}).catch(()=>{})});f++;f<q.length&&d(f)}).catch(k=>{f++;f<q.length&&d(f)}):(f++,f<q.length&&d(f))})(q[f])};d(0);l(e);break;case "index":d=f=>{(a=>{kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(k=>{k&&(a.view.value&&a.view.value!=e.viewId.toString()||kb.button.create(b.mobile,
b.type,"kb-action-button"+f.toString(),a.label.value,a.message.value,()=>{kb.view.records.get(b.app.id,(b.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(E=>{var G=[];let y=(c,x)=>{M([a],E[c],kb.create("div"),"record").then(u=>{u.performed&&G.push(kb.view.records.transform(u.record));kb.progressUpdate();c++;c<E.length?y(c,x):x()}).catch(()=>{})};E.length!=0?(kb.progressStart(E.length),y(0,()=>{kb.view.records.set(b.app.id,{put:G}).then(c=>kb.alert("Done!",()=>window.location.reload(!0))).catch(c=>
kb.alert(kb.error.parse(c)))})):kb.alert("There are no records.")}).catch(E=>kb.alert(kb.error.parse(E)))}));f++;f<q.length&&d(f)}).catch(k=>{f++;f<q.length&&d(f)})})(q[f])},d(0),l(e)}else l(e)})(JSON.parse(B.tab).map((q,d)=>kb.extend({sIndex:{value:d.toString()}},q.setting)).reduce((q,d)=>{(b.mobile?["all","both","mobile"]:["all","both","pc"]).includes(d.device.value)&&d.event.value.includes(b.type)&&q.push(d);return q},[]))}catch(q){kb.alert(kb.error.parse(q)),l(e)}}).catch(C=>l(e)):l(e)}).catch(B=>
l(e))})(e.type.split(".").first()=="mobile",e.reuse?"reuse":e.type.split(".").slice(-2).first())}));kb.event.on("kb.action.call",e=>new Promise((l,D)=>{kb.config[K].config.get().then(L=>{Object.keys(L).length!=0?kb.field.load(kb.config[K].app,!0).then(J=>{b.app={id:kb.config[K].app,fields:J.origin};b.fieldInfos=J;b.picker=new KintoneBoosterRecordPicker("record");try{(v=>{if(v.length!=0){var B=(()=>{var C=v;e.pattern=="change"&&(C=v.filter(q=>(d=>"fields"in e?!d.first()||e.fields.some(f=>d.includes(f)):
!d.first()||d.includes(e.field))(q.triggers.value.map(d=>d.value.field.value))));return C})();B.length!=0?M(B,e.record,e.container,e.workplace?e.workplace:"record").then(C=>{e.stopPropagation&&(b.latest={record:JSON.stringify(kb.record.simplify({fields:J.origin},e.record)),time:(new Date).getTime()});e.performed=C.performed;l(e)}).catch(()=>l(e)):l(e)}else l(e)})(JSON.parse(L.tab).map((v,B)=>kb.extend({sIndex:{value:B.toString()}},v.setting)).reduce((v,B)=>{(e.mobile?["all","both","mobile"]:["all",
"both","pc"]).includes(B.device.value)&&B.event.value.includes(e.pattern)&&v.push(B);return v},[]))}catch(v){kb.alert(kb.error.parse(v)),l(e)}}).catch(J=>l(e)):l(e)}).catch(L=>l(e))}))})(kintone.$PLUGIN_ID);