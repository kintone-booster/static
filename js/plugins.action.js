/*
* FileName "plugins.action.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(K){var c={},M=function(d,l,E,L){return new Promise(function(J,t){var D=JSON.stringify(kb.record.simplify({fields:c.fieldInfos.origin},l)),m=function(h,f){var g=function(){h++;h<d.length?m(h,f):f()};(function(a){var k=kb.filter.scan(c.app,l,a.condition.value);k?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(function(A){if(A){var G={clear:function(x){try{a.clear.value.map(function(b){return b.value}).each(function(b,z){b.table.value in c.fieldInfos.tables&&(l[b.table.value].value=
l[b.table.value].value.filter(function(y){return!k[b.table.value].value.includes(y)}),k[b.table.value].value=[])}),x()}catch(b){kb.alert(kb.error.parse(b)),t()}},fill:function(x){try{a.fill.value.map(function(b){return b.value}).each(function(b,z){b.table.value in c.fieldInfos.tables&&function(y){y=kb.isNumeric(y)?parseInt(y)-k[b.table.value].value.length:0;0<y&&Array(y).fill().map(function(){return kb.record.create(c.fieldInfos.origin[b.table.value],!1)}).each(function(B,q){l[b.table.value]==k[b.table.value]?
l[b.table.value].value.push({value:B}):(l[b.table.value].value.push({value:B}),k[b.table.value].value.push({value:B}))})}(kb.formula.calculate({field:{value:Object.values(c.fieldInfos.parallelize).first().code},formula:b.range},k,k,l,c.fieldInfos.parallelize))}),x()}catch(b){kb.alert(kb.error.parse(b)),t()}},formula:function(x){try{a.formula.value.map(function(b){return b.value}).each(function(b,z){b.field.value in c.fieldInfos.parallelize&&function(y){y.tableCode?k[y.tableCode].value.each(function(B,
q){B.value[y.code].value=kb.formula.calculate(b,B.value,k,l,c.fieldInfos.parallelize);"lookup"==y.type&&(B.value[y.code].lookup=!0)}):(k[y.code].value=kb.formula.calculate(b,k,k,l,c.fieldInfos.parallelize),"lookup"==y.type&&(k[y.code].lookup=!0))}(c.fieldInfos.parallelize[b.field.value])}),x()}catch(b){kb.alert(kb.error.parse(b)),t()}},lookup:function(x){try{a.lookupApp.value?kb.field.load(a.lookupApp.value).then(function(b){(function(z){var y=[],B=[],q=function(r,u){var n=function(v,p){return v.lookup?
kb.extend({lookup:!0},p):p};kb.view.records.get(a.lookupApp.value,u.query,u.sort).then(function(v){0!=v.length?function(p){a.lookupLimited.value.includes("limited")||1==v.length?p(v.first()):c.picker.show({app:a.lookupApp.value,query:u.query,sort:u.sort,picker:y.reduce(function(w,e){w[e.external.code]=e.external;return w},{})},function(w){return p(w)})}(function(p){y.each(function(w,e){if(a.lookupOverwrite.value.includes("overwrite")||kb.field.isEmpty(u.record[w.internal.code].value))u.record[w.internal.code]=
n(w.internal,p[w.external.code])});r++;r<B.length?q(r,B[r]):(E.latest.action[a.sIndex.value].lookup=C(),x())}):(a.lookupReset.value.includes("reset")&&y.each(function(p,w){u.record[p.internal.code]=n(p.internal,kb.record.create({fields:{empty:p.internal}}).empty)}),r++,r<B.length?q(r,B[r]):(E.latest.action[a.sIndex.value].lookup=C(),x()))})["catch"](function(v){kb.alert(kb.error.parse(v));t()})},C=function(){return function(r){return JSON.stringify(B.reduce(function(u,n){u.push(n.query);u.push(kb.record.simplify({fields:r},
n.record));return u},[]))}(y.reduce(function(r,u){r[u.internal.code]=u.internal;return r},{}))};a.lookupCriteria.value.some(function(r){return!(r.value.external.value in z.external&&r.value.internal.value in z.internal)})?(kb.alert("No field to lookup was found"),t()):a.lookupMapping.value.some(function(r){return!(r.value.external.value in z.external&&r.value.internal.value in z.internal)})?(kb.alert("No field to lookup was found"),t()):(y=a.lookupMapping.value.map(function(r){return{external:z.external[r.value.external.value],
internal:z.internal[r.value.internal.value]}}),B=function(r){return r.map(function(u){return{query:a.lookupCriteria.value.reduce(function(n,v){var p=z.external[v.value.external.value],w=v.value.operator.value,e=z.internal[v.value.internal.value];var F=e.tableCode?u.value:l;a.lookupIgnore.value.includes("ignore")&&kb.field.isEmpty(F[e.code].value)||n.push(kb.filter.query.create(p,w,F[e.code]));return n},kb.filter.query.parse(a.lookupFilter.value).map(function(n){return z.external[n.field].code+" "+
n.operator+" "+n.value})).join(" and "),sort:(0!=a.lookupSort.value.length?a.lookupSort.value.map(function(n){return n.value.field.value+" "+n.value.order.value}):["$id asc"]).join(","),record:u.value}})}(function(r){return r?k[r].value:[{value:l}]}(Array.from(new Set(y.map(function(r){return r.internal.tableCode}))).first())),0!=B.length?E.latest.action[a.sIndex.value].lookup&&E.latest.action[a.sIndex.value].lookup==C()?x():q(0,B.first()):x())})({external:b.origin,internal:c.fieldInfos.parallelize})})["catch"](function(b){kb.alert(kb.error.parse(b));
t()}):x()}catch(b){kb.alert(kb.error.parse(b)),t()}},user:function(x){try{a.userSource.value?function(b){0==kb.roleSet.user.length?kb.roleSet.load().then(function(){return b()}):b()}(function(){var b=[],z=[],y=function(q,C){(function(u){b.each(function(n,v){if(n.isCustom)switch(n.field.type){case "USER_SELECT":n.value=u.reduce(function(p,w){"customItemValues"in w&&function(e){0!=e.length&&function(F){(function(H){0!=H.length&&(p.some(function(I){return I.code==H.first().info.code})||p.push({code:H.first().info.code,
name:H.first().info.name}))})(kb.roleSet.user.filter(function(H){return H.info.id==F}))}(e.first().value)}(w.customItemValues.filter(function(e){return e.code==n.item}));return Array.from(new Set(p)).filter(function(e){return e})},[]);break;default:n.value=u.reduce(function(p,w){"customItemValues"in w&&function(e){0!=e.length&&p.push(e.first().value)}(w.customItemValues.filter(function(e){return e.code==n.item}));return Array.from(new Set(p)).filter(function(e){return e})},[]).join(",")}else switch(n.item){case "groups":case "organizations":n.value=
u.map(function(p){return p.code});break;case "primaryOrganization":n.value=u.reduce(function(p,w){n.item in w&&function(e){0!=e.length&&(p.some(function(F){return F.code==e.first().info.code})||p.push({code:e.first().info.code,name:e.first().info.name}))}(kb.roleSet.organization.filter(function(e){return e.info.id==w[n.item]}));return p},[]);break;default:n.value=u.reduce(function(p,w){n.item in w&&p.push(w[n.item]);return Array.from(new Set(p)).filter(function(e){return e})},[]).join(",")}})})(C[a.userSource.value].value.reduce(function(u,
n){(function(v){0!=v.length&&u.push(v.first().info)})(kb.roleSet.user.filter(function(v){return v.info.code==n.code}));return u},[]));var r=function(u,n){(function(v,p){var w=function(e,F,H){switch(v.item){case "groups":kintone.api(kintone.api.url("/v1/user/groups",!0),"GET",{code:v.value[e]}).then(function(I){I.groups&&(F=F.concat(I.groups.map(function(N){return{code:N.code,name:N.name}})),e++,e<v.value.length?w(e,F,H):H(F))})["catch"](function(I){kb.alert(kb.error.parse(I));t()});break;case "organizations":kintone.api(kintone.api.url("/v1/user/organizations",
!0),"GET",{code:v.value[e]}).then(function(I){I.organizationTitles&&(F=F.concat(I.organizationTitles.map(function(N){return{code:N.organization.code,name:N.organization.name}})),e++,e<v.value.length?w(e,F,H):H(F))})["catch"](function(I){kb.alert(kb.error.parse(I));t()})}};a.userOverwrite.value.includes("overwrite")||kb.field.isEmpty(C[v.field.code].value)||p();switch(v.item){case "groups":case "organizations":0!=v.value.length?w(0,[],function(e){C[v.field.code].value=e;p()}):(C[v.field.code].value=
v.value,p());break;default:C[v.field.code].value=v.value,p()}})(b[u],function(){u++;u<b.length?r(u,n):n()})};r(0,function(){q++;q<z.length?y(q,z[q]):(E.latest.action[a.sIndex.value].user=B(),x())})},B=function(){return function(q){return JSON.stringify(z.map(function(C){return kb.record.simplify({fields:q},C)}))}(b.reduce(function(q,C){q[C.field.code]=C.field;return q},function(q){var C={};C[q]=c.fieldInfos.parallelize[q];return C}(a.userSource.value)))};a.userCustomItem.value.some(function(q){return!(q.value.field.value in
c.fieldInfos.parallelize)})?(kb.alert("No field to user informations was found"),t()):a.userMapping.value.some(function(q){return!(q.value.field.value in c.fieldInfos.parallelize)})?(kb.alert("No field to user informations was found"),t()):(a.userCustomItem.value.each(function(q,C){b.push({isCustom:!0,item:q.value.item.value,field:c.fieldInfos.parallelize[q.value.field.value],value:[]})}),a.userMapping.value.each(function(q,C){b.push({isCustom:!1,item:q.value.item.value,field:c.fieldInfos.parallelize[q.value.field.value],
value:[]})}),a.userPrimaryOrganization.value&&a.userPrimaryOrganization.value in c.fieldInfos.parallelize&&b.push({isCustom:!1,item:"primaryOrganization",field:c.fieldInfos.parallelize[a.userPrimaryOrganization.value],value:[]}),a.userOrganization.value&&a.userOrganization.value in c.fieldInfos.parallelize&&b.push({isCustom:!1,item:"organizations",field:c.fieldInfos.parallelize[a.userOrganization.value],value:[]}),a.userGroup.value&&a.userGroup.value in c.fieldInfos.parallelize&&b.push({isCustom:!1,
item:"groups",field:c.fieldInfos.parallelize[a.userGroup.value],value:[]}),z=function(q){return q?k[q].value:[{value:l}]}(c.fieldInfos.parallelize[a.userSource.value].tableCode).map(function(q){return q.value}),0!=z.length?E.latest.action[a.sIndex.value].user&&E.latest.action[a.sIndex.value].user==B()?x():0!=b.length?y(0,z.first()):x():x())}):x()}catch(b){kb.alert(kb.error.parse(b)),t()}}};G.clear(function(){G.fill(function(){G.formula(function(){G.lookup(function(){G.user(function(){g()})})})})})}else g()})["catch"](function(A){kb.alert(kb.error.parse(A));
t()}):g()})(function(a){E.latest?E.latest.action||(E.latest.action={}):E.latest={action:{}};a.sIndex.value in E.latest.action||(E.latest.action[a.sIndex.value]={lookup:"[]",user:"[]"});return a}(d[h]))};m(0,function(){J({record:l,performed:D!=JSON.stringify(kb.record.simplify({fields:c.fieldInfos.origin},l))})})})};kintone.events.on("app.record.create.show app.record.detail.process.proceed app.record.detail.show app.record.edit.show app.record.index.show mobile.app.record.create.show mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.show mobile.app.record.index.show".split(" "),
function(d){return new Promise(function(l,E){(function(L,J){c.mobile=L;c.type=J;kb.config[K].config.get().then(function(t){0!=Object.keys(t).length?kb.field.load(kb.config[K].app,!0).then(function(D){c.app={id:kb.config[K].app,fields:D.origin};c.fieldInfos=D;c.picker=new KintoneBoosterRecordPicker("record");try{["create","edit","reuse"].includes(c.type)&&function(m){if(0!=m.length){var h="",f=null;kintone.events.on(D.changes.reduce(function(g,a){g.push("app.record.create.change."+a);g.push("app.record.edit.change."+
a);g.push("mobile.app.record.create.change."+a);g.push("mobile.app.record.edit.change."+a);return g},[]),function(g){var a=function(){var k=m;return m.some(function(A){return!A.triggers})?(kb.alert(kb.error.config.update("Boost! Action")),[]):k=m.filter(function(A){return function(G){return!G.first()||G.includes(g.type.split(".").last())}(A.triggers.value.map(function(G){return G.value.field.value}))})}();if(function(){var k=!0;h&&(k=!1,h==JSON.stringify(kb.record.simplify({fields:D.origin},g.record))?
(h="",f=null):f<(new Date).getTime()-5E3&&(h="",f=null,k=!0));k&&["DATETIME","TIME"].includes(g.changes.field.type)&&function(A){A&&(Array.isArray(A)?A:[A]).each(function(G,x){G.elm(".control-errors-content-gaia")&&(k=!1)})}(kb.field.get(D.parallelize[g.type.split(".").last()],c.mobile,c.type));return k}()&&0!=a.length)return M(a,g.record,kb.elm("body"),"record").then(function(k){kb.event.call("kb.style.call",{container:kb.elm("body"),record:g.record,mobile:c.mobile,pattern:"reuse"==c.type?"create":
c.type,workplace:"record"}).then(function(A){if(k.performed||A.performed)k.performed?(h=JSON.stringify(kb.record.simplify({fields:D.origin},A.record)),f=(new Date).getTime()):(h="",f=null),(c.mobile?kintone.mobile.app.record:kintone.app.record).set(g)})["catch"](function(){})})["catch"](function(){}),g});kb.event.on("kb.action.installed",function(g){return{installed:!0}})}else kb.event.on("kb.action.installed",function(g){return{installed:!1}})}(JSON.parse(t.tab).map(function(m,h){return kb.extend({sIndex:{value:h.toString()}},
m.setting)}).reduce(function(m,h){(c.mobile?["both","mobile"]:["both","pc"]).includes(h.device.value)&&h.event.value.includes("change")&&m.push(h);return m},[])),function(m){if(0!=m.length)switch(c.type){case "create":case "edit":case "reuse":M(m,d.record,kb.elm("body"),"record").then(function(f){return l(d)})["catch"](function(){});break;case "process":(function(f){0!=f.length?M(f,d.record,kb.elm("body"),"record").then(function(g){return l(d)})["catch"](function(){}):l(d)})(m.filter(function(f){return f.action.value==
d.action.value+":"+d.status.value+":"+d.nextStatus.value}));break;case "detail":var h=function(f){(function(g){kb.filter.scan(c.app,d.record,g.condition.value)?kb.filter.auth(g.user.value,g.organization.value,g.group.value).then(function(a){a&&kb.button.create(c.mobile,c.type,"kb-action-button"+f.toString(),g.label.value,g.message.value,function(){M([g],d.record,kb.elm("body"),"record").then(function(k){kb.view.records.set(c.app.id,{put:[kb.view.records.transform(k.record)]}).then(function(A){return kb.alert("Done!",
function(){return window.location.reload(!0)})})["catch"](function(A){return kb.alert(kb.error.parse(A))})})["catch"](function(){})});f++;f<m.length&&h(f)})["catch"](function(a){f++;f<m.length&&h(f)}):(f++,f<m.length&&h(f))})(m[f])};h(0);l(d);break;case "index":h=function(f){(function(g){kb.filter.auth(g.user.value,g.organization.value,g.group.value).then(function(a){a&&(g.view.value&&g.view.value!=d.viewId.toString()||kb.button.create(c.mobile,c.type,"kb-action-button"+f.toString(),g.label.value,
g.message.value,function(){kb.view.records.get(c.app.id,(c.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(function(k){var A=[],G=function(x,b){M([g],k[x],kb.create("div"),"record").then(function(z){z.performed&&A.push(kb.view.records.transform(z.record));kb.progressUpdate();x++;x<k.length?G(x,b):b()})["catch"](function(){})};0!=k.length?(kb.progressStart(k.length),G(0,function(){kb.view.records.set(c.app.id,{put:A}).then(function(x){return kb.alert("Done!",function(){return window.location.reload(!0)})})["catch"](function(x){return kb.alert(kb.error.parse(x))})})):
kb.alert("There are no records.")})["catch"](function(k){return kb.alert(kb.error.parse(k))})}));f++;f<m.length&&h(f)})["catch"](function(a){f++;f<m.length&&h(f)})})(m[f])},h(0),l(d)}else l(d)}(JSON.parse(t.tab).map(function(m,h){return kb.extend({sIndex:{value:h.toString()}},m.setting)}).reduce(function(m,h){(c.mobile?["both","mobile"]:["both","pc"]).includes(h.device.value)&&h.event.value.includes(c.type)&&m.push(h);return m},[]))}catch(m){kb.alert(kb.error.parse(m)),l(d)}})["catch"](function(D){return l(d)}):
l(d)})["catch"](function(t){return l(d)})})("mobile"==d.type.split(".").first(),d.reuse?"reuse":d.type.split(".").slice(-2).first())})});kb.event.on("kb.action.call",function(d){return new Promise(function(l,E){kb.config[K].config.get().then(function(L){0!=Object.keys(L).length?kb.field.load(kb.config[K].app,!0).then(function(J){c.app={id:kb.config[K].app,fields:J.origin};c.fieldInfos=J;c.picker=new KintoneBoosterRecordPicker("record");try{(function(t){if(0!=t.length){var D=function(){var m=t;if("change"==
d.pattern){if(t.some(function(h){return!h.triggers}))return kb.alert(kb.error.config.update("Boost! Action")),[];m=t.filter(function(h){return function(f){return!f.first()||f.includes(d.field)}(h.triggers.value.map(function(f){return f.value.field.value}))})}return m}();0!=D.length?M(D,d.record,d.container,d.workplace?d.workplace:"record").then(function(m){d.performed=m.performed;l(d)})["catch"](function(){return l(d)}):l(d)}else l(d)})(JSON.parse(L.tab).map(function(t,D){return kb.extend({sIndex:{value:D.toString()}},
t.setting)}).reduce(function(t,D){(d.mobile?["both","mobile"]:["both","pc"]).includes(D.device.value)&&D.event.value.includes(d.pattern)&&t.push(D);return t},[]))}catch(t){kb.alert(kb.error.parse(t)),l(d)}})["catch"](function(J){return l(d)}):l(d)})["catch"](function(L){return l(d)})})})})(kintone.$PLUGIN_ID);