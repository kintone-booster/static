/*
* FileName "plugins.action.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(D){var a={},E=function(c,e,H){var A=!1;return new Promise(function(B,r){var u=function(l,n){var g=JSON.stringify(kb.record.simplify({fields:a.fieldInfos.origin},e)),d=function(){g!=JSON.stringify(kb.record.simplify({fields:a.fieldInfos.origin},e))&&(A=!0);l++;l<c.length?u(l,n):n()};(function(b){var h=kb.filter.scan(a.app,e,b.condition.value);h?kb.filter.auth(b.user.value,b.organization.value,b.group.value).then(function(y){y?(b.clear.value.map(function(f){return f.value}).each(function(f,
p){f.table.value in a.fieldInfos.tables&&(e[f.table.value].value=e[f.table.value].value.filter(function(m){return!h[f.table.value].value.includes(m)}),h[f.table.value].value=[])}),b.fill.value.map(function(f){return f.value}).each(function(f,p){f.table.value in a.fieldInfos.tables&&function(m){m=kb.isNumeric(m)?parseInt(m)-h[f.table.value].value.length:0;0<m&&Array(m).fill().map(function(){return kb.record.create(a.fieldInfos.origin[f.table.value],!1)}).each(function(q,F){e[f.table.value]==h[f.table.value]?
e[f.table.value].value.push({value:q}):(e[f.table.value].value.push({value:q}),h[f.table.value].value.push({value:q}))})}(kb.formula.calculate({field:{value:Object.values(a.fieldInfos.parallelize).first().code},formula:f.range},h,h,e,a.fieldInfos.parallelize))}),b.formula.value.map(function(f){return f.value}).each(function(f,p){f.field.value in a.fieldInfos.parallelize&&function(m){m.tableCode?h[m.tableCode].value.each(function(q,F){q.value[m.code].value=kb.formula.calculate(f,q.value,h,e,a.fieldInfos.parallelize);
"lookup"==m.type&&(q.value[m.code].lookup=!0)}):(h[m.code].value=kb.formula.calculate(f,h,h,e,a.fieldInfos.parallelize),"lookup"==m.type&&(h[m.code].lookup=!0))}(a.fieldInfos.parallelize[f.field.value])}),b.app.value?kb.field.load(b.app.value).then(function(f){(function(p){var m=[],q=[],F=function(k,t){var v=function(z,w){return z.lookup?kb.extend({lookup:!0},w):w};kb.view.records.get(b.app.value,t.query,t.sort).then(function(z){0!=z.length?function(w){b.limited.value.includes("limited")||1==z.length?
w(z.first()):a.picker.show({app:b.app.value,query:t.query,sort:t.sort,picker:m.reduce(function(x,C){x[C.external.code]=C.external;return x},{})},function(x){return w(x)})}(function(w){m.each(function(x,C){if(b.overwrite.value.includes("overwrite")||kb.field.isEmpty(t.record[x.internal.code].value))t.record[x.internal.code]=v(x.internal,w[x.external.code])});k++;k<q.length?F(k,q[k]):(b.latest=G(),d())}):(b.reset.value.includes("reset")&&m.each(function(w,x){t.record[w.internal.code]=v(w.internal,kb.record.create({fields:{empty:w.internal}}).empty)}),
k++,k<q.length?F(k,q[k]):(b.latest=G(),d()))})["catch"](function(z){kb.alert(kb.error.parse(z));r()})},G=function(){return function(k){return JSON.stringify(q.reduce(function(t,v){t.push(v.query);t.push(kb.record.simplify({fields:k},v.record));return t},[]))}(m.reduce(function(k,t){k[t.internal.code]=t.internal;return k},{}))};b.criteria.value.some(function(k){return!(k.value.external.value in p.external&&k.value.internal.value in p.internal)})?(kb.alert("No field to lookup was found"),r()):b.mapping.value.some(function(k){return!(k.value.external.value in
p.external&&k.value.internal.value in p.internal)})?(kb.alert("No field to lookup was found"),r()):(m=b.mapping.value.map(function(k){return{external:p.external[k.value.external.value],internal:p.internal[k.value.internal.value]}}),q=function(k){return k.map(function(t){return{query:b.criteria.value.reduce(function(v,z){var w=p.external[z.value.external.value],x=z.value.operator.value,C=p.internal[z.value.internal.value];var I=C.tableCode?t.value:e;b.ignore.value.includes("ignore")&&kb.field.isEmpty(I[C.code].value)||
v.push(kb.filter.query.create(w,x,I[C.code]));return v},kb.filter.query.parse(b.filter.value).map(function(v){return p.external[v.field].code+" "+v.operator+" "+v.value})).join(" and "),sort:(0!=b.sort.value.length?b.sort.value.map(function(v){return v.value.field.value+" "+v.value.order.value}):["$id asc"]).join(","),record:t.value}})}(function(k){return k?h[k].value:[{value:e}]}(Array.from(new Set(m.map(function(k){return k.internal.tableCode}))).first())),0!=q.length?b.latest&&b.latest==G()?d():
F(0,q.first()):d())})({external:f.origin,internal:a.fieldInfos.parallelize})})["catch"](function(f){kb.alert(kb.error.parse(f));r()}):d()):d()})["catch"](function(y){kb.alert(kb.error.parse(y));r()}):d()})(c[l])};u(0,function(){B({record:e,performed:A})})})};kintone.events.on("app.record.create.show app.record.detail.process.proceed app.record.detail.show app.record.edit.show app.record.index.show mobile.app.record.create.show mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.show mobile.app.record.index.show".split(" "),
function(c){return new Promise(function(e,H){(function(A,B){a.mobile=A;a.type=B;kb.config[D].config.get().then(function(r){0!=Object.keys(r).length?kb.field.load(kb.config[D].app,!0).then(function(u){a.app={id:kb.config[D].app,fields:u.origin};a.fieldInfos=u;a.picker=new KintoneBoosterRecordPicker("record");try{["create","edit","reuse"].includes(a.type)&&function(l){if(0!=l.length){var n="",g=null;kintone.events.on(u.changes.reduce(function(d,b){d.push("app.record.create.change."+b);d.push("app.record.edit.change."+
b);d.push("mobile.app.record.create.change."+b);d.push("mobile.app.record.edit.change."+b);return d},[]),function(d){if(function(){var b=!0;n&&(b=!1,n==JSON.stringify(kb.record.simplify({fields:u.origin},d.record))?(n="",g=null):g<(new Date).getTime()-5E3&&(n="",g=null,b=!0));b&&["DATETIME","TIME"].includes(d.changes.field.type)&&function(h){h&&(Array.isArray(h)?h:[h]).each(function(y,f){y.elm(".control-errors-content-gaia")&&(b=!1)})}(kb.field.get(u.parallelize[d.type.split(".").last()],a.mobile,
a.type));return b}())return E(l,d.record,"record").then(function(b){kb.event.call("kb.style.call",{record:d.record,mobile:a.mobile,pattern:"reuse"==a.type?"create":a.type,workplace:"record"}).then(function(h){if(b.performed||h.performed)n=JSON.stringify(kb.record.simplify({fields:u.origin},h.record)),g=(new Date).getTime(),(a.mobile?kintone.mobile.app.record:kintone.app.record).set(d)})["catch"](function(){})})["catch"](function(){}),d})}else e(c)}((a.config?a.config:a.config=JSON.parse(r.tab)).reduce(function(l,
n){(a.mobile?["both","mobile"]:["both","pc"]).includes(n.setting.device.value)&&n.setting.event.value.includes("change")&&l.push(n.setting);return l},[])),function(l){if(0!=l.length)switch(a.type){case "create":case "edit":case "reuse":E(l,c.record,"record").then(function(g){return e(c)})["catch"](function(){});break;case "process":(function(g){0!=g.length?E(g,c.record,"record").then(function(d){return e(c)})["catch"](function(){}):e(c)})(l.filter(function(g){return g.action.value==c.action.value+
":"+c.status.value+":"+c.nextStatus.value}));break;case "detail":var n=function(g){(function(d){kb.filter.scan(a.app,c.record,d.condition.value)?kb.filter.auth(d.user.value,d.organization.value,d.group.value).then(function(b){b&&kb.button.create(a.mobile,a.type,"kb-action-button"+g.toString(),d.label.value,d.message.value,function(){E([d],c.record,"record").then(function(h){kb.view.records.set(a.app.id,{put:[kb.view.records.transform(h.record)]}).then(function(y){return kb.alert("Done!",function(){return window.location.reload(!0)})})["catch"](function(y){return kb.alert(kb.error.parse(y))})})["catch"](function(){})});
g++;g<l.length&&n(g)})["catch"](function(b){g++;g<l.length&&n(g)}):(g++,g<l.length&&n(g))})(l[g])};n(0);e(c);break;case "index":n=function(g){(function(d){kb.filter.auth(d.user.value,d.organization.value,d.group.value).then(function(b){b&&(d.view.value&&d.view.value!=c.viewId.toString()||kb.button.create(a.mobile,a.type,"kb-action-button"+g.toString(),d.label.value,d.message.value,function(){kb.view.records.get(a.app.id,(a.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(function(h){var y=
[],f=function(p,m){E([d],h[p],"record").then(function(q){q.performed&&y.push(kb.view.records.transform(q.record));kb.progressUpdate();p++;p<h.length?f(p,m):m()})["catch"](function(){})};0!=h.length?(kb.progressStart(h.length),f(0,function(){kb.view.records.set(a.app.id,{put:y}).then(function(p){return kb.alert("Done!",function(){return window.location.reload(!0)})})["catch"](function(p){return kb.alert(kb.error.parse(p))})})):kb.alert("There are no records.")})["catch"](function(h){return kb.alert(kb.error.parse(h))})}));
g++;g<l.length&&n(g)})["catch"](function(b){g++;g<l.length&&n(g)})})(l[g])},n(0),e(c)}else e(c)}((a.config?a.config:a.config=JSON.parse(r.tab)).reduce(function(l,n){(a.mobile?["both","mobile"]:["both","pc"]).includes(n.setting.device.value)&&n.setting.event.value.includes(a.type)&&l.push(n.setting);return l},[]))}catch(l){kb.alert(kb.error.parse(l)),e(c)}})["catch"](function(u){return e(c)}):e(c)})["catch"](function(r){return e(c)})})("mobile"==c.type.split(".").first(),c.reuse?"reuse":c.type.split(".").slice(-2).first())})});
kb.event.on("kb.action.call",function(c){return new Promise(function(e,H){kb.config[D].config.get().then(function(A){0!=Object.keys(A).length?kb.field.load(kb.config[D].app,!0).then(function(B){a.app={id:kb.config[D].app,fields:B.origin};a.fieldInfos=B;a.picker=new KintoneBoosterRecordPicker("record");try{(function(r){0!=r.length?E(r,c.record,c.workplace?c.workplace:"record").then(function(u){c.performed=u.performed;e(c)})["catch"](function(){return e(c)}):e(c)})((a.config?a.config:a.config=JSON.parse(A.tab)).reduce(function(r,
u){(c.mobile?["both","mobile"]:["both","pc"]).includes(u.setting.device.value)&&u.setting.event.value.includes(c.pattern)&&r.push(u.setting);return r},[]))}catch(r){kb.alert(kb.error.parse(r)),e(c)}})["catch"](function(B){return e(c)}):e(c)})["catch"](function(A){return e(c)})})});kb.event.on("kb.action.installed",function(c){return{installed:a.config.some(function(e){return(c.mobile?["both","mobile"]:["both","pc"]).includes(e.setting.device.value)&&e.setting.event.value.includes("change")})}})})(kintone.$PLUGIN_ID);