/*
* FileName "plugins.attachment.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(J=>{var c={forceUpdate:!1,observers:[]},R={file:l=>{l=new Kuc.Attachment({className:"control-gaia kb-attachment-field-"+l.id,label:"",language:kb.operator.language,message:(()=>{var r="";switch(kb.operator.language){case "en":r="(Maximum: 1 GB)";break;case "ja":r="(\u6700\u59271 GB)";break;case "zh":r="(\u6700\u59271 GB)";break;case "zh-TW":r="(\u6700\u59271 GB)"}return r})(),requiredIcon:l.required});Object.defineProperty(l,"value",{get(){return this.files},set(r){var G=[],E=(D,w)=>{kb.file.download(r[D],
!0).then(x=>{G.push(new File([x],r[D].name,{type:r[D].contentType}));D++;D<r.length?E(D,w):w(G)}).catch(x=>{kb.alert(kb.error.parse(x));this.files=[]})};Array.isArray(r)&&0!=r.length?E(0,D=>this.files=D):this.files=[]},enumerable:!0,configurable:!0});return l}},P=l=>{var r={};if(l.useMultiline.value.includes("use")&&!c.mobile)for(var G in c.fieldInfos.tables)(E=>{var D=Object.keys(E.fields).filter(w=>l.multilines.value.map(x=>x.value.field.value).includes(w));0!=D.length&&(r[E.id]={tableInfo:E,lines:Object.keys(E.fields).reduce((w,
x)=>{D.includes(x)&&0!=w.last().length&&w.push([]);w.last().push(c.fieldInfos.parallelize[x].id);return w},[[]])})})(c.fieldInfos.tables[G]);return[l,r]},Q=(l,r,G)=>{(E=>{E.observe(kb.elm(".subtable-"+l.id+(c.mobile?"":" tbody")),{childList:!0,subtree:!1});(D=>{kb.elms(D).length==r[l.code].value.length&&G.each((w,x)=>w({record:r}))})(".subtable-"+l.id+(c.mobile?" .subtable-row-gaia":" tbody tr"));c.observers.push(E)})(new MutationObserver(()=>{G.each((E,D)=>E({record:r}))}))},L=(l,r,G,E=0)=>{l.scrollWidth>
l.clientWidth?(0<l.scrollLeft+E?r.removeAttr("disabled"):r.attr("disabled","disabled"),l.scrollLeft+E<l.scrollWidth-l.clientWidth?G.removeAttr("disabled"):G.attr("disabled","disabled")):(r.attr("disabled","disabled"),G.attr("disabled","disabled"))};kintone.events.on(["app.record.create.show","app.record.edit.show","mobile.app.record.create.show","mobile.app.record.edit.show"],l=>new Promise((r,G)=>{((E,D)=>{c.mobile=E;c.type=D;c.observers.each((w,x)=>w.disconnect());c.observers=[];kb.config[J].config.get().then(w=>
{0!=Object.keys(w).length?kb.field.load(kb.config[J].app,!0).then(x=>{c.app={id:kb.config[J].app,fields:x.origin};c.fieldInfos=x;try{(([u,I])=>{var B={};u.useLookupNavi.value.includes("use")&&(kb.event.off("kb.attachment.lookup.call"),Object.values(c.fieldInfos.parallelize).filter(m=>m.lookup).each((m,q)=>{(h=>{if(m.tableCode){var e=c.fieldInfos.tables[m.tableCode];e.code in B||(B[e.code]=[]);B[e.code].push(h);c.mobile&&h({record:l.record})}else h({record:l.record})})(h=>{((e,a)=>{e&&(Array.isArray(e)?
e:[e]).each((f,d)=>{f.value.parentNode.elm(".kb-attachment-lookup-operation")||(a(f.value,c.mobile?f.value:f.value.elm("input[type=text]")),f.nextSibling&&f.nextSibling.tagName.toLowerCase().startsWith("kuc")&&(b=>{b&&a(c.mobile?b:b.parentNode,b)})(f.nextSibling.elm("input[type=text]")),kb.event.on("kb.attachment.lookup.call",b=>{if(b.field==f&&f.nextSibling&&f.nextSibling.tagName.toLowerCase().startsWith("kuc")&&!f.nextSibling.elm(".kb-attachment-lookup-operation")){var k=f.nextSibling.elm("input[type=text]");
a(c.mobile?k:k.parentNode,k)}return b}))})})(kb.field.get(m,c.mobile,c.type),(e,a)=>{e.parentNode.css({alignItems:"center"}).insertBefore(kb.create("button").addClass("kb-icon kb-icon-open kb-attachment-lookup-operation"+(c.mobile?" kb-mobile":"")).on("click",f=>{((d,b)=>{d?kb.view.records.get(b,kb.filter.query.create({code:m.lookup.relatedKeyField},"=",{type:m.type,value:d})).then(k=>{0!=k.length&&window.open(kb.record.page.detail(c.mobile,b,k.first().$id.value))}).catch(k=>kb.alert(kb.error.parse(k))):
window.open(kb.record.page.add(c.mobile,b))})(a.val(),m.lookup.relatedApp.app)}),e.nextSibling);c.mobile&&a.addClass("kb-attachment-lookup-operation-input kb-mobile")})})}));u.usePlaceholder.value.includes("use")&&u.placeholders.value.map(m=>m.value).each((m,q)=>{m.field.value in c.fieldInfos.parallelize&&(h=>{(e=>{if(h.tableCode){var a=c.fieldInfos.tables[h.tableCode];a.code in B||(B[a.code]=[]);B[a.code].push(e)}else e({record:l.record})})(e=>{(a=>{a&&(Array.isArray(a)?a:[a]).each((f,d)=>{c.mobile?
f.value.attr("placeholder",m.text.value):f.value.elm("input[type=text],textarea").attr("placeholder",m.text.value)})})(kb.field.get(h,c.mobile,c.type))})})(c.fieldInfos.parallelize[m.field.value])});u.useAlignTableButtons.value.includes("use")&&!c.mobile&&Object.values(x.tables).filter(m=>!Object.keys(I).includes(m.id)).each((m,q)=>{((h,e)=>{0!=l.record[h.code].value.length&&((a=>{a.prepend(a.elm('[class^="subtable-operation-gaia"]'))})(e.addClass("kb-attachment-subtable-operation").elm("thead").elm("tr")),
h.code in B||(B[h.code]=[]),B[h.code].push(a=>{e.elms("tbody tr").each((f,d)=>{Array.from(f.elms("td").last().classList).some(b=>b.startsWith("subtable-operation-gaia"))&&f.prepend(f.elm('[class^="subtable-operation-gaia"]'))})}))})(m,kb.elm(".subtable-"+m.id))});if(u.useMultiline.value.includes("use")&&!c.mobile)for(var y in I)((m,q)=>{var h=(e,a,f)=>{var d=[];a&&a.elms("tr").each((b,k)=>{b.hasClass("kb-attachment-subtable-multi")||(n=>{u.useAlignTableButtons.value.includes("use")?b.addClass("kb-attachment-subtable-multi").append(n):
b.addClass("kb-attachment-subtable-multi").prepend(n);e.lines.each((v,g)=>{n.append((p=>{v.each((C,t)=>{var F={};f?C?p.append(b.elm(".label-"+C).addClass("kb-attachment-subtable-multi-cell").css(F)):p.append(kb.create("th").addClass("subtable-label-gaia kb-attachment-subtable-multi-cell").css(F)):(F.width=q.elm("thead").elm(".label-"+C).css("width"),C?p.append(b.elm(".field-"+C).closest("td").addClass("kb-attachment-subtable-multi-cell").css(F)):p.append(kb.create("td").addClass("kb-attachment-subtable-multi-cell").css(F)));
t==v.length-1&&d.push(p.lastElementChild)});return p})(kb.create("div").css({alignItems:"stretch",display:"flex"})))});f&&(v=>{kb.children(n).each((g,p)=>{kb.children(g).reduce((C,t)=>C+=t.outerWidth(!1),0)<v&&kb.children(g).last().css({flex:"1"})})})(n.firstElementChild.outerWidth(!1))})(f?kb.create("th").addClass("subtable-label-gaia"):kb.create("td"))});f||d.each((b,k)=>b.css({flex:"1"}))};0!=l.record[m.tableInfo.code].value.length&&(u.useAlignTableButtons.value.includes("use")&&q.addClass("kb-attachment-subtable-operation"),
h(m,q.elm("thead"),!0),m.tableInfo.code in B||(B[m.tableInfo.code]=[]),B[m.tableInfo.code].push(e=>{h(m,q.elm("tbody"),!1)}))})(I[y],kb.elm(".subtable-"+I[y].tableInfo.id));"useTableCopy"in u||(kb.alert(kb.error.config.update("Boost! Attachment")),u.useTableCopy={value:[]});!u.useTableCopy.value.includes("use")&&!u.useTableSort.value.includes("use")||c.mobile||("object"===typeof Kuc?Object.values(c.fieldInfos.tables).each((m,q)=>{((h,e)=>{var a=null,f={},d=b=>{kb.event.call("kb.action.call",{container:kb.elm("body"),
record:b,mobile:c.mobile,pattern:"change",fields:[h.code].concat(Object.keys(h.fields)),stopPropagation:!0,workplace:"record"}).then(k=>{kb.event.call("kb.style.call",{container:k.container,record:k.record,mobile:k.mobile,pattern:"$id"in k.record?k.record.$id.value?"edit":"create":"create",workplace:k.workplace}).then(n=>{kb.event.call("kb.cascade.call",n).then(v=>{(c.mobile?kintone.mobile.app.record:kintone.app.record).set({record:v.record})}).catch(()=>{})}).catch(()=>{})}).catch(()=>{})};(b=>{h.code in
B||(B[h.code]=[]);B[h.code].push(b)})(b=>{try{var k=kintone.app.record.get().record}catch{k=b.record}(n=>{n[h.code].value.each((v,g)=>{Object.values(h.fields).filter(p=>"FILE"==p.type).each(p=>{(C=>{Array.isArray(C)&&0!=C.length&&((t,F)=>{t&&(t.nextSibling&&t.nextSibling.tagName.toLowerCase().startsWith("kuc")||(t.hide().insertAdjacentElement("afterend",R.file(p)),t.nextSibling.value=F?F:n[h.code].value[g].value[p.code].value),kb.isNumeric(a)&&a==g?(t.nextSibling.files=f[p.id],a=null,f={}):F&&(t.nextSibling.value=
F))})(C[g],(()=>{var t=null;kb.preset&&p.code in kb.preset.files&&g.toString()in kb.preset.files[p.code]&&(t=kb.preset.files[p.code][g.toString()],delete kb.preset.files[p.code][g.toString()]);return t})())})(kb.field.get(p,c.mobile,c.type))})})})(k);u.useTableCopy.value.includes("use")&&e.elms('[class^="subtable-operation-gaia"]').each((n,v)=>{((g,p)=>{g&&(n.elm(".kb-attachment-subtable-copy")||n.insertBefore(p.on("click",C=>{((t,F)=>{(K=>{a=t+1;f=Object.values(h.fields).filter(H=>"FILE"==H.type).reduce((H,
M)=>{H[M.id]=[...e.elms("tbody .kb-attachment-field-"+M.id)[t].files];return H},{});for(let H in K)if(void 0===K[H].value)switch(h.fields[H].type){case "CHECK_BOX":case "FILE":case "GROUP_SELECT":case "MULTI_SELECT":case "ORGANIZATION_SELECT":case "USER_SELECT":K[H].value=[];break;default:K[H].value=null}else h.fields[H].lookup&&(K[H].lookup=!0);F[h.code].value.splice(t+1,0,{value:K});d(F)})(kb.extend({},F[h.code].value[t].value))})(e.elms(".kb-attachment-subtable-copy").indexOf(p),kintone.app.record.get().record)}),
g.nextSibling))})(n.elm("button"),kb.create("button").addClass("kb-icon kb-icon-copy kb-attachment-subtable-copy"))})});u.useTableSort.value.includes("use")&&Object.values(h.fields).each((b,k)=>{var n=(v,g)=>{var p=(()=>{var C=!1;if("NUMBER"==b.type)C=!0;else switch(b.type){case "CALC":switch(b.format){case "NUMBER":case "NUMBER_DIGIT":C=!0}}return C})();v.each((C,t)=>C.rowIndex=t);return v.sort((C,t)=>(g?t.value[b.code].value||"":C.value[b.code].value||"").localeCompare(g?C.value[b.code].value||
"":t.value[b.code].value||"",void 0,p?{numeric:!0}:void 0))};if("CALC DATE DATETIME DROP_DOWN LINK NUMBER RADIO_BUTTON SINGLE_LINE_TEXT TIME".split(" ").includes(b.type))e.elm("thead .label-"+b.id).on("click",v=>{((g,p,C)=>{(t=>{g.hasClass(t+"desc")?g.removeClass(t+"desc").addClass(t+"asc"):g.removeClass(t+"asc").addClass(t+"desc");g.closest("tr").elms('[class*="'+CSS.escape(t)+'"]').each((F,K)=>{F!=g&&F.removeClass(t+"asc").removeClass(t+"desc")});p[h.code].value=n(p[h.code].value,g.hasClass(t+"desc"))})("kb-attachment-subtable-sort-");
(t=>{Object.values(h.fields).filter(F=>"FILE"==F.type).each((F,K)=>{C?((H,M)=>{e.elms("tbody tr").each((N,O)=>N.elms(".kb-attachment-subtable-multi-cell")[H].append(M[t[O]]))})(e.elms("thead .kb-attachment-subtable-multi-cell").indexOf(e.elm("thead .label-"+F.id)),e.elms("tbody .kb-attachment-field-"+F.id)):((H,M)=>{e.elms("tbody tr").each((N,O)=>N.elms("td")[H].append(M[t[O]]))})(Array.from(g.parentNode.children).indexOf(e.elm("thead .label-"+F.id)),e.elms("tbody .kb-attachment-field-"+F.id))})})(p[h.code].value.map(t=>
t.rowIndex));d(p)})(v.currentTarget,kintone.app.record.get().record,e.elm("thead tr").hasClass("kb-attachment-subtable-multi"))})});c.forceUpdate||(c.forceUpdate=0!=Object.values(h.fields).filter(b=>"FILE"==b.type).length)})(m,kb.elm(".subtable-"+m.id),!0)}):kb.alert(kb.error.config.reinstall("Boost! Attachment","https://kintone-booster.com/"+kb.operator.language.substring(0,2)+"/attachment.html")));if(u.useTab.value.includes("use")){u.tabs.value.map(m=>m.value).each((m,q)=>{m.field.value in c.fieldInfos.origin&&
(h=>{(e=>{e&&(e.addClass("kb-attachment-tab-operation"+(c.mobile?" kb-mobile":"")),((a,f,d)=>{a.elms(".input-radio-item-cybozu,.radio-gaia").each((b,k)=>{b.addClass("kb-attachment-tab")});a.append(kb.create("span").addClass("kb-attachment-tab-spacer"));a.parentNode.insertBefore(f.on("click",b=>{b=Math.floor(a.clientWidth/-2);L(a,f,d,b);a.scrollBy({left:b})}),a);a.parentNode.insertBefore(d.on("click",b=>{b=Math.ceil(a.clientWidth/2);L(a,f,d,b);a.scrollBy({left:b})}),a.nextSibling);L(a,f,d)})(e.elm(".input-radio-item-cybozu,.radio-gaia").parentNode.addClass("kb-attachment-tab-container"),
kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-left"),kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-right")))})(kb.field.get(h,c.mobile,c.type))})(c.fieldInfos.parallelize[m.field.value])});var z=u.activeTabColor.value||"transparent",A=u.inactiveTabColor.value||"transparent";kb.elm(".kb-tab-style")||kb.elm("head").append(kb.create("style").addClass("kb-tab-style").attr("type","text/css").text(`
.kb-attachment-tab label{
	background-color:${A};
}
.kb-attachment-tab input:checked+label{
	background-color:${z};
}
`))}if(c.forceUpdate)kintone.events.on(["app.record.create.submit.success","app.record.edit.submit.success"],function(m){return new kintone.Promise(function(q,h){try{var e=(a,f,d)=>{var b=(k,n,v)=>{0!=n.field.length?(g=>{kb.file.upload(g,!0).then(p=>{n.record.push({contentType:g.contentType,fileKey:p.fileKey,name:g.name,size:g.size});k++;k<n.field.length?b(k,n,v):v()})})(n.field[k]):v()};b(0,f[a],()=>{a++;a<f.length?e(a,f,d):d()})};c.observers.each((a,f)=>a.disconnect());c.observers=[];kb.loadStart();
e(0,Object.values(c.fieldInfos.tables).reduce((a,f)=>{(d=>{Object.values(f.fields).filter(b=>"FILE"==b.type).each((b,k)=>{d.elms("tbody .kb-attachment-field-"+b.id).each((n,v)=>{m.record[f.code].value[v].value[b.code].value=[];a.push({field:n.value,record:m.record[f.code].value[v].value[b.code].value})})})})(kb.elm(".subtable-"+f.id));return a},[]),()=>{var a={};a.$id=m.record.$id;Object.keys(c.fieldInfos.tables).each((f,d)=>a[f]=m.record[f]);kb.view.records.set(kintone.app.getId(),{put:[kb.view.records.transform(a)]},
!1).then(f=>{kb.loadEnd();q(m)}).catch(f=>kb.alert(kb.error.parse(f),()=>q(m)))})}catch(a){kb.alert(kb.error.parse(a),()=>q(m))}})});for(y in B)Q(c.fieldInfos.tables[y],l.record,B[y])})(P(JSON.parse(w.flat))),r(l)}catch(u){kb.alert(kb.error.parse(u)),r(l)}}).catch(x=>r(l)):r(l)}).catch(w=>r(l))})("mobile"==l.type.split(".").first(),l.type.split(".").slice(-2).first())}));kintone.events.on(["app.record.detail.show","mobile.app.record.detail.show"],l=>new Promise((r,G)=>{((E,D)=>{c.mobile=E;c.type=
D;c.observers.each((w,x)=>w.disconnect());c.observers=[];kb.config[J].config.get().then(w=>{0!=Object.keys(w).length?kb.field.load(kb.config[J].app,!0).then(x=>{c.app={id:kb.config[J].app,fields:x.origin};c.fieldInfos=x;try{(([u,I])=>{var B={};u.useAttachmentViewer.value.includes("use")&&Object.values(c.fieldInfos.parallelize).filter(A=>"FILE"==A.type).each((A,m)=>{(q=>{if(A.tableCode){var h=c.fieldInfos.tables[A.tableCode];h.code in B||(B[h.code]=[]);B[h.code].push(q)}else q({record:l.record})})(q=>
{(h=>{h&&(Array.isArray(h)?h:[h]).each((e,a)=>{(f=>{(c.mobile?kb.children(e.value):e.value.elm("ul").elms("li")).each((d,b)=>{d.elm("a")&&!d.elm(".kb-attachment-file-operation")&&(k=>{0!=k.length&&(d.prepend(kb.create("span").addClass("kb-attachment-file-operation").html(k.first().name).on("click",n=>kb.attachment.show(k.first(),!u.onlyView.value.includes("onlyView")))),f=f.filter(n=>n!=k.first()))})(f.filter(k=>k.name==d.elm("a").html()))})})(A.tableCode?q.record[A.tableCode].value[a].value[A.code].value:
q.record[A.code].value)})})(kb.field.get(A,c.mobile,c.type))})});if(u.useMultiline.value.includes("use")&&!c.mobile)for(var y in I)((A,m)=>{var q=(h,e,a)=>{var f=[];e&&e.elms("tr").each((d,b)=>{d.hasClass("kb-attachment-subtable-multi")||(k=>{d.addClass("kb-attachment-subtable-multi").prepend(k);h.lines.each((n,v)=>{k.append((g=>{n.each((p,C)=>{var t={};a?p?g.append(d.elm(".label-"+p).addClass("kb-attachment-subtable-multi-cell").css(t)):g.append(kb.create("th").addClass("subtable-label-gaia kb-attachment-subtable-multi-cell").css(t)):
(t.width=m.elm("thead").elm(".label-"+p).css("width"),p?g.append(d.elm(".field-"+p).closest("td").addClass("kb-attachment-subtable-multi-cell").css(t)):g.append(kb.create("td").addClass("kb-attachment-subtable-multi-cell").css(t)));C==n.length-1&&f.push(g.lastElementChild)});return g})(kb.create("div").css({alignItems:"stretch",display:"flex"})))});a&&(n=>{kb.children(k).each((v,g)=>{kb.children(v).reduce((p,C)=>p+=C.outerWidth(!1),0)<n&&kb.children(v).last().css({flex:"1"})})})(k.firstElementChild.outerWidth(!1))})(a?
kb.create("th").addClass("subtable-label-gaia"):kb.create("td"))});a||f.each((d,b)=>d.css({flex:"1"}))};0!=l.record[A.tableInfo.code].value.length&&(q(A,m.elm("thead"),!0),A.tableInfo.code in B||(B[A.tableInfo.code]=[]),B[A.tableInfo.code].push(h=>{q(A,m.elm("tbody"),!1)}))})(I[y],kb.elm(".subtable-"+I[y].tableInfo.id));"useTab"in u||(kb.alert(kb.error.config.update("Boost! Attachment")),u.useTab={value:[]});if(u.useTab.value.includes("use")){u.tabs.value.map(A=>A.value).each((A,m)=>{A.field.value in
c.fieldInfos.origin&&(q=>{(h=>{h&&(((e,a)=>{a.each((f,d)=>{e.elm(".kb-attachment-tab-container").append(kb.create("span").addClass("kb-attachment-tab").append(kb.create("input").attr("type","radio").attr("id",q.code+"_"+d).attr("name",q.code).attr("value",f.label).on("change",b=>{(k=>{kb.event.call("kb.style.call",{container:kb.elm("body"),record:(()=>{k[q.code].value=kb.elms('[name="'+CSS.escape(q.code)+'"]').find(n=>n.checked).attr("value");return k})(),mobile:c.mobile,pattern:"edit",workplace:"record"}).then(n=>
{}).catch(()=>{})})((c.mobile?kintone.mobile.app.record:kintone.app.record).get().record)})).append(kb.create("label").attr("for",q.code+"_"+d).html(f.label)))});e.elm(".kb-attachment-tab-container").append(kb.create("span").addClass("kb-attachment-tab-spacer"));h.css({display:"none"}).parentNode.insertBefore(e,h.nextSibling);((f,d,b)=>{d.on("click",k=>{k=Math.floor(f.clientWidth/-2);L(f,d,b,k);f.scrollBy({left:k})});b.on("click",k=>{k=Math.ceil(f.clientWidth/2);L(f,d,b,k);f.scrollBy({left:k})});
L(f,d,b)})(e.elm(".kb-attachment-tab-container"),e.elm(".kb-icon-arrow-left"),e.elm(".kb-icon-arrow-right"))})(kb.create("div").addClass("kb-attachment-tab-operation"+(c.mobile?" kb-mobile":"")).append(kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-left")).append(kb.create("div").addClass("kb-attachment-tab-container")).append(kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-right")),Object.values(q.options).reduce((e,a)=>{e[a.index]=a;return e},[])),(e=>{e&&(e.checked=
!0)})(kb.elm('[name="'+CSS.escape(q.code)+'"][value="'+CSS.escape(l.record[q.code].value)+'"]')))})(kb.field.get(q,c.mobile,c.type))})(c.fieldInfos.parallelize[A.field.value])});I=u.activeTabColor.value||"transparent";var z=u.inactiveTabColor.value||"transparent";kb.elm(".kb-tab-style")||kb.elm("head").append(kb.create("style").addClass("kb-tab-style").attr("type","text/css").text(`
.kb-attachment-tab label{
	background-color:${z};
}
.kb-attachment-tab input:checked+label{
	background-color:${I};
}
`))}for(y in B)Q(c.fieldInfos.tables[y],l.record,B[y])})(P(JSON.parse(w.flat))),r(l)}catch(u){kb.alert(kb.error.parse(u)),r(l)}}).catch(x=>r(l)):r(l)}).catch(w=>r(l))})("mobile"==l.type.split(".").first(),l.type.split(".").slice(-2).first())}));kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],l=>new Promise((r,G)=>{((E,D)=>{c.mobile=E;c.type=D;c.observers.each((w,x)=>w.disconnect());c.observers=[];kb.config[J].config.get().then(w=>{0!=Object.keys(w).length?kb.field.load(kb.config[J].app,
!0).then(x=>{c.app={id:kb.config[J].app,fields:x.origin};c.fieldInfos=x;try{(u=>{var I=()=>{u.useSearchBox.value.includes("use")?kb.view.load(c.app.id).then(B=>{(y=>{0==kb.roleSet.user.length?kb.roleSet.load().then(()=>y()):y()})(()=>{(y=>{var z=(()=>{var m={},q={},h=(a=>Object.keys(a).reduce((f,d)=>{"NONE"!=a[d]&&f.push(d);return f},[]))(cybozu.data.page.FIELD_ACCESSIBILITY||cybozu.data.page.FIELD_ACCESS_CONTROL.right.fields),e=a=>{var f={CREATED_AT:"CREATED_TIME",DECIMAL:"NUMBER",EDITOR:"RICH_TEXT",
MODIFIED_AT:"UPDATED_TIME",MULTIPLE_CHECK:"CHECK_BOX",MULTIPLE_SELECT:"MULTI_SELECT",MULTIPLE_LINE_TEXT:"MULTI_LINE_TEXT",RECORD_ID:"RECORD_NUMBER",SINGLE_CHECK:"RADIO_BUTTON",SINGLE_SELECT:"DROP_DOWN"};return a in f?f[a]:a};Object.values(cybozu.data.page.FORM_DATA.schema.table.fieldList).each((a,f)=>{if(h.includes(a.id))if("REFERENCE_TABLE"==a.type)q[a.id]=a.var;else switch(m[a.var]={id:"f"+a.id,type:e(a.type)},m[a.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":m[a.var].option=
(()=>{var d={};"options"in a.properties&&Array.isArray(a.properties.options)&&a.properties.options.each((b,k)=>{b.valid&&(d[b.label]=b.id)});return d})();break;case "STATUS":m[a.var].status=(()=>{var d={};(b=>{("string"===typeof b.useStatus?"true"==b.useStatus:b.useStatus)&&b.states.each((k,n)=>{k.valid&&(d[k.label]=k.id)})})(cybozu.data.page.STATUS_DATA);return d})()}});Object.values(cybozu.data.page.FORM_DATA.schema.subTable).map(a=>Object.values(a.fieldList)).flat().each((a,f)=>{if(h.includes(a.id))switch(m[a.var]=
{id:"f"+a.id,type:e(a.type)},m[a.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":m[a.var].option=(()=>{var d={};"options"in a.properties&&Array.isArray(a.properties.options)&&a.properties.options.each((b,k)=>{b.valid&&(d[b.label]=b.id)});return d})()}});cybozu.data.page.FORM_DATA.referenceTables.each((a,f)=>{a.masterApp.schema&&h.includes(a.fieldId)&&((d,b,k)=>{Object.values(a.masterApp.schema.table.fieldList).each((n,v)=>{if(!d.includes(n.id))switch(m[q[b]+"."+
n.var]={id:"f"+b+".f"+n.id,type:e(n.type)},m[q[b]+"."+n.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":m[q[b]+"."+n.var].option=(()=>{var g={};"options"in n.properties&&Array.isArray(n.properties.options)&&n.properties.options.each((p,C)=>{p.valid&&(g[p.label]=p.id)});return g})();break;case "STATUS":m[q[b]+"."+n.var].status=(()=>{var g={};("string"===typeof k.useStatus?"true"==k.useStatus:k.useStatus)&&k.states.each((p,C)=>{p.valid&&(g[p.label]=p.id)});return g})()}})})(a.masterApp.unAccessibleFieldIds,
a.fieldId,a.masterApp.status)});return m})(),A={build:m=>{var q=y.filterCond.match(/ and /g)?" and ":" or ",h=y.filterCond.split(q).filter(a=>a),e=(a,f)=>{0!=h.length?(d=>{if(d.info){var b=RegExp("[/\\\\^$*+?.()|[\\]{}]","g"),k=function(v){var g={groups:[],organizations:[],users:[]},p="";v.match(/ in /g)&&(C=>{C.each((t,F)=>{if(t.replace(/^[ ]+/g,"").replace(/[ ]+$/g,"").match(/^"/g))switch(t=t.replace(/^[ "]+/g,"").replace(/[ "]+$/g,""),t){case "GROUP":p="groups";break;case "ORGANIZATION":p="organizations";
break;case "USER":p="users";break;default:p||="users",g[p].push(t)}})})(v.split(" in ").last().replace(/^\(/g,"").replace(/\)$/g,"").split(","));return g};switch(d.info.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":for(var n in d.info.option)d.query.match(new RegExp('"'+n.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+n.replace(b,"\\$&")+'"'),'"'+d.info.option[n]+'"'));break;case "CREATOR":case "MODIFIER":case "USER_SELECT":(v=>{kb.roleSet.group.filter(g=>
v.groups.includes(g.code.value)).each((g,p)=>{d.query.match(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'),'"'+g.info.id+'"'))});kb.roleSet.organization.filter(g=>v.organizations.includes(g.code.value)).each((g,p)=>{d.query.match(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'),'"'+g.info.id+'"'))});kb.roleSet.user.filter(g=>v.users.includes(g.code.value)).each((g,
p)=>{d.query.match(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'),'"'+g.info.id+'"'))})})(k(d.query));break;case "GROUP_SELECT":(v=>{kb.roleSet.group.filter(g=>v.groups.includes(g.code.value)).each((g,p)=>{d.query.match(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'),'"'+g.info.id+'"'))})})(k(d.query));break;case "ORGANIZATION_SELECT":(v=>
{kb.roleSet.organization.filter(g=>v.organizations.includes(g.code.value)).each((g,p)=>{d.query.match(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'),'"'+g.info.id+'"'))})})(k(d.query));break;case "STATUS":for(n in d.info.status)d.query.match(new RegExp('"'+n.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+n.replace(b,"\\$&")+'"'),'"'+d.info.status[n]+'"'))}h[a]=d.query}else h[a]="";a++;a<h.length?e(a,
f):f(h.filter(v=>v).join(q))})((d=>{var b={info:null,query:""};1<d.length&&d.last()in z&&(b.info=z[d.last()],b.query=h[a].replace(new RegExp(d.last().replace(/[\/\\^$*+?.()|\[\]{}]/g,"\\$&")),b.info.id));return b})(h[a].match(/^([^ ]+)/))):f("")};e(0,a=>{m(a)})},search:m=>{var q=kb.elm(".kb-attachment-search-operation").elm(".kb-keyword").elm("input"),h=kb.elm(".kb-attachment-search-operation").elm(".kb-target").elm("select"),e=kintone.api.url("/k/",!0).replace(/\.json/g,"")+(c.mobile?"m/"+c.app.id:
c.app.id)+"/?view="+l.viewId.toString();if(q.val()){var a=(f=>{var d=(h.val()?[y.fields[h.val()]]:Object.values(y.fields)).reduce((b,k)=>{b.push(f.map(n=>{var v=n.match(/^!/g);n=n.replace(/^!/g,"");var g="";if("EMPTY"==n)switch(k.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":case "STATUS":g=z[k.code].id+(v?" not":"")+' in ("")';break;case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "RICH_TEXT":case "SINGLE_LINE_TEXT":g=z[k.code].id+(v?" !":" ")+'= ""'}else switch(k.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":n in
z[k.code].option&&(g=z[k.code].id+(v?" not":"")+' in ("'+z[k.code].option[n].replace(/"/g,'\\"')+'")');break;case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "RICH_TEXT":case "SINGLE_LINE_TEXT":g=z[k.code].id+(v?" not":"")+' like "'+n.replace(/"/g,'\\"')+'"';break;case "STATUS":n in z[k.code].status&&(g=z[k.code].id+(v?" not":"")+' in ("'+z[k.code].status[n].replace(/"/g,'\\"')+'")')}return g}).join(" or "));return b.filter(n=>n)},[]).map(b=>"("+b+")");return m?["("+m+")"].concat(d.join(" or ")).join(" and "):
d.join(" or ")})(q.val().split(/[ \u3000]/).filter(f=>f));window.location.href=a?e+"&keyword="+q.val()+"&target="+h.val()+"&q="+encodeURIComponent(a):e}else window.location.href=e}};y.fields=y.fields.reduce((m,q)=>{if(q in z)switch(c.fieldInfos.parallelize[q].type){case "CHECK_BOX":case "DROP_DOWN":case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "MULTI_SELECT":case "RADIO_BUTTON":case "RICH_TEXT":case "SINGLE_LINE_TEXT":m[q]=c.fieldInfos.parallelize[q]}return m},{});0!=Object.keys(y.fields).length?
A.build(m=>{(q=>{q.elm(".kb-attachment-search-operation")||(h=>{q.addClass("kb-scope").attr("form-id","form_"+h.id).append(kb.create("div").addClass("kb-attachment-search-operation"+(c.mobile?" kb-mobile":"")).append(kb.field.activate((e=>{e.elm("select").empty().assignOption([{code:"",label:"All"}].concat(Object.values(y.fields).map(a=>({code:a.code,label:a.label}))),"label","code");return e})(kb.field.create(h.fields.target).addClass("kb-target")),h)).append(kb.field.activate(kb.field.create(h.fields.keyword).addClass("kb-keyword"),
h)).append(kb.create("button").addClass("kb-icon kb-icon-lookup").on("click",e=>{A.search(m)})).append(kb.create("button").addClass("kb-icon kb-icon-del").on("click",e=>{e.currentTarget.parentNode.elm(".kb-keyword").elm("input").val("");A.search(m)})));kb.record.set(q,h,(e=>{var a={};"keyword"in e&&(a.keyword={value:e.keyword});"target"in e&&(a.target={value:e.target});return a})(kb.queries()));kb.event.on("kb.change.keyword",e=>{e.container==q&&A.search(m);return e})})({id:"AttachmentSearch",fields:{target:{code:"target",
type:"DROP_DOWN",label:"",required:!1,noLabel:!0,options:[{index:0,label:"open"},{index:1,label:"close"}]},keyword:{code:"keyword",type:"SINGLE_LINE_TEXT",label:"",required:!1,noLabel:!0,placeholder:""}}})})(c.mobile?kintone.mobile.app.getHeaderSpaceElement():kintone.app.getHeaderMenuSpaceElement());r(l)}):r(l)})(B.origin.reduce((y,z)=>{if(z.id==l.viewId.toString())switch(l.viewType){case "list":y=z;break;default:y.filterCond=z.filterCond}return y},{fields:Object.values(c.fieldInfos.parallelize).reduce((y,
z)=>{z.tableCode||y.push(z.code);return y},[]),filterCond:""}))})}):r(l)};"useBulkUpdate"in u||(kb.alert(kb.error.config.update("Boost! Attachment")),u.useBulkUpdate={value:[]});u.useBulkUpdate.value.includes("use")&&"list"==l.viewType?kb.filter.auth(u.permitUser.value,u.permitOrganization.value,u.permitGroup.value).then(B=>{B&&kb.icon.create(c.mobile,c.type,"kb-attachment-button","refresh",()=>{kb.record.builder.build(Object.values(c.fieldInfos.placed).reduce((y,z)=>{c.fieldInfos.disables.includes(z.code)||
z.tableCode||(y[z.code]=z);return y},{}),null,y=>{kb.view.records.get(c.app.id,(c.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(z=>{0!=z.length?kb.confirm(kb.constants.common.message.confirm.submit[kb.operator.language],()=>{kb.view.records.set(c.app.id,{put:z.map(A=>({id:A.$id.value,record:kb.extend({},y)}))}).then(A=>kb.alert("Done!",()=>window.location.reload(!0))).catch(A=>kb.alert(kb.error.parse(A)))}):kb.alert("There are no records.")}).catch(z=>kb.alert(kb.error.parse(z)))})});
I()}).catch(B=>I()):I()})(JSON.parse(w.flat))}catch(u){kb.alert(kb.error.parse(u)),r(l)}}).catch(x=>r(l)):r(l)}).catch(w=>r(l))})("mobile"==l.type.split(".").first(),l.type.split(".").slice(-2).first())}));kintone.events.on(["app.report.show","mobile.app.report.show"],l=>new Promise((r,G)=>{((E,D)=>{c.mobile=E;c.type=D;c.observers.each((w,x)=>w.disconnect());c.observers=[];kb.config[J].config.get().then(w=>{if(0!=Object.keys(w).length)try{var x=JSON.parse(w.flat);"usePivotTranspose"in x||(kb.alert(kb.error.config.update("Boost! Attachment")),
x.usePivotTranspose={value:[]});x.usePivotTranspose.value.includes("use")&&(kb.elm(".kb-pivottranspose-style")||kb.elm("head").append(kb.create("style").addClass("kb-pivottranspose-style").attr("type","text/css").text("\n.gaia-report-crosstable{\n\tborder:1px solid #e3e7e8;\n\tborder-collapse:collapse;\n\tborder-spacing:0;\n\twriting-mode:vertical-lr;\n}\n.gaia-report-crosstable :is(colgroup,tr){\n\tbackground-color:transparent !important;\n\tborder:none !important;\n}\n.gaia-report-crosstable tr :is(td,th){\n\tborder:1px solid #e3e7e8;\n\twriting-mode:horizontal-tb;\n\twhite-space:nowrap;\n}\n.gaia-report-crosstable tr>td:first-child{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable .gaia-report-crosstable-row-group .gaia-report-crosstable-groupname{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable .gaia-report-crosstable-row-total .gaia-report-crosstable-groupname{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable .gaia-report-crosstable-row-subtotal .gaia-report-crosstable-groupvalue{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-group>td:nth-child(2n+1){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-total>td:nth-child(2n+1){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-subtotal:has(td[rowspan])>td:nth-child(2n+1){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-subtotal:not(:has(td[rowspan]))>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:not(:has(td[rowspan])) .gaia-report-crosstable-row-group>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:not(:has(td[rowspan])) .gaia-report-crosstable-row-total>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:not(:has(td[rowspan])) .gaia-report-crosstable-row-subtotal>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n")));
r(l)}catch(u){kb.alert(kb.error.parse(u)),r(l)}else r(l)}).catch(w=>r(l))})("mobile"==l.type.split(".").first(),l.type.split(".").slice(-2).first())}));kb.event.on("kb.attachment.call",l=>new Promise((r,G)=>{kb.config[J].config.get().then(E=>{if(0!=Object.keys(E).length)try{(D=>{switch(l.mode){case "download":l.downloadable=D.useAttachmentViewer.value.includes("use")?!D.onlyView.value.includes("onlyView"):!0;break;case "placeholder":D.usePlaceholder.value.includes("use")&&(w=>{D.placeholders.value.map(x=>
x.value).each((x,u)=>{x.field.value in w&&(u=w[x.field.value],u.tableCode?l.fields[u.tableCode].fields[u.code].placeholder=x.text.value:l.fields[u.code].placeholder=x.text.value)})})(kb.field.parallelize(l.fields))}r(l)})(JSON.parse(E.flat))}catch(D){kb.alert(kb.error.parse(D)),r(l)}else r(l)}).catch(E=>r(l))}))})(kintone.$PLUGIN_ID);
