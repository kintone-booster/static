/*
* FileName "plugins.attachment.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(D=>{var f={},J=c=>{var t={};"useMultiline"in c||(kb.alert(kb.error.config.update("Boost! Attachment")),c.useMultiline={value:[]});if(c.useMultiline.value.includes("use")&&!f.mobile)for(var F in f.fieldInfos.tables)(A=>{var B=Object.keys(A.fields).filter(y=>c.multilines.value.map(w=>w.value.field.value).includes(y));0!=B.length&&(y=>{t[A.id]={tableInfo:A,colspans:(w=>y.map(q=>w-q.length))(Math.max(...y.map(w=>w.length))),lines:y}})(Object.keys(A.fields).reduce((y,w)=>{B.includes(w)&&
0!=y.last().length&&y.push([]);y.last().push(f.fieldInfos.parallelize[w].id);return y},[[]]))})(f.fieldInfos.tables[F]);return[c,t]},G=(c,t,F)=>{if(["create","edit"].includes(f.type))kintone.events.on(["app.record.create.change."+c.code,"app.record.edit.change."+c.code],F);if(kb.elms(".subtable-"+c.id+" tbody tr").length!=t[c.code].value.length){let A=new MutationObserver(()=>{kb.elms(".subtable-"+c.id+" tbody tr").length==t[c.code].value.length&&(F({record:t}),A.disconnect())});A.observe(kb.elm(".subtable-"+
c.id),{childList:!0,subtree:!0})}else F({record:t})};kintone.events.on(["app.record.create.show","app.record.edit.show","mobile.app.record.create.show","mobile.app.record.edit.show"],c=>new Promise((t,F)=>{((A,B)=>{f.mobile=A;f.type=B;kb.config[D].config.get().then(y=>{0!=Object.keys(y).length?kb.field.load(kb.config[D].app,!0).then(w=>{f.app={id:kb.config[D].app,fields:w.origin};f.fieldInfos=w;try{(([q,C])=>{q.useLookupNavi.value.includes("use")&&Object.values(f.fieldInfos.parallelize).filter(d=>
d.lookup).each((d,m)=>{(u=>{d.tableCode?G(f.fieldInfos.tables[d.tableCode],c.record,u):u({record:c.record})})(u=>{(g=>{g&&(Array.isArray(g)?g:[g]).each((l,n)=>{l.value.parentNode.elm(".kb-attachment-lookup-operation")||l.value.parentNode.css({alignItems:"center"}).insertBefore(kb.create("button").addClass("kb-icon kb-icon-open kb-attachment-lookup-operation").on("click",p=>{((b,x)=>{b?kb.view.records.get(x,kb.filter.query.create({code:d.lookup.relatedKeyField},"=",{type:d.type,value:b})).then(a=>
{0!=a.length&&window.open(kb.record.page.detail(f.mobile,x,a.first().$id.value))}).catch(a=>kb.alert(kb.error.parse(a))):window.open(kb.record.page.add(f.mobile,x))})(l.value.elm("input[type=text]").val(),d.lookup.relatedApp.app)}),l.value.nextSibling)})})(kb.field.get(d,f.mobile,f.type))})});q.usePlaceholder.value.includes("use")&&q.placeholders.value.map(d=>d.value).each((d,m)=>{d.field.value in f.fieldInfos.parallelize&&(u=>{(g=>{u.tableCode?G(f.fieldInfos.tables[u.tableCode],c.record,g):g({record:c.record})})(g=>
{(l=>{l&&(Array.isArray(l)?l:[l]).each((n,p)=>{f.mobile?n.value.attr("placeholder",d.text.value):n.value.elm("input[type=text],textarea").attr("placeholder",d.text.value)})})(kb.field.get(u,f.mobile,f.type))})})(f.fieldInfos.parallelize[d.field.value])});q.useAlignTableButtons.value.includes("use")&&!f.mobile&&Object.values(w.tables).filter(d=>!Object.keys(C).includes(d.id)).each((d,m)=>{((u,g)=>{(l=>{l.prepend(l.elm(".subtable-operation-gaia"))})(g.addClass("kb-attachment-subtable-operation").elm("thead").elm("tr"));
G(u,c.record,l=>{g.elms("tbody tr").each((n,p)=>{n.elms("td").last().hasClass("subtable-operation-gaia")&&n.prepend(n.elm(".subtable-operation-gaia"))})})})(d,kb.elm(".subtable-"+d.id))});if(q.useMultiline.value.includes("use")&&!f.mobile)for(var E in C)((d,m)=>{var u=(g,l,n)=>{l.elms("tr").each((p,b)=>{p.hasClass("kb-attachment-subtable-multi")||((x,a)=>{g.lines.each((e,r)=>{0==r?q.useAlignTableButtons.value.includes("use")&&a.prepend(a.elm(".subtable-operation-gaia")):(l.insertBefore((h=>{q.useAlignTableButtons.value.includes("use")&&
(n?h.append(kb.create("th").addClass("subtable-operation-gaia")):h.append(kb.create("td").addClass("subtable-operation-gaia")));e.each((v,k)=>{n?v?h.append(x.elm(".label-"+v)):h.append(kb.create("th").addClass("subtable-label-gaia")):v?h.append(x.elm(".field-"+v).closest("td")):h.append(kb.create("td"))});return h})(kb.create("tr").addClass("kb-attachment-subtable-multi")),a.nextSibling),a=a.nextSibling);0!=g.colspans[r]&&(h=>{n?a.elm(".label-"+e.last()).attr("colspan",h):a.elm(".field-"+e.last()).closest("td").attr("colspan",
h)})((g.colspans[r]+1).toString())})})(p.addClass("kb-attachment-subtable-multi"),p.addClass("kb-attachment-subtable-multi"))})};q.useAlignTableButtons.value.includes("use")&&m.addClass("kb-attachment-subtable-operation");u(d,m.elm("thead"),!0);G(d.tableInfo,c.record,g=>{u(d,m.elm("tbody"),!1)})})(C[E],kb.elm(".subtable-"+C[E].tableInfo.id))})(J(JSON.parse(y.flat))),t(c)}catch(q){kb.alert(kb.error.parse(q)),t(c)}}).catch(w=>t(c)):t(c)}).catch(y=>t(c))})("mobile"==c.type.split(".").first(),c.type.split(".").slice(-2).first())}));
kintone.events.on(["app.record.detail.show","mobile.app.record.detail.show"],c=>new Promise((t,F)=>{((A,B)=>{f.mobile=A;f.type=B;kb.config[D].config.get().then(y=>{0!=Object.keys(y).length?kb.field.load(kb.config[D].app,!0).then(w=>{f.app={id:kb.config[D].app,fields:w.origin};f.fieldInfos=w;try{(([q,C])=>{q.useAttachmentViewer.value.includes("use")&&Object.values(f.fieldInfos.parallelize).filter(d=>"FILE"==d.type).each((d,m)=>{(u=>{d.tableCode?G(f.fieldInfos.tables[d.tableCode],c.record,u):u({record:c.record})})(u=>
{(g=>{g&&(Array.isArray(g)?g:[g]).each((l,n)=>{(p=>{(f.mobile?kb.children(l.value):l.value.elm("ul").elms("li")).each((b,x)=>{b.elm("a")&&(a=>{0!=a.length&&(b.prepend(kb.create("span").addClass("kb-attachment-file-operation").html(a.first().name).on("click",e=>kb.attachment.show(a.first(),!q.onlyView.value.includes("onlyView")))),p=p.filter(e=>e!=a.first()))})(p.filter(a=>a.name==b.elm("a").html()))})})(d.tableCode?u.record[d.tableCode].value[n].value[d.code].value:u.record[d.code].value)})})(kb.field.get(d,
f.mobile,f.type))})});if(q.useMultiline.value.includes("use")&&!f.mobile)for(var E in C)((d,m)=>{var u=(g,l,n)=>{l.elms("tr").each((p,b)=>{p.hasClass("kb-attachment-subtable-multi")||((x,a)=>{g.lines.each((e,r)=>{0!=r&&(l.insertBefore((h=>{e.each((v,k)=>{n?v?h.append(x.elm(".label-"+v)):h.append(kb.create("th").addClass("subtable-label-gaia")):v?h.append(x.elm(".field-"+v).closest("td")):h.append(kb.create("td"))});return h})(kb.create("tr").addClass("kb-attachment-subtable-multi")),a.nextSibling),
a=a.nextSibling);0!=g.colspans[r]&&(h=>{n?a.elm(".label-"+e.last()).attr("colspan",h):a.elm(".field-"+e.last()).closest("td").attr("colspan",h)})((g.colspans[r]+1).toString())})})(p.addClass("kb-attachment-subtable-multi"),p.addClass("kb-attachment-subtable-multi"))})};u(d,m.elm("thead"),!0);G(d.tableInfo,c.record,g=>{u(d,m.elm("tbody"),!1)})})(C[E],kb.elm(".subtable-"+C[E].tableInfo.id))})(J(JSON.parse(y.flat))),t(c)}catch(q){kb.alert(kb.error.parse(q)),t(c)}}).catch(w=>t(c)):t(c)}).catch(y=>t(c))})("mobile"==
c.type.split(".").first(),c.type.split(".").slice(-2).first())}));kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],c=>new Promise((t,F)=>{((A,B)=>{f.mobile=A;f.type=B;kb.config[D].config.get().then(y=>{0!=Object.keys(y).length?kb.field.load(kb.config[D].app,!0).then(w=>{f.app={id:kb.config[D].app,fields:w.origin};f.fieldInfos=w;try{(q=>{var C=()=>{q.useSearchBox.value.includes("use")&&"list"==c.viewType?kb.view.load(f.app.id).then(E=>{(d=>{0==kb.roleSet.user.length?kb.roleSet.load().then(()=>
d()):d()})(()=>{(d=>{var m=(()=>{var g={},l={},n=(b=>Object.keys(b).reduce((x,a)=>{"NONE"!=b[a]&&x.push(a);return x},[]))(cybozu.data.page.FIELD_ACCESSIBILITY||cybozu.data.page.FIELD_ACCESS_CONTROL.right.fields),p=b=>{var x={CREATED_AT:"CREATED_TIME",DECIMAL:"NUMBER",EDITOR:"RICH_TEXT",MODIFIED_AT:"UPDATED_TIME",MULTIPLE_CHECK:"CHECK_BOX",MULTIPLE_SELECT:"MULTI_SELECT",MULTIPLE_LINE_TEXT:"MULTI_LINE_TEXT",RECORD_ID:"RECORD_NUMBER",SINGLE_CHECK:"RADIO_BUTTON",SINGLE_SELECT:"DROP_DOWN"};return b in
x?x[b]:b};Object.values(cybozu.data.page.FORM_DATA.schema.table.fieldList).each((b,x)=>{if(n.includes(b.id))if("REFERENCE_TABLE"==b.type)l[b.id]=b.var;else switch(g[b.var]={id:"f"+b.id,type:p(b.type)},g[b.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":g[b.var].option=(()=>{var a={};"options"in b.properties&&Array.isArray(b.properties.options)&&b.properties.options.each((e,r)=>{e.valid&&(a[e.label]=e.id)});return a})();break;case "STATUS":g[b.var].status=(()=>
{var a={};(e=>{("string"===typeof e.useStatus?"true"==e.useStatus:e.useStatus)&&e.states.each((r,h)=>{r.valid&&(a[r.label]=r.id)})})(cybozu.data.page.STATUS_DATA);return a})()}});Object.values(cybozu.data.page.FORM_DATA.schema.subTable).map(b=>Object.values(b.fieldList)).flat().each((b,x)=>{if(n.includes(b.id))switch(g[b.var]={id:"f"+b.id,type:p(b.type)},g[b.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":g[b.var].option=(()=>{var a={};"options"in b.properties&&
Array.isArray(b.properties.options)&&b.properties.options.each((e,r)=>{e.valid&&(a[e.label]=e.id)});return a})()}});cybozu.data.page.FORM_DATA.referenceTables.each((b,x)=>{b.masterApp.schema&&n.includes(b.fieldId)&&((a,e,r)=>{Object.values(b.masterApp.schema.table.fieldList).each((h,v)=>{if(!a.includes(h.id))switch(g[l[e]+"."+h.var]={id:"f"+e+".f"+h.id,type:p(h.type)},g[l[e]+"."+h.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":g[l[e]+"."+h.var].option=(()=>{var k=
{};"options"in h.properties&&Array.isArray(h.properties.options)&&h.properties.options.each((z,I)=>{z.valid&&(k[z.label]=z.id)});return k})();break;case "STATUS":g[l[e]+"."+h.var].status=(()=>{var k={};("string"===typeof r.useStatus?"true"==r.useStatus:r.useStatus)&&r.states.each((z,I)=>{z.valid&&(k[z.label]=z.id)});return k})()}})})(b.masterApp.unAccessibleFieldIds,b.fieldId,b.masterApp.status)});return g})(),u={build:g=>{var l=d.filterCond.match(/ and /g)?" and ":" or ",n=d.filterCond.split(l).filter(b=>
b),p=(b,x)=>{0!=n.length?(a=>{if(a.info){var e=RegExp("[/\\\\^$*+?.()|[\\]{}]","g"),r=function(v){var k={groups:[],organizations:[],users:[]},z="";v.match(/ in /g)&&(I=>{I.each((H,K)=>{if(H.replace(/^[ ]+/g,"").replace(/[ ]+$/g,"").match(/^"/g))switch(H=H.replace(/^[ "]+/g,"").replace(/[ "]+$/g,""),H){case "GROUP":z="groups";break;case "ORGANIZATION":z="organizations";break;case "USER":z="users";break;default:z||="users",k[z].push(H)}})})(v.split(" in ").last().replace(/^\(/g,"").replace(/\)$/g,"").split(","));
return k};switch(a.info.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":for(var h in a.info.option)a.query.match(new RegExp('"'+h.replace(e,"\\$&")+'"'))&&(a.query=a.query.replace(new RegExp('"'+h.replace(e,"\\$&")+'"'),'"'+a.info.option[h]+'"'));break;case "CREATOR":case "MODIFIER":case "USER_SELECT":(v=>{kb.roleSet.group.filter(k=>v.groups.includes(k.code.value)).each((k,z)=>{a.query.match(new RegExp('"'+k.code.value.replace(e,"\\$&")+'"'))&&(a.query=a.query.replace(new RegExp('"'+
k.code.value.replace(e,"\\$&")+'"'),'"'+k.info.id+'"'))});kb.roleSet.organization.filter(k=>v.organizations.includes(k.code.value)).each((k,z)=>{a.query.match(new RegExp('"'+k.code.value.replace(e,"\\$&")+'"'))&&(a.query=a.query.replace(new RegExp('"'+k.code.value.replace(e,"\\$&")+'"'),'"'+k.info.id+'"'))});kb.roleSet.user.filter(k=>v.users.includes(k.code.value)).each((k,z)=>{a.query.match(new RegExp('"'+k.code.value.replace(e,"\\$&")+'"'))&&(a.query=a.query.replace(new RegExp('"'+k.code.value.replace(e,
"\\$&")+'"'),'"'+k.info.id+'"'))})})(r(a.query));break;case "GROUP_SELECT":(v=>{kb.roleSet.group.filter(k=>v.groups.includes(k.code.value)).each((k,z)=>{a.query.match(new RegExp('"'+k.code.value.replace(e,"\\$&")+'"'))&&(a.query=a.query.replace(new RegExp('"'+k.code.value.replace(e,"\\$&")+'"'),'"'+k.info.id+'"'))})})(r(a.query));break;case "ORGANIZATION_SELECT":(v=>{kb.roleSet.organization.filter(k=>v.organizations.includes(k.code.value)).each((k,z)=>{a.query.match(new RegExp('"'+k.code.value.replace(e,
"\\$&")+'"'))&&(a.query=a.query.replace(new RegExp('"'+k.code.value.replace(e,"\\$&")+'"'),'"'+k.info.id+'"'))})})(r(a.query));break;case "STATUS":for(h in a.info.status)a.query.match(new RegExp('"'+h.replace(e,"\\$&")+'"'))&&(a.query=a.query.replace(new RegExp('"'+h.replace(e,"\\$&")+'"'),'"'+a.info.status[h]+'"'))}n[b]=a.query}else n[b]="";b++;b<n.length?p(b,x):x(n.filter(v=>v).join(l))})((a=>{var e={info:null,query:""};1<a.length&&a.last()in m&&(e.info=m[a.last()],e.query=n[b].replace(new RegExp(a.last().replace(/[\/\\^$*+?.()|\[\]{}]/g,
"\\$&")),e.info.id));return e})(n[b].match(/^([^ ]+)/))):x("")};p(0,b=>{g(b)})},search:g=>{var l=kb.elm(".kb-attachment-search-operation").elm(".kb-keyword").elm("input"),n=kb.elm(".kb-attachment-search-operation").elm(".kb-target").elm("select"),p=kintone.api.url("/k/",!0).replace(/\.json/g,"")+(f.mobile?"m/"+f.app.id:f.app.id)+"/?view="+c.viewId.toString();if(l.val()){var b=(x=>{var a=(n.val()?[d.fields[n.val()]]:Object.values(d.fields)).reduce((e,r)=>{e.push(x.map(h=>{var v=h.match(/^!/g);h=h.replace(/^!/g,
"");var k="";if("EMPTY"==h)switch(r.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":case "STATUS":k=m[r.code].id+(v?" not":"")+' in ("")';break;case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "RICH_TEXT":case "SINGLE_LINE_TEXT":k=m[r.code].id+(v?" !":" ")+'= ""'}else switch(r.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":h in m[r.code].option&&(k=m[r.code].id+(v?" not":"")+' in ("'+m[r.code].option[h].replace(/"/g,'\\"')+'")');
break;case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "RICH_TEXT":case "SINGLE_LINE_TEXT":k=m[r.code].id+(v?" not":"")+' like "'+h.replace(/"/g,'\\"')+'"';break;case "STATUS":h in m[r.code].status&&(k=m[r.code].id+(v?" not":"")+' in ("'+m[r.code].status[h].replace(/"/g,'\\"')+'")')}return k}).join(" or "));return e.filter(h=>h)},[]).map(e=>"("+e+")");return g?["("+g+")"].concat(a.join(" or ")).join(" and "):a.join(" or ")})(l.val().split(/[ \u3000]/).filter(x=>x));window.location.href=b?p+"&keyword="+
l.val()+"&target="+n.val()+"&q="+encodeURIComponent(b):p}else window.location.href=p}};d.fields=d.fields.reduce((g,l)=>{if(l in m)switch(f.fieldInfos.parallelize[l].type){case "CHECK_BOX":case "DROP_DOWN":case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "MULTI_SELECT":case "RADIO_BUTTON":case "RICH_TEXT":case "SINGLE_LINE_TEXT":g[l]=f.fieldInfos.parallelize[l]}return g},{});0!=Object.keys(d.fields).length?u.build(g=>{(l=>{l.elm(".kb-attachment-search-operation")||(n=>{l.addClass("kb-scope").attr("form-id",
"form_"+n.id).append(kb.create("div").addClass("kb-attachment-search-operation"+(f.mobile?" kb-mobile":"")).append(kb.field.activate((p=>{p.elm("select").empty().assignOption([{code:"",label:"All"}].concat(Object.values(d.fields).map(b=>({code:b.code,label:b.label}))),"label","code");return p})(kb.field.create(n.fields.target).addClass("kb-target")),n)).append(kb.field.activate(kb.field.create(n.fields.keyword).addClass("kb-keyword"),n)).append(kb.create("button").addClass("kb-icon kb-icon-lookup").on("click",
p=>{u.search(g)})).append(kb.create("button").addClass("kb-icon kb-icon-del").on("click",p=>{p.currentTarget.parentNode.elm(".kb-keyword").elm("input").val("");u.search(g)})));kb.record.set(l,n,(p=>{var b={};"keyword"in p&&(b.keyword={value:p.keyword});"target"in p&&(b.target={value:p.target});return b})(kb.queries()));kb.event.on("kb.change.keyword",p=>{p.container==l&&u.search(g);return p})})({id:"AttachmentSearch",fields:{target:{code:"target",type:"DROP_DOWN",label:"",required:!1,noLabel:!0,options:[{index:0,
label:"open"},{index:1,label:"close"}]},keyword:{code:"keyword",type:"SINGLE_LINE_TEXT",label:"",required:!1,noLabel:!0,placeholder:""}}})})(f.mobile?kintone.mobile.app.getHeaderSpaceElement():kintone.app.getHeaderMenuSpaceElement());t(c)}):t(c)})(E.list.reduce((d,m)=>{m.id==c.viewId.toString()&&(d=m);return d},{fields:Object.values(f.fieldInfos.parallelize).reduce((d,m)=>{m.tableCode||d.push(m.code);return d},[]),filterCond:""}))})}):t(c)};"useBulkUpdate"in q||(kb.alert(kb.error.config.update("Boost! Attachment")),
q.useBulkUpdate={value:[]});q.useBulkUpdate.value.includes("use")&&"list"==c.viewType?kb.filter.auth(q.permitUser.value,q.permitOrganization.value,q.permitGroup.value).then(E=>{E&&kb.icon.create(f.mobile,f.type,"kb-attachment-button","refresh",()=>{kb.record.builder.build(Object.values(f.fieldInfos.placed).reduce((d,m)=>{f.fieldInfos.disables.includes(m.code)||m.tableCode||(d[m.code]=m);return d},{}),null,d=>{kb.view.records.get(f.app.id,(f.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(m=>
{0!=m.length?kb.confirm(kb.constants.common.message.confirm.submit[kb.operator.language],()=>{kb.view.records.set(f.app.id,{put:m.map(u=>({id:u.$id.value,record:kb.extend({},d)}))}).then(u=>kb.alert("Done!",()=>window.location.reload(!0))).catch(u=>kb.alert(kb.error.parse(u)))}):kb.alert("There are no records.")}).catch(m=>kb.alert(kb.error.parse(m)))})});C()}).catch(E=>C()):C()})(JSON.parse(y.flat))}catch(q){kb.alert(kb.error.parse(q)),t(c)}}).catch(w=>t(c)):t(c)}).catch(y=>t(c))})("mobile"==c.type.split(".").first(),
c.type.split(".").slice(-2).first())}));kb.event.on("kb.attachment.call",c=>new Promise((t,F)=>{kb.config[D].config.get().then(A=>{if(0!=Object.keys(A).length)try{(B=>{switch(c.mode){case "download":c.downloadable=B.useAttachmentViewer.value.includes("use")?!B.onlyView.value.includes("onlyView"):!0;break;case "placeholder":B.usePlaceholder.value.includes("use")&&(y=>{B.placeholders.value.map(w=>w.value).each((w,q)=>{w.field.value in y&&(q=y[w.field.value],q.tableCode?c.fields[q.tableCode].fields[q.code].placeholder=
w.text.value:c.fields[q.code].placeholder=w.text.value)})})(kb.field.parallelize(c.fields))}t(c)})(JSON.parse(A.flat))}catch(B){kb.alert(kb.error.parse(B)),t(c)}else t(c)}).catch(A=>t(c))}))})(kintone.$PLUGIN_ID);