/*
* FileName "plugins.attachment.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(H=>{var d={forceUpdate:!1,observers:[]},O={file:h=>{h=new Kuc.Attachment({className:"control-gaia kb-attachment-field-"+h.id,label:"",language:kb.operator.language,message:(()=>{var r="";switch(kb.operator.language){case "en":r="(Maximum: 1 GB)";break;case "ja":r="(\u6700\u59271 GB)";break;case "zh":r="(\u6700\u59271 GB)";break;case "zh-TW":r="(\u6700\u59271 GB)"}return r})(),requiredIcon:h.required});Object.defineProperty(h,"value",{get(){return this.files},set(r){var F=[],C=(B,v)=>{kb.file.download(r[B],
!0).then(w=>{F.push(new File([w],r[B].name,{type:r[B].contentType}));B++;B<r.length?C(B,v):v(F)}).catch(w=>{kb.alert(kb.error.parse(w));this.files=[]})};Array.isArray(r)&&0!=r.length?C(0,B=>this.files=B):this.files=[]},enumerable:!0,configurable:!0});return h}},M=h=>{var r={};if(h.useMultiline.value.includes("use")&&!d.mobile)for(var F in d.fieldInfos.tables)(C=>{var B=Object.keys(C.fields).filter(v=>h.multilines.value.map(w=>w.value.field.value).includes(v));0!=B.length&&(r[C.id]={tableInfo:C,lines:Object.keys(C.fields).reduce((v,
w)=>{B.includes(w)&&0!=v.last().length&&v.push([]);v.last().push(d.fieldInfos.parallelize[w].id);return v},[[]])})})(d.fieldInfos.tables[F]);return[h,r]},N=(h,r,F)=>{(C=>{C.observe(kb.elm(".subtable-"+h.id),{childList:!0,subtree:!0});kb.elms(".subtable-"+h.id+" tbody tr").length==r[h.code].value.length&&F.each((B,v)=>B({record:r}));d.observers.push(C)})(new MutationObserver(()=>{F.each((C,B)=>C({record:r}))}))},J=(h,r,F,C=0)=>{h.scrollWidth>h.clientWidth?(0<h.scrollLeft+C?r.removeAttr("disabled"):
r.attr("disabled","disabled"),h.scrollLeft+C<h.scrollWidth-h.clientWidth?F.removeAttr("disabled"):F.attr("disabled","disabled")):(r.attr("disabled","disabled"),F.attr("disabled","disabled"))};kintone.events.on(["app.record.create.show","app.record.edit.show","mobile.app.record.create.show","mobile.app.record.edit.show"],h=>new Promise((r,F)=>{((C,B)=>{d.mobile=C;d.type=B;d.observers.each((v,w)=>v.disconnect());d.observers=[];kb.config[H].config.get().then(v=>{0!=Object.keys(v).length?kb.field.load(kb.config[H].app,
!0).then(w=>{d.app={id:kb.config[H].app,fields:w.origin};d.fieldInfos=w;try{(([t,G])=>{var A={};t.useLookupNavi.value.includes("use")&&Object.values(d.fieldInfos.parallelize).filter(l=>l.lookup).each((l,p)=>{(n=>{if(l.tableCode){var f=d.fieldInfos.tables[l.tableCode];f.code in A||(A[f.code]=[]);A[f.code].push(n)}else n({record:h.record})})(n=>{(f=>{f&&(Array.isArray(f)?f:[f]).each((a,m)=>{a.value.parentNode.elm(".kb-attachment-lookup-operation")||a.value.parentNode.css({alignItems:"center"}).insertBefore(kb.create("button").addClass("kb-icon kb-icon-open kb-attachment-lookup-operation").on("click",
b=>{((c,k)=>{c?kb.view.records.get(k,kb.filter.query.create({code:l.lookup.relatedKeyField},"=",{type:l.type,value:c})).then(g=>{0!=g.length&&window.open(kb.record.page.detail(d.mobile,k,g.first().$id.value))}).catch(g=>kb.alert(kb.error.parse(g))):window.open(kb.record.page.add(d.mobile,k))})(a.value.elm("input[type=text]").val(),l.lookup.relatedApp.app)}),a.value.nextSibling)})})(kb.field.get(l,d.mobile,d.type))})});t.usePlaceholder.value.includes("use")&&t.placeholders.value.map(l=>l.value).each((l,
p)=>{l.field.value in d.fieldInfos.parallelize&&(n=>{(f=>{if(n.tableCode){var a=d.fieldInfos.tables[n.tableCode];a.code in A||(A[a.code]=[]);A[a.code].push(f)}else f({record:h.record})})(f=>{(a=>{a&&(Array.isArray(a)?a:[a]).each((m,b)=>{d.mobile?m.value.attr("placeholder",l.text.value):m.value.elm("input[type=text],textarea").attr("placeholder",l.text.value)})})(kb.field.get(n,d.mobile,d.type))})})(d.fieldInfos.parallelize[l.field.value])});t.useAlignTableButtons.value.includes("use")&&!d.mobile&&
Object.values(w.tables).filter(l=>!Object.keys(G).includes(l.id)).each((l,p)=>{((n,f)=>{0!=h.record[n.code].value.length&&((a=>{a.prepend(a.elm('[class^="subtable-operation-gaia"]'))})(f.addClass("kb-attachment-subtable-operation").elm("thead").elm("tr")),n.code in A||(A[n.code]=[]),A[n.code].push(a=>{f.elms("tbody tr").each((m,b)=>{Array.from(m.elms("td").last().classList).some(c=>c.startsWith("subtable-operation-gaia"))&&m.prepend(m.elm('[class^="subtable-operation-gaia"]'))})}))})(l,kb.elm(".subtable-"+
l.id))});if(t.useMultiline.value.includes("use")&&!d.mobile)for(var x in G)((l,p)=>{var n=(f,a,m)=>{var b=[];a&&a.elms("tr").each((c,k)=>{c.hasClass("kb-attachment-subtable-multi")||(g=>{t.useAlignTableButtons.value.includes("use")?c.addClass("kb-attachment-subtable-multi").append(g):c.addClass("kb-attachment-subtable-multi").prepend(g);f.lines.each((q,e)=>{g.append((u=>{q.each((E,D)=>{var I={};m?E?u.append(c.elm(".label-"+E).addClass("kb-attachment-subtable-multi-cell").css(I)):u.append(kb.create("th").addClass("subtable-label-gaia kb-attachment-subtable-multi-cell").css(I)):
(I.width=p.elm("thead").elm(".label-"+E).css("width"),E?u.append(c.elm(".field-"+E).closest("td").addClass("kb-attachment-subtable-multi-cell").css(I)):u.append(kb.create("td").addClass("kb-attachment-subtable-multi-cell").css(I)));D==q.length-1&&b.push(u.lastElementChild)});return u})(kb.create("div").css({alignItems:"stretch",display:"flex"})))});m&&(q=>{kb.children(g).each((e,u)=>{kb.children(e).reduce((E,D)=>E+=D.outerWidth(!1),0)<q&&kb.children(e).last().css({flex:"1"})})})(g.firstElementChild.outerWidth(!1))})(m?
kb.create("th").addClass("subtable-label-gaia"):kb.create("td"))});m||b.each((c,k)=>c.css({flex:"1"}))};0!=h.record[l.tableInfo.code].value.length&&(t.useAlignTableButtons.value.includes("use")&&p.addClass("kb-attachment-subtable-operation"),n(l,p.elm("thead"),!0),l.tableInfo.code in A||(A[l.tableInfo.code]=[]),A[l.tableInfo.code].push(f=>{n(l,p.elm("tbody"),!1)}))})(G[x],kb.elm(".subtable-"+G[x].tableInfo.id));t.useTableSort.value.includes("use")&&!d.mobile&&("object"===typeof Kuc?Object.values(d.fieldInfos.tables).each((l,
p)=>{((n,f)=>{(a=>{n.code in A||(A[n.code]=[]);A[n.code].push(a)})(a=>{try{var m=kintone.app.record.get().record}catch{m=a.record}(b=>{b[n.code].value.each((c,k)=>{Object.values(n.fields).filter(g=>"FILE"==g.type).each(g=>{var q=kb.field.get(g,d.mobile,d.type);Array.isArray(q)&&0!=q.length&&(q=q[k],q.nextSibling&&q.nextSibling.tagName.toLowerCase().startsWith("kuc")||(q.hide().insertAdjacentElement("afterend",O.file(g)),q.nextSibling.value=b[n.code].value[k].value[g.code].value))})})})(m)});Object.values(n.fields).each((a,
m)=>{var b=(c,k)=>{var g=(()=>{var q=!1;if("NUMBER"==a.type)q=!0;else switch(a.type){case "CALC":switch(a.format){case "NUMBER":case "NUMBER_DIGIT":q=!0}}return q})();c.each((q,e)=>q.rowIndex=e);return c.sort((q,e)=>(k?e.value[a.code].value||"":q.value[a.code].value||"").localeCompare(k?q.value[a.code].value||"":e.value[a.code].value||"",void 0,g?{numeric:!0}:void 0))};if("CALC DATE DATETIME DROP_DOWN LINK NUMBER RADIO_BUTTON SINGLE_LINE_TEXT TIME".split(" ").includes(a.type))f.elm("thead .label-"+
a.id).on("click",c=>{((k,g,q)=>{(e=>{k.hasClass(e+"desc")?k.removeClass(e+"desc").addClass(e+"asc"):k.removeClass(e+"asc").addClass(e+"desc");k.closest("tr").elms('[class*="'+CSS.escape(e)+'"]').each((u,E)=>{u!=k&&u.removeClass(e+"asc").removeClass(e+"desc")});g.record[n.code].value=b(g.record[n.code].value,k.hasClass(e+"desc"))})("kb-attachment-subtable-sort-");(e=>{Object.values(n.fields).filter(u=>"FILE"==u.type).each((u,E)=>{q?((D,I)=>{f.elms("tbody tr").each((K,L)=>K.elms(".kb-attachment-subtable-multi-cell")[D].append(I[e[L]]))})(f.elms("thead .kb-attachment-subtable-multi-cell").indexOf(f.elm("thead .label-"+
u.id)),f.elms("tbody .kb-attachment-field-"+u.id)):((D,I)=>{f.elms("tbody tr").each((K,L)=>K.elms("td")[D].append(I[e[L]]))})(Array.from(k.parentNode.children).indexOf(f.elm("thead .label-"+u.id)),f.elms("tbody .kb-attachment-field-"+u.id))})})(g.record[n.code].value.map(e=>e.rowIndex));kintone.app.record.set(g);kb.event.call("kb.style.call",{container:kb.elm("body"),record:g.record,mobile:d.mobile,pattern:"$id"in g.record?g.record.$id.value?"edit":"create":"create",workplace:"record"}).then(e=>{}).catch(()=>
{})})(c.currentTarget,kintone.app.record.get(),f.elm("thead tr").hasClass("kb-attachment-subtable-multi"))})});d.forceUpdate||(d.forceUpdate=0!=Object.values(n.fields).filter(a=>"FILE"==a.type).length)})(l,kb.elm(".subtable-"+l.id),!0)}):kb.alert(kb.error.config.reinstall("Boost! Attachment","https://kintone-booster.com/"+kb.operator.language.substring(0,2)+"/attachment.html")));"useTab"in t||(kb.alert(kb.error.config.update("Boost! Attachment")),t.useTab={value:[]});if(t.useTab.value.includes("use")){t.tabs.value.map(l=>
l.value).each((l,p)=>{l.field.value in d.fieldInfos.origin&&(n=>{(f=>{f&&(f.addClass("kb-attachment-tab-operation"+(d.mobile?" kb-mobile":"")),((a,m,b)=>{a.elms(".input-radio-item-cybozu,.radio-gaia").each((c,k)=>{c.addClass("kb-attachment-tab")});a.append(kb.create("span").addClass("kb-attachment-tab-spacer"));a.parentNode.insertBefore(m.on("click",c=>{c=Math.floor(a.clientWidth/-2);J(a,m,b,c);a.scrollBy({left:c})}),a);a.parentNode.insertBefore(b.on("click",c=>{c=Math.ceil(a.clientWidth/2);J(a,m,
b,c);a.scrollBy({left:c})}),a.nextSibling);J(a,m,b)})(f.elm(".input-radio-item-cybozu,.radio-gaia").parentNode.addClass("kb-attachment-tab-container"),kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-left"),kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-right")))})(kb.field.get(n,d.mobile,d.type))})(d.fieldInfos.parallelize[l.field.value])});var y=t.activeTabColor.value||"transparent",z=t.inactiveTabColor.value||"transparent";kb.elm(".kb-tab-style")||kb.elm("head").append(kb.create("style").addClass("kb-tab-style").attr("type",
"text/css").text(`
.kb-attachment-tab label{
	background-color:${z};
}
.kb-attachment-tab input:checked+label{
	background-color:${y};
}
`))}if(d.forceUpdate)kintone.events.on(["app.record.create.submit.success","app.record.edit.submit.success"],function(l){return new kintone.Promise(function(p,n){try{var f=(a,m,b)=>{var c=(k,g,q)=>{0!=g.field.length?(e=>{kb.file.upload(e,!0).then(u=>{g.record.push({contentType:e.contentType,fileKey:u.fileKey,name:e.name,size:e.size});k++;k<g.field.length?c(k,g,q):q()})})(g.field[k]):q()};c(0,m[a],()=>{a++;a<m.length?f(a,m,b):b()})};d.observers.each((a,m)=>a.disconnect());d.observers=[];kb.loadStart();
f(0,Object.values(d.fieldInfos.tables).reduce((a,m)=>{(b=>{Object.values(m.fields).filter(c=>"FILE"==c.type).each((c,k)=>{b.elms("tbody .kb-attachment-field-"+c.id).each((g,q)=>{l.record[m.code].value[q].value[c.code].value=[];a.push({field:g.value,record:l.record[m.code].value[q].value[c.code].value})})})})(kb.elm(".subtable-"+m.id));return a},[]),()=>{var a={};a.$id=l.record.$id;Object.keys(d.fieldInfos.tables).each((m,b)=>a[m]=l.record[m]);kb.view.records.set(kintone.app.getId(),{put:[kb.view.records.transform(a)]},
!1).then(m=>{kb.loadEnd();p(l)}).catch(m=>kb.alert(kb.error.parse(m),()=>p(l)))})}catch(a){kb.alert(kb.error.parse(a),()=>p(l))}})});for(x in A)N(d.fieldInfos.tables[x],h.record,A[x])})(M(JSON.parse(v.flat))),r(h)}catch(t){kb.alert(kb.error.parse(t)),r(h)}}).catch(w=>r(h)):r(h)}).catch(v=>r(h))})("mobile"==h.type.split(".").first(),h.type.split(".").slice(-2).first())}));kintone.events.on(["app.record.detail.show","mobile.app.record.detail.show"],h=>new Promise((r,F)=>{((C,B)=>{d.mobile=C;d.type=
B;d.observers.each((v,w)=>v.disconnect());d.observers=[];kb.config[H].config.get().then(v=>{0!=Object.keys(v).length?kb.field.load(kb.config[H].app,!0).then(w=>{d.app={id:kb.config[H].app,fields:w.origin};d.fieldInfos=w;try{(([t,G])=>{var A={};t.useAttachmentViewer.value.includes("use")&&Object.values(d.fieldInfos.parallelize).filter(z=>"FILE"==z.type).each((z,l)=>{(p=>{if(z.tableCode){var n=d.fieldInfos.tables[z.tableCode];n.code in A||(A[n.code]=[]);A[n.code].push(p)}else p({record:h.record})})(p=>
{(n=>{n&&(Array.isArray(n)?n:[n]).each((f,a)=>{(m=>{(d.mobile?kb.children(f.value):f.value.elm("ul").elms("li")).each((b,c)=>{b.elm("a")&&!b.elm(".kb-attachment-file-operation")&&(k=>{0!=k.length&&(b.prepend(kb.create("span").addClass("kb-attachment-file-operation").html(k.first().name).on("click",g=>kb.attachment.show(k.first(),!t.onlyView.value.includes("onlyView")))),m=m.filter(g=>g!=k.first()))})(m.filter(k=>k.name==b.elm("a").html()))})})(z.tableCode?p.record[z.tableCode].value[a].value[z.code].value:
p.record[z.code].value)})})(kb.field.get(z,d.mobile,d.type))})});if(t.useMultiline.value.includes("use")&&!d.mobile)for(var x in G)((z,l)=>{var p=(n,f,a)=>{var m=[];f&&f.elms("tr").each((b,c)=>{b.hasClass("kb-attachment-subtable-multi")||(k=>{b.addClass("kb-attachment-subtable-multi").prepend(k);n.lines.each((g,q)=>{k.append((e=>{g.each((u,E)=>{var D={};a?u?e.append(b.elm(".label-"+u).addClass("kb-attachment-subtable-multi-cell").css(D)):e.append(kb.create("th").addClass("subtable-label-gaia kb-attachment-subtable-multi-cell").css(D)):
(D.width=l.elm("thead").elm(".label-"+u).css("width"),u?e.append(b.elm(".field-"+u).closest("td").addClass("kb-attachment-subtable-multi-cell").css(D)):e.append(kb.create("td").addClass("kb-attachment-subtable-multi-cell").css(D)));E==g.length-1&&m.push(e.lastElementChild)});return e})(kb.create("div").css({alignItems:"stretch",display:"flex"})))});a&&(g=>{kb.children(k).each((q,e)=>{kb.children(q).reduce((u,E)=>u+=E.outerWidth(!1),0)<g&&kb.children(q).last().css({flex:"1"})})})(k.firstElementChild.outerWidth(!1))})(a?
kb.create("th").addClass("subtable-label-gaia"):kb.create("td"))});a||m.each((b,c)=>b.css({flex:"1"}))};0!=h.record[z.tableInfo.code].value.length&&(p(z,l.elm("thead"),!0),z.tableInfo.code in A||(A[z.tableInfo.code]=[]),A[z.tableInfo.code].push(n=>{p(z,l.elm("tbody"),!1)}))})(G[x],kb.elm(".subtable-"+G[x].tableInfo.id));"useTab"in t||(kb.alert(kb.error.config.update("Boost! Attachment")),t.useTab={value:[]});if(t.useTab.value.includes("use")){t.tabs.value.map(z=>z.value).each((z,l)=>{z.field.value in
d.fieldInfos.origin&&(p=>{(n=>{n&&(((f,a)=>{a.each((m,b)=>{f.elm(".kb-attachment-tab-container").append(kb.create("span").addClass("kb-attachment-tab").append(kb.create("input").attr("type","radio").attr("id",p.code+"_"+b).attr("name",p.code).attr("value",m.label).on("change",c=>{(k=>{kb.event.call("kb.style.call",{container:kb.elm("body"),record:(()=>{k[p.code].value=kb.elms('[name="'+CSS.escape(p.code)+'"]').find(g=>g.checked).attr("value");return k})(),mobile:d.mobile,pattern:"edit",workplace:"record"}).then(g=>
{}).catch(()=>{})})((d.mobile?kintone.mobile.app.record:kintone.app.record).get().record)})).append(kb.create("label").attr("for",p.code+"_"+b).html(m.label)))});f.elm(".kb-attachment-tab-container").append(kb.create("span").addClass("kb-attachment-tab-spacer"));n.css({display:"none"}).parentNode.insertBefore(f,n.nextSibling);((m,b,c)=>{b.on("click",k=>{k=Math.floor(m.clientWidth/-2);J(m,b,c,k);m.scrollBy({left:k})});c.on("click",k=>{k=Math.ceil(m.clientWidth/2);J(m,b,c,k);m.scrollBy({left:k})});
J(m,b,c)})(f.elm(".kb-attachment-tab-container"),f.elm(".kb-icon-arrow-left"),f.elm(".kb-icon-arrow-right"))})(kb.create("div").addClass("kb-attachment-tab-operation"+(d.mobile?" kb-mobile":"")).append(kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-left")).append(kb.create("div").addClass("kb-attachment-tab-container")).append(kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-right")),Object.values(p.options).reduce((f,a)=>{f[a.index]=a;return f},[])),(f=>{f&&(f.checked=
!0)})(kb.elm('[name="'+CSS.escape(p.code)+'"][value="'+CSS.escape(h.record[p.code].value)+'"]')))})(kb.field.get(p,d.mobile,d.type))})(d.fieldInfos.parallelize[z.field.value])});G=t.activeTabColor.value||"transparent";var y=t.inactiveTabColor.value||"transparent";kb.elm(".kb-tab-style")||kb.elm("head").append(kb.create("style").addClass("kb-tab-style").attr("type","text/css").text(`
.kb-attachment-tab label{
	background-color:${y};
}
.kb-attachment-tab input:checked+label{
	background-color:${G};
}
`))}for(x in A)N(d.fieldInfos.tables[x],h.record,A[x])})(M(JSON.parse(v.flat))),r(h)}catch(t){kb.alert(kb.error.parse(t)),r(h)}}).catch(w=>r(h)):r(h)}).catch(v=>r(h))})("mobile"==h.type.split(".").first(),h.type.split(".").slice(-2).first())}));kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],h=>new Promise((r,F)=>{((C,B)=>{d.mobile=C;d.type=B;d.observers.each((v,w)=>v.disconnect());d.observers=[];kb.config[H].config.get().then(v=>{0!=Object.keys(v).length?kb.field.load(kb.config[H].app,
!0).then(w=>{d.app={id:kb.config[H].app,fields:w.origin};d.fieldInfos=w;try{(t=>{var G=()=>{t.useSearchBox.value.includes("use")?kb.view.load(d.app.id).then(A=>{(x=>{0==kb.roleSet.user.length?kb.roleSet.load().then(()=>x()):x()})(()=>{(x=>{var y=(()=>{var l={},p={},n=(a=>Object.keys(a).reduce((m,b)=>{"NONE"!=a[b]&&m.push(b);return m},[]))(cybozu.data.page.FIELD_ACCESSIBILITY||cybozu.data.page.FIELD_ACCESS_CONTROL.right.fields),f=a=>{var m={CREATED_AT:"CREATED_TIME",DECIMAL:"NUMBER",EDITOR:"RICH_TEXT",
MODIFIED_AT:"UPDATED_TIME",MULTIPLE_CHECK:"CHECK_BOX",MULTIPLE_SELECT:"MULTI_SELECT",MULTIPLE_LINE_TEXT:"MULTI_LINE_TEXT",RECORD_ID:"RECORD_NUMBER",SINGLE_CHECK:"RADIO_BUTTON",SINGLE_SELECT:"DROP_DOWN"};return a in m?m[a]:a};Object.values(cybozu.data.page.FORM_DATA.schema.table.fieldList).each((a,m)=>{if(n.includes(a.id))if("REFERENCE_TABLE"==a.type)p[a.id]=a.var;else switch(l[a.var]={id:"f"+a.id,type:f(a.type)},l[a.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":l[a.var].option=
(()=>{var b={};"options"in a.properties&&Array.isArray(a.properties.options)&&a.properties.options.each((c,k)=>{c.valid&&(b[c.label]=c.id)});return b})();break;case "STATUS":l[a.var].status=(()=>{var b={};(c=>{("string"===typeof c.useStatus?"true"==c.useStatus:c.useStatus)&&c.states.each((k,g)=>{k.valid&&(b[k.label]=k.id)})})(cybozu.data.page.STATUS_DATA);return b})()}});Object.values(cybozu.data.page.FORM_DATA.schema.subTable).map(a=>Object.values(a.fieldList)).flat().each((a,m)=>{if(n.includes(a.id))switch(l[a.var]=
{id:"f"+a.id,type:f(a.type)},l[a.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":l[a.var].option=(()=>{var b={};"options"in a.properties&&Array.isArray(a.properties.options)&&a.properties.options.each((c,k)=>{c.valid&&(b[c.label]=c.id)});return b})()}});cybozu.data.page.FORM_DATA.referenceTables.each((a,m)=>{a.masterApp.schema&&n.includes(a.fieldId)&&((b,c,k)=>{Object.values(a.masterApp.schema.table.fieldList).each((g,q)=>{if(!b.includes(g.id))switch(l[p[c]+"."+
g.var]={id:"f"+c+".f"+g.id,type:f(g.type)},l[p[c]+"."+g.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":l[p[c]+"."+g.var].option=(()=>{var e={};"options"in g.properties&&Array.isArray(g.properties.options)&&g.properties.options.each((u,E)=>{u.valid&&(e[u.label]=u.id)});return e})();break;case "STATUS":l[p[c]+"."+g.var].status=(()=>{var e={};("string"===typeof k.useStatus?"true"==k.useStatus:k.useStatus)&&k.states.each((u,E)=>{u.valid&&(e[u.label]=u.id)});return e})()}})})(a.masterApp.unAccessibleFieldIds,
a.fieldId,a.masterApp.status)});return l})(),z={build:l=>{var p=x.filterCond.match(/ and /g)?" and ":" or ",n=x.filterCond.split(p).filter(a=>a),f=(a,m)=>{0!=n.length?(b=>{if(b.info){var c=RegExp("[/\\\\^$*+?.()|[\\]{}]","g"),k=function(q){var e={groups:[],organizations:[],users:[]},u="";q.match(/ in /g)&&(E=>{E.each((D,I)=>{if(D.replace(/^[ ]+/g,"").replace(/[ ]+$/g,"").match(/^"/g))switch(D=D.replace(/^[ "]+/g,"").replace(/[ "]+$/g,""),D){case "GROUP":u="groups";break;case "ORGANIZATION":u="organizations";
break;case "USER":u="users";break;default:u||="users",e[u].push(D)}})})(q.split(" in ").last().replace(/^\(/g,"").replace(/\)$/g,"").split(","));return e};switch(b.info.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":for(var g in b.info.option)b.query.match(new RegExp('"'+g.replace(c,"\\$&")+'"'))&&(b.query=b.query.replace(new RegExp('"'+g.replace(c,"\\$&")+'"'),'"'+b.info.option[g]+'"'));break;case "CREATOR":case "MODIFIER":case "USER_SELECT":(q=>{kb.roleSet.group.filter(e=>
q.groups.includes(e.code.value)).each((e,u)=>{b.query.match(new RegExp('"'+e.code.value.replace(c,"\\$&")+'"'))&&(b.query=b.query.replace(new RegExp('"'+e.code.value.replace(c,"\\$&")+'"'),'"'+e.info.id+'"'))});kb.roleSet.organization.filter(e=>q.organizations.includes(e.code.value)).each((e,u)=>{b.query.match(new RegExp('"'+e.code.value.replace(c,"\\$&")+'"'))&&(b.query=b.query.replace(new RegExp('"'+e.code.value.replace(c,"\\$&")+'"'),'"'+e.info.id+'"'))});kb.roleSet.user.filter(e=>q.users.includes(e.code.value)).each((e,
u)=>{b.query.match(new RegExp('"'+e.code.value.replace(c,"\\$&")+'"'))&&(b.query=b.query.replace(new RegExp('"'+e.code.value.replace(c,"\\$&")+'"'),'"'+e.info.id+'"'))})})(k(b.query));break;case "GROUP_SELECT":(q=>{kb.roleSet.group.filter(e=>q.groups.includes(e.code.value)).each((e,u)=>{b.query.match(new RegExp('"'+e.code.value.replace(c,"\\$&")+'"'))&&(b.query=b.query.replace(new RegExp('"'+e.code.value.replace(c,"\\$&")+'"'),'"'+e.info.id+'"'))})})(k(b.query));break;case "ORGANIZATION_SELECT":(q=>
{kb.roleSet.organization.filter(e=>q.organizations.includes(e.code.value)).each((e,u)=>{b.query.match(new RegExp('"'+e.code.value.replace(c,"\\$&")+'"'))&&(b.query=b.query.replace(new RegExp('"'+e.code.value.replace(c,"\\$&")+'"'),'"'+e.info.id+'"'))})})(k(b.query));break;case "STATUS":for(g in b.info.status)b.query.match(new RegExp('"'+g.replace(c,"\\$&")+'"'))&&(b.query=b.query.replace(new RegExp('"'+g.replace(c,"\\$&")+'"'),'"'+b.info.status[g]+'"'))}n[a]=b.query}else n[a]="";a++;a<n.length?f(a,
m):m(n.filter(q=>q).join(p))})((b=>{var c={info:null,query:""};1<b.length&&b.last()in y&&(c.info=y[b.last()],c.query=n[a].replace(new RegExp(b.last().replace(/[\/\\^$*+?.()|\[\]{}]/g,"\\$&")),c.info.id));return c})(n[a].match(/^([^ ]+)/))):m("")};f(0,a=>{l(a)})},search:l=>{var p=kb.elm(".kb-attachment-search-operation").elm(".kb-keyword").elm("input"),n=kb.elm(".kb-attachment-search-operation").elm(".kb-target").elm("select"),f=kintone.api.url("/k/",!0).replace(/\.json/g,"")+(d.mobile?"m/"+d.app.id:
d.app.id)+"/?view="+h.viewId.toString();if(p.val()){var a=(m=>{var b=(n.val()?[x.fields[n.val()]]:Object.values(x.fields)).reduce((c,k)=>{c.push(m.map(g=>{var q=g.match(/^!/g);g=g.replace(/^!/g,"");var e="";if("EMPTY"==g)switch(k.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":case "STATUS":e=y[k.code].id+(q?" not":"")+' in ("")';break;case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "RICH_TEXT":case "SINGLE_LINE_TEXT":e=y[k.code].id+(q?" !":" ")+'= ""'}else switch(k.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":g in
y[k.code].option&&(e=y[k.code].id+(q?" not":"")+' in ("'+y[k.code].option[g].replace(/"/g,'\\"')+'")');break;case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "RICH_TEXT":case "SINGLE_LINE_TEXT":e=y[k.code].id+(q?" not":"")+' like "'+g.replace(/"/g,'\\"')+'"';break;case "STATUS":g in y[k.code].status&&(e=y[k.code].id+(q?" not":"")+' in ("'+y[k.code].status[g].replace(/"/g,'\\"')+'")')}return e}).join(" or "));return c.filter(g=>g)},[]).map(c=>"("+c+")");return l?["("+l+")"].concat(b.join(" or ")).join(" and "):
b.join(" or ")})(p.val().split(/[ \u3000]/).filter(m=>m));window.location.href=a?f+"&keyword="+p.val()+"&target="+n.val()+"&q="+encodeURIComponent(a):f}else window.location.href=f}};x.fields=x.fields.reduce((l,p)=>{if(p in y)switch(d.fieldInfos.parallelize[p].type){case "CHECK_BOX":case "DROP_DOWN":case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "MULTI_SELECT":case "RADIO_BUTTON":case "RICH_TEXT":case "SINGLE_LINE_TEXT":l[p]=d.fieldInfos.parallelize[p]}return l},{});0!=Object.keys(x.fields).length?
z.build(l=>{(p=>{p.elm(".kb-attachment-search-operation")||(n=>{p.addClass("kb-scope").attr("form-id","form_"+n.id).append(kb.create("div").addClass("kb-attachment-search-operation"+(d.mobile?" kb-mobile":"")).append(kb.field.activate((f=>{f.elm("select").empty().assignOption([{code:"",label:"All"}].concat(Object.values(x.fields).map(a=>({code:a.code,label:a.label}))),"label","code");return f})(kb.field.create(n.fields.target).addClass("kb-target")),n)).append(kb.field.activate(kb.field.create(n.fields.keyword).addClass("kb-keyword"),
n)).append(kb.create("button").addClass("kb-icon kb-icon-lookup").on("click",f=>{z.search(l)})).append(kb.create("button").addClass("kb-icon kb-icon-del").on("click",f=>{f.currentTarget.parentNode.elm(".kb-keyword").elm("input").val("");z.search(l)})));kb.record.set(p,n,(f=>{var a={};"keyword"in f&&(a.keyword={value:f.keyword});"target"in f&&(a.target={value:f.target});return a})(kb.queries()));kb.event.on("kb.change.keyword",f=>{f.container==p&&z.search(l);return f})})({id:"AttachmentSearch",fields:{target:{code:"target",
type:"DROP_DOWN",label:"",required:!1,noLabel:!0,options:[{index:0,label:"open"},{index:1,label:"close"}]},keyword:{code:"keyword",type:"SINGLE_LINE_TEXT",label:"",required:!1,noLabel:!0,placeholder:""}}})})(d.mobile?kintone.mobile.app.getHeaderSpaceElement():kintone.app.getHeaderMenuSpaceElement());r(h)}):r(h)})(A.origin.reduce((x,y)=>{if(y.id==h.viewId.toString())switch(h.viewType){case "list":x=y;break;default:x.filterCond=y.filterCond}return x},{fields:Object.values(d.fieldInfos.parallelize).reduce((x,
y)=>{y.tableCode||x.push(y.code);return x},[]),filterCond:""}))})}):r(h)};"useBulkUpdate"in t||(kb.alert(kb.error.config.update("Boost! Attachment")),t.useBulkUpdate={value:[]});t.useBulkUpdate.value.includes("use")&&"list"==h.viewType?kb.filter.auth(t.permitUser.value,t.permitOrganization.value,t.permitGroup.value).then(A=>{A&&kb.icon.create(d.mobile,d.type,"kb-attachment-button","refresh",()=>{kb.record.builder.build(Object.values(d.fieldInfos.placed).reduce((x,y)=>{d.fieldInfos.disables.includes(y.code)||
y.tableCode||(x[y.code]=y);return x},{}),null,x=>{kb.view.records.get(d.app.id,(d.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(y=>{0!=y.length?kb.confirm(kb.constants.common.message.confirm.submit[kb.operator.language],()=>{kb.view.records.set(d.app.id,{put:y.map(z=>({id:z.$id.value,record:kb.extend({},x)}))}).then(z=>kb.alert("Done!",()=>window.location.reload(!0))).catch(z=>kb.alert(kb.error.parse(z)))}):kb.alert("There are no records.")}).catch(y=>kb.alert(kb.error.parse(y)))})});
G()}).catch(A=>G()):G()})(JSON.parse(v.flat))}catch(t){kb.alert(kb.error.parse(t)),r(h)}}).catch(w=>r(h)):r(h)}).catch(v=>r(h))})("mobile"==h.type.split(".").first(),h.type.split(".").slice(-2).first())}));kintone.events.on(["app.report.show","mobile.app.report.show"],h=>new Promise((r,F)=>{((C,B)=>{d.mobile=C;d.type=B;d.observers.each((v,w)=>v.disconnect());d.observers=[];kb.config[H].config.get().then(v=>{if(0!=Object.keys(v).length)try{var w=JSON.parse(v.flat);"usePivotTranspose"in w||(kb.alert(kb.error.config.update("Boost! Attachment")),
w.usePivotTranspose={value:[]});w.usePivotTranspose.value.includes("use")&&(kb.elm(".kb-pivottranspose-style")||kb.elm("head").append(kb.create("style").addClass("kb-pivottranspose-style").attr("type","text/css").text("\n.gaia-report-crosstable{\n\tborder:1px solid #e3e7e8;\n\tborder-collapse:collapse;\n\tborder-spacing:0;\n\twriting-mode:vertical-lr;\n}\n.gaia-report-crosstable :is(colgroup,tr){\n\tbackground-color:transparent !important;\n\tborder:none !important;\n}\n.gaia-report-crosstable tr :is(td,th){\n\tborder:1px solid #e3e7e8;\n\twriting-mode:horizontal-tb;\n\twhite-space:nowrap;\n}\n.gaia-report-crosstable tr>td:first-child{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable .gaia-report-crosstable-row-group .gaia-report-crosstable-groupname{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable .gaia-report-crosstable-row-total .gaia-report-crosstable-groupname{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable .gaia-report-crosstable-row-subtotal .gaia-report-crosstable-groupvalue{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-group>td:nth-child(2n+1){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-total>td:nth-child(2n+1){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-subtotal:has(td[rowspan])>td:nth-child(2n+1){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-subtotal:not(:has(td[rowspan]))>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:not(:has(td[rowspan])) .gaia-report-crosstable-row-group>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:not(:has(td[rowspan])) .gaia-report-crosstable-row-total>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:not(:has(td[rowspan])) .gaia-report-crosstable-row-subtotal>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n")));
r(h)}catch(t){kb.alert(kb.error.parse(t)),r(h)}else r(h)}).catch(v=>r(h))})("mobile"==h.type.split(".").first(),h.type.split(".").slice(-2).first())}));kb.event.on("kb.attachment.call",h=>new Promise((r,F)=>{kb.config[H].config.get().then(C=>{if(0!=Object.keys(C).length)try{(B=>{switch(h.mode){case "download":h.downloadable=B.useAttachmentViewer.value.includes("use")?!B.onlyView.value.includes("onlyView"):!0;break;case "placeholder":B.usePlaceholder.value.includes("use")&&(v=>{B.placeholders.value.map(w=>
w.value).each((w,t)=>{w.field.value in v&&(t=v[w.field.value],t.tableCode?h.fields[t.tableCode].fields[t.code].placeholder=w.text.value:h.fields[t.code].placeholder=w.text.value)})})(kb.field.parallelize(h.fields))}r(h)})(JSON.parse(C.flat))}catch(B){kb.alert(kb.error.parse(B)),r(h)}else r(h)}).catch(C=>r(h))}))})(kintone.$PLUGIN_ID);
