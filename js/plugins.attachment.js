/*
* FileName "plugins.attachment.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(G=>{var f={forceUpdate:!1,observers:[]},L={file:g=>{g=new Kuc.Attachment({className:"control-gaia kb-attachment-field-"+g.id,label:"",language:kb.operator.language,message:(()=>{var r="";switch(kb.operator.language){case "en":r="(Maximum: 1 GB)";break;case "ja":r="(\u6700\u59271 GB)";break;case "zh":r="(\u6700\u59271 GB)";break;case "zh-TW":r="(\u6700\u59271 GB)"}return r})(),requiredIcon:g.required});Object.defineProperty(g,"value",{get(){return this.files},set(r){var E=[],C=(A,u)=>{kb.file.download(r[A],
!0).then(v=>{E.push(new File([v],r[A].name,{type:r[A].contentType}));A++;A<r.length?C(A,u):u(E)}).catch(v=>{kb.alert(kb.error.parse(v));this.files=[]})};Array.isArray(r)&&0!=r.length?C(0,A=>this.files=A):this.files=[]},enumerable:!0,configurable:!0});return g}},J=g=>{var r={};if(g.useMultiline.value.includes("use")&&!f.mobile)for(var E in f.fieldInfos.tables)(C=>{var A=Object.keys(C.fields).filter(u=>g.multilines.value.map(v=>v.value.field.value).includes(u));0!=A.length&&(r[C.id]={tableInfo:C,lines:Object.keys(C.fields).reduce((u,
v)=>{A.includes(v)&&0!=u.last().length&&u.push([]);u.last().push(f.fieldInfos.parallelize[v].id);return u},[[]])})})(f.fieldInfos.tables[E]);return[g,r]},K=(g,r,E)=>{(C=>{C.observe(kb.elm(".subtable-"+g.id),{childList:!0,subtree:!0});kb.elms(".subtable-"+g.id+" tbody tr").length==r[g.code].value.length&&E.each((A,u)=>A({record:r}));f.observers.push(C)})(new MutationObserver(()=>{E.each((C,A)=>C({record:r}))}))};kintone.events.on(["app.record.create.show","app.record.edit.show","mobile.app.record.create.show",
"mobile.app.record.edit.show"],g=>new Promise((r,E)=>{((C,A)=>{f.mobile=C;f.type=A;f.observers.each((u,v)=>u.disconnect());f.observers=[];kb.config[G].config.get().then(u=>{0!=Object.keys(u).length?kb.field.load(kb.config[G].app,!0).then(v=>{f.app={id:kb.config[G].app,fields:v.origin};f.fieldInfos=v;try{(([w,F])=>{var y={};w.useLookupNavi.value.includes("use")&&Object.values(f.fieldInfos.parallelize).filter(b=>b.lookup).each((b,B)=>{(n=>{if(b.tableCode){var h=f.fieldInfos.tables[b.tableCode];h.code in
y||(y[h.code]=[]);y[h.code].push(n)}else n({record:g.record})})(n=>{(h=>{h&&(Array.isArray(h)?h:[h]).each((e,m)=>{e.value.parentNode.elm(".kb-attachment-lookup-operation")||e.value.parentNode.css({alignItems:"center"}).insertBefore(kb.create("button").addClass("kb-icon kb-icon-open kb-attachment-lookup-operation").on("click",c=>{((q,d)=>{q?kb.view.records.get(d,kb.filter.query.create({code:b.lookup.relatedKeyField},"=",{type:b.type,value:q})).then(a=>{0!=a.length&&window.open(kb.record.page.detail(f.mobile,
d,a.first().$id.value))}).catch(a=>kb.alert(kb.error.parse(a))):window.open(kb.record.page.add(f.mobile,d))})(e.value.elm("input[type=text]").val(),b.lookup.relatedApp.app)}),e.value.nextSibling)})})(kb.field.get(b,f.mobile,f.type))})});w.usePlaceholder.value.includes("use")&&w.placeholders.value.map(b=>b.value).each((b,B)=>{b.field.value in f.fieldInfos.parallelize&&(n=>{(h=>{if(n.tableCode){var e=f.fieldInfos.tables[n.tableCode];e.code in y||(y[e.code]=[]);y[e.code].push(h)}else h({record:g.record})})(h=>
{(e=>{e&&(Array.isArray(e)?e:[e]).each((m,c)=>{f.mobile?m.value.attr("placeholder",b.text.value):m.value.elm("input[type=text],textarea").attr("placeholder",b.text.value)})})(kb.field.get(n,f.mobile,f.type))})})(f.fieldInfos.parallelize[b.field.value])});w.useAlignTableButtons.value.includes("use")&&!f.mobile&&Object.values(v.tables).filter(b=>!Object.keys(F).includes(b.id)).each((b,B)=>{((n,h)=>{0!=g.record[n.code].value.length&&((e=>{e.prepend(e.elm('[class^="subtable-operation-gaia"]'))})(h.addClass("kb-attachment-subtable-operation").elm("thead").elm("tr")),
n.code in y||(y[n.code]=[]),y[n.code].push(e=>{h.elms("tbody tr").each((m,c)=>{Array.from(m.elms("td").last().classList).some(q=>q.startsWith("subtable-operation-gaia"))&&m.prepend(m.elm('[class^="subtable-operation-gaia"]'))})}))})(b,kb.elm(".subtable-"+b.id))});if(w.useMultiline.value.includes("use")&&!f.mobile)for(var x in F)((b,B)=>{var n=(h,e,m)=>{var c=[];e&&e.elms("tr").each((q,d)=>{q.hasClass("kb-attachment-subtable-multi")||(a=>{w.useAlignTableButtons.value.includes("use")?q.addClass("kb-attachment-subtable-multi").append(a):
q.addClass("kb-attachment-subtable-multi").prepend(a);h.lines.each((k,l)=>{a.append((t=>{k.each((p,z)=>{var D={};m?p?t.append(q.elm(".label-"+p).addClass("kb-attachment-subtable-multi-cell").css(D)):t.append(kb.create("th").addClass("subtable-label-gaia kb-attachment-subtable-multi-cell").css(D)):(D.width=B.elm("thead").elm(".label-"+p).css("width"),p?t.append(q.elm(".field-"+p).closest("td").addClass("kb-attachment-subtable-multi-cell").css(D)):t.append(kb.create("td").addClass("kb-attachment-subtable-multi-cell").css(D)));
z==k.length-1&&c.push(t.lastElementChild)});return t})(kb.create("div").css({alignItems:"stretch",display:"flex"})))});m&&(k=>{kb.children(a).each((l,t)=>{kb.children(l).reduce((p,z)=>p+=z.outerWidth(!1),0)<k&&kb.children(l).last().css({flex:"1"})})})(a.firstElementChild.outerWidth(!1))})(m?kb.create("th").addClass("subtable-label-gaia"):kb.create("td"))});m||c.each((q,d)=>q.css({flex:"1"}))};0!=g.record[b.tableInfo.code].value.length&&(w.useAlignTableButtons.value.includes("use")&&B.addClass("kb-attachment-subtable-operation"),
n(b,B.elm("thead"),!0),b.tableInfo.code in y||(y[b.tableInfo.code]=[]),y[b.tableInfo.code].push(h=>{n(b,B.elm("tbody"),!1)}))})(F[x],kb.elm(".subtable-"+F[x].tableInfo.id));"useTableSort"in w||(kb.alert(kb.error.config.update("Boost! Attachment")),w.useTableSort={value:[]});w.useTableSort.value.includes("use")&&!f.mobile&&("object"===typeof Kuc?Object.values(f.fieldInfos.tables).each((b,B)=>{((n,h)=>{(e=>{n.code in y||(y[n.code]=[]);y[n.code].push(e)})(e=>{try{var m=kintone.app.record.get().record}catch{m=
e.record}(c=>{c[n.code].value.each((q,d)=>{Object.values(n.fields).filter(a=>"FILE"==a.type).each(a=>{var k=kb.field.get(a,f.mobile,f.type);Array.isArray(k)&&0!=k.length&&(k=k[d],k.nextSibling&&k.nextSibling.tagName.toLowerCase().startsWith("kuc")||(k.hide().insertAdjacentElement("afterend",L.file(a)),k.nextSibling.value=c[n.code].value[d].value[a.code].value))})})})(m)});Object.values(n.fields).each((e,m)=>{var c=(q,d)=>{var a=(()=>{var k=!1;if("NUMBER"==e.type)k=!0;else switch(e.type){case "CALC":switch(e.format){case "NUMBER":case "NUMBER_DIGIT":k=
!0}}return k})();q.each((k,l)=>k.rowIndex=l);return q.sort((k,l)=>(d?l.value[e.code].value||"":k.value[e.code].value||"").localeCompare(d?k.value[e.code].value||"":l.value[e.code].value||"",void 0,a?{numeric:!0}:void 0))};if("CALC DATE DATETIME DROP_DOWN LINK NUMBER RADIO_BUTTON SINGLE_LINE_TEXT TIME".split(" ").includes(e.type))h.elm("thead .label-"+e.id).on("click",q=>{((d,a,k)=>{(l=>{d.hasClass(l+"desc")?d.removeClass(l+"desc").addClass(l+"asc"):d.removeClass(l+"asc").addClass(l+"desc");d.closest("tr").elms('[class*="'+
CSS.escape(l)+'"]').each((t,p)=>{t!=d&&t.removeClass(l+"asc").removeClass(l+"desc")});a.record[n.code].value=c(a.record[n.code].value,d.hasClass(l+"desc"))})("kb-attachment-subtable-sort-");(l=>{Object.values(n.fields).filter(t=>"FILE"==t.type).each((t,p)=>{k?((z,D)=>{h.elms("tbody tr").each((H,I)=>H.elms(".kb-attachment-subtable-multi-cell")[z].append(D[l[I]]))})(h.elms("thead .kb-attachment-subtable-multi-cell").indexOf(h.elm("thead .label-"+t.id)),h.elms("tbody .kb-attachment-field-"+t.id)):((z,
D)=>{h.elms("tbody tr").each((H,I)=>H.elms("td")[z].append(D[l[I]]))})(Array.from(d.parentNode.children).indexOf(h.elm("thead .label-"+t.id)),h.elms("tbody .kb-attachment-field-"+t.id))})})(a.record[n.code].value.map(l=>l.rowIndex));kintone.app.record.set(a);kb.event.call("kb.style.call",{container:kb.elm("body"),record:a.record,mobile:f.mobile,pattern:"$id"in a.record?a.record.$id.value?"edit":"create":"create",workplace:"record"}).then(l=>{}).catch(()=>{})})(q.currentTarget,kintone.app.record.get(),
h.elm("thead tr").hasClass("kb-attachment-subtable-multi"))})});f.forceUpdate||(f.forceUpdate=0!=Object.values(n.fields).filter(e=>"FILE"==e.type).length)})(b,kb.elm(".subtable-"+b.id),!0)}):kb.alert(kb.error.config.reinstall("Boost! Attachment","https://kintone-booster.com/"+kb.operator.language.substring(0,2)+"/attachment.html")));if(f.forceUpdate)kintone.events.on(["app.record.create.submit.success","app.record.edit.submit.success"],function(b){return new kintone.Promise(function(B,n){try{var h=
(e,m,c)=>{var q=(d,a,k)=>{0!=a.field.length?(l=>{kb.file.upload(l,!0).then(t=>{a.record.push({contentType:l.contentType,fileKey:t.fileKey,name:l.name,size:l.size});d++;d<a.field.length?q(d,a,k):k()})})(a.field[d]):k()};q(0,m[e],()=>{e++;e<m.length?h(e,m,c):c()})};f.observers.each((e,m)=>e.disconnect());f.observers=[];kb.loadStart();h(0,Object.values(f.fieldInfos.tables).reduce((e,m)=>{(c=>{Object.values(m.fields).filter(q=>"FILE"==q.type).each((q,d)=>{c.elms("tbody .kb-attachment-field-"+q.id).each((a,
k)=>{b.record[m.code].value[k].value[q.code].value=[];e.push({field:a.value,record:b.record[m.code].value[k].value[q.code].value})})})})(kb.elm(".subtable-"+m.id));return e},[]),()=>{var e={};e.$id=b.record.$id;Object.keys(f.fieldInfos.tables).each((m,c)=>e[m]=b.record[m]);kb.view.records.set(kintone.app.getId(),{put:[kb.view.records.transform(e)]},!1).then(m=>{kb.loadEnd();B(b)}).catch(m=>kb.alert(kb.error.parse(m),()=>B(b)))})}catch(e){kb.alert(kb.error.parse(e),()=>B(b))}})});for(x in y)K(f.fieldInfos.tables[x],
g.record,y[x])})(J(JSON.parse(u.flat))),r(g)}catch(w){kb.alert(kb.error.parse(w)),r(g)}}).catch(v=>r(g)):r(g)}).catch(u=>r(g))})("mobile"==g.type.split(".").first(),g.type.split(".").slice(-2).first())}));kintone.events.on(["app.record.detail.show","mobile.app.record.detail.show"],g=>new Promise((r,E)=>{((C,A)=>{f.mobile=C;f.type=A;f.observers.each((u,v)=>u.disconnect());f.observers=[];kb.config[G].config.get().then(u=>{0!=Object.keys(u).length?kb.field.load(kb.config[G].app,!0).then(v=>{f.app={id:kb.config[G].app,
fields:v.origin};f.fieldInfos=v;try{(([w,F])=>{var y={};w.useAttachmentViewer.value.includes("use")&&Object.values(f.fieldInfos.parallelize).filter(b=>"FILE"==b.type).each((b,B)=>{(n=>{if(b.tableCode){var h=f.fieldInfos.tables[b.tableCode];h.code in y||(y[h.code]=[]);y[h.code].push(n)}else n({record:g.record})})(n=>{(h=>{h&&(Array.isArray(h)?h:[h]).each((e,m)=>{(c=>{(f.mobile?kb.children(e.value):e.value.elm("ul").elms("li")).each((q,d)=>{q.elm("a")&&!q.elm(".kb-attachment-file-operation")&&(a=>{0!=
a.length&&(q.prepend(kb.create("span").addClass("kb-attachment-file-operation").html(a.first().name).on("click",k=>kb.attachment.show(a.first(),!w.onlyView.value.includes("onlyView")))),c=c.filter(k=>k!=a.first()))})(c.filter(a=>a.name==q.elm("a").html()))})})(b.tableCode?n.record[b.tableCode].value[m].value[b.code].value:n.record[b.code].value)})})(kb.field.get(b,f.mobile,f.type))})});if(w.useMultiline.value.includes("use")&&!f.mobile)for(var x in F)((b,B)=>{var n=(h,e,m)=>{var c=[];e&&e.elms("tr").each((q,
d)=>{q.hasClass("kb-attachment-subtable-multi")||(a=>{q.addClass("kb-attachment-subtable-multi").prepend(a);h.lines.each((k,l)=>{a.append((t=>{k.each((p,z)=>{var D={};m?p?t.append(q.elm(".label-"+p).addClass("kb-attachment-subtable-multi-cell").css(D)):t.append(kb.create("th").addClass("subtable-label-gaia kb-attachment-subtable-multi-cell").css(D)):(D.width=B.elm("thead").elm(".label-"+p).css("width"),p?t.append(q.elm(".field-"+p).closest("td").addClass("kb-attachment-subtable-multi-cell").css(D)):
t.append(kb.create("td").addClass("kb-attachment-subtable-multi-cell").css(D)));z==k.length-1&&c.push(t.lastElementChild)});return t})(kb.create("div").css({alignItems:"stretch",display:"flex"})))});m&&(k=>{kb.children(a).each((l,t)=>{kb.children(l).reduce((p,z)=>p+=z.outerWidth(!1),0)<k&&kb.children(l).last().css({flex:"1"})})})(a.firstElementChild.outerWidth(!1))})(m?kb.create("th").addClass("subtable-label-gaia"):kb.create("td"))});m||c.each((q,d)=>q.css({flex:"1"}))};0!=g.record[b.tableInfo.code].value.length&&
(n(b,B.elm("thead"),!0),b.tableInfo.code in y||(y[b.tableInfo.code]=[]),y[b.tableInfo.code].push(h=>{n(b,B.elm("tbody"),!1)}))})(F[x],kb.elm(".subtable-"+F[x].tableInfo.id));for(x in y)K(f.fieldInfos.tables[x],g.record,y[x])})(J(JSON.parse(u.flat))),r(g)}catch(w){kb.alert(kb.error.parse(w)),r(g)}}).catch(v=>r(g)):r(g)}).catch(u=>r(g))})("mobile"==g.type.split(".").first(),g.type.split(".").slice(-2).first())}));kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],g=>new Promise((r,
E)=>{((C,A)=>{f.mobile=C;f.type=A;f.observers.each((u,v)=>u.disconnect());f.observers=[];kb.config[G].config.get().then(u=>{0!=Object.keys(u).length?kb.field.load(kb.config[G].app,!0).then(v=>{f.app={id:kb.config[G].app,fields:v.origin};f.fieldInfos=v;try{(w=>{var F=()=>{w.useSearchBox.value.includes("use")?kb.view.load(f.app.id).then(y=>{(x=>{0==kb.roleSet.user.length?kb.roleSet.load().then(()=>x()):x()})(()=>{(x=>{var b=(()=>{var n={},h={},e=(c=>Object.keys(c).reduce((q,d)=>{"NONE"!=c[d]&&q.push(d);
return q},[]))(cybozu.data.page.FIELD_ACCESSIBILITY||cybozu.data.page.FIELD_ACCESS_CONTROL.right.fields),m=c=>{var q={CREATED_AT:"CREATED_TIME",DECIMAL:"NUMBER",EDITOR:"RICH_TEXT",MODIFIED_AT:"UPDATED_TIME",MULTIPLE_CHECK:"CHECK_BOX",MULTIPLE_SELECT:"MULTI_SELECT",MULTIPLE_LINE_TEXT:"MULTI_LINE_TEXT",RECORD_ID:"RECORD_NUMBER",SINGLE_CHECK:"RADIO_BUTTON",SINGLE_SELECT:"DROP_DOWN"};return c in q?q[c]:c};Object.values(cybozu.data.page.FORM_DATA.schema.table.fieldList).each((c,q)=>{if(e.includes(c.id))if("REFERENCE_TABLE"==
c.type)h[c.id]=c.var;else switch(n[c.var]={id:"f"+c.id,type:m(c.type)},n[c.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":n[c.var].option=(()=>{var d={};"options"in c.properties&&Array.isArray(c.properties.options)&&c.properties.options.each((a,k)=>{a.valid&&(d[a.label]=a.id)});return d})();break;case "STATUS":n[c.var].status=(()=>{var d={};(a=>{("string"===typeof a.useStatus?"true"==a.useStatus:a.useStatus)&&a.states.each((k,l)=>{k.valid&&(d[k.label]=k.id)})})(cybozu.data.page.STATUS_DATA);
return d})()}});Object.values(cybozu.data.page.FORM_DATA.schema.subTable).map(c=>Object.values(c.fieldList)).flat().each((c,q)=>{if(e.includes(c.id))switch(n[c.var]={id:"f"+c.id,type:m(c.type)},n[c.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":n[c.var].option=(()=>{var d={};"options"in c.properties&&Array.isArray(c.properties.options)&&c.properties.options.each((a,k)=>{a.valid&&(d[a.label]=a.id)});return d})()}});cybozu.data.page.FORM_DATA.referenceTables.each((c,
q)=>{c.masterApp.schema&&e.includes(c.fieldId)&&((d,a,k)=>{Object.values(c.masterApp.schema.table.fieldList).each((l,t)=>{if(!d.includes(l.id))switch(n[h[a]+"."+l.var]={id:"f"+a+".f"+l.id,type:m(l.type)},n[h[a]+"."+l.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":n[h[a]+"."+l.var].option=(()=>{var p={};"options"in l.properties&&Array.isArray(l.properties.options)&&l.properties.options.each((z,D)=>{z.valid&&(p[z.label]=z.id)});return p})();break;case "STATUS":n[h[a]+
"."+l.var].status=(()=>{var p={};("string"===typeof k.useStatus?"true"==k.useStatus:k.useStatus)&&k.states.each((z,D)=>{z.valid&&(p[z.label]=z.id)});return p})()}})})(c.masterApp.unAccessibleFieldIds,c.fieldId,c.masterApp.status)});return n})(),B={build:n=>{var h=x.filterCond.match(/ and /g)?" and ":" or ",e=x.filterCond.split(h).filter(c=>c),m=(c,q)=>{0!=e.length?(d=>{if(d.info){var a=RegExp("[/\\\\^$*+?.()|[\\]{}]","g"),k=function(t){var p={groups:[],organizations:[],users:[]},z="";t.match(/ in /g)&&
(D=>{D.each((H,I)=>{if(H.replace(/^[ ]+/g,"").replace(/[ ]+$/g,"").match(/^"/g))switch(H=H.replace(/^[ "]+/g,"").replace(/[ "]+$/g,""),H){case "GROUP":z="groups";break;case "ORGANIZATION":z="organizations";break;case "USER":z="users";break;default:z||="users",p[z].push(H)}})})(t.split(" in ").last().replace(/^\(/g,"").replace(/\)$/g,"").split(","));return p};switch(d.info.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":for(var l in d.info.option)d.query.match(new RegExp('"'+
l.replace(a,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+l.replace(a,"\\$&")+'"'),'"'+d.info.option[l]+'"'));break;case "CREATOR":case "MODIFIER":case "USER_SELECT":(t=>{kb.roleSet.group.filter(p=>t.groups.includes(p.code.value)).each((p,z)=>{d.query.match(new RegExp('"'+p.code.value.replace(a,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+p.code.value.replace(a,"\\$&")+'"'),'"'+p.info.id+'"'))});kb.roleSet.organization.filter(p=>t.organizations.includes(p.code.value)).each((p,z)=>
{d.query.match(new RegExp('"'+p.code.value.replace(a,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+p.code.value.replace(a,"\\$&")+'"'),'"'+p.info.id+'"'))});kb.roleSet.user.filter(p=>t.users.includes(p.code.value)).each((p,z)=>{d.query.match(new RegExp('"'+p.code.value.replace(a,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+p.code.value.replace(a,"\\$&")+'"'),'"'+p.info.id+'"'))})})(k(d.query));break;case "GROUP_SELECT":(t=>{kb.roleSet.group.filter(p=>t.groups.includes(p.code.value)).each((p,
z)=>{d.query.match(new RegExp('"'+p.code.value.replace(a,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+p.code.value.replace(a,"\\$&")+'"'),'"'+p.info.id+'"'))})})(k(d.query));break;case "ORGANIZATION_SELECT":(t=>{kb.roleSet.organization.filter(p=>t.organizations.includes(p.code.value)).each((p,z)=>{d.query.match(new RegExp('"'+p.code.value.replace(a,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+p.code.value.replace(a,"\\$&")+'"'),'"'+p.info.id+'"'))})})(k(d.query));break;case "STATUS":for(l in d.info.status)d.query.match(new RegExp('"'+
l.replace(a,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+l.replace(a,"\\$&")+'"'),'"'+d.info.status[l]+'"'))}e[c]=d.query}else e[c]="";c++;c<e.length?m(c,q):q(e.filter(t=>t).join(h))})((d=>{var a={info:null,query:""};1<d.length&&d.last()in b&&(a.info=b[d.last()],a.query=e[c].replace(new RegExp(d.last().replace(/[\/\\^$*+?.()|\[\]{}]/g,"\\$&")),a.info.id));return a})(e[c].match(/^([^ ]+)/))):q("")};m(0,c=>{n(c)})},search:n=>{var h=kb.elm(".kb-attachment-search-operation").elm(".kb-keyword").elm("input"),
e=kb.elm(".kb-attachment-search-operation").elm(".kb-target").elm("select"),m=kintone.api.url("/k/",!0).replace(/\.json/g,"")+(f.mobile?"m/"+f.app.id:f.app.id)+"/?view="+g.viewId.toString();if(h.val()){var c=(q=>{var d=(e.val()?[x.fields[e.val()]]:Object.values(x.fields)).reduce((a,k)=>{a.push(q.map(l=>{var t=l.match(/^!/g);l=l.replace(/^!/g,"");var p="";if("EMPTY"==l)switch(k.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":case "STATUS":p=b[k.code].id+(t?" not":"")+
' in ("")';break;case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "RICH_TEXT":case "SINGLE_LINE_TEXT":p=b[k.code].id+(t?" !":" ")+'= ""'}else switch(k.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":l in b[k.code].option&&(p=b[k.code].id+(t?" not":"")+' in ("'+b[k.code].option[l].replace(/"/g,'\\"')+'")');break;case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "RICH_TEXT":case "SINGLE_LINE_TEXT":p=b[k.code].id+(t?" not":"")+' like "'+l.replace(/"/g,'\\"')+'"';
break;case "STATUS":l in b[k.code].status&&(p=b[k.code].id+(t?" not":"")+' in ("'+b[k.code].status[l].replace(/"/g,'\\"')+'")')}return p}).join(" or "));return a.filter(l=>l)},[]).map(a=>"("+a+")");return n?["("+n+")"].concat(d.join(" or ")).join(" and "):d.join(" or ")})(h.val().split(/[ \u3000]/).filter(q=>q));window.location.href=c?m+"&keyword="+h.val()+"&target="+e.val()+"&q="+encodeURIComponent(c):m}else window.location.href=m}};x.fields=x.fields.reduce((n,h)=>{if(h in b)switch(f.fieldInfos.parallelize[h].type){case "CHECK_BOX":case "DROP_DOWN":case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "MULTI_SELECT":case "RADIO_BUTTON":case "RICH_TEXT":case "SINGLE_LINE_TEXT":n[h]=
f.fieldInfos.parallelize[h]}return n},{});0!=Object.keys(x.fields).length?B.build(n=>{(h=>{h.elm(".kb-attachment-search-operation")||(e=>{h.addClass("kb-scope").attr("form-id","form_"+e.id).append(kb.create("div").addClass("kb-attachment-search-operation"+(f.mobile?" kb-mobile":"")).append(kb.field.activate((m=>{m.elm("select").empty().assignOption([{code:"",label:"All"}].concat(Object.values(x.fields).map(c=>({code:c.code,label:c.label}))),"label","code");return m})(kb.field.create(e.fields.target).addClass("kb-target")),
e)).append(kb.field.activate(kb.field.create(e.fields.keyword).addClass("kb-keyword"),e)).append(kb.create("button").addClass("kb-icon kb-icon-lookup").on("click",m=>{B.search(n)})).append(kb.create("button").addClass("kb-icon kb-icon-del").on("click",m=>{m.currentTarget.parentNode.elm(".kb-keyword").elm("input").val("");B.search(n)})));kb.record.set(h,e,(m=>{var c={};"keyword"in m&&(c.keyword={value:m.keyword});"target"in m&&(c.target={value:m.target});return c})(kb.queries()));kb.event.on("kb.change.keyword",
m=>{m.container==h&&B.search(n);return m})})({id:"AttachmentSearch",fields:{target:{code:"target",type:"DROP_DOWN",label:"",required:!1,noLabel:!0,options:[{index:0,label:"open"},{index:1,label:"close"}]},keyword:{code:"keyword",type:"SINGLE_LINE_TEXT",label:"",required:!1,noLabel:!0,placeholder:""}}})})(f.mobile?kintone.mobile.app.getHeaderSpaceElement():kintone.app.getHeaderMenuSpaceElement());r(g)}):r(g)})(y.origin.reduce((x,b)=>{if(b.id==g.viewId.toString())switch(g.viewType){case "list":x=b;
break;default:x.filterCond=b.filterCond}return x},{fields:Object.values(f.fieldInfos.parallelize).reduce((x,b)=>{b.tableCode||x.push(b.code);return x},[]),filterCond:""}))})}):r(g)};"useBulkUpdate"in w||(kb.alert(kb.error.config.update("Boost! Attachment")),w.useBulkUpdate={value:[]});w.useBulkUpdate.value.includes("use")&&"list"==g.viewType?kb.filter.auth(w.permitUser.value,w.permitOrganization.value,w.permitGroup.value).then(y=>{y&&kb.icon.create(f.mobile,f.type,"kb-attachment-button","refresh",
()=>{kb.record.builder.build(Object.values(f.fieldInfos.placed).reduce((x,b)=>{f.fieldInfos.disables.includes(b.code)||b.tableCode||(x[b.code]=b);return x},{}),null,x=>{kb.view.records.get(f.app.id,(f.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(b=>{0!=b.length?kb.confirm(kb.constants.common.message.confirm.submit[kb.operator.language],()=>{kb.view.records.set(f.app.id,{put:b.map(B=>({id:B.$id.value,record:kb.extend({},x)}))}).then(B=>kb.alert("Done!",()=>window.location.reload(!0))).catch(B=>
kb.alert(kb.error.parse(B)))}):kb.alert("There are no records.")}).catch(b=>kb.alert(kb.error.parse(b)))})});F()}).catch(y=>F()):F()})(JSON.parse(u.flat))}catch(w){kb.alert(kb.error.parse(w)),r(g)}}).catch(v=>r(g)):r(g)}).catch(u=>r(g))})("mobile"==g.type.split(".").first(),g.type.split(".").slice(-2).first())}));kintone.events.on(["app.report.show","mobile.app.report.show"],g=>new Promise((r,E)=>{((C,A)=>{f.mobile=C;f.type=A;f.observers.each((u,v)=>u.disconnect());f.observers=[];kb.config[G].config.get().then(u=>
{if(0!=Object.keys(u).length)try{var v=JSON.parse(u.flat);"usePivotTranspose"in v||(kb.alert(kb.error.config.update("Boost! Attachment")),v.usePivotTranspose={value:[]});v.usePivotTranspose.value.includes("use")&&(kb.elm(".kb-pivottranspose-style")||kb.elm("head").append(kb.create("style").addClass("kb-pivottranspose-style").attr("type","text/css").text("\n.gaia-report-crosstable{\n\tborder:1px solid #e3e7e8;\n\tborder-collapse:collapse;\n\tborder-spacing:0;\n\twriting-mode:vertical-lr;\n}\n.gaia-report-crosstable :is(colgroup,tr){\n\tbackground-color:transparent !important;\n\tborder:none !important;\n}\n.gaia-report-crosstable tr :is(td,th){\n\tborder:1px solid #e3e7e8;\n\twriting-mode:horizontal-tb;\n\twhite-space:nowrap;\n}\n.gaia-report-crosstable tr>td:first-child{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable .gaia-report-crosstable-row-group .gaia-report-crosstable-groupname{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable .gaia-report-crosstable-row-total .gaia-report-crosstable-groupname{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable .gaia-report-crosstable-row-subtotal .gaia-report-crosstable-groupvalue{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-group>td:nth-child(2n+1){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-total>td:nth-child(2n+1){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-subtotal:has(td[rowspan])>td:nth-child(2n+1){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-subtotal:not(:has(td[rowspan]))>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:not(:has(td[rowspan])) .gaia-report-crosstable-row-group>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:not(:has(td[rowspan])) .gaia-report-crosstable-row-total>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:not(:has(td[rowspan])) .gaia-report-crosstable-row-subtotal>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n")));
r(g)}catch(w){kb.alert(kb.error.parse(w)),r(g)}else r(g)}).catch(u=>r(g))})("mobile"==g.type.split(".").first(),g.type.split(".").slice(-2).first())}));kb.event.on("kb.attachment.call",g=>new Promise((r,E)=>{kb.config[G].config.get().then(C=>{if(0!=Object.keys(C).length)try{(A=>{switch(g.mode){case "download":g.downloadable=A.useAttachmentViewer.value.includes("use")?!A.onlyView.value.includes("onlyView"):!0;break;case "placeholder":A.usePlaceholder.value.includes("use")&&(u=>{A.placeholders.value.map(v=>
v.value).each((v,w)=>{v.field.value in u&&(w=u[v.field.value],w.tableCode?g.fields[w.tableCode].fields[w.code].placeholder=v.text.value:g.fields[w.code].placeholder=v.text.value)})})(kb.field.parallelize(g.fields))}r(g)})(JSON.parse(C.flat))}catch(A){kb.alert(kb.error.parse(A)),r(g)}else r(g)}).catch(C=>r(g))}))})(kintone.$PLUGIN_ID);
