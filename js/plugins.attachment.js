/*
* FileName "plugins.attachment.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(w){var f=0;return function(){return f<w.length?{done:!1,value:w[f++]}:{done:!0}}};$jscomp.arrayIterator=function(w){return{next:$jscomp.arrayIteratorImpl(w)}};$jscomp.makeIterator=function(w){var f="undefined"!=typeof Symbol&&Symbol.iterator&&w[Symbol.iterator];if(f)return f.call(w);if("number"==typeof w.length)return $jscomp.arrayIterator(w);throw Error(String(w)+" is not an iterable or ArrayLike");};
$jscomp.arrayFromIterator=function(w){for(var f,G=[];!(f=w.next()).done;)G.push(f.value);return G};$jscomp.arrayFromIterable=function(w){return w instanceof Array?w:$jscomp.arrayFromIterator($jscomp.makeIterator(w))};
(function(w){var f={},G=function(c){var r={};"useMultiline"in c||(kb.alert(kb.error.config.update("Boost! Attachment")),c.useMultiline={value:[]});if(c.useMultiline.value.includes("use")&&!f.mobile)for(var E in f.fieldInfos.tables)(function(C){var D=Object.keys(C.fields).filter(function(x){return c.multilines.value.map(function(u){return u.value.field.value}).includes(x)});0!=D.length&&function(x){r[C.id]={tableInfo:C,colspans:function(u){return x.map(function(A){return u-A.length})}(Math.max.apply(Math,
$jscomp.arrayFromIterable(x.map(function(u){return u.length})))),lines:x}}(Object.keys(C.fields).reduce(function(x,u){D.includes(u)&&0!=x.last().length&&x.push([]);x.last().push(f.fieldInfos.parallelize[u].id);return x},[[]]))})(f.fieldInfos.tables[E]);return[c,r]},F=function(c,r,E){if(["create","edit"].includes(f.type))kintone.events.on(["app.record.create.change."+c.code,"app.record.edit.change."+c.code],E);if(kb.elms(".subtable-"+c.id+" tbody tr").length!=r[c.code].value.length){var C=new MutationObserver(function(){kb.elms(".subtable-"+
c.id+" tbody tr").length==r[c.code].value.length&&(E({record:r}),C.disconnect())});C.observe(kb.elm(".subtable-"+c.id),{childList:!0,subtree:!0})}else E({record:r})};kintone.events.on(["app.record.create.show","app.record.edit.show","mobile.app.record.create.show","mobile.app.record.edit.show"],function(c){return new Promise(function(r,E){(function(C,D){f.mobile=C;f.type=D;kb.config[w].config.get().then(function(x){0!=Object.keys(x).length?kb.field.load(kb.config[w].app,!0).then(function(u){f.app=
{id:kb.config[w].app,fields:u.origin};f.fieldInfos=u;try{(function(A){A=$jscomp.makeIterator(A);var B=A.next().value,y=A.next().value;B.useLookupNavi.value.includes("use")&&Object.values(f.fieldInfos.parallelize).filter(function(q){return q.lookup}).each(function(q,m){(function(k){q.tableCode?F(f.fieldInfos.tables[q.tableCode],c.record,k):k({record:c.record})})(function(k){(function(l){l&&(Array.isArray(l)?l:[l]).each(function(g,a){g.value.parentNode.elm(".kb-attachment-lookup-operation")||g.value.parentNode.css({alignItems:"center"}).insertBefore(kb.create("button").addClass("kb-icon kb-icon-open kb-attachment-lookup-operation").on("click",
function(v){(function(d,b){d?kb.view.records.get(b,kb.filter.query.create({code:q.lookup.relatedKeyField},"=",{type:q.type,value:d})).then(function(h){0!=h.length&&window.open(kb.record.page.detail(f.mobile,b,h.first().$id.value))})["catch"](function(h){return kb.alert(kb.error.parse(h))}):window.open(kb.record.page.add(f.mobile,b))})(g.value.elm("input[type=text]").val(),q.lookup.relatedApp.app)}),g.value.nextSibling)})})(kb.field.get(q,f.mobile,f.type))})});B.usePlaceholder.value.includes("use")&&
B.placeholders.value.map(function(q){return q.value}).each(function(q,m){q.field.value in f.fieldInfos.parallelize&&function(k){(function(l){k.tableCode?F(f.fieldInfos.tables[k.tableCode],c.record,l):l({record:c.record})})(function(l){(function(g){g&&(Array.isArray(g)?g:[g]).each(function(a,v){f.mobile?a.value.attr("placeholder",q.text.value):a.value.elm("input[type=text],textarea").attr("placeholder",q.text.value)})})(kb.field.get(k,f.mobile,f.type))})}(f.fieldInfos.parallelize[q.field.value])});
B.useAlignTableButtons.value.includes("use")&&!f.mobile&&Object.values(u.tables).filter(function(q){return!Object.keys(y).includes(q.id)}).each(function(q,m){(function(k,l){(function(g){g.prepend(g.elm(".subtable-operation-gaia"))})(l.addClass("kb-attachment-subtable-operation").elm("thead").elm("tr"));F(k,c.record,function(g){l.elms("tbody tr").each(function(a,v){a.elms("td").last().hasClass("subtable-operation-gaia")&&a.prepend(a.elm(".subtable-operation-gaia"))})})})(q,kb.elm(".subtable-"+q.id))});
if(B.useMultiline.value.includes("use")&&!f.mobile)for(var p in y)(function(q,m){var k=function(l,g,a){g.elms("tr").each(function(v,d){v.hasClass("kb-attachment-subtable-multi")||function(b,h){l.lines.each(function(n,t){0==t?B.useAlignTableButtons.value.includes("use")&&h.prepend(h.elm(".subtable-operation-gaia")):(g.insertBefore(function(e){B.useAlignTableButtons.value.includes("use")&&(a?e.append(kb.create("th").addClass("subtable-operation-gaia")):e.append(kb.create("td").addClass("subtable-operation-gaia")));
n.each(function(z,I){a?z?e.append(b.elm(".label-"+z)):e.append(kb.create("th").addClass("subtable-label-gaia")):z?e.append(b.elm(".field-"+z).closest("td")):e.append(kb.create("td"))});return e}(kb.create("tr").addClass("kb-attachment-subtable-multi")),h.nextSibling),h=h.nextSibling);0!=l.colspans[t]&&function(e){a?h.elm(".label-"+n.last()).attr("colspan",e):h.elm(".field-"+n.last()).closest("td").attr("colspan",e)}((l.colspans[t]+1).toString())})}(v.addClass("kb-attachment-subtable-multi"),v.addClass("kb-attachment-subtable-multi"))})};
B.useAlignTableButtons.value.includes("use")&&m.addClass("kb-attachment-subtable-operation");k(q,m.elm("thead"),!0);F(q.tableInfo,c.record,function(l){k(q,m.elm("tbody"),!1)})})(y[p],kb.elm(".subtable-"+y[p].tableInfo.id))})(G(JSON.parse(x.flat))),r(c)}catch(A){kb.alert(kb.error.parse(A)),r(c)}})["catch"](function(u){return r(c)}):r(c)})["catch"](function(x){return r(c)})})("mobile"==c.type.split(".").first(),c.type.split(".").slice(-2).first())})});kintone.events.on(["app.record.detail.show","mobile.app.record.detail.show"],
function(c){return new Promise(function(r,E){(function(C,D){f.mobile=C;f.type=D;kb.config[w].config.get().then(function(x){0!=Object.keys(x).length?kb.field.load(kb.config[w].app,!0).then(function(u){f.app={id:kb.config[w].app,fields:u.origin};f.fieldInfos=u;try{(function(A){A=$jscomp.makeIterator(A);var B=A.next().value;A=A.next().value;B.useAttachmentViewer.value.includes("use")&&Object.values(f.fieldInfos.parallelize).filter(function(p){return"FILE"==p.type}).each(function(p,q){(function(m){p.tableCode?
F(f.fieldInfos.tables[p.tableCode],c.record,m):m({record:c.record})})(function(m){(function(k){k&&(Array.isArray(k)?k:[k]).each(function(l,g){(function(a){(f.mobile?kb.children(l.value):l.value.elm("ul").elms("li")).each(function(v,d){v.elm("a")&&function(b){0!=b.length&&(v.prepend(kb.create("span").addClass("kb-attachment-file-operation").html(b.first().name).on("click",function(h){return kb.attachment.show(b.first(),!B.onlyView.value.includes("onlyView"))})),a=a.filter(function(h){return h!=b.first()}))}(a.filter(function(b){return b.name==
v.elm("a").html()}))})})(p.tableCode?m.record[p.tableCode].value[g].value[p.code].value:m.record[p.code].value)})})(kb.field.get(p,f.mobile,f.type))})});if(B.useMultiline.value.includes("use")&&!f.mobile)for(var y in A)(function(p,q){var m=function(k,l,g){l.elms("tr").each(function(a,v){a.hasClass("kb-attachment-subtable-multi")||function(d,b){k.lines.each(function(h,n){0!=n&&(l.insertBefore(function(t){h.each(function(e,z){g?e?t.append(d.elm(".label-"+e)):t.append(kb.create("th").addClass("subtable-label-gaia")):
e?t.append(d.elm(".field-"+e).closest("td")):t.append(kb.create("td"))});return t}(kb.create("tr").addClass("kb-attachment-subtable-multi")),b.nextSibling),b=b.nextSibling);0!=k.colspans[n]&&function(t){g?b.elm(".label-"+h.last()).attr("colspan",t):b.elm(".field-"+h.last()).closest("td").attr("colspan",t)}((k.colspans[n]+1).toString())})}(a.addClass("kb-attachment-subtable-multi"),a.addClass("kb-attachment-subtable-multi"))})};m(p,q.elm("thead"),!0);F(p.tableInfo,c.record,function(k){m(p,q.elm("tbody"),
!1)})})(A[y],kb.elm(".subtable-"+A[y].tableInfo.id))})(G(JSON.parse(x.flat))),r(c)}catch(A){kb.alert(kb.error.parse(A)),r(c)}})["catch"](function(u){return r(c)}):r(c)})["catch"](function(x){return r(c)})})("mobile"==c.type.split(".").first(),c.type.split(".").slice(-2).first())})});kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],function(c){return new Promise(function(r,E){(function(C,D){f.mobile=C;f.type=D;kb.config[w].config.get().then(function(x){0!=Object.keys(x).length?
kb.field.load(kb.config[w].app,!0).then(function(u){f.app={id:kb.config[w].app,fields:u.origin};f.fieldInfos=u;try{(function(A){A.useSearchBox.value.includes("use")&&"list"==c.viewType?kb.view.load(f.app.id).then(function(B){(function(y){0==kb.roleSet.user.length?kb.roleSet.load().then(function(){return y()}):y()})(function(){(function(y){var p=function(){var m={},k={},l=function(a){return Object.keys(a).reduce(function(v,d){"NONE"!=a[d]&&v.push(d);return v},[])}(cybozu.data.page.FIELD_ACCESSIBILITY||
cybozu.data.page.FIELD_ACCESS_CONTROL.right.fields),g=function(a){var v={CREATED_AT:"CREATED_TIME",DECIMAL:"NUMBER",EDITOR:"RICH_TEXT",MODIFIED_AT:"UPDATED_TIME",MULTIPLE_CHECK:"CHECK_BOX",MULTIPLE_SELECT:"MULTI_SELECT",MULTIPLE_LINE_TEXT:"MULTI_LINE_TEXT",RECORD_ID:"RECORD_NUMBER",SINGLE_CHECK:"RADIO_BUTTON",SINGLE_SELECT:"DROP_DOWN"};return a in v?v[a]:a};Object.values(cybozu.data.page.FORM_DATA.schema.table.fieldList).each(function(a,v){if(l.includes(a.id))if("REFERENCE_TABLE"==a.type)k[a.id]=
a["var"];else switch(m[a["var"]]={id:"f"+a.id,type:g(a.type)},m[a["var"]].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":m[a["var"]].option=function(){var d={};"options"in a.properties&&Array.isArray(a.properties.options)&&a.properties.options.each(function(b,h){b.valid&&(d[b.label]=b.id)});return d}();break;case "STATUS":m[a["var"]].status=function(){var d={};(function(b){("string"===typeof b.useStatus?"true"==b.useStatus:b.useStatus)&&b.states.each(function(h,n){h.valid&&
(d[h.label]=h.id)})})(cybozu.data.page.STATUS_DATA);return d}()}});Object.values(cybozu.data.page.FORM_DATA.schema.subTable).map(function(a){return Object.values(a.fieldList)}).flat().each(function(a,v){if(l.includes(a.id))switch(m[a["var"]]={id:"f"+a.id,type:g(a.type)},m[a["var"]].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":m[a["var"]].option=function(){var d={};"options"in a.properties&&Array.isArray(a.properties.options)&&a.properties.options.each(function(b,
h){b.valid&&(d[b.label]=b.id)});return d}()}});cybozu.data.page.FORM_DATA.referenceTables.each(function(a,v){a.masterApp.schema&&l.includes(a.fieldId)&&function(d,b,h){Object.values(a.masterApp.schema.table.fieldList).each(function(n,t){if(!d.includes(n.id))switch(m[k[b]+"."+n["var"]]={id:"f"+b+".f"+n.id,type:g(n.type)},m[k[b]+"."+n["var"]].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":m[k[b]+"."+n["var"]].option=function(){var e={};"options"in n.properties&&Array.isArray(n.properties.options)&&
n.properties.options.each(function(z,I){z.valid&&(e[z.label]=z.id)});return e}();break;case "STATUS":m[k[b]+"."+n["var"]].status=function(){var e={};("string"===typeof h.useStatus?"true"==h.useStatus:h.useStatus)&&h.states.each(function(z,I){z.valid&&(e[z.label]=z.id)});return e}()}})}(a.masterApp.unAccessibleFieldIds,a.fieldId,a.masterApp.status)});return m}(),q={build:function(m){var k=y.filterCond.match(/ and /g)?" and ":" or ",l=y.filterCond.split(k).filter(function(a){return a}),g=function(a,
v){0!=l.length?function(d){if(d.info){var b=RegExp("[/\\\\^$*+?.()|[\\]{}]","g"),h=function(t){var e={groups:[],organizations:[],users:[]},z="";t.match(/ in /g)&&function(I){I.each(function(H,J){if(H.replace(/^[ ]+/g,"").replace(/[ ]+$/g,"").match(/^"/g))switch(H=H.replace(/^[ "]+/g,"").replace(/[ "]+$/g,""),H){case "GROUP":z="groups";break;case "ORGANIZATION":z="organizations";break;case "USER":z="users";break;default:z||(z="users"),e[z].push(H)}})}(t.split(" in ").last().replace(/^\(/g,"").replace(/\)$/g,
"").split(","));return e};switch(d.info.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":for(var n in d.info.option)d.query.match(new RegExp('"'+n.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+n.replace(b,"\\$&")+'"'),'"'+d.info.option[n]+'"'));break;case "CREATOR":case "MODIFIER":case "USER_SELECT":(function(t){kb.roleSet.group.filter(function(e){return t.groups.includes(e.code.value)}).each(function(e,z){d.query.match(new RegExp('"'+e.code.value.replace(b,
"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+e.code.value.replace(b,"\\$&")+'"'),'"'+e.info.id+'"'))});kb.roleSet.organization.filter(function(e){return t.organizations.includes(e.code.value)}).each(function(e,z){d.query.match(new RegExp('"'+e.code.value.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+e.code.value.replace(b,"\\$&")+'"'),'"'+e.info.id+'"'))});kb.roleSet.user.filter(function(e){return t.users.includes(e.code.value)}).each(function(e,z){d.query.match(new RegExp('"'+
e.code.value.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+e.code.value.replace(b,"\\$&")+'"'),'"'+e.info.id+'"'))})})(h(d.query));break;case "GROUP_SELECT":(function(t){kb.roleSet.group.filter(function(e){return t.groups.includes(e.code.value)}).each(function(e,z){d.query.match(new RegExp('"'+e.code.value.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+e.code.value.replace(b,"\\$&")+'"'),'"'+e.info.id+'"'))})})(h(d.query));break;case "ORGANIZATION_SELECT":(function(t){kb.roleSet.organization.filter(function(e){return t.organizations.includes(e.code.value)}).each(function(e,
z){d.query.match(new RegExp('"'+e.code.value.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+e.code.value.replace(b,"\\$&")+'"'),'"'+e.info.id+'"'))})})(h(d.query));break;case "STATUS":for(n in d.info.status)d.query.match(new RegExp('"'+n.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+n.replace(b,"\\$&")+'"'),'"'+d.info.status[n]+'"'))}l[a]=d.query}else l[a]="";a++;a<l.length?g(a,v):v(l.filter(function(t){return t}).join(k))}(function(d){var b={info:null,query:""};
1<d.length&&d.last()in p&&(b.info=p[d.last()],b.query=l[a].replace(new RegExp(d.last().replace(/[\/\\^$*+?.()|\[\]{}]/g,"\\$&")),b.info.id));return b}(l[a].match(/^([^ ]+)/))):v("")};g(0,function(a){m(a)})},search:function(m){var k=kb.elm(".kb-attachment-search-operation").elm(".kb-keyword").elm("input"),l=kb.elm(".kb-attachment-search-operation").elm(".kb-target").elm("select"),g=kintone.api.url("/k/",!0).replace(/\.json/g,"")+(f.mobile?"m/"+f.app.id:f.app.id)+"/?view="+c.viewId.toString();if(k.val()){var a=
function(v){var d=(l.val()?[y.fields[l.val()]]:Object.values(y.fields)).reduce(function(b,h){b.push(v.map(function(n){var t=n.match(/^!/g);n=n.replace(/^!/g,"");var e="";if("EMPTY"==n)switch(h.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":case "STATUS":e=p[h.code].id+(t?" not":"")+' in ("")';break;case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "RICH_TEXT":case "SINGLE_LINE_TEXT":e=p[h.code].id+(t?" !":" ")+'= ""'}else switch(h.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":n in
p[h.code].option&&(e=p[h.code].id+(t?" not":"")+' in ("'+p[h.code].option[n].replace(/"/g,'\\"')+'")');break;case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "RICH_TEXT":case "SINGLE_LINE_TEXT":e=p[h.code].id+(t?" not":"")+' like "'+n.replace(/"/g,'\\"')+'"';break;case "STATUS":n in p[h.code].status&&(e=p[h.code].id+(t?" not":"")+' in ("'+p[h.code].status[n].replace(/"/g,'\\"')+'")')}return e}).join(" or "));return b.filter(function(n){return n})},[]).map(function(b){return"("+b+")"});return m?
["("+m+")"].concat(d.join(" or ")).join(" and "):d.join(" or ")}(k.val().split(/[ \u3000]/).filter(function(v){return v}));window.location.href=a?g+"&keyword="+k.val()+"&target="+l.val()+"&q="+encodeURIComponent(a):g}else window.location.href=g}};y.fields=y.fields.reduce(function(m,k){if(k in p)switch(f.fieldInfos.parallelize[k].type){case "CHECK_BOX":case "DROP_DOWN":case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "MULTI_SELECT":case "RADIO_BUTTON":case "RICH_TEXT":case "SINGLE_LINE_TEXT":m[k]=
f.fieldInfos.parallelize[k]}return m},{});0!=Object.keys(y.fields).length?q.build(function(m){(function(k){k.elm(".kb-attachment-search-operation")||function(l){k.addClass("kb-scope").attr("form-id","form_"+l.id).append(kb.create("div").addClass("kb-attachment-search-operation"+(f.mobile?" kb-mobile":"")).append(kb.field.activate(function(g){g.elm("select").empty().assignOption([{code:"",label:"All"}].concat(Object.values(y.fields).map(function(a){return{code:a.code,label:a.label}})),"label","code");
return g}(kb.field.create(l.fields.target).addClass("kb-target")),l)).append(kb.field.activate(kb.field.create(l.fields.keyword).addClass("kb-keyword"),l)).append(kb.create("button").addClass("kb-icon kb-icon-lookup").on("click",function(g){q.search(m)})).append(kb.create("button").addClass("kb-icon kb-icon-del").on("click",function(g){g.currentTarget.parentNode.elm(".kb-keyword").elm("input").val("");q.search(m)})));kb.record.set(k,l,function(g){var a={};"keyword"in g&&(a.keyword={value:g.keyword});
"target"in g&&(a.target={value:g.target});return a}(kb.queries()));kb.event.on("kb.change.keyword",function(g){g.container==k&&q.search(m);return g})}({id:"AttachmentSearch",fields:{target:{code:"target",type:"DROP_DOWN",label:"",required:!1,noLabel:!0,options:[{index:0,label:"open"},{index:1,label:"close"}]},keyword:{code:"keyword",type:"SINGLE_LINE_TEXT",label:"",required:!1,noLabel:!0,placeholder:""}}})})(f.mobile?kintone.mobile.app.getHeaderSpaceElement():kintone.app.getHeaderMenuSpaceElement());
r(c)}):r(c)})(B.list.reduce(function(y,p){p.id==c.viewId.toString()&&(y=p);return y},{fields:Object.values(f.fieldInfos.parallelize).reduce(function(y,p){p.tableCode||y.push(p.code);return y},[]),filterCond:""}))})}):r(c)})(JSON.parse(x.flat))}catch(A){kb.alert(kb.error.parse(A)),r(c)}})["catch"](function(u){return r(c)}):r(c)})["catch"](function(x){return r(c)})})("mobile"==c.type.split(".").first(),c.type.split(".").slice(-2).first())})});kb.event.on("kb.attachment.call",function(c){return new Promise(function(r,
E){kb.config[w].config.get().then(function(C){if(0!=Object.keys(C).length)try{(function(D){switch(c.mode){case "download":c.downloadable=D.useAttachmentViewer.value.includes("use")?!D.onlyView.value.includes("onlyView"):!0;break;case "placeholder":D.usePlaceholder.value.includes("use")&&function(x){D.placeholders.value.map(function(u){return u.value}).each(function(u,A){if(u.field.value in x){var B=x[u.field.value];B.tableCode?c.fields[B.tableCode].fields[B.code].placeholder=u.text.value:c.fields[B.code].placeholder=
u.text.value}})}(kb.field.parallelize(c.fields))}r(c)})(JSON.parse(C.flat))}catch(D){kb.alert(kb.error.parse(D)),r(c)}else r(c)})["catch"](function(C){return r(c)})})})})(kintone.$PLUGIN_ID);