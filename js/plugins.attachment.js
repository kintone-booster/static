/*
* FileName "plugins.attachment.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(D){var g={},G=function(c,n,E){if(["create","edit"].includes(g.type))kintone.events.on(["app.record.create.change."+c.code,"app.record.edit.change."+c.code],E);if(kb.elms(".subtable-"+c.id+" tbody tr").length!=n[c.code].value.length){var B=new MutationObserver(function(){kb.elms(".subtable-"+c.id+" tbody tr").length==n[c.code].value.length&&(E({record:n}),B.disconnect())});B.observe(kb.elm(".subtable-"+c.id),{childList:!0,subtree:!0})}else E({record:n})};kintone.events.on(["app.record.create.show",
"app.record.edit.show","mobile.app.record.create.show","mobile.app.record.edit.show"],function(c){return new Promise(function(n,E){(function(B,C){g.mobile=B;g.type=C;kb.config[D].config.get().then(function(A){0!=Object.keys(A).length?kb.field.load(kb.config[D].app,!0).then(function(w){g.app={id:kb.config[D].app,fields:w.origin};g.fieldInfos=w;try{(function(z){z.useLookupNavi.value.includes("use")&&Object.values(g.fieldInfos.parallelize).filter(function(h){return h.lookup}).each(function(h,u){(function(k){h.tableCode?
G(g.fieldInfos.tables[h.tableCode],c.record,k):k({record:c.record})})(function(k){(function(v){v&&(Array.isArray(v)?v:[v]).each(function(f,l){f.value.parentNode.elm(".kb-attachment-lookup-operation")||f.value.parentNode.css({alignItems:"center"}).insertBefore(kb.create("button").addClass("kb-icon kb-icon-open kb-attachment-lookup-operation").on("click",function(p){(function(m,a){m?kb.view.records.get(a,kb.filter.query.create({code:h.lookup.relatedKeyField},"=",{type:h.type,value:m})).then(function(r){0!=
r.length&&window.open(kb.record.page.detail(g.mobile,a,r.first().$id.value))})["catch"](function(r){return kb.alert(kb.error.parse(r))}):window.open(kb.record.page.add(g.mobile,a))})(f.value.elm("input[type=text]").val(),h.lookup.relatedApp.app)}),f.value.nextSibling)})})(kb.field.get(h,g.mobile,g.type))})});z.usePlaceholder.value.includes("use")&&z.placeholders.value.map(function(h){return h.value}).each(function(h,u){h.field.value in g.fieldInfos.parallelize&&function(k){(function(v){k.tableCode?
G(g.fieldInfos.tables[k.tableCode],c.record,v):v({record:c.record})})(function(v){(function(f){f&&(Array.isArray(f)?f:[f]).each(function(l,p){l.value.elm("input[type=text],textarea").attr("placeholder",h.text.value)})})(kb.field.get(k,g.mobile,g.type))})}(g.fieldInfos.parallelize[h.field.value])});z.useAlignTableButtons.value.includes("use")&&!g.mobile&&Object.values(w.tables).each(function(h,u){(function(k,v){(function(f){f.prepend(f.elm(".subtable-operation-gaia"))})(v.addClass("kb-attachment-subtable-operation").elm("thead").elm("tr"));
G(k,c.record,function(f){v.elms("tbody tr").each(function(l,p){l.elms("td").last().hasClass("subtable-operation-gaia")&&l.prepend(l.elm(".subtable-operation-gaia"))})})})(h,kb.elm(".subtable-"+h.id))})})(JSON.parse(A.flat)),n(c)}catch(z){kb.alert(kb.error.parse(z)),n(c)}})["catch"](function(w){return n(c)}):n(c)})["catch"](function(A){return n(c)})})("mobile"==c.type.split(".").first(),c.type.split(".").slice(-2).first())})});kintone.events.on(["app.record.detail.show","mobile.app.record.detail.show"],
function(c){return new Promise(function(n,E){(function(B,C){g.mobile=B;g.type=C;kb.config[D].config.get().then(function(A){0!=Object.keys(A).length?kb.field.load(kb.config[D].app,!0).then(function(w){g.app={id:kb.config[D].app,fields:w.origin};g.fieldInfos=w;try{(function(z){z.useAttachmentViewer.value.includes("use")&&Object.values(g.fieldInfos.parallelize).filter(function(h){return"FILE"==h.type}).each(function(h,u){(function(k){h.tableCode?G(g.fieldInfos.tables[h.tableCode],c.record,k):k({record:c.record})})(function(k){(function(v){v&&
(Array.isArray(v)?v:[v]).each(function(f,l){(function(p){f.value.elm("ul").elms("li").each(function(m,a){m.elm("a")&&function(r){0!=r.length&&(m.prepend(kb.create("span").addClass("kb-attachment-file-operation").html(r.first().name).on("click",function(b){return kb.attachment.show(r.first(),!z.onlyView.value.includes("onlyView"))})),p=p.filter(function(b){return b!=r.first()}))}(p.filter(function(r){return r.name==m.elm("a").html()}))})})(h.tableCode?k.record[h.tableCode].value[l].value[h.code].value:
k.record[h.code].value)})})(kb.field.get(h,g.mobile,g.type))})})})(JSON.parse(A.flat)),n(c)}catch(z){kb.alert(kb.error.parse(z)),n(c)}})["catch"](function(w){return n(c)}):n(c)})["catch"](function(A){return n(c)})})("mobile"==c.type.split(".").first(),c.type.split(".").slice(-2).first())})});kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],function(c){return new Promise(function(n,E){(function(B,C){g.mobile=B;g.type=C;kb.config[D].config.get().then(function(A){0!=Object.keys(A).length?
kb.field.load(kb.config[D].app,!0).then(function(w){g.app={id:kb.config[D].app,fields:w.origin};g.fieldInfos=w;try{(function(z){z.useSearchBox.value.includes("use")&&"list"==c.viewType?kb.view.load(g.app.id).then(function(h){(function(u){0==kb.roleSet.user.length?kb.roleSet.load().then(function(){return u()}):u()})(function(){(function(u){var k=function(){var f={},l={},p=function(a){return Object.keys(a).reduce(function(r,b){"NONE"!=a[b]&&r.push(b);return r},[])}(cybozu.data.page.FIELD_ACCESSIBILITY||
cybozu.data.page.FIELD_ACCESS_CONTROL.right.fields),m=function(a){var r={CREATED_AT:"CREATED_TIME",DECIMAL:"NUMBER",EDITOR:"RICH_TEXT",MODIFIED_AT:"UPDATED_TIME",MULTIPLE_CHECK:"CHECK_BOX",MULTIPLE_SELECT:"MULTI_SELECT",MULTIPLE_LINE_TEXT:"MULTI_LINE_TEXT",RECORD_ID:"RECORD_NUMBER",SINGLE_CHECK:"RADIO_BUTTON",SINGLE_SELECT:"DROP_DOWN"};return a in r?r[a]:a};Object.values(cybozu.data.page.FORM_DATA.schema.table.fieldList).each(function(a,r){if(p.includes(a.id))if("REFERENCE_TABLE"==a.type)l[a.id]=
a["var"];else switch(f[a["var"]]={id:"f"+a.id,type:m(a.type)},f[a["var"]].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":f[a["var"]].option=function(){var b={};"options"in a.properties&&Array.isArray(a.properties.options)&&a.properties.options.each(function(e,t){e.valid&&(b[e.label]=e.id)});return b}();break;case "STATUS":f[a["var"]].status=function(){var b={};(function(e){("string"===typeof e.useStatus?"true"==e.useStatus:e.useStatus)&&e.states.each(function(t,q){t.valid&&
(b[t.label]=t.id)})})(cybozu.data.page.STATUS_DATA);return b}()}});Object.values(cybozu.data.page.FORM_DATA.schema.subTable).map(function(a){return Object.values(a.fieldList)}).flat().each(function(a,r){if(p.includes(a.id))switch(f[a["var"]]={id:"f"+a.id,type:m(a.type)},f[a["var"]].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":f[a["var"]].option=function(){var b={};"options"in a.properties&&Array.isArray(a.properties.options)&&a.properties.options.each(function(e,
t){e.valid&&(b[e.label]=e.id)});return b}()}});cybozu.data.page.FORM_DATA.referenceTables.each(function(a,r){a.masterApp.schema&&p.includes(a.fieldId)&&function(b,e,t){Object.values(a.masterApp.schema.table.fieldList).each(function(q,x){if(!b.includes(q.id))switch(f[l[e]+"."+q["var"]]={id:"f"+e+".f"+q.id,type:m(q.type)},f[l[e]+"."+q["var"]].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":f[l[e]+"."+q["var"]].option=function(){var d={};"options"in q.properties&&Array.isArray(q.properties.options)&&
q.properties.options.each(function(y,H){y.valid&&(d[y.label]=y.id)});return d}();break;case "STATUS":f[l[e]+"."+q["var"]].status=function(){var d={};("string"===typeof t.useStatus?"true"==t.useStatus:t.useStatus)&&t.states.each(function(y,H){y.valid&&(d[y.label]=y.id)});return d}()}})}(a.masterApp.unAccessibleFieldIds,a.fieldId,a.masterApp.status)});return f}(),v={build:function(f){var l=u.filterCond.match(/ and /g)?" and ":" or ",p=u.filterCond.split(l).filter(function(a){return a}),m=function(a,
r){0!=p.length?function(b){if(b.info){var e=RegExp("[/\\\\^$*+?.()|[\\]{}]","g"),t=function(x){var d={groups:[],organizations:[],users:[]},y="";x.match(/ in /g)&&function(H){H.each(function(F,I){if(F.replace(/^[ ]+/g,"").replace(/[ ]+$/g,"").match(/^"/g))switch(F=F.replace(/^[ "]+/g,"").replace(/[ "]+$/g,""),F){case "GROUP":y="groups";break;case "ORGANIZATION":y="organizations";break;case "USER":y="users";break;default:y||(y="users"),d[y].push(F)}})}(x.split(" in ").last().replace(/^\(/g,"").replace(/\)$/g,
"").split(","));return d};switch(b.info.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":for(var q in b.info.option)b.query.match(new RegExp('"'+q.replace(e,"\\$&")+'"'))&&(b.query=b.query.replace(new RegExp('"'+q.replace(e,"\\$&")+'"'),'"'+b.info.option[q]+'"'));break;case "CREATOR":case "MODIFIER":case "USER_SELECT":(function(x){kb.roleSet.group.filter(function(d){return x.groups.includes(d.code.value)}).each(function(d,y){b.query.match(new RegExp('"'+d.code.value.replace(e,
"\\$&")+'"'))&&(b.query=b.query.replace(new RegExp('"'+d.code.value.replace(e,"\\$&")+'"'),'"'+d.info.id+'"'))});kb.roleSet.organization.filter(function(d){return x.organizations.includes(d.code.value)}).each(function(d,y){b.query.match(new RegExp('"'+d.code.value.replace(e,"\\$&")+'"'))&&(b.query=b.query.replace(new RegExp('"'+d.code.value.replace(e,"\\$&")+'"'),'"'+d.info.id+'"'))});kb.roleSet.user.filter(function(d){return x.users.includes(d.code.value)}).each(function(d,y){b.query.match(new RegExp('"'+
d.code.value.replace(e,"\\$&")+'"'))&&(b.query=b.query.replace(new RegExp('"'+d.code.value.replace(e,"\\$&")+'"'),'"'+d.info.id+'"'))})})(t(b.query));break;case "GROUP_SELECT":(function(x){kb.roleSet.group.filter(function(d){return x.groups.includes(d.code.value)}).each(function(d,y){b.query.match(new RegExp('"'+d.code.value.replace(e,"\\$&")+'"'))&&(b.query=b.query.replace(new RegExp('"'+d.code.value.replace(e,"\\$&")+'"'),'"'+d.info.id+'"'))})})(t(b.query));break;case "ORGANIZATION_SELECT":(function(x){kb.roleSet.organization.filter(function(d){return x.organizations.includes(d.code.value)}).each(function(d,
y){b.query.match(new RegExp('"'+d.code.value.replace(e,"\\$&")+'"'))&&(b.query=b.query.replace(new RegExp('"'+d.code.value.replace(e,"\\$&")+'"'),'"'+d.info.id+'"'))})})(t(b.query));break;case "STATUS":for(q in b.info.status)b.query.match(new RegExp('"'+q.replace(e,"\\$&")+'"'))&&(b.query=b.query.replace(new RegExp('"'+q.replace(e,"\\$&")+'"'),'"'+b.info.status[q]+'"'))}p[a]=b.query}else p[a]="";a++;a<p.length?m(a,r):r(p.filter(function(x){return x}).join(l))}(function(b){var e={info:null,query:""};
1<b.length&&b.last()in k&&(e.info=k[b.last()],e.query=p[a].replace(new RegExp(b.last().replace(/[\/\\^$*+?.()|\[\]{}]/g,"\\$&")),e.info.id));return e}(p[a].match(/^([^ ]+)/))):r("")};m(0,function(a){f(a)})},search:function(f){var l=kb.elm(".kb-attachment-search-operation").elm(".kb-keyword").elm("input"),p=kb.elm(".kb-attachment-search-operation").elm(".kb-target").elm("select"),m=kintone.api.url("/k/",!0).replace(/\.json/g,"")+g.app.id+"/?view="+c.viewId.toString();if(l.val()){var a=function(r){var b=
(p.val()?[u.fields[p.val()]]:Object.values(u.fields)).reduce(function(e,t){e.push("("+r.map(function(q){var x=q.match(/^!/g);q=q.replace(/^!/g,"");var d="";if("EMPTY"==q)switch(t.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":case "STATUS":d=k[t.code].id+(x?" not":"")+' in ("")';break;case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "RICH_TEXT":case "SINGLE_LINE_TEXT":d=k[t.code].id+(x?" !":" ")+'= ""'}else switch(t.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":q in
k[t.code].option&&(d=k[t.code].id+(x?" not":"")+' in ("'+k[t.code].option[q].replace(/"/g,'\\"')+'")');break;case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "RICH_TEXT":case "SINGLE_LINE_TEXT":d=k[t.code].id+(x?" not":"")+' like "'+q.replace(/"/g,'\\"')+'"';break;case "STATUS":q in k[t.code].status&&(d=k[t.code].id+(x?" not":"")+' in ("'+k[t.code].status[q].replace(/"/g,'\\"')+'")')}return d}).join(" or ")+")");return e},[]);return f?["("+f+")"].concat(b.join(" or ")).join(" and "):b.join(" or ")}(l.val().split(" ").filter(function(r){return r}));
window.location.href=a?m+"&keyword="+l.val()+"&target="+p.val()+"&q="+encodeURIComponent(a):m}else window.location.href=m}};u.fields=u.fields.reduce(function(f,l){if(l in k)switch(g.fieldInfos.parallelize[l].type){case "CHECK_BOX":case "DROP_DOWN":case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "MULTI_SELECT":case "RADIO_BUTTON":case "RICH_TEXT":case "SINGLE_LINE_TEXT":f[l]=g.fieldInfos.parallelize[l]}return f},{});0!=Object.keys(u.fields).length?v.build(function(f){(function(l){l.elm(".kb-attachment-search-operation")||
function(p){l.addClass("kb-scope").attr("form-id","form_"+p.id).append(kb.create("div").addClass("kb-attachment-search-operation"+(g.mobile?" kb-mobile":"")).append(kb.field.activate(function(m){m.elm("select").empty().assignOption([{code:"",label:"All"}].concat(Object.values(u.fields).map(function(a){return{code:a.code,label:a.label}})),"label","code");return m}(kb.field.create(p.fields.target).addClass("kb-target")),p)).append(kb.field.activate(kb.field.create(p.fields.keyword).addClass("kb-keyword"),
p)).append(kb.create("button").addClass("kb-icon kb-icon-lookup").on("click",function(m){v.search(f)})).append(kb.create("button").addClass("kb-icon kb-icon-del").on("click",function(m){m.currentTarget.parentNode.elm(".kb-keyword").elm("input").val("");v.search(f)})));kb.record.set(l,p,function(m){var a={};"keyword"in m&&(a.keyword={value:m.keyword});"target"in m&&(a.target={value:m.target});return a}(kb.queries()));kb.event.on("kb.change.keyword",function(m){m.container==l&&v.search(f);return m})}({id:"AttachmentSearch",
fields:{target:{code:"target",type:"DROP_DOWN",label:"",required:!1,noLabel:!0,options:[{index:0,label:"open"},{index:1,label:"close"}]},keyword:{code:"keyword",type:"SINGLE_LINE_TEXT",label:"",required:!1,noLabel:!0,placeholder:""}}})})(g.mobile?kintone.mobile.app.getHeaderSpaceElement():kintone.app.getHeaderMenuSpaceElement());n(c)}):n(c)})(h.list.reduce(function(u,k){k.id==c.viewId.toString()&&(u=k);return u},{fields:Object.values(g.fieldInfos.parallelize).reduce(function(u,k){k.tableCode||u.push(k.code);
return u},[]),filterCond:""}))})}):n(c)})(JSON.parse(A.flat))}catch(z){kb.alert(kb.error.parse(z)),n(c)}})["catch"](function(w){return n(c)}):n(c)})["catch"](function(A){return n(c)})})("mobile"==c.type.split(".").first(),c.type.split(".").slice(-2).first())})});kb.event.on("kb.attachment.call",function(c){return new Promise(function(n,E){kb.config[D].config.get().then(function(B){if(0!=Object.keys(B).length)try{(function(C){switch(c.mode){case "download":c.downloadable=C.useAttachmentViewer.value.includes("use")?
!C.onlyView.value.includes("onlyView"):!0;break;case "placeholder":C.usePlaceholder.value.includes("use")&&function(A){C.placeholders.value.map(function(w){return w.value}).each(function(w,z){if(w.field.value in A){var h=A[w.field.value];h.tableCode?c.fields[h.tableCode].fields[h.code].placeholder=w.text.value:c.fields[h.code].placeholder=w.text.value}})}(kb.field.parallelize(c.fields))}n(c)})(JSON.parse(B.flat))}catch(C){kb.alert(kb.error.parse(C)),n(c)}else n(c)})["catch"](function(B){return n(c)})})})})(kintone.$PLUGIN_ID);