/*
* FileName "plugins.attachment.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(J=>{var c={forceUpdate:!1,observers:[]},R={file:l=>{l=new Kuc.Attachment({className:"control-gaia kb-attachment-field-"+l.id,label:"",language:kb.operator.language,message:(()=>{var r="";switch(kb.operator.language){case "en":r="(Maximum: 1 GB)";break;case "ja":r="(\u6700\u59271 GB)";break;case "zh":r="(\u6700\u59271 GB)";break;case "zh-TW":r="(\u6700\u59271 GB)"}return r})(),requiredIcon:l.required});Object.defineProperty(l,"value",{get(){return this.files},set(r){var G=[],F=(E,w)=>{kb.file.download(r[E],
!0).then(y=>{G.push(new File([y],r[E].name,{type:r[E].contentType}));E++;E<r.length?F(E,w):w(G)}).catch(y=>{kb.alert(kb.error.parse(y));this.files=[]})};Array.isArray(r)&&0!=r.length?F(0,E=>this.files=E):this.files=[]},enumerable:!0,configurable:!0});return l}},P=l=>{var r={};if(l.useMultiline.value.includes("use")&&!c.mobile)for(var G in c.fieldInfos.tables)(F=>{var E=Object.keys(F.fields).filter(w=>l.multilines.value.map(y=>y.value.field.value).includes(w));0!=E.length&&(r[F.id]={tableInfo:F,lines:Object.keys(F.fields).reduce((w,
y)=>{E.includes(y)&&0!=w.last().length&&w.push([]);w.last().push(c.fieldInfos.parallelize[y].id);return w},[[]])})})(c.fieldInfos.tables[G]);return[l,r]},Q=(l,r,G)=>{(F=>{F.observe(kb.elm(".subtable-"+l.id+(c.mobile?"":" tbody")),{childList:!0,subtree:!1});(E=>{kb.elms(E).length==r[l.code].value.length&&G.each((w,y)=>w({record:r}))})(".subtable-"+l.id+(c.mobile?" .subtable-row-gaia":" tbody tr"));c.observers.push(F)})(new MutationObserver(()=>{G.each((F,E)=>F({record:r}))}))},L=(l,r,G,F=0)=>{l.scrollWidth>
l.clientWidth?(0<l.scrollLeft+F?r.removeAttr("disabled"):r.attr("disabled","disabled"),l.scrollLeft+F<l.scrollWidth-l.clientWidth?G.removeAttr("disabled"):G.attr("disabled","disabled")):(r.attr("disabled","disabled"),G.attr("disabled","disabled"))};kintone.events.on(["app.record.create.show","app.record.edit.show","mobile.app.record.create.show","mobile.app.record.edit.show"],l=>new Promise((r,G)=>{((F,E)=>{c.mobile=F;c.type=E;c.observers.each((w,y)=>w.disconnect());c.observers=[];kb.config[J].config.get().then(w=>
{0!=Object.keys(w).length?kb.field.load(kb.config[J].app,!0).then(y=>{c.app={id:kb.config[J].app,fields:y.origin};c.fieldInfos=y;try{(([t,I])=>{var C={};t.useLookupNavi.value.includes("use")&&(kb.event.off("kb.attachment.lookup.call"),Object.values(c.fieldInfos.parallelize).filter(m=>m.lookup).each((m,p)=>{(h=>{if(m.tableCode){var e=c.fieldInfos.tables[m.tableCode];e.code in C||(C[e.code]=[]);C[e.code].push(h);c.mobile&&h({record:l.record})}else h({record:l.record})})(h=>{((e,a)=>{e&&(Array.isArray(e)?
e:[e]).each((f,d)=>{f.value.parentNode.elm(".kb-attachment-lookup-operation")||(a(f.value,c.mobile?f.value:f.value.elm("input[type=text]")),f.nextSibling&&f.nextSibling.tagName.toLowerCase().startsWith("kuc")&&(b=>{b&&a(c.mobile?b:b.parentNode,b)})(f.nextSibling.elm("input[type=text]")),kb.event.on("kb.attachment.lookup.call",b=>{if(b.field==f&&f.nextSibling&&f.nextSibling.tagName.toLowerCase().startsWith("kuc")&&!f.nextSibling.elm(".kb-attachment-lookup-operation")){var k=f.nextSibling.elm("input[type=text]");
a(c.mobile?k:k.parentNode,k)}return b}))})})(kb.field.get(m,c.mobile,c.type),(e,a)=>{e.parentNode.css({alignItems:"center"}).insertBefore(kb.create("button").addClass("kb-icon kb-icon-open kb-attachment-lookup-operation"+(c.mobile?" kb-mobile":"")).on("click",f=>{((d,b)=>{d?kb.view.records.get(b,kb.filter.query.create({code:m.lookup.relatedKeyField},"=",{type:m.type,value:d})).then(k=>{0!=k.length&&window.open(kb.record.page.detail(c.mobile,b,k.first().$id.value))}).catch(k=>kb.alert(kb.error.parse(k))):
window.open(kb.record.page.add(c.mobile,b))})(a.val(),m.lookup.relatedApp.app)}),e.nextSibling);c.mobile&&a.addClass("kb-attachment-lookup-operation-input kb-mobile")})})}));t.usePlaceholder.value.includes("use")&&t.placeholders.value.map(m=>m.value).each((m,p)=>{m.field.value in c.fieldInfos.parallelize&&(h=>{(e=>{if(h.tableCode){var a=c.fieldInfos.tables[h.tableCode];a.code in C||(C[a.code]=[]);C[a.code].push(e)}else e({record:l.record})})(e=>{(a=>{a&&(Array.isArray(a)?a:[a]).each((f,d)=>{c.mobile?
f.value.attr("placeholder",m.text.value):f.value.elm("input[type=text],textarea").attr("placeholder",m.text.value)})})(kb.field.get(h,c.mobile,c.type))})})(c.fieldInfos.parallelize[m.field.value])});t.useAlignTableButtons.value.includes("use")&&!c.mobile&&Object.values(y.tables).filter(m=>!Object.keys(I).includes(m.id)).each((m,p)=>{((h,e)=>{0!=l.record[h.code].value.length&&((a=>{a.prepend(a.elm('[class^="subtable-operation-gaia"]'))})(e.addClass("kb-attachment-subtable-operation").elm("thead").elm("tr")),
h.code in C||(C[h.code]=[]),C[h.code].push(a=>{e.elms("tbody tr").each((f,d)=>{Array.from(f.elms("td").last().classList).some(b=>b.startsWith("subtable-operation-gaia"))&&f.prepend(f.elm('[class^="subtable-operation-gaia"]'))})}))})(m,kb.elm(".subtable-"+m.id))});if(t.useMultiline.value.includes("use")&&!c.mobile)for(var z in I)((m,p)=>{var h=(e,a,f)=>{var d=[];a&&a.elms("tr").each((b,k)=>{b.hasClass("kb-attachment-subtable-multi")||(n=>{t.useAlignTableButtons.value.includes("use")?b.addClass("kb-attachment-subtable-multi").append(n):
b.addClass("kb-attachment-subtable-multi").prepend(n);e.lines.each((v,g)=>{n.append((q=>{v.each((x,u)=>{var D={};f?x?q.append(b.elm(".label-"+x).addClass("kb-attachment-subtable-multi-cell").css(D)):q.append(kb.create("th").addClass("subtable-label-gaia kb-attachment-subtable-multi-cell").css(D)):(D.width=p.elm("thead").elm(".label-"+x).css("width"),x?q.append(b.elm(".field-"+x).closest("td").addClass("kb-attachment-subtable-multi-cell").css(D)):q.append(kb.create("td").addClass("kb-attachment-subtable-multi-cell").css(D)));
u==v.length-1&&d.push(q.lastElementChild)});return q})(kb.create("div").css({alignItems:"stretch",display:"flex"})))});f&&(v=>{kb.children(n).each((g,q)=>{kb.children(g).reduce((x,u)=>x+=u.outerWidth(!1),0)<v&&kb.children(g).last().css({flex:"1"})})})(n.firstElementChild.outerWidth(!1))})(f?kb.create("th").addClass("subtable-label-gaia"):kb.create("td"))});f||d.each((b,k)=>b.css({flex:"1"}))};0!=l.record[m.tableInfo.code].value.length&&(t.useAlignTableButtons.value.includes("use")&&p.addClass("kb-attachment-subtable-operation"),
h(m,p.elm("thead"),!0),m.tableInfo.code in C||(C[m.tableInfo.code]=[]),C[m.tableInfo.code].push(e=>{h(m,p.elm("tbody"),!1)}))})(I[z],kb.elm(".subtable-"+I[z].tableInfo.id));"useTableCopy"in t||(kb.alert(kb.error.config.update("Boost! Attachment")),t.useTableCopy={value:[]});!t.useTableCopy.value.includes("use")&&!t.useTableSort.value.includes("use")||c.mobile||("object"===typeof Kuc?Object.values(c.fieldInfos.tables).each((m,p)=>{((h,e)=>{var a=null,f={},d=b=>{kb.event.call("kb.action.call",{container:kb.elm("body"),
record:b,mobile:c.mobile,pattern:"change",fields:[h.code].concat(Object.keys(h.fields)),stopPropagation:!0,workplace:"record"}).then(k=>{kb.event.call("kb.style.call",{container:k.container,record:k.record,mobile:k.mobile,pattern:"$id"in k.record?k.record.$id.value?"edit":"create":"create",workplace:k.workplace}).then(n=>{kb.event.call("kb.cascade.call",n).then(v=>{(c.mobile?kintone.mobile.app.record:kintone.app.record).set({record:v.record})}).catch(()=>{})}).catch(()=>{})}).catch(()=>{})};(b=>{h.code in
C||(C[h.code]=[]);C[h.code].push(b)})(b=>{try{var k=kintone.app.record.get().record}catch{k=b.record}(n=>{n[h.code].value.each((v,g)=>{Object.values(h.fields).filter(q=>"FILE"==q.type).each(q=>{(x=>{Array.isArray(x)&&0!=x.length&&((u,D)=>{u&&(u.nextSibling&&u.nextSibling.tagName.toLowerCase().startsWith("kuc")||(u.hide().insertAdjacentElement("afterend",R.file(q)),u.nextSibling.value=D?D:n[h.code].value[g].value[q.code].value),kb.isNumeric(a)&&a==g?(u.nextSibling.files=f[q.id],a=null,f={}):D&&(u.nextSibling.value=
D))})(x[g],(()=>{var u=null;kb.preset&&q.code in kb.preset.files&&g.toString()in kb.preset.files[q.code]&&(u=kb.preset.files[q.code][g.toString()],delete kb.preset.files[q.code][g.toString()]);return u})())})(kb.field.get(q,c.mobile,c.type))})})})(k);t.useTableCopy.value.includes("use")&&e.elms('[class^="subtable-operation-gaia"]').each((n,v)=>{((g,q)=>{g&&(n.elm(".kb-attachment-subtable-copy")||n.insertBefore(q.on("click",x=>{((u,D)=>{(K=>{a=u+1;f=Object.values(h.fields).filter(H=>"FILE"==H.type).reduce((H,
M)=>{H[M.id]=[...e.elms("tbody .kb-attachment-field-"+M.id)[u].files];return H},{});for(let H in K)if(void 0===K[H].value)switch(h.fields[H].type){case "CHECK_BOX":case "FILE":case "GROUP_SELECT":case "MULTI_SELECT":case "ORGANIZATION_SELECT":case "USER_SELECT":K[H].value=[];break;default:K[H].value=null}else h.fields[H].lookup&&(K[H].lookup=!0);D[h.code].value.splice(u+1,0,{value:K});d(D)})(kb.extend({},D[h.code].value[u].value))})(e.elms(".kb-attachment-subtable-copy").indexOf(q),kintone.app.record.get().record)}),
g.nextSibling))})(n.elm("button"),kb.create("button").addClass("kb-icon kb-icon-copy kb-attachment-subtable-copy"))})});t.useTableSort.value.includes("use")&&Object.values(h.fields).each((b,k)=>{var n=(v,g)=>{var q=(()=>{var x=!1;if("NUMBER"==b.type)x=!0;else switch(b.type){case "CALC":switch(b.format){case "NUMBER":case "NUMBER_DIGIT":x=!0}}return x})();v.each((x,u)=>x.rowIndex=u);return v.sort((x,u)=>(g?u.value[b.code].value||"":x.value[b.code].value||"").localeCompare(g?x.value[b.code].value||
"":u.value[b.code].value||"",void 0,q?{numeric:!0}:void 0))};if("CALC DATE DATETIME DROP_DOWN LINK NUMBER RADIO_BUTTON SINGLE_LINE_TEXT TIME".split(" ").includes(b.type))e.elm("thead .label-"+b.id).on("click",v=>{((g,q,x)=>{(u=>{g.hasClass(u+"desc")?g.removeClass(u+"desc").addClass(u+"asc"):g.removeClass(u+"asc").addClass(u+"desc");g.closest("tr").elms('[class*="'+CSS.escape(u)+'"]').each((D,K)=>{D!=g&&D.removeClass(u+"asc").removeClass(u+"desc")});q[h.code].value=n(q[h.code].value,g.hasClass(u+"desc"))})("kb-attachment-subtable-sort-");
(u=>{Object.values(h.fields).filter(D=>"FILE"==D.type).each((D,K)=>{x?((H,M)=>{e.elms("tbody tr").each((N,O)=>N.elms(".kb-attachment-subtable-multi-cell")[H].append(M[u[O]]))})(e.elms("thead .kb-attachment-subtable-multi-cell").indexOf(e.elm("thead .label-"+D.id)),e.elms("tbody .kb-attachment-field-"+D.id)):((H,M)=>{e.elms("tbody tr").each((N,O)=>N.elms("td")[H].append(M[u[O]]))})(Array.from(g.parentNode.children).indexOf(e.elm("thead .label-"+D.id)),e.elms("tbody .kb-attachment-field-"+D.id))})})(q[h.code].value.map(u=>
u.rowIndex));d(q)})(v.currentTarget,kintone.app.record.get().record,e.elm("thead tr").hasClass("kb-attachment-subtable-multi"))})});c.forceUpdate||(c.forceUpdate=0!=Object.values(h.fields).filter(b=>"FILE"==b.type).length)})(m,kb.elm(".subtable-"+m.id),!0)}):kb.alert(kb.error.config.reinstall("Boost! Attachment","https://kintone-booster.com/"+kb.operator.language.substring(0,2)+"/attachment.html")));if(t.useTab.value.includes("use")){t.tabs.value.map(m=>m.value).each((m,p)=>{m.field.value in c.fieldInfos.origin&&
(h=>{(e=>{e&&(e.addClass("kb-attachment-tab-operation"+(c.mobile?" kb-mobile":"")),((a,f,d)=>{a.elms(".input-radio-item-cybozu,.radio-gaia").each((b,k)=>{b.addClass("kb-attachment-tab")});a.append(kb.create("span").addClass("kb-attachment-tab-spacer"));a.parentNode.insertBefore(f.on("click",b=>{b=Math.floor(a.clientWidth/-2);L(a,f,d,b);a.scrollBy({left:b})}),a);a.parentNode.insertBefore(d.on("click",b=>{b=Math.ceil(a.clientWidth/2);L(a,f,d,b);a.scrollBy({left:b})}),a.nextSibling);L(a,f,d)})(e.elm(".input-radio-item-cybozu,.radio-gaia").parentNode.addClass("kb-attachment-tab-container"),
kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-left"),kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-right")))})(kb.field.get(h,c.mobile,c.type))})(c.fieldInfos.parallelize[m.field.value])});var A=t.activeTabColor.value||"transparent",B=t.inactiveTabColor.value||"transparent";kb.elm(".kb-tab-style")||kb.elm("head").append(kb.create("style").addClass("kb-tab-style").attr("type","text/css").text(`
.kb-attachment-tab label{
	background-color:${B};
}
.kb-attachment-tab input:checked+label{
	background-color:${A};
}
`))}if(c.forceUpdate)kintone.events.on(["app.record.create.submit.success","app.record.edit.submit.success"],function(m){return new kintone.Promise(function(p,h){try{var e=(a,f,d)=>{var b=(k,n,v)=>{0!=n.field.length?(g=>{kb.file.upload(g,!0).then(q=>{n.record.push({contentType:g.contentType,fileKey:q.fileKey,name:g.name,size:g.size});k++;k<n.field.length?b(k,n,v):v()})})(n.field[k]):v()};b(0,f[a],()=>{a++;a<f.length?e(a,f,d):d()})};c.observers.each((a,f)=>a.disconnect());c.observers=[];kb.loadStart();
e(0,Object.values(c.fieldInfos.tables).reduce((a,f)=>{(d=>{Object.values(f.fields).filter(b=>"FILE"==b.type).each((b,k)=>{d.elms("tbody .kb-attachment-field-"+b.id).each((n,v)=>{m.record[f.code].value[v].value[b.code].value=[];a.push({field:n.value,record:m.record[f.code].value[v].value[b.code].value})})})})(kb.elm(".subtable-"+f.id));return a},[]),()=>{var a={};a.$id=m.record.$id;Object.keys(c.fieldInfos.tables).each((f,d)=>a[f]=m.record[f]);kb.view.records.set(kintone.app.getId(),{put:[kb.view.records.transform(a)]},
!1).then(f=>{kb.loadEnd();p(m)}).catch(f=>kb.alert(kb.error.parse(f),()=>p(m)))})}catch(a){kb.alert(kb.error.parse(a),()=>p(m))}})});for(z in C)Q(c.fieldInfos.tables[z],l.record,C[z])})(P(JSON.parse(w.flat))),r(l)}catch(t){kb.alert(kb.error.parse(t)),r(l)}}).catch(y=>r(l)):r(l)}).catch(w=>r(l))})("mobile"==l.type.split(".").first(),l.type.split(".").slice(-2).first())}));kintone.events.on(["app.record.detail.show","mobile.app.record.detail.show"],l=>new Promise((r,G)=>{((F,E)=>{c.mobile=F;c.type=
E;c.observers.each((w,y)=>w.disconnect());c.observers=[];kb.config[J].config.get().then(w=>{0!=Object.keys(w).length?kb.field.load(kb.config[J].app,!0).then(y=>{c.app={id:kb.config[J].app,fields:y.origin};c.fieldInfos=y;try{(([t,I])=>{var C={};t.useAttachmentViewer.value.includes("use")&&Object.values(c.fieldInfos.parallelize).filter(B=>"FILE"==B.type).each((B,m)=>{(p=>{if(B.tableCode){var h=c.fieldInfos.tables[B.tableCode];h.code in C||(C[h.code]=[]);C[h.code].push(p)}else p({record:l.record})})(p=>
{(h=>{h&&(Array.isArray(h)?h:[h]).each((e,a)=>{(f=>{(c.mobile?kb.children(e.value):e.value.elm("ul").elms("li")).each((d,b)=>{d.elm("a")&&!d.elm(".kb-attachment-file-operation")&&(k=>{0!=k.length&&(d.prepend(kb.create("span").addClass("kb-attachment-file-operation").html(k.first().name).on("click",n=>kb.attachment.show(k.first(),!t.onlyView.value.includes("onlyView")))),f=f.filter(n=>n!=k.first()))})(f.filter(k=>k.name==d.elm("a").html()))})})(B.tableCode?p.record[B.tableCode].value[a].value[B.code].value:
p.record[B.code].value)})})(kb.field.get(B,c.mobile,c.type))})});if(t.useMultiline.value.includes("use")&&!c.mobile)for(var z in I)((B,m)=>{var p=(h,e,a)=>{var f=[];e&&e.elms("tr").each((d,b)=>{d.hasClass("kb-attachment-subtable-multi")||(k=>{d.addClass("kb-attachment-subtable-multi").prepend(k);h.lines.each((n,v)=>{k.append((g=>{n.each((q,x)=>{var u={};a?q?g.append(d.elm(".label-"+q).addClass("kb-attachment-subtable-multi-cell").css(u)):g.append(kb.create("th").addClass("subtable-label-gaia kb-attachment-subtable-multi-cell").css(u)):
(u.width=m.elm("thead").elm(".label-"+q).css("width"),q?g.append(d.elm(".field-"+q).closest("td").addClass("kb-attachment-subtable-multi-cell").css(u)):g.append(kb.create("td").addClass("kb-attachment-subtable-multi-cell").css(u)));x==n.length-1&&f.push(g.lastElementChild)});return g})(kb.create("div").css({alignItems:"stretch",display:"flex"})))});a&&(n=>{kb.children(k).each((v,g)=>{kb.children(v).reduce((q,x)=>q+=x.outerWidth(!1),0)<n&&kb.children(v).last().css({flex:"1"})})})(k.firstElementChild.outerWidth(!1))})(a?
kb.create("th").addClass("subtable-label-gaia"):kb.create("td"))});a||f.each((d,b)=>d.css({flex:"1"}))};0!=l.record[B.tableInfo.code].value.length&&(p(B,m.elm("thead"),!0),B.tableInfo.code in C||(C[B.tableInfo.code]=[]),C[B.tableInfo.code].push(h=>{p(B,m.elm("tbody"),!1)}))})(I[z],kb.elm(".subtable-"+I[z].tableInfo.id));"useTab"in t||(kb.alert(kb.error.config.update("Boost! Attachment")),t.useTab={value:[]});if(t.useTab.value.includes("use")){t.tabs.value.map(B=>B.value).each((B,m)=>{B.field.value in
c.fieldInfos.origin&&(p=>{(h=>{h&&(((e,a)=>{a.each((f,d)=>{e.elm(".kb-attachment-tab-container").append(kb.create("span").addClass("kb-attachment-tab").append(kb.create("input").attr("type","radio").attr("id",p.code+"_"+d).attr("name",p.code).attr("value",f.label).on("change",b=>{(k=>{kb.event.call("kb.style.call",{container:kb.elm("body"),record:(()=>{k[p.code].value=kb.elms('[name="'+CSS.escape(p.code)+'"]').find(n=>n.checked).attr("value");return k})(),mobile:c.mobile,pattern:"edit",workplace:"record"}).then(n=>
{}).catch(()=>{})})((c.mobile?kintone.mobile.app.record:kintone.app.record).get().record)})).append(kb.create("label").attr("for",p.code+"_"+d).html(f.label)))});e.elm(".kb-attachment-tab-container").append(kb.create("span").addClass("kb-attachment-tab-spacer"));h.css({display:"none"}).parentNode.insertBefore(e,h.nextSibling);((f,d,b)=>{d.on("click",k=>{k=Math.floor(f.clientWidth/-2);L(f,d,b,k);f.scrollBy({left:k})});b.on("click",k=>{k=Math.ceil(f.clientWidth/2);L(f,d,b,k);f.scrollBy({left:k})});
L(f,d,b)})(e.elm(".kb-attachment-tab-container"),e.elm(".kb-icon-arrow-left"),e.elm(".kb-icon-arrow-right"))})(kb.create("div").addClass("kb-attachment-tab-operation"+(c.mobile?" kb-mobile":"")).append(kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-left")).append(kb.create("div").addClass("kb-attachment-tab-container")).append(kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-right")),Object.values(p.options).reduce((e,a)=>{e[a.index]=a;return e},[])),(e=>{e&&(e.checked=
!0)})(kb.elm('[name="'+CSS.escape(p.code)+'"][value="'+CSS.escape(l.record[p.code].value)+'"]')))})(kb.field.get(p,c.mobile,c.type))})(c.fieldInfos.parallelize[B.field.value])});I=t.activeTabColor.value||"transparent";var A=t.inactiveTabColor.value||"transparent";kb.elm(".kb-tab-style")||kb.elm("head").append(kb.create("style").addClass("kb-tab-style").attr("type","text/css").text(`
.kb-attachment-tab label{
	background-color:${A};
}
.kb-attachment-tab input:checked+label{
	background-color:${I};
}
`))}for(z in C)Q(c.fieldInfos.tables[z],l.record,C[z])})(P(JSON.parse(w.flat))),r(l)}catch(t){kb.alert(kb.error.parse(t)),r(l)}}).catch(y=>r(l)):r(l)}).catch(w=>r(l))})("mobile"==l.type.split(".").first(),l.type.split(".").slice(-2).first())}));kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],l=>new Promise((r,G)=>{((F,E)=>{c.mobile=F;c.type=E;c.observers.each((w,y)=>w.disconnect());c.observers=[];kb.config[J].config.get().then(w=>{0!=Object.keys(w).length?kb.field.load(kb.config[J].app,
!0).then(y=>{c.app={id:kb.config[J].app,fields:y.origin};c.fieldInfos=y;try{(t=>{var I=()=>{t.useSearchBox.value.includes("use")?kb.view.load(c.app.id).then(C=>{(z=>{0==kb.roleSet.user.length?kb.roleSet.load().then(()=>z()):z()})(()=>{(z=>{var A=(()=>{var m={},p={},h=(a=>Object.keys(a).reduce((f,d)=>{"NONE"!=a[d]&&f.push(d);return f},[]))(cybozu.data.page.FIELD_ACCESSIBILITY||cybozu.data.page.FIELD_ACCESS_CONTROL.right.fields),e=a=>{var f={CREATED_AT:"CREATED_TIME",DECIMAL:"NUMBER",EDITOR:"RICH_TEXT",
MODIFIED_AT:"UPDATED_TIME",MULTIPLE_CHECK:"CHECK_BOX",MULTIPLE_SELECT:"MULTI_SELECT",MULTIPLE_LINE_TEXT:"MULTI_LINE_TEXT",RECORD_ID:"RECORD_NUMBER",SINGLE_CHECK:"RADIO_BUTTON",SINGLE_SELECT:"DROP_DOWN"};return a in f?f[a]:a};Object.values(cybozu.data.page.FORM_DATA.schema.table.fieldList).each((a,f)=>{if(h.includes(a.id))if("REFERENCE_TABLE"==a.type)p[a.id]=a.var;else switch(m[a.var]={id:"f"+a.id,type:e(a.type)},m[a.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":m[a.var].option=
(()=>{var d={};"options"in a.properties&&Array.isArray(a.properties.options)&&a.properties.options.each((b,k)=>{b.valid&&(d[b.label]=b.id)});return d})();break;case "STATUS":m[a.var].status=(()=>{var d={};(b=>{("string"===typeof b.useStatus?"true"==b.useStatus:b.useStatus)&&b.states.each((k,n)=>{k.valid&&(d[k.label]=k.id)})})(cybozu.data.page.STATUS_DATA);return d})()}});Object.values(cybozu.data.page.FORM_DATA.schema.subTable).map(a=>Object.values(a.fieldList)).flat().each((a,f)=>{if(h.includes(a.id))switch(m[a.var]=
{id:"f"+a.id,type:e(a.type)},m[a.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":m[a.var].option=(()=>{var d={};"options"in a.properties&&Array.isArray(a.properties.options)&&a.properties.options.each((b,k)=>{b.valid&&(d[b.label]=b.id)});return d})()}});cybozu.data.page.FORM_DATA.referenceTables.each((a,f)=>{a.masterApp.schema&&h.includes(a.fieldId)&&((d,b,k)=>{Object.values(a.masterApp.schema.table.fieldList).each((n,v)=>{if(!d.includes(n.id))switch(m[p[b]+"."+
n.var]={id:"f"+b+".f"+n.id,type:e(n.type)},m[p[b]+"."+n.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":m[p[b]+"."+n.var].option=(()=>{var g={};"options"in n.properties&&Array.isArray(n.properties.options)&&n.properties.options.each((q,x)=>{q.valid&&(g[q.label]=q.id)});return g})();break;case "STATUS":m[p[b]+"."+n.var].status=(()=>{var g={};("string"===typeof k.useStatus?"true"==k.useStatus:k.useStatus)&&k.states.each((q,x)=>{q.valid&&(g[q.label]=q.id)});return g})()}})})(a.masterApp.unAccessibleFieldIds,
a.fieldId,a.masterApp.status)});return m})(),B={build:m=>{var p=z.filterCond.match(/ and /g)?" and ":" or ",h=z.filterCond.split(p).filter(a=>a),e=(a,f)=>{0!=h.length?(d=>{if(d.info){var b=RegExp("[/\\\\^$*+?.()|[\\]{}]","g"),k=function(v,g){var q={groups:[],organizations:[],users:[]},x="";v.match(/ in /g)&&(u=>{u.each((D,K)=>{if(D.replace(/^[ ]+/g,"").replace(/[ ]+$/g,"").match(/^"/g))switch(D=D.replace(/^[ "]+/g,"").replace(/[ "]+$/g,""),D){case "GROUP":x="groups";break;case "ORGANIZATION":x="organizations";
break;case "USER":x="users";break;default:if(!x)switch(g){case "GROUP_SELECT":x="groups";break;case "ORGANIZATION_SELECT":x="organizations";break;default:x="users"}q[x].push(D)}})})(v.split(" in ").last().replace(/^\(/g,"").replace(/\)$/g,"").split(","));return q};switch(d.info.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":for(var n in d.info.option)d.query.match(new RegExp('"'+n.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+n.replace(b,"\\$&")+
'"'),'"'+d.info.option[n]+'"'));break;case "CREATOR":case "MODIFIER":case "USER_SELECT":(v=>{kb.roleSet.group.filter(g=>v.groups.includes(g.code.value)).each((g,q)=>{d.query.match(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'),'"'+g.info.id+'"'))});kb.roleSet.organization.filter(g=>v.organizations.includes(g.code.value)).each((g,q)=>{d.query.match(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+
g.code.value.replace(b,"\\$&")+'"'),'"'+g.info.id+'"'))});kb.roleSet.user.filter(g=>v.users.includes(g.code.value)).each((g,q)=>{d.query.match(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'),'"'+g.info.id+'"'))})})(k(d.query));break;case "GROUP_SELECT":(v=>{kb.roleSet.group.filter(g=>v.groups.includes(g.code.value)).each((g,q)=>{d.query.match(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+
g.code.value.replace(b,"\\$&")+'"'),'"'+g.info.id+'"'))})})(k(d.query,d.info.type));break;case "ORGANIZATION_SELECT":(v=>{kb.roleSet.organization.filter(g=>v.organizations.includes(g.code.value)).each((g,q)=>{d.query.match(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'))&&(d.query=d.query.replace(new RegExp('"'+g.code.value.replace(b,"\\$&")+'"'),'"'+g.info.id+'"'))})})(k(d.query,d.info.type));break;case "STATUS":for(n in d.info.status)d.query.match(new RegExp('"'+n.replace(b,"\\$&")+'"'))&&(d.query=
d.query.replace(new RegExp('"'+n.replace(b,"\\$&")+'"'),'"'+d.info.status[n]+'"'))}h[a]=d.query}else h[a]="";a++;a<h.length?e(a,f):f(h.filter(v=>v).join(p))})((d=>{var b={info:null,query:""};1<d.length&&d.last()in A&&(b.info=A[d.last()],b.query=h[a].replace(new RegExp(d.last().replace(/[\/\\^$*+?.()|\[\]{}]/g,"\\$&")),b.info.id));return b})(h[a].match(/^([^ ]+)/))):f("")};e(0,a=>{m(a)})},search:m=>{var p=kb.elm(".kb-attachment-search-operation").elm(".kb-keyword").elm("input"),h=kb.elm(".kb-attachment-search-operation").elm(".kb-target").elm("select"),
e=kintone.api.url("/k/",!0).replace(/\.json/g,"")+(c.mobile?"m/"+c.app.id:c.app.id)+"/?view="+l.viewId.toString();if(p.val()){var a=(f=>{var d=(h.val()?[z.fields[h.val()]]:Object.values(z.fields)).reduce((b,k)=>{b.push(f.map(n=>{var v=n.match(/^!/g);n=n.replace(/^!/g,"");var g="";if("EMPTY"==n)switch(k.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":case "STATUS":g=A[k.code].id+(v?" not":"")+' in ("")';break;case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "RICH_TEXT":case "SINGLE_LINE_TEXT":g=
A[k.code].id+(v?" !":" ")+'= ""'}else switch(k.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":n in A[k.code].option&&(g=A[k.code].id+(v?" not":"")+' in ("'+A[k.code].option[n].replace(/"/g,'\\"')+'")');break;case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "RICH_TEXT":case "SINGLE_LINE_TEXT":g=A[k.code].id+(v?" not":"")+' like "'+n.replace(/"/g,'\\"')+'"';break;case "STATUS":n in A[k.code].status&&(g=A[k.code].id+(v?" not":"")+' in ("'+A[k.code].status[n].replace(/"/g,
'\\"')+'")')}return g}).join(" or "));return b.filter(n=>n)},[]).map(b=>"("+b+")");return m?["("+m+")"].concat(d.join(" or ")).join(" and "):d.join(" or ")})(p.val().split(/[ \u3000]/).filter(f=>f));window.location.href=a?e+"&keyword="+p.val()+"&target="+h.val()+"&q="+encodeURIComponent(a):e}else window.location.href=e}};z.fields=z.fields.reduce((m,p)=>{if(p in A)switch(c.fieldInfos.parallelize[p].type){case "CHECK_BOX":case "DROP_DOWN":case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "MULTI_SELECT":case "RADIO_BUTTON":case "RICH_TEXT":case "SINGLE_LINE_TEXT":m[p]=
c.fieldInfos.parallelize[p]}return m},{});0!=Object.keys(z.fields).length?B.build(m=>{(p=>{p.elm(".kb-attachment-search-operation")||(h=>{p.addClass("kb-scope").attr("form-id","form_"+h.id).append(kb.create("div").addClass("kb-attachment-search-operation"+(c.mobile?" kb-mobile":"")).append(kb.field.activate((e=>{e.elm("select").empty().assignOption([{code:"",label:"All"}].concat(Object.values(z.fields).map(a=>({code:a.code,label:a.label}))),"label","code");return e})(kb.field.create(h.fields.target).addClass("kb-target")),
h)).append(kb.field.activate(kb.field.create(h.fields.keyword).addClass("kb-keyword"),h)).append(kb.create("button").addClass("kb-icon kb-icon-lookup").on("click",e=>{B.search(m)})).append(kb.create("button").addClass("kb-icon kb-icon-del").on("click",e=>{e.currentTarget.parentNode.elm(".kb-keyword").elm("input").val("");B.search(m)})));kb.record.set(p,h,(e=>{var a={};"keyword"in e&&(a.keyword={value:e.keyword});"target"in e&&(a.target={value:e.target});return a})(kb.queries()));kb.event.on("kb.change.keyword",
e=>{e.container==p&&B.search(m);return e})})({id:"AttachmentSearch",fields:{target:{code:"target",type:"DROP_DOWN",label:"",required:!1,noLabel:!0,options:[{index:0,label:"open"},{index:1,label:"close"}]},keyword:{code:"keyword",type:"SINGLE_LINE_TEXT",label:"",required:!1,noLabel:!0,placeholder:""}}})})(c.mobile?kintone.mobile.app.getHeaderSpaceElement():kintone.app.getHeaderMenuSpaceElement());r(l)}):r(l)})(C.origin.reduce((z,A)=>{if(A.id==l.viewId.toString())switch(l.viewType){case "list":z=A;
break;default:z.filterCond=A.filterCond}return z},{fields:Object.values(c.fieldInfos.parallelize).reduce((z,A)=>{A.tableCode||z.push(A.code);return z},[]),filterCond:""}))})}):r(l)};"useBulkUpdate"in t||(kb.alert(kb.error.config.update("Boost! Attachment")),t.useBulkUpdate={value:[]});t.useBulkUpdate.value.includes("use")&&"list"==l.viewType?kb.filter.auth(t.permitUser.value,t.permitOrganization.value,t.permitGroup.value).then(C=>{C&&kb.icon.create(c.mobile,c.type,"kb-attachment-button","refresh",
()=>{kb.record.builder.build(Object.values(c.fieldInfos.placed).reduce((z,A)=>{c.fieldInfos.disables.includes(A.code)||A.tableCode||(z[A.code]=A);return z},{}),null,z=>{kb.view.records.get(c.app.id,(c.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(A=>{0!=A.length?kb.confirm(kb.constants.common.message.confirm.submit[kb.operator.language],()=>{kb.view.records.set(c.app.id,{put:A.map(B=>({id:B.$id.value,record:kb.extend({},z)}))}).then(B=>kb.alert("Done!",()=>window.location.reload(!0))).catch(B=>
kb.alert(kb.error.parse(B)))}):kb.alert("There are no records.")}).catch(A=>kb.alert(kb.error.parse(A)))})});I()}).catch(C=>I()):I()})(JSON.parse(w.flat))}catch(t){kb.alert(kb.error.parse(t)),r(l)}}).catch(y=>r(l)):r(l)}).catch(w=>r(l))})("mobile"==l.type.split(".").first(),l.type.split(".").slice(-2).first())}));kintone.events.on(["app.report.show","mobile.app.report.show"],l=>new Promise((r,G)=>{((F,E)=>{c.mobile=F;c.type=E;c.observers.each((w,y)=>w.disconnect());c.observers=[];kb.config[J].config.get().then(w=>
{if(0!=Object.keys(w).length)try{var y=JSON.parse(w.flat);"usePivotTranspose"in y||(kb.alert(kb.error.config.update("Boost! Attachment")),y.usePivotTranspose={value:[]});y.usePivotTranspose.value.includes("use")&&(kb.elm(".kb-pivottranspose-style")||kb.elm("head").append(kb.create("style").addClass("kb-pivottranspose-style").attr("type","text/css").text("\n.gaia-report-crosstable{\n\tborder:1px solid #e3e7e8;\n\tborder-collapse:collapse;\n\tborder-spacing:0;\n\twriting-mode:vertical-lr;\n}\n.gaia-report-crosstable :is(colgroup,tr){\n\tbackground-color:transparent !important;\n\tborder:none !important;\n}\n.gaia-report-crosstable tr :is(td,th){\n\tborder:1px solid #e3e7e8;\n\twriting-mode:horizontal-tb;\n\twhite-space:nowrap;\n}\n.gaia-report-crosstable tr>td:first-child{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable .gaia-report-crosstable-row-group .gaia-report-crosstable-groupname{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable .gaia-report-crosstable-row-total .gaia-report-crosstable-groupname{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable .gaia-report-crosstable-row-subtotal .gaia-report-crosstable-groupvalue{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-group>td:nth-child(2n+1){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-total>td:nth-child(2n+1){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-subtotal:has(td[rowspan])>td:nth-child(2n+1){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-subtotal:not(:has(td[rowspan]))>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:not(:has(td[rowspan])) .gaia-report-crosstable-row-group>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:not(:has(td[rowspan])) .gaia-report-crosstable-row-total>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:not(:has(td[rowspan])) .gaia-report-crosstable-row-subtotal>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n")));
r(l)}catch(t){kb.alert(kb.error.parse(t)),r(l)}else r(l)}).catch(w=>r(l))})("mobile"==l.type.split(".").first(),l.type.split(".").slice(-2).first())}));kb.event.on("kb.attachment.call",l=>new Promise((r,G)=>{kb.config[J].config.get().then(F=>{if(0!=Object.keys(F).length)try{(E=>{switch(l.mode){case "download":l.downloadable=E.useAttachmentViewer.value.includes("use")?!E.onlyView.value.includes("onlyView"):!0;break;case "placeholder":E.usePlaceholder.value.includes("use")&&(w=>{E.placeholders.value.map(y=>
y.value).each((y,t)=>{y.field.value in w&&(t=w[y.field.value],t.tableCode?l.fields[t.tableCode].fields[t.code].placeholder=y.text.value:l.fields[t.code].placeholder=y.text.value)})})(kb.field.parallelize(l.fields))}r(l)})(JSON.parse(F.flat))}catch(E){kb.alert(kb.error.parse(E)),r(l)}else r(l)}).catch(F=>r(l))}))})(kintone.$PLUGIN_ID);
