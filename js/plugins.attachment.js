/*
* FileName "plugins.attachment.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(J=>{var d={forceUpdate:!1,observers:[]},R={file:h=>{h=new Kuc.Attachment({className:"control-gaia kb-attachment-field-"+h.id,label:"",language:kb.operator.language,message:(()=>{var q="";switch(kb.operator.language){case "en":q="(Maximum: 1 GB)";break;case "ja":q="(\u6700\u59271 GB)";break;case "zh":q="(\u6700\u59271 GB)";break;case "zh-TW":q="(\u6700\u59271 GB)"}return q})(),requiredIcon:h.required});Object.defineProperty(h,"value",{get(){return this.files},set(q){var G=[],E=(D,w)=>{kb.file.download(q[D],
!0).then(y=>{G.push(new File([y],q[D].name,{type:q[D].contentType}));D++;D<q.length?E(D,w):w(G)}).catch(y=>{kb.alert(kb.error.parse(y));this.files=[]})};Array.isArray(q)&&0!=q.length?E(0,D=>this.files=D):this.files=[]},enumerable:!0,configurable:!0});return h}},P=h=>{var q={};if(h.useMultiline.value.includes("use")&&!d.mobile)for(var G in d.fieldInfos.tables)(E=>{var D=Object.keys(E.fields).filter(w=>h.multilines.value.map(y=>y.value.field.value).includes(w));0!=D.length&&(q[E.id]={tableInfo:E,lines:Object.keys(E.fields).reduce((w,
y)=>{D.includes(y)&&0!=w.last().length&&w.push([]);w.last().push(d.fieldInfos.parallelize[y].id);return w},[[]])})})(d.fieldInfos.tables[G]);return[h,q]},Q=(h,q,G)=>{(E=>{E.observe(kb.elm(".subtable-"+h.id),{childList:!0,subtree:!0});kb.elms(".subtable-"+h.id+" tbody tr").length==q[h.code].value.length&&G.each((D,w)=>D({record:q}));d.observers.push(E)})(new MutationObserver(()=>{G.each((E,D)=>E({record:q}))}))},L=(h,q,G,E=0)=>{h.scrollWidth>h.clientWidth?(0<h.scrollLeft+E?q.removeAttr("disabled"):
q.attr("disabled","disabled"),h.scrollLeft+E<h.scrollWidth-h.clientWidth?G.removeAttr("disabled"):G.attr("disabled","disabled")):(q.attr("disabled","disabled"),G.attr("disabled","disabled"))};kintone.events.on(["app.record.create.show","app.record.edit.show","mobile.app.record.create.show","mobile.app.record.edit.show"],h=>new Promise((q,G)=>{((E,D)=>{d.mobile=E;d.type=D;d.observers.each((w,y)=>w.disconnect());d.observers=[];kb.config[J].config.get().then(w=>{0!=Object.keys(w).length?kb.field.load(kb.config[J].app,
!0).then(y=>{d.app={id:kb.config[J].app,fields:y.origin};d.fieldInfos=y;try{(([t,I])=>{var C={};t.useLookupNavi.value.includes("use")&&Object.values(d.fieldInfos.parallelize).filter(k=>k.lookup).each((k,p)=>{(g=>{if(k.tableCode){var e=d.fieldInfos.tables[k.tableCode];e.code in C||(C[e.code]=[]);C[e.code].push(g)}else g({record:h.record})})(g=>{(e=>{e&&(Array.isArray(e)?e:[e]).each((a,m)=>{a.value.parentNode.elm(".kb-attachment-lookup-operation")||a.value.parentNode.css({alignItems:"center"}).insertBefore(kb.create("button").addClass("kb-icon kb-icon-open kb-attachment-lookup-operation").on("click",
c=>{((b,l)=>{b?kb.view.records.get(l,kb.filter.query.create({code:k.lookup.relatedKeyField},"=",{type:k.type,value:b})).then(n=>{0!=n.length&&window.open(kb.record.page.detail(d.mobile,l,n.first().$id.value))}).catch(n=>kb.alert(kb.error.parse(n))):window.open(kb.record.page.add(d.mobile,l))})(a.value.elm("input[type=text]").val(),k.lookup.relatedApp.app)}),a.value.nextSibling)})})(kb.field.get(k,d.mobile,d.type))})});t.usePlaceholder.value.includes("use")&&t.placeholders.value.map(k=>k.value).each((k,
p)=>{k.field.value in d.fieldInfos.parallelize&&(g=>{(e=>{if(g.tableCode){var a=d.fieldInfos.tables[g.tableCode];a.code in C||(C[a.code]=[]);C[a.code].push(e)}else e({record:h.record})})(e=>{(a=>{a&&(Array.isArray(a)?a:[a]).each((m,c)=>{d.mobile?m.value.attr("placeholder",k.text.value):m.value.elm("input[type=text],textarea").attr("placeholder",k.text.value)})})(kb.field.get(g,d.mobile,d.type))})})(d.fieldInfos.parallelize[k.field.value])});t.useAlignTableButtons.value.includes("use")&&!d.mobile&&
Object.values(y.tables).filter(k=>!Object.keys(I).includes(k.id)).each((k,p)=>{((g,e)=>{0!=h.record[g.code].value.length&&((a=>{a.prepend(a.elm('[class^="subtable-operation-gaia"]'))})(e.addClass("kb-attachment-subtable-operation").elm("thead").elm("tr")),g.code in C||(C[g.code]=[]),C[g.code].push(a=>{e.elms("tbody tr").each((m,c)=>{Array.from(m.elms("td").last().classList).some(b=>b.startsWith("subtable-operation-gaia"))&&m.prepend(m.elm('[class^="subtable-operation-gaia"]'))})}))})(k,kb.elm(".subtable-"+
k.id))});if(t.useMultiline.value.includes("use")&&!d.mobile)for(var z in I)((k,p)=>{var g=(e,a,m)=>{var c=[];a&&a.elms("tr").each((b,l)=>{b.hasClass("kb-attachment-subtable-multi")||(n=>{t.useAlignTableButtons.value.includes("use")?b.addClass("kb-attachment-subtable-multi").append(n):b.addClass("kb-attachment-subtable-multi").prepend(n);e.lines.each((u,f)=>{n.append((r=>{u.each((x,v)=>{var F={};m?x?r.append(b.elm(".label-"+x).addClass("kb-attachment-subtable-multi-cell").css(F)):r.append(kb.create("th").addClass("subtable-label-gaia kb-attachment-subtable-multi-cell").css(F)):
(F.width=p.elm("thead").elm(".label-"+x).css("width"),x?r.append(b.elm(".field-"+x).closest("td").addClass("kb-attachment-subtable-multi-cell").css(F)):r.append(kb.create("td").addClass("kb-attachment-subtable-multi-cell").css(F)));v==u.length-1&&c.push(r.lastElementChild)});return r})(kb.create("div").css({alignItems:"stretch",display:"flex"})))});m&&(u=>{kb.children(n).each((f,r)=>{kb.children(f).reduce((x,v)=>x+=v.outerWidth(!1),0)<u&&kb.children(f).last().css({flex:"1"})})})(n.firstElementChild.outerWidth(!1))})(m?
kb.create("th").addClass("subtable-label-gaia"):kb.create("td"))});m||c.each((b,l)=>b.css({flex:"1"}))};0!=h.record[k.tableInfo.code].value.length&&(t.useAlignTableButtons.value.includes("use")&&p.addClass("kb-attachment-subtable-operation"),g(k,p.elm("thead"),!0),k.tableInfo.code in C||(C[k.tableInfo.code]=[]),C[k.tableInfo.code].push(e=>{g(k,p.elm("tbody"),!1)}))})(I[z],kb.elm(".subtable-"+I[z].tableInfo.id));"useTableCopy"in t||(kb.alert(kb.error.config.update("Boost! Attachment")),t.useTableCopy=
{value:[]});!t.useTableCopy.value.includes("use")&&!t.useTableSort.value.includes("use")||d.mobile||("object"===typeof Kuc?Object.values(d.fieldInfos.tables).each((k,p)=>{((g,e)=>{var a=null,m={},c=b=>{kb.event.call("kb.action.call",{container:kb.elm("body"),record:b,mobile:d.mobile,pattern:"change",fields:[g.code].concat(Object.keys(g.fields)),stopPropagation:!0,workplace:"record"}).then(l=>{kb.event.call("kb.style.call",{container:l.container,record:l.record,mobile:l.mobile,pattern:"$id"in l.record?
l.record.$id.value?"edit":"create":"create",workplace:l.workplace}).then(n=>{kb.event.call("kb.cascade.call",n).then(u=>{(d.mobile?kintone.mobile.app.record:kintone.app.record).set({record:u.record})}).catch(()=>{})}).catch(()=>{})}).catch(()=>{})};(b=>{g.code in C||(C[g.code]=[]);C[g.code].push(b)})(b=>{try{var l=kintone.app.record.get().record}catch{l=b.record}(n=>{n[g.code].value.each((u,f)=>{Object.values(g.fields).filter(r=>"FILE"==r.type).each(r=>{var x=kb.field.get(r,d.mobile,d.type);Array.isArray(x)&&
0!=x.length&&(x=x[f],x.nextSibling&&x.nextSibling.tagName.toLowerCase().startsWith("kuc")||(x.hide().insertAdjacentElement("afterend",R.file(r)),x.nextSibling.value=n[g.code].value[f].value[r.code].value),kb.isNumeric(a)&&a==f&&(x.nextSibling.files=m[r.id],a=null,m={}))})})})(l);t.useTableCopy.value.includes("use")&&e.elms('[class^="subtable-operation-gaia"]').each((n,u)=>{((f,r)=>{f&&(n.elm(".kb-attachment-subtable-copy")||n.insertBefore(r.on("click",x=>{((v,F)=>{(K=>{a=v+1;m=Object.values(g.fields).filter(H=>
"FILE"==H.type).reduce((H,M)=>{H[M.id]=[...e.elms("tbody .kb-attachment-field-"+M.id)[v].files];return H},{});for(let H in K)if(void 0===K[H].value)switch(g.fields[H].type){case "CHECK_BOX":case "FILE":case "GROUP_SELECT":case "MULTI_SELECT":case "ORGANIZATION_SELECT":case "USER_SELECT":K[H].value=[];break;default:K[H].value=null}else g.fields[H].lookup&&(K[H].lookup=!0);F[g.code].value.splice(v+1,0,{value:K});c(F)})(kb.extend({},F[g.code].value[v].value))})(e.elms(".kb-attachment-subtable-copy").indexOf(r),
kintone.app.record.get().record)}),f.nextSibling))})(n.elm("button"),kb.create("button").addClass("kb-icon kb-icon-copy kb-attachment-subtable-copy"))})});t.useTableSort.value.includes("use")&&Object.values(g.fields).each((b,l)=>{var n=(u,f)=>{var r=(()=>{var x=!1;if("NUMBER"==b.type)x=!0;else switch(b.type){case "CALC":switch(b.format){case "NUMBER":case "NUMBER_DIGIT":x=!0}}return x})();u.each((x,v)=>x.rowIndex=v);return u.sort((x,v)=>(f?v.value[b.code].value||"":x.value[b.code].value||"").localeCompare(f?
x.value[b.code].value||"":v.value[b.code].value||"",void 0,r?{numeric:!0}:void 0))};if("CALC DATE DATETIME DROP_DOWN LINK NUMBER RADIO_BUTTON SINGLE_LINE_TEXT TIME".split(" ").includes(b.type))e.elm("thead .label-"+b.id).on("click",u=>{((f,r,x)=>{(v=>{f.hasClass(v+"desc")?f.removeClass(v+"desc").addClass(v+"asc"):f.removeClass(v+"asc").addClass(v+"desc");f.closest("tr").elms('[class*="'+CSS.escape(v)+'"]').each((F,K)=>{F!=f&&F.removeClass(v+"asc").removeClass(v+"desc")});r[g.code].value=n(r[g.code].value,
f.hasClass(v+"desc"))})("kb-attachment-subtable-sort-");(v=>{Object.values(g.fields).filter(F=>"FILE"==F.type).each((F,K)=>{x?((H,M)=>{e.elms("tbody tr").each((N,O)=>N.elms(".kb-attachment-subtable-multi-cell")[H].append(M[v[O]]))})(e.elms("thead .kb-attachment-subtable-multi-cell").indexOf(e.elm("thead .label-"+F.id)),e.elms("tbody .kb-attachment-field-"+F.id)):((H,M)=>{e.elms("tbody tr").each((N,O)=>N.elms("td")[H].append(M[v[O]]))})(Array.from(f.parentNode.children).indexOf(e.elm("thead .label-"+
F.id)),e.elms("tbody .kb-attachment-field-"+F.id))})})(r[g.code].value.map(v=>v.rowIndex));c(r)})(u.currentTarget,kintone.app.record.get().record,e.elm("thead tr").hasClass("kb-attachment-subtable-multi"))})});d.forceUpdate||(d.forceUpdate=0!=Object.values(g.fields).filter(b=>"FILE"==b.type).length)})(k,kb.elm(".subtable-"+k.id),!0)}):kb.alert(kb.error.config.reinstall("Boost! Attachment","https://kintone-booster.com/"+kb.operator.language.substring(0,2)+"/attachment.html")));if(t.useTab.value.includes("use")){t.tabs.value.map(k=>
k.value).each((k,p)=>{k.field.value in d.fieldInfos.origin&&(g=>{(e=>{e&&(e.addClass("kb-attachment-tab-operation"+(d.mobile?" kb-mobile":"")),((a,m,c)=>{a.elms(".input-radio-item-cybozu,.radio-gaia").each((b,l)=>{b.addClass("kb-attachment-tab")});a.append(kb.create("span").addClass("kb-attachment-tab-spacer"));a.parentNode.insertBefore(m.on("click",b=>{b=Math.floor(a.clientWidth/-2);L(a,m,c,b);a.scrollBy({left:b})}),a);a.parentNode.insertBefore(c.on("click",b=>{b=Math.ceil(a.clientWidth/2);L(a,m,
c,b);a.scrollBy({left:b})}),a.nextSibling);L(a,m,c)})(e.elm(".input-radio-item-cybozu,.radio-gaia").parentNode.addClass("kb-attachment-tab-container"),kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-left"),kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-right")))})(kb.field.get(g,d.mobile,d.type))})(d.fieldInfos.parallelize[k.field.value])});var A=t.activeTabColor.value||"transparent",B=t.inactiveTabColor.value||"transparent";kb.elm(".kb-tab-style")||kb.elm("head").append(kb.create("style").addClass("kb-tab-style").attr("type",
"text/css").text(`
.kb-attachment-tab label{
	background-color:${B};
}
.kb-attachment-tab input:checked+label{
	background-color:${A};
}
`))}if(d.forceUpdate)kintone.events.on(["app.record.create.submit.success","app.record.edit.submit.success"],function(k){return new kintone.Promise(function(p,g){try{var e=(a,m,c)=>{var b=(l,n,u)=>{0!=n.field.length?(f=>{kb.file.upload(f,!0).then(r=>{n.record.push({contentType:f.contentType,fileKey:r.fileKey,name:f.name,size:f.size});l++;l<n.field.length?b(l,n,u):u()})})(n.field[l]):u()};b(0,m[a],()=>{a++;a<m.length?e(a,m,c):c()})};d.observers.each((a,m)=>a.disconnect());d.observers=[];kb.loadStart();
e(0,Object.values(d.fieldInfos.tables).reduce((a,m)=>{(c=>{Object.values(m.fields).filter(b=>"FILE"==b.type).each((b,l)=>{c.elms("tbody .kb-attachment-field-"+b.id).each((n,u)=>{k.record[m.code].value[u].value[b.code].value=[];a.push({field:n.value,record:k.record[m.code].value[u].value[b.code].value})})})})(kb.elm(".subtable-"+m.id));return a},[]),()=>{var a={};a.$id=k.record.$id;Object.keys(d.fieldInfos.tables).each((m,c)=>a[m]=k.record[m]);kb.view.records.set(kintone.app.getId(),{put:[kb.view.records.transform(a)]},
!1).then(m=>{kb.loadEnd();p(k)}).catch(m=>kb.alert(kb.error.parse(m),()=>p(k)))})}catch(a){kb.alert(kb.error.parse(a),()=>p(k))}})});for(z in C)Q(d.fieldInfos.tables[z],h.record,C[z])})(P(JSON.parse(w.flat))),q(h)}catch(t){kb.alert(kb.error.parse(t)),q(h)}}).catch(y=>q(h)):q(h)}).catch(w=>q(h))})("mobile"==h.type.split(".").first(),h.type.split(".").slice(-2).first())}));kintone.events.on(["app.record.detail.show","mobile.app.record.detail.show"],h=>new Promise((q,G)=>{((E,D)=>{d.mobile=E;d.type=
D;d.observers.each((w,y)=>w.disconnect());d.observers=[];kb.config[J].config.get().then(w=>{0!=Object.keys(w).length?kb.field.load(kb.config[J].app,!0).then(y=>{d.app={id:kb.config[J].app,fields:y.origin};d.fieldInfos=y;try{(([t,I])=>{var C={};t.useAttachmentViewer.value.includes("use")&&Object.values(d.fieldInfos.parallelize).filter(B=>"FILE"==B.type).each((B,k)=>{(p=>{if(B.tableCode){var g=d.fieldInfos.tables[B.tableCode];g.code in C||(C[g.code]=[]);C[g.code].push(p)}else p({record:h.record})})(p=>
{(g=>{g&&(Array.isArray(g)?g:[g]).each((e,a)=>{(m=>{(d.mobile?kb.children(e.value):e.value.elm("ul").elms("li")).each((c,b)=>{c.elm("a")&&!c.elm(".kb-attachment-file-operation")&&(l=>{0!=l.length&&(c.prepend(kb.create("span").addClass("kb-attachment-file-operation").html(l.first().name).on("click",n=>kb.attachment.show(l.first(),!t.onlyView.value.includes("onlyView")))),m=m.filter(n=>n!=l.first()))})(m.filter(l=>l.name==c.elm("a").html()))})})(B.tableCode?p.record[B.tableCode].value[a].value[B.code].value:
p.record[B.code].value)})})(kb.field.get(B,d.mobile,d.type))})});if(t.useMultiline.value.includes("use")&&!d.mobile)for(var z in I)((B,k)=>{var p=(g,e,a)=>{var m=[];e&&e.elms("tr").each((c,b)=>{c.hasClass("kb-attachment-subtable-multi")||(l=>{c.addClass("kb-attachment-subtable-multi").prepend(l);g.lines.each((n,u)=>{l.append((f=>{n.each((r,x)=>{var v={};a?r?f.append(c.elm(".label-"+r).addClass("kb-attachment-subtable-multi-cell").css(v)):f.append(kb.create("th").addClass("subtable-label-gaia kb-attachment-subtable-multi-cell").css(v)):
(v.width=k.elm("thead").elm(".label-"+r).css("width"),r?f.append(c.elm(".field-"+r).closest("td").addClass("kb-attachment-subtable-multi-cell").css(v)):f.append(kb.create("td").addClass("kb-attachment-subtable-multi-cell").css(v)));x==n.length-1&&m.push(f.lastElementChild)});return f})(kb.create("div").css({alignItems:"stretch",display:"flex"})))});a&&(n=>{kb.children(l).each((u,f)=>{kb.children(u).reduce((r,x)=>r+=x.outerWidth(!1),0)<n&&kb.children(u).last().css({flex:"1"})})})(l.firstElementChild.outerWidth(!1))})(a?
kb.create("th").addClass("subtable-label-gaia"):kb.create("td"))});a||m.each((c,b)=>c.css({flex:"1"}))};0!=h.record[B.tableInfo.code].value.length&&(p(B,k.elm("thead"),!0),B.tableInfo.code in C||(C[B.tableInfo.code]=[]),C[B.tableInfo.code].push(g=>{p(B,k.elm("tbody"),!1)}))})(I[z],kb.elm(".subtable-"+I[z].tableInfo.id));"useTab"in t||(kb.alert(kb.error.config.update("Boost! Attachment")),t.useTab={value:[]});if(t.useTab.value.includes("use")){t.tabs.value.map(B=>B.value).each((B,k)=>{B.field.value in
d.fieldInfos.origin&&(p=>{(g=>{g&&(((e,a)=>{a.each((m,c)=>{e.elm(".kb-attachment-tab-container").append(kb.create("span").addClass("kb-attachment-tab").append(kb.create("input").attr("type","radio").attr("id",p.code+"_"+c).attr("name",p.code).attr("value",m.label).on("change",b=>{(l=>{kb.event.call("kb.style.call",{container:kb.elm("body"),record:(()=>{l[p.code].value=kb.elms('[name="'+CSS.escape(p.code)+'"]').find(n=>n.checked).attr("value");return l})(),mobile:d.mobile,pattern:"edit",workplace:"record"}).then(n=>
{}).catch(()=>{})})((d.mobile?kintone.mobile.app.record:kintone.app.record).get().record)})).append(kb.create("label").attr("for",p.code+"_"+c).html(m.label)))});e.elm(".kb-attachment-tab-container").append(kb.create("span").addClass("kb-attachment-tab-spacer"));g.css({display:"none"}).parentNode.insertBefore(e,g.nextSibling);((m,c,b)=>{c.on("click",l=>{l=Math.floor(m.clientWidth/-2);L(m,c,b,l);m.scrollBy({left:l})});b.on("click",l=>{l=Math.ceil(m.clientWidth/2);L(m,c,b,l);m.scrollBy({left:l})});
L(m,c,b)})(e.elm(".kb-attachment-tab-container"),e.elm(".kb-icon-arrow-left"),e.elm(".kb-icon-arrow-right"))})(kb.create("div").addClass("kb-attachment-tab-operation"+(d.mobile?" kb-mobile":"")).append(kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-left")).append(kb.create("div").addClass("kb-attachment-tab-container")).append(kb.create("button").addClass("kb-icon kb-icon-arrow kb-icon-arrow-right")),Object.values(p.options).reduce((e,a)=>{e[a.index]=a;return e},[])),(e=>{e&&(e.checked=
!0)})(kb.elm('[name="'+CSS.escape(p.code)+'"][value="'+CSS.escape(h.record[p.code].value)+'"]')))})(kb.field.get(p,d.mobile,d.type))})(d.fieldInfos.parallelize[B.field.value])});I=t.activeTabColor.value||"transparent";var A=t.inactiveTabColor.value||"transparent";kb.elm(".kb-tab-style")||kb.elm("head").append(kb.create("style").addClass("kb-tab-style").attr("type","text/css").text(`
.kb-attachment-tab label{
	background-color:${A};
}
.kb-attachment-tab input:checked+label{
	background-color:${I};
}
`))}for(z in C)Q(d.fieldInfos.tables[z],h.record,C[z])})(P(JSON.parse(w.flat))),q(h)}catch(t){kb.alert(kb.error.parse(t)),q(h)}}).catch(y=>q(h)):q(h)}).catch(w=>q(h))})("mobile"==h.type.split(".").first(),h.type.split(".").slice(-2).first())}));kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],h=>new Promise((q,G)=>{((E,D)=>{d.mobile=E;d.type=D;d.observers.each((w,y)=>w.disconnect());d.observers=[];kb.config[J].config.get().then(w=>{0!=Object.keys(w).length?kb.field.load(kb.config[J].app,
!0).then(y=>{d.app={id:kb.config[J].app,fields:y.origin};d.fieldInfos=y;try{(t=>{var I=()=>{t.useSearchBox.value.includes("use")?kb.view.load(d.app.id).then(C=>{(z=>{0==kb.roleSet.user.length?kb.roleSet.load().then(()=>z()):z()})(()=>{(z=>{var A=(()=>{var k={},p={},g=(a=>Object.keys(a).reduce((m,c)=>{"NONE"!=a[c]&&m.push(c);return m},[]))(cybozu.data.page.FIELD_ACCESSIBILITY||cybozu.data.page.FIELD_ACCESS_CONTROL.right.fields),e=a=>{var m={CREATED_AT:"CREATED_TIME",DECIMAL:"NUMBER",EDITOR:"RICH_TEXT",
MODIFIED_AT:"UPDATED_TIME",MULTIPLE_CHECK:"CHECK_BOX",MULTIPLE_SELECT:"MULTI_SELECT",MULTIPLE_LINE_TEXT:"MULTI_LINE_TEXT",RECORD_ID:"RECORD_NUMBER",SINGLE_CHECK:"RADIO_BUTTON",SINGLE_SELECT:"DROP_DOWN"};return a in m?m[a]:a};Object.values(cybozu.data.page.FORM_DATA.schema.table.fieldList).each((a,m)=>{if(g.includes(a.id))if("REFERENCE_TABLE"==a.type)p[a.id]=a.var;else switch(k[a.var]={id:"f"+a.id,type:e(a.type)},k[a.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":k[a.var].option=
(()=>{var c={};"options"in a.properties&&Array.isArray(a.properties.options)&&a.properties.options.each((b,l)=>{b.valid&&(c[b.label]=b.id)});return c})();break;case "STATUS":k[a.var].status=(()=>{var c={};(b=>{("string"===typeof b.useStatus?"true"==b.useStatus:b.useStatus)&&b.states.each((l,n)=>{l.valid&&(c[l.label]=l.id)})})(cybozu.data.page.STATUS_DATA);return c})()}});Object.values(cybozu.data.page.FORM_DATA.schema.subTable).map(a=>Object.values(a.fieldList)).flat().each((a,m)=>{if(g.includes(a.id))switch(k[a.var]=
{id:"f"+a.id,type:e(a.type)},k[a.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":k[a.var].option=(()=>{var c={};"options"in a.properties&&Array.isArray(a.properties.options)&&a.properties.options.each((b,l)=>{b.valid&&(c[b.label]=b.id)});return c})()}});cybozu.data.page.FORM_DATA.referenceTables.each((a,m)=>{a.masterApp.schema&&g.includes(a.fieldId)&&((c,b,l)=>{Object.values(a.masterApp.schema.table.fieldList).each((n,u)=>{if(!c.includes(n.id))switch(k[p[b]+"."+
n.var]={id:"f"+b+".f"+n.id,type:e(n.type)},k[p[b]+"."+n.var].type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":k[p[b]+"."+n.var].option=(()=>{var f={};"options"in n.properties&&Array.isArray(n.properties.options)&&n.properties.options.each((r,x)=>{r.valid&&(f[r.label]=r.id)});return f})();break;case "STATUS":k[p[b]+"."+n.var].status=(()=>{var f={};("string"===typeof l.useStatus?"true"==l.useStatus:l.useStatus)&&l.states.each((r,x)=>{r.valid&&(f[r.label]=r.id)});return f})()}})})(a.masterApp.unAccessibleFieldIds,
a.fieldId,a.masterApp.status)});return k})(),B={build:k=>{var p=z.filterCond.match(/ and /g)?" and ":" or ",g=z.filterCond.split(p).filter(a=>a),e=(a,m)=>{0!=g.length?(c=>{if(c.info){var b=RegExp("[/\\\\^$*+?.()|[\\]{}]","g"),l=function(u){var f={groups:[],organizations:[],users:[]},r="";u.match(/ in /g)&&(x=>{x.each((v,F)=>{if(v.replace(/^[ ]+/g,"").replace(/[ ]+$/g,"").match(/^"/g))switch(v=v.replace(/^[ "]+/g,"").replace(/[ "]+$/g,""),v){case "GROUP":r="groups";break;case "ORGANIZATION":r="organizations";
break;case "USER":r="users";break;default:r||="users",f[r].push(v)}})})(u.split(" in ").last().replace(/^\(/g,"").replace(/\)$/g,"").split(","));return f};switch(c.info.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":for(var n in c.info.option)c.query.match(new RegExp('"'+n.replace(b,"\\$&")+'"'))&&(c.query=c.query.replace(new RegExp('"'+n.replace(b,"\\$&")+'"'),'"'+c.info.option[n]+'"'));break;case "CREATOR":case "MODIFIER":case "USER_SELECT":(u=>{kb.roleSet.group.filter(f=>
u.groups.includes(f.code.value)).each((f,r)=>{c.query.match(new RegExp('"'+f.code.value.replace(b,"\\$&")+'"'))&&(c.query=c.query.replace(new RegExp('"'+f.code.value.replace(b,"\\$&")+'"'),'"'+f.info.id+'"'))});kb.roleSet.organization.filter(f=>u.organizations.includes(f.code.value)).each((f,r)=>{c.query.match(new RegExp('"'+f.code.value.replace(b,"\\$&")+'"'))&&(c.query=c.query.replace(new RegExp('"'+f.code.value.replace(b,"\\$&")+'"'),'"'+f.info.id+'"'))});kb.roleSet.user.filter(f=>u.users.includes(f.code.value)).each((f,
r)=>{c.query.match(new RegExp('"'+f.code.value.replace(b,"\\$&")+'"'))&&(c.query=c.query.replace(new RegExp('"'+f.code.value.replace(b,"\\$&")+'"'),'"'+f.info.id+'"'))})})(l(c.query));break;case "GROUP_SELECT":(u=>{kb.roleSet.group.filter(f=>u.groups.includes(f.code.value)).each((f,r)=>{c.query.match(new RegExp('"'+f.code.value.replace(b,"\\$&")+'"'))&&(c.query=c.query.replace(new RegExp('"'+f.code.value.replace(b,"\\$&")+'"'),'"'+f.info.id+'"'))})})(l(c.query));break;case "ORGANIZATION_SELECT":(u=>
{kb.roleSet.organization.filter(f=>u.organizations.includes(f.code.value)).each((f,r)=>{c.query.match(new RegExp('"'+f.code.value.replace(b,"\\$&")+'"'))&&(c.query=c.query.replace(new RegExp('"'+f.code.value.replace(b,"\\$&")+'"'),'"'+f.info.id+'"'))})})(l(c.query));break;case "STATUS":for(n in c.info.status)c.query.match(new RegExp('"'+n.replace(b,"\\$&")+'"'))&&(c.query=c.query.replace(new RegExp('"'+n.replace(b,"\\$&")+'"'),'"'+c.info.status[n]+'"'))}g[a]=c.query}else g[a]="";a++;a<g.length?e(a,
m):m(g.filter(u=>u).join(p))})((c=>{var b={info:null,query:""};1<c.length&&c.last()in A&&(b.info=A[c.last()],b.query=g[a].replace(new RegExp(c.last().replace(/[\/\\^$*+?.()|\[\]{}]/g,"\\$&")),b.info.id));return b})(g[a].match(/^([^ ]+)/))):m("")};e(0,a=>{k(a)})},search:k=>{var p=kb.elm(".kb-attachment-search-operation").elm(".kb-keyword").elm("input"),g=kb.elm(".kb-attachment-search-operation").elm(".kb-target").elm("select"),e=kintone.api.url("/k/",!0).replace(/\.json/g,"")+(d.mobile?"m/"+d.app.id:
d.app.id)+"/?view="+h.viewId.toString();if(p.val()){var a=(m=>{var c=(g.val()?[z.fields[g.val()]]:Object.values(z.fields)).reduce((b,l)=>{b.push(m.map(n=>{var u=n.match(/^!/g);n=n.replace(/^!/g,"");var f="";if("EMPTY"==n)switch(l.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":case "STATUS":f=A[l.code].id+(u?" not":"")+' in ("")';break;case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "RICH_TEXT":case "SINGLE_LINE_TEXT":f=A[l.code].id+(u?" !":" ")+'= ""'}else switch(l.type){case "CHECK_BOX":case "DROP_DOWN":case "MULTI_SELECT":case "RADIO_BUTTON":n in
A[l.code].option&&(f=A[l.code].id+(u?" not":"")+' in ("'+A[l.code].option[n].replace(/"/g,'\\"')+'")');break;case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "RICH_TEXT":case "SINGLE_LINE_TEXT":f=A[l.code].id+(u?" not":"")+' like "'+n.replace(/"/g,'\\"')+'"';break;case "STATUS":n in A[l.code].status&&(f=A[l.code].id+(u?" not":"")+' in ("'+A[l.code].status[n].replace(/"/g,'\\"')+'")')}return f}).join(" or "));return b.filter(n=>n)},[]).map(b=>"("+b+")");return k?["("+k+")"].concat(c.join(" or ")).join(" and "):
c.join(" or ")})(p.val().split(/[ \u3000]/).filter(m=>m));window.location.href=a?e+"&keyword="+p.val()+"&target="+g.val()+"&q="+encodeURIComponent(a):e}else window.location.href=e}};z.fields=z.fields.reduce((k,p)=>{if(p in A)switch(d.fieldInfos.parallelize[p].type){case "CHECK_BOX":case "DROP_DOWN":case "FILE":case "LINK":case "MULTI_LINE_TEXT":case "MULTI_SELECT":case "RADIO_BUTTON":case "RICH_TEXT":case "SINGLE_LINE_TEXT":k[p]=d.fieldInfos.parallelize[p]}return k},{});0!=Object.keys(z.fields).length?
B.build(k=>{(p=>{p.elm(".kb-attachment-search-operation")||(g=>{p.addClass("kb-scope").attr("form-id","form_"+g.id).append(kb.create("div").addClass("kb-attachment-search-operation"+(d.mobile?" kb-mobile":"")).append(kb.field.activate((e=>{e.elm("select").empty().assignOption([{code:"",label:"All"}].concat(Object.values(z.fields).map(a=>({code:a.code,label:a.label}))),"label","code");return e})(kb.field.create(g.fields.target).addClass("kb-target")),g)).append(kb.field.activate(kb.field.create(g.fields.keyword).addClass("kb-keyword"),
g)).append(kb.create("button").addClass("kb-icon kb-icon-lookup").on("click",e=>{B.search(k)})).append(kb.create("button").addClass("kb-icon kb-icon-del").on("click",e=>{e.currentTarget.parentNode.elm(".kb-keyword").elm("input").val("");B.search(k)})));kb.record.set(p,g,(e=>{var a={};"keyword"in e&&(a.keyword={value:e.keyword});"target"in e&&(a.target={value:e.target});return a})(kb.queries()));kb.event.on("kb.change.keyword",e=>{e.container==p&&B.search(k);return e})})({id:"AttachmentSearch",fields:{target:{code:"target",
type:"DROP_DOWN",label:"",required:!1,noLabel:!0,options:[{index:0,label:"open"},{index:1,label:"close"}]},keyword:{code:"keyword",type:"SINGLE_LINE_TEXT",label:"",required:!1,noLabel:!0,placeholder:""}}})})(d.mobile?kintone.mobile.app.getHeaderSpaceElement():kintone.app.getHeaderMenuSpaceElement());q(h)}):q(h)})(C.origin.reduce((z,A)=>{if(A.id==h.viewId.toString())switch(h.viewType){case "list":z=A;break;default:z.filterCond=A.filterCond}return z},{fields:Object.values(d.fieldInfos.parallelize).reduce((z,
A)=>{A.tableCode||z.push(A.code);return z},[]),filterCond:""}))})}):q(h)};"useBulkUpdate"in t||(kb.alert(kb.error.config.update("Boost! Attachment")),t.useBulkUpdate={value:[]});t.useBulkUpdate.value.includes("use")&&"list"==h.viewType?kb.filter.auth(t.permitUser.value,t.permitOrganization.value,t.permitGroup.value).then(C=>{C&&kb.icon.create(d.mobile,d.type,"kb-attachment-button","refresh",()=>{kb.record.builder.build(Object.values(d.fieldInfos.placed).reduce((z,A)=>{d.fieldInfos.disables.includes(A.code)||
A.tableCode||(z[A.code]=A);return z},{}),null,z=>{kb.view.records.get(d.app.id,(d.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(A=>{0!=A.length?kb.confirm(kb.constants.common.message.confirm.submit[kb.operator.language],()=>{kb.view.records.set(d.app.id,{put:A.map(B=>({id:B.$id.value,record:kb.extend({},z)}))}).then(B=>kb.alert("Done!",()=>window.location.reload(!0))).catch(B=>kb.alert(kb.error.parse(B)))}):kb.alert("There are no records.")}).catch(A=>kb.alert(kb.error.parse(A)))})});
I()}).catch(C=>I()):I()})(JSON.parse(w.flat))}catch(t){kb.alert(kb.error.parse(t)),q(h)}}).catch(y=>q(h)):q(h)}).catch(w=>q(h))})("mobile"==h.type.split(".").first(),h.type.split(".").slice(-2).first())}));kintone.events.on(["app.report.show","mobile.app.report.show"],h=>new Promise((q,G)=>{((E,D)=>{d.mobile=E;d.type=D;d.observers.each((w,y)=>w.disconnect());d.observers=[];kb.config[J].config.get().then(w=>{if(0!=Object.keys(w).length)try{var y=JSON.parse(w.flat);"usePivotTranspose"in y||(kb.alert(kb.error.config.update("Boost! Attachment")),
y.usePivotTranspose={value:[]});y.usePivotTranspose.value.includes("use")&&(kb.elm(".kb-pivottranspose-style")||kb.elm("head").append(kb.create("style").addClass("kb-pivottranspose-style").attr("type","text/css").text("\n.gaia-report-crosstable{\n\tborder:1px solid #e3e7e8;\n\tborder-collapse:collapse;\n\tborder-spacing:0;\n\twriting-mode:vertical-lr;\n}\n.gaia-report-crosstable :is(colgroup,tr){\n\tbackground-color:transparent !important;\n\tborder:none !important;\n}\n.gaia-report-crosstable tr :is(td,th){\n\tborder:1px solid #e3e7e8;\n\twriting-mode:horizontal-tb;\n\twhite-space:nowrap;\n}\n.gaia-report-crosstable tr>td:first-child{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable .gaia-report-crosstable-row-group .gaia-report-crosstable-groupname{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable .gaia-report-crosstable-row-total .gaia-report-crosstable-groupname{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable .gaia-report-crosstable-row-subtotal .gaia-report-crosstable-groupvalue{\n\tbackground-color:transparent !important;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-group>td:nth-child(2n+1){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-total>td:nth-child(2n+1){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-subtotal:has(td[rowspan])>td:nth-child(2n+1){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:has(td[rowspan]) .gaia-report-crosstable-row-subtotal:not(:has(td[rowspan]))>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:not(:has(td[rowspan])) .gaia-report-crosstable-row-group>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:not(:has(td[rowspan])) .gaia-report-crosstable-row-total>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n.gaia-report-crosstable:not(:has(td[rowspan])) .gaia-report-crosstable-row-subtotal>td:nth-child(2n){\n\tbackground-color:#f5f5f5;\n}\n")));
q(h)}catch(t){kb.alert(kb.error.parse(t)),q(h)}else q(h)}).catch(w=>q(h))})("mobile"==h.type.split(".").first(),h.type.split(".").slice(-2).first())}));kb.event.on("kb.attachment.call",h=>new Promise((q,G)=>{kb.config[J].config.get().then(E=>{if(0!=Object.keys(E).length)try{(D=>{switch(h.mode){case "download":h.downloadable=D.useAttachmentViewer.value.includes("use")?!D.onlyView.value.includes("onlyView"):!0;break;case "placeholder":D.usePlaceholder.value.includes("use")&&(w=>{D.placeholders.value.map(y=>
y.value).each((y,t)=>{y.field.value in w&&(t=w[y.field.value],t.tableCode?h.fields[t.tableCode].fields[t.code].placeholder=y.text.value:h.fields[t.code].placeholder=y.text.value)})})(kb.field.parallelize(h.fields))}q(h)})(JSON.parse(E.flat))}catch(D){kb.alert(kb.error.parse(D)),q(h)}else q(h)}).catch(E=>q(h))}))})(kintone.$PLUGIN_ID);
