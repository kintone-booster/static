/*
* FileName "plugins.groupgantt.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(I=>{var e={},K=(z,h)=>{(d=>{var v=null,A=()=>{var k=b=>{var n=b.changedTouches?Array.from(b.changedTouches).first():b,u=b.currentTarget.closest(".kb-gantt-row").elms(".kb-gantt-cell"),l=b.currentTarget.closest(".kb-gantt-row"),q=n.clientX+v.scrollLeft,m={move:c=>{var a=c.changedTouches?Array.from(c.changedTouches).first():c,f=Math.min(q-v.scrollLeft,a.clientX),t=Math.max(q-v.scrollLeft,a.clientX);u.each((r,g)=>{g=r.getBoundingClientRect();g.left<t&&g.right>f?r.addClass("kb-gantt-hover-cell"):r.removeClass("kb-gantt-hover-cell")});
c.stopPropagation();c.preventDefault()},end:c=>{(a=>{var f=(r=>d.time.start?r:(new Date(r)).format("Y-m-d"))(a.first().attr("startvalue")),t=(r=>{d.time.end||(r=new Date(r),r=0===r.getHours()&&0===r.getMinutes()?r.calc("-1 day").format("Y-m-d"):r.format("Y-m-d"));return r})(a.last().attr("endvalue"));kb.confirm((()=>{var r=kb.constants.groupgantt.message.confirm.create[kb.operator.language];r=r.replace(/%start%/,(new Date(f)).format(d.time.start?"Y-m-d H:i":"Y-m-d"));return r=r.replace(/%end%/,(new Date(t)).format(d.time.end?
"Y-m-d H:i":"Y-m-d"))})(),()=>{localStorage.setItem("kb-gantt-create",(()=>{var r=[];(g=>{g.value=f;r.push(g)})(kb.extend({},e.fieldInfos.parallelize[h.taskStart.value]));(g=>{g.value=t;r.push(g)})(kb.extend({},e.fieldInfos.parallelize[h.taskEnd.value]));l.groupValues.reduce((g,x)=>{g=kb.extend({},e.fieldInfos.parallelize[x.field]);g.value=x.value;r.push(g);return r},r);return JSON.stringify({fields:r})})());window.open(kb.record.page.add(e.mobile,kb.config[I].app))})})(u.filter(a=>a.hasClass("kb-gantt-hover-cell")));
kb.elm("body").removeClass("kb-gantt-pointer-lock");u.each((a,f)=>a.removeClass("kb-gantt-hover-cell"));window.off("mousemove,touchmove",m.move);window.off("mouseup,touchend",m.end);c.stopPropagation();c.preventDefault()}};if(d.editable.start||d.editable.end)kb.elm("body").addClass("kb-gantt-pointer-lock"),window.on("mousemove,touchmove",m.move),window.on("mouseup,touchend",m.end);b.stopPropagation();b.preventDefault()},p=b=>{var n=b.changedTouches?Array.from(b.changedTouches).first():b,u=b.currentTarget.closest(".kb-gantt-group"),
l=n.pageX,q=b.currentTarget.closest(".kb-gantt-group").outerWidth(!1),m={move:c=>{var a=c.changedTouches?Array.from(c.changedTouches).first():c,f=q+a.pageX-l;v.elms(".kb-gantt-group").each((t,r)=>{t.css({maxWidth:f.toString()+"px",width:f.toString()+"px"})});c.stopPropagation();c.preventDefault()},end:c=>{((a,f)=>{kb.elm(".kb_groupgantt_style_"+CSS.escape(f))&&kb.elm("head").removeChild(kb.elm(".kb_groupgantt_style_"+CSS.escape(f)));kb.elm("head").append(kb.create("style").addClass("kb_groupgantt_style_"+
f).attr("type","text/css").text(a));localStorage.setItem(f,a)})((a=>".kb-gantt-group{max-width:"+a+";width:"+a+";}")(u.css("width")),"kb-gantt-style-"+h.view.value);window.off("mousemove,touchmove",m.move);window.off("mouseup,touchend",m.end);c.stopPropagation();c.preventDefault()}};window.on("mousemove,touchmove",m.move);window.on("mouseup,touchend",m.end);b.stopPropagation();b.preventDefault()};v.empty().append(kb.create("thead").append(kb.create("tr").addClass("kb-gantt-head-top").append(kb.create("th").addClass("kb-gantt-group").attr("rowspan",
"3").append(kb.create("div").addClass("kb-gantt-group-container").append(kb.create("span").addClass("kb-gantt-group-label").html("&nbsp;")).append(kb.create("span").addClass("kb-gantt-group-resizer").on("mousedown,touchstart",b=>p(b)))))).append(kb.create("tr").addClass("kb-gantt-head-center").append(kb.create("th").addClass("kb-hidden"))).append(kb.create("tr").addClass("kb-gantt-head-bottom").append(kb.create("th").addClass("kb-hidden")))).append(kb.create("tbody").append(kb.create("tr").addClass("kb-gantt-row").append(kb.create("td").addClass("kb-gantt-group").append(kb.create("div").addClass("kb-gantt-group-container").append(kb.create("span").addClass("kb-gantt-group-label")).append(kb.create("span").addClass("kb-gantt-group-resizer"))))));
(b=>{var n=e.range.start,u=e.range.end,l=m=>{var c=n.getDay();switch(h.columnScale.value){case "1day":case "12hour":case "6hour":case "4hour":case "3hour":case "1hour":switch(c){case 0:m.addClass("kb-gantt-sunday");break;case 6:m.addClass("kb-gantt-saturday")}}m.attr("weekvalue",kb.constants.weeks.en[c]);return m},q=(m,c)=>{b[m].cells.each((a,f)=>{0==f?(a.attr("colspan",b[m].cells.length),c&&(a.addClass(c),b[m].latest=a)):a.hide()});b[m].cells=[]};C(n,E(u,1)).each(m=>{(c=>{var a="";b.top&&0!=b.top.cells.length&&
n.format(b.top.format)!=c.format(b.top.format)&&(a||="kb-gantt-border-thick",q("top",a));b.center&&0!=b.center.cells.length&&n.format(b.center.format)!=c.format(b.center.format)&&(a||="kb-gantt-border-thin",q("center",a));a&&(v.elm(".kb-gantt-head-bottom").lastElementChild.addClass(a),v.elm(".kb-gantt-row").lastElementChild.addClass(a))})(E(n,-1));(c=>{if(c>u)return c=[v.elms(".kb-gantt-head-bottom th").last(),v.elms(".kb-gantt-row td").last()],b.top&&(0!=b.top.cells.length&&q("top"),b.top.latest&&
c.push(b.top.latest)),b.center&&(0!=b.center.cells.length&&q("center"),b.center.latest&&c.push(b.center.latest)),c.each((a,f)=>a.removeClass("kb-gantt-border-thick").removeClass("kb-gantt-border-thin")),KB_BREAK;b.top&&v.elm(".kb-gantt-head-top").append((a=>{b.top.cells.push(a);b.top.latest=null;return a})(kb.create("th").html(n.format(b.top.format))));b.center&&v.elm(".kb-gantt-head-center").append((a=>{b.center.cells.push(a);b.center.latest=null;return l(a)})(kb.create("th").html(n.format(b.center.format))));
v.elm(".kb-gantt-head-bottom").append((a=>{if(b.bottom.format){var f=n.format(b.bottom.format);b.bottom.indicator?(b.bottom.exclude||[]).includes(f)||a.append(kb.create("span").addClass("kb-gantt-head-indicator").html(f)):a.html(f)}return l(a.css({"min-width":h.columnWidth.value+"px"}))})(kb.create("th").html("&nbsp;")));v.elm(".kb-gantt-row").append(l(kb.create("td").addClass("kb-gantt-cell").attr("startvalue",n.toISOString()).attr("endvalue",c.toISOString()).attr("columnindex",m)));n=c})(E(n,1))})})((()=>
{switch(h.columnScale.value){case "12hour":case "6hour":case "4hour":case "3hour":case "1hour":var b={top:{format:"Y-m",cells:[]},center:{format:"d",cells:[]},bottom:{exclude:["00"],format:"H",indicator:!0}};break;case "30min":case "20min":case "15min":b={top:{format:"m-d (w)",cells:[]},center:{format:"H",cells:[]},bottom:{exclude:["00"],format:"i",indicator:!0}};break;default:b={top:{format:"Y-m",cells:[]},center:!1,bottom:{format:"d"}}}return b})());(b=>{v.elms(".kb-gantt-group").each((n,u)=>{"th"==
n.tagName.toLowerCase()?((l,q)=>{n.css({height:n.getBoundingClientRect().height.toString()+"px",zIndex:q+1});v.elm("thead").css({zIndex:q+2});l&&kb.children(l).each((m,c)=>m.css({zIndex:q+3}))})(kb.elm("#header-global-navigation-root"),b.elms("td").length):n.closest("tr").elms("td").reverse().each((l,q)=>l.css({zIndex:q+1}))});(n=>{v.elm("tbody").empty();h.group.value.each((u,l)=>{((q,m)=>{u.value.backcolor.value&&m.css({backgroundColor:u.value.backcolor.value});u.value.forecolor.value&&m.css({color:u.value.forecolor.value});
m.attr("groupid",q).elm(".kb-gantt-group-label").html(u.value.label.value);m.tasks={};m.grouping=()=>{m.tasks={};(c=>{Object.values(m.tasks).each(a=>a.render(q));kb.event.call("kb.groupgantt.group.load",{container:m,records:c})})(Object.values(e.records).reduce((c,a)=>{var f=kb.filter.scan(e.app,a,u.value.condition.value);f&&(d.tableCode?(t=>{f[d.tableCode].value.each((r,g)=>{g=f.$id.value.toString()+"_"+r.value.$rowId.value.toString();g in e.tasks?(e.tasks[g].create(q),m.tasks[g]=e.tasks[g]):t.push(r.id.toString())});
0!=t.length&&(f[d.tableCode].value=f[d.tableCode].value.filter(r=>!t.includes(r.id)))})([]):(t=>{t in e.tasks?(e.tasks[t].create(q),m.tasks[t]=e.tasks[t]):f=!1})(f.$id.value.toString()),f&&c.push(f));return c},[]))};(new MutationObserver(c=>{for(const r of c)if([...r.addedNodes,...r.removedNodes].some(g=>g.classList&&g.classList.contains("kb-gantt-task"))){var a=(g=>g?g.outerHeight(!0):0)(m.elm(".kb-gantt-task")),f=0,t=[];Object.values(m.tasks).each((g,x)=>{for(f=0;(t[f]||[]).some(H=>!(g.fields.end.value<=
H.fields.start.value||g.fields.start.value>=H.fields.end.value));)f++;t[f]||(t[f]=[]);t[f].push(g);e.tasks[g.id].groups[q]&&e.tasks[g.id].groups[q].css({top:(f*a).toString()+"px"})});m.elm(".kb-gantt-group-container").css({minHeight:((t.length+1)*a).toString()+"px"});break}})).observe(m,{childList:!0,subtree:!0});Promise.resolve().then(()=>{(c=>{c=c.some(a=>{var f;(f=e.fieldInfos.disables.includes(a.field))||(f=!["=","in"].includes(a.operator));f||e.fieldInfos.parallelize[a.field].tableCode&&(f=e.fieldInfos.parallelize[a.field].tableCode!=
d.tableCode);f||["DROP_DOWN","RADIO_BUTTON"].includes(e.fieldInfos.parallelize[a.field].type)&&(f=1<a.value.replace(/^\(|\)$/g,"").split(",").length);return f})?[]:c;m.groupQuery=c.filter(a=>!e.fieldInfos.parallelize[a.field].tableCode).map(a=>a.field+" "+a.operator+" "+a.value).join(" and ");m.groupValues=c.map(a=>{a.value=a.value.replace(/^\(|\)$/g,"");switch(e.fieldInfos.parallelize[a.field].type){case "CHECK_BOX":case "MULTI_SELECT":a.value=a.value.split(",").map(f=>f.replace(/^"|"$/g,""));break;
case "GROUP_SELECT":case "ORGANIZATION_SELECT":case "USER_SELECT":a.value=a.value.split(",").map(f=>({code:f.replace(/^"|"$/g,"")}));break;default:a.value=a.value.replace(/^"|"$/g,"")}return a})})(kb.filter.query.parse.expand(e.app,u.value.condition.value));m.grouping()});v.elm("tbody").append((c=>{c.elms(".kb-gantt-cell").each((a,f)=>{a.addEventListener("mousedown",t=>k(t));a.addEventListener("touchstart",t=>k(t),{passive:!0})});(a=>{a.addEventListener("mousedown",f=>p(f));a.addEventListener("touchstart",
f=>p(f),{passive:!0})})(c.elm(".kb-gantt-group-resizer"));return c})(m))})("_"+l.toString(),n.cloneNode(!0))})})(b.cloneNode(!0))})(v.elm(".kb-gantt-row"))},E=(k,p)=>new Date(k.getTime()+p*d.scale.interval),C=(k,p)=>{k=p.getTime()-k.getTime();return Math.ceil(k/d.scale.interval)},y=(k,p)=>{kb.view.records.get(e.app.id,(b=>{var n=[],u=(l,q)=>d.timeStamp[q]?(l.getTime()/1E3).toString():d.time[q]?l.toISOString():l.format("Y-m-d");n.push(h.taskStart.value+(d.tableCode?' not in ("")':'!=""'));n.push(h.taskEnd.value+
(d.tableCode?' not in ("")':'!=""'));n.push(h.taskStart.value+'<"'+u(d.time.start?(new Date(k.end)).calc("1 day").calc(kb.timezoneOffset()+" hour"):(new Date(k.end)).calc("1 day"),"start")+'"');n.push(h.taskEnd.value+'>"'+u(d.time.end?(new Date(k.start)).calc(kb.timezoneOffset()+" hour"):(new Date(k.start)).calc("-1 day"),"end")+'"');return(b?"("+b+") and ":"")+"("+n.join(" and ")+")"})((e.mobile?kintone.mobile.app:kintone.app).getQueryCondition()),(b=>{b=b.match(/order by/g)?b.replace(/^.*order by/g,
""):"";return(b=b.replace(/limit [0-9]+/g,"").replace(/ offset [0-9]+/g,"").replace(/^[ ]+/g,"").replace(/[ ]+$/g,""))?b:"$id asc"})((e.mobile?kintone.mobile.app:kintone.app).getQuery())).then(b=>{var n=(u,l)=>{B(b[u],()=>{u++;u<b.length?n(u,l):l()})};e.range={start:(new Date(d.session.start)).calc(kb.timezoneOffset()+" hour"),end:(new Date(d.session.end)).calc("1 day").calc(kb.timezoneOffset()+" hour")};e.records={};e.tasks={};0!=b.length?n(0,()=>p()):p()}).catch(b=>kb.alert(kb.error.parse(b)))},
B=(k,p)=>{try{(b=>{var n=l=>{(q=>{var m=(c,a,f)=>{f||(c=c.calc(kb.timezoneOffset()+" hour"));var t=c.getTime();f=e.range.start.getTime();t-=f;f+=Math.floor(t/d.scale.interval)*d.scale.interval;switch(a){case "ceil":c.setTime(0===t%d.scale.interval?f:f+d.scale.interval);break;case "floor":c.setTime(f)}return c};e.tasks[q]={id:q,recordId:b.toString(),rowId:"$rowId"in l?l.$rowId.value.toString():"",source:l,span:null,fields:{title:l[h.taskTitle.value],start:l[h.taskStart.value],end:(c=>{!d.time.end&&
c.value&&(c.value=(new Date(c.value)).calc("1 day").format("Y-m-d"));return c})(l[h.taskEnd.value])},groups:{},visible:{start:null,end:null,span:null},create:c=>{(a=>{c in a.groups||(a.groups[c]=(f=>{var t=g=>{g.changedTouches&&Array.from(g.changedTouches).first();var x=(w=>({destination:null,guide:g.currentTarget.parentNode.cloneNode(!0).css({left:w.left.toString()+"px",margin:"0",opacity:"0.5",pointerEvents:"none",position:"fixed",top:w.top.toString()+"px",zIndex:g.currentTarget.closest(".kb-gantt-row").elms("td").length+
1}),offset:{x:g.clientX-w.left,y:g.clientY-w.top},source:g.currentTarget.closest(".kb-gantt-cell")}))(g.currentTarget.parentNode.getBoundingClientRect()),H={move:w=>{var D=w.changedTouches?Array.from(w.changedTouches).first():w,F=document.elementFromPoint(D.clientX,D.clientY);if(F instanceof HTMLElement){if(F.hasClass("kb-gantt-cell")&&!F.closest(".kb-gantt-row").hasClass("kb-gantt-cursor-lock")){var G=new Date(F.attr("startvalue"));if(d.time.start||!d.time.start&&0===G.getHours()&&0===G.getMinutes())x.destination&&
x.destination!==F&&x.destination.removeClass("kb-gantt-hover-cell"),x.destination=F.addClass("kb-gantt-hover-cell")}x.guide.css({left:(D.clientX-x.offset.x).toString()+"px",top:(D.clientY-x.offset.y).toString()+"px"})}w.stopPropagation();w.preventDefault()},end:w=>{x.destination&&(((D,F)=>{e.queuedTask={id:q,fields:[h.taskStart.value,h.taskEnd.value]};a.fields.start.value=E(new Date(a.fields.start.value),F).toISOString();D!==x.source.closest(".kb-gantt-row")&&(D.groupValues.each((G,J)=>{G.field in
a.source&&(e.queuedTask.fields.push(G.field),a.source[G.field].value=G.value)}),a.create(D.attr("groupid")));a.grouping()})(x.destination.closest(".kb-gantt-row"),C(new Date(a.visible.start),new Date(x.destination.attr("startvalue")))),x.destination.removeClass("kb-gantt-hover-cell"));kb.elm("body").removeClass("kb-gantt-pointer-lock").removeChild(x.guide);v.elms(".kb-gantt-cursor-lock").each((D,F)=>D.removeClass("kb-gantt-cursor-lock"));window.off("mousemove,touchmove",H.move);window.off("mouseup,touchend",
H.end);w.stopPropagation();w.preventDefault()}};g.currentTarget.hasClass("kb-gantt-task-disabled")||(kb.elm("body").addClass("kb-gantt-pointer-lock").append(x.guide),v.elms(".kb-gantt-row").each((w,D)=>{w!=g.currentTarget.closest(".kb-gantt-row")&&(0==w.groupValues.length?w.addClass("kb-gantt-cursor-lock"):q in w.tasks?w.addClass("kb-gantt-cursor-lock"):d.tableCode&&!kb.filter.scan(e.app,e.records[b],w.groupQuery)&&w.addClass("kb-gantt-cursor-lock"))}),window.on("mousemove,touchmove",H.move),window.on("mouseup,touchend",
H.end),g.stopPropagation(),g.preventDefault())},r=g=>{g.changedTouches&&Array.from(g.changedTouches).first();var x=parseInt(g.currentTarget.closest(".kb-gantt-row").elm('[endvalue="'+CSS.escape(a.visible.end)+'"]').attr("columnindex")),H=g.currentTarget.closest(".kb-gantt-task"),w=0,D={move:F=>{var G=F.changedTouches?Array.from(F.changedTouches).first():F;if((G=document.elementFromPoint(G.clientX,G.clientY))&&G.hasClass("kb-gantt-cell")){var J=new Date(G.attr("endvalue"));if(d.time.end||!d.time.end&&
0===J.getHours()&&0===J.getMinutes())w=parseInt(G.attr("columnindex"))-x,0<a.visible.span+w&&H.css({width:((a.visible.span+w)*parseFloat(h.columnWidth.value)-1).toString()+"px"})}F.stopPropagation();F.preventDefault()},end:F=>{e.queuedTask={id:q,fields:[h.taskStart.value,h.taskEnd.value]};a.span+=w;a.render();kb.elm("body").removeClass("kb-gantt-pointer-lock");window.off("mousemove,touchmove",D.move);window.off("mouseup,touchend",D.end);F.stopPropagation();F.preventDefault()}};g.currentTarget.hasClass("kb-gantt-task-disabled")||
(kb.elm("body").addClass("kb-gantt-pointer-lock"),window.on("mousemove,touchmove",D.move),window.on("mouseup,touchend",D.end),g.stopPropagation(),g.preventDefault())};f.append((g=>{d.editable.start||g.addClass("kb-gantt-task-disabled");g.addEventListener("mousedown",x=>t(x));g.addEventListener("touchstart",x=>t(x),{passive:!0});return g})(kb.create("span").addClass("kb-gantt-task-handle"))).append(kb.create("span").addClass("kb-gantt-task-label")).append((g=>{d.editable.end||g.addClass("kb-gantt-task-disabled");
g.addEventListener("mousedown",x=>r(x));g.addEventListener("touchstart",x=>r(x),{passive:!0});return g})(kb.create("span").addClass("kb-gantt-task-resizer")));(g=>{f.addEventListener("mousedown",g);f.addEventListener("touchstart",g,{passive:!0});f.addEventListener("contextmenu",x=>{var H=x.changedTouches?Array.from(x.changedTouches).first():x;e.popup.contents.css({bottom:(document.documentElement.clientHeight-H.clientY).toString()+"px",left:H.clientX.toString()+"px"});e.popup.show(()=>{kb.confirm(kb.constants.groupgantt.message.confirm.edit[kb.operator.language],
()=>{h.readOnly.value.includes("readOnly")?window.open(kb.record.page.detail(e.mobile,e.app.id,b)):window.open(kb.record.page.edit(e.mobile,e.app.id,b))})},()=>{kb.confirm(kb.constants.common.message.confirm.copy[kb.operator.language],()=>{d.tableCode?kintone.api(kintone.api.url("/k/v1/record",!0),"GET",{app:e.app.id,id:b}).then(w=>{w.record&&(localStorage.setItem("kb-gantt-reuse",JSON.stringify({row:w.record[d.tableCode].value.find(D=>D.id.toString()==a.rowId),tableCode:d.tableCode})),window.open(kb.record.page.edit(e.mobile,
e.app.id,b)))}).catch(w=>kb.alert(kb.error.parse(w))):window.open(kb.record.page.reuse(e.mobile,e.app.id,b))})},()=>{kb.confirm(kb.constants.common.message.confirm.delete[kb.operator.language],()=>{d.tableCode?(w=>{w.value=w.value.filter(D=>D.value.$rowId.value!=a.rowId);e.queuedTask={id:q,fields:[h.taskStart.value,h.taskEnd.value]};kb.event.call("kb.groupgantt.task.submit",{task:a}).then(D=>a.leave()).catch(()=>{})})(e.records[b][d.tableCode]):(delete e.records[b],kb.view.records.delete(e.app.id,
[b]).then(w=>a.leave()).catch(w=>kb.alert(kb.error.parse(w))))})});x.stopPropagation();x.preventDefault()})})(g=>{g.stopPropagation();g.preventDefault()});return f})(kb.create("div").addClass("kb-gantt-task")))})(e.tasks[q])},grouping:()=>{(c=>{v.elms(".kb-gantt-row").each((a,f)=>{Promise.resolve().then(()=>{a.grouping();if(!(c.id in a.tasks)){var t=a.attr("groupid");t in c.groups&&(c.groups[t].remove(),delete c.groups[t])}})})})(e.tasks[q])},leave:()=>{var c=e.tasks[q],a;for(a in c.groups)delete v.elm('[groupid="'+
CSS.escape(a)+'"]').tasks[c.id],c.groups[a].remove();delete e.tasks[q]},render:c=>{(a=>{a.span?a.fields.end.value=E(new Date(a.fields.start.value),a.span).toISOString():a.span=C(new Date(a.fields.start.value),new Date(a.fields.end.value));a.visible=((f,t)=>({start:f,end:t,span:C(new Date(f),new Date(t))}))((f=>a.fields.start.value<f?f:a.fields.start.value)(e.range.start.toISOString()),(f=>a.fields.end.value>f?f:a.fields.end.value)(e.range.end.toISOString()));kb.event.call("kb.style.call",{container:kb.elm("body"),
record:e.records[b],mobile:e.mobile,pattern:"detail",workplace:"view"}).then(f=>{f=c?{[c]:a.groups[c]}:a.groups;for(var t in f){var r=f[t];r.elm(".kb-gantt-task-label").html(kb.field.stringify(e.fieldInfos.parallelize[h.taskTitle.value],a.fields.title.value," / "));r.css({backgroundColor:a.source[h.taskTitle.value].backcolor||"",color:a.source[h.taskTitle.value].forecolor||"",width:(a.visible.span*parseFloat(h.columnWidth.value)-1).toString()+"px"});v.elm('[groupid="'+CSS.escape(t)+'"] .kb-gantt-cell[startvalue="'+
CSS.escape(a.visible.start)+'"]').append(r)}}).catch(f=>{});kb.event.call("kb.groupgantt.task.submit",{task:a})})(e.tasks[q])}};(c=>{c.fields.start.value=m(new Date(c.fields.start.value),"floor",d.time.start).toISOString();c.fields.end.value=m(new Date(c.fields.end.value),"ceil",d.time.end).toISOString()})(e.tasks[q])})(d.tableCode?b.toString()+"_"+l.$rowId.value.toString():b.toString())},u=(l,q)=>{var m=(c=>c?d.time.start?new Date(c):(new Date(c)).calc(kb.timezoneOffset()+" hour"):"")(l[h.taskStart.value].value);
l=(c=>c?d.time.end?new Date(c):(new Date(c)).calc("1 day").calc(kb.timezoneOffset()+" hour"):"")(l[h.taskEnd.value].value);if(m&&l){if(m>=l)throw Error((()=>{var c=kb.constants.groupgantt.message.invalid.record[kb.operator.language];return c=c.replace(/%recordId%/,'<a href="'+kb.record.page.detail(e.mobile,e.app.id,b)+'" target="_blank">Open Record</a>')})());m<e.range.end&&l>e.range.start&&q()}};d.tableCode?k[d.tableCode].value.each((l,q)=>{l.value.$rowId={value:l.id};u(l.value,()=>n(l.value,b))}):
u(k,()=>n(k,b));e.records[b]=k;p()})(k.$id.value)}catch(b){kb.alert(kb.error.parse(b))}};z.empty().append((k=>{k.append(kb.create("div").addClass("kb-gantt-header-filter").append(kb.create("span").addClass("kb-gantt-guide").html("From:")).append(kb.create("button").addClass("kb-gantt-button kb-gantt-pickup-button").on("click",p=>{(b=>{kb.pickupDate(d.session.start,n=>{d.session.start=n;b.html(d.session.start)})})(p.currentTarget.nextElementSibling)})).append(kb.create("span").addClass("kb-gantt-guide").html(d.session.start)).append(kb.create("span").addClass("kb-gantt-guide").html("&nbsp;&nbsp;To:")).append(kb.create("button").addClass("kb-gantt-button kb-gantt-pickup-button").on("click",
p=>{(b=>{kb.pickupDate(d.session.end,n=>{d.session.end=n;b.html(d.session.end)})})(p.currentTarget.nextElementSibling)})).append(kb.create("span").addClass("kb-gantt-guide").html(d.session.end)).append(kb.create("button").addClass("kb-gantt-button kb-gantt-search-button").on("click",p=>{d.session.start<=d.session.end?(y(d.session,()=>A()),sessionStorage.setItem("kb-gantt-cache-"+h.view.value,JSON.stringify({start:d.session.start,end:d.session.end}))):kb.alert(kb.constants.groupgantt.message.invalid.search[kb.operator.language])})));
return k})(kb.create("div").attr("id","kb-gantt-header"))).append(kb.create("div").attr("id","kb-gantt-main").append((k=>{v=k;h.readOnly.value.includes("readOnly")&&v.addClass("kb-gantt-readonly");return v})(kb.create("table").addClass("kb-gantt"))));e.popup||(e.popup=(k=>{var p={delete:null,edit:null,reuse:null};kb.elm("body").append(k.on("mousedown,touchstart",b=>{b.currentTarget.hide();b.stopPropagation();b.preventDefault()}).append(k.contents=kb.create("div").on("mousedown,touchstart",b=>{b.stopPropagation();
b.preventDefault()}).append(kb.create("button").addClass("kb-icon kb-icon-edit").on("click",b=>{k.hide();p.edit&&p.edit()})).append(kb.create("button").addClass("kb-icon kb-icon-copy").on("click",b=>{k.hide();p.reuse&&p.reuse()})).append(kb.create("button").addClass("kb-icon kb-icon-del").on("click",b=>{k.hide();p.delete&&p.delete()}))));h.readOnly.value.includes("readOnly")&&(k.contents.elm(".kb-icon-copy").attr("disabled","disabled"),k.contents.elm(".kb-icon-del").attr("disabled","disabled"));k.show=
(b,n,u)=>{p.edit=b;p.reuse=n;p.delete=u;k.css({display:"block"})};return k})(kb.create("div").addClass("kb-gantt-popup")));y(d.session,()=>A());(k=>{kb.elm(".kb_groupgantt_style_"+CSS.escape(k))||localStorage.getItem(k)&&kb.elm("head").append(kb.create("style").addClass("kb_groupgantt_style_"+k).attr("type","text/css").text(localStorage.getItem(k)))})("kb-gantt-style-"+h.view.value);kb.event.on("kb.groupgantt.task.submit",k=>{var p={id:k.task.recordId,record:{}};"queuedTask"in e&&e.queuedTask.id==
k.task.id&&(d.tableCode?(p.record[d.tableCode]={value:[]},e.records[k.task.recordId][d.tableCode].value.each((b,n)=>{(u=>{e.queuedTask.fields.each((l,q)=>{!d.time.start&&l==h.taskStart.value&&u.value[l].value&&(u.value[l].value=(new Date(u.value[l].value)).format("Y-m-d"));!d.time.end&&l==h.taskEnd.value&&u.value[l].value&&(u.value[l].value=(new Date(u.value[l].value)).calc("-1 day").format("Y-m-d"))});p.record[d.tableCode].value.push(u)})(kb.extend({},b))})):e.queuedTask.fields.each((b,n)=>{p.record[b]=
{value:k.task.source[b].value};!d.time.start&&b==h.taskStart.value&&p.record[b].value&&(p.record[b].value=(new Date(p.record[b].value)).format("Y-m-d"));!d.time.end&&b==h.taskEnd.value&&p.record[b].value&&(p.record[b].value=(new Date(p.record[b].value)).calc("-1 day").format("Y-m-d"))}),kb.view.records.set(e.app.id,{put:[p]},!0).then(b=>{}).catch(b=>kb.alert(kb.error.parse(b))),delete e.queuedTask)});(k=>{k.onmessage=p=>{"record"in p.data&&(b=>{(n=>{if(n in e.records)for(var u in e.tasks)e.tasks[u].recordId==
n&&e.tasks[u].leave();B(b,()=>{v.elms(".kb-gantt-row").each((l,q)=>{Promise.resolve().then(()=>l.grouping())})})})(b.$id.value)})(p.data.record)}})(new BroadcastChannel("kb-gantt-channel"))})((d=>(v=>({editable:{start:v.start.isEditable,end:v.end.isEditable},scale:((A,E)=>({amount:A,interval:A*{min:6E4,hour:36E5,day:864E5}[E],unit:E}))(parseInt(h.columnScale.value.replace(/\D/g,""),10),h.columnScale.value.replace(/\d/g,"")),session:(A=>{if(A)A=JSON.parse(A);else switch(h.columnScale.value){case "12hour":A=
{start:(new Date).format("Y-m-d"),end:(new Date).calc("1 month,-1 day").format("Y-m-d")};break;case "6hour":A={start:(new Date).format("Y-m-d"),end:(new Date).calc("6 day").format("Y-m-d")};break;case "4hour":A={start:(new Date).format("Y-m-d"),end:(new Date).calc("6 day").format("Y-m-d")};break;case "3hour":A={start:(new Date).format("Y-m-d"),end:(new Date).calc("6 day").format("Y-m-d")};break;case "1hour":A={start:(new Date).format("Y-m-d"),end:(new Date).calc("1 day").format("Y-m-d")};break;case "30min":A=
{start:(new Date).format("Y-m-d"),end:(new Date).format("Y-m-d")};break;case "20min":A={start:(new Date).format("Y-m-d"),end:(new Date).format("Y-m-d")};break;case "15min":A={start:(new Date).format("Y-m-d"),end:(new Date).format("Y-m-d")};break;default:A={start:(new Date).format("Y-m-d"),end:(new Date).calc("1 month,-1 day").format("Y-m-d")}}return A})(sessionStorage.getItem("kb-gantt-cache-"+h.view.value)),tableCode:e.fieldInfos.parallelize[h.taskTitle.value].tableCode,time:{start:v.start.isDateTime,
end:v.end.isDateTime},timeStamp:{start:v.start.isTimeStamp,end:v.end.isTimeStamp}}))({start:d(e.fieldInfos.parallelize[h.taskStart.value]),end:d(e.fieldInfos.parallelize[h.taskEnd.value])}))(d=>{switch(d.type){case "CALC":switch(d.format){case "DATE":d.isDateTime=!1;d.isEditable=!1;break;case "DATETIME":d.isDateTime=!0,d.isEditable=!1}d.isTimeStamp=!0;break;case "CREATED_TIME":case "UPDATED_TIME":d.isDateTime=!0;d.isEditable=!1;d.isTimeStamp=!1;break;case "DATE":d.isDateTime=!1;d.isEditable=!0;d.isTimeStamp=
!1;break;case "DATETIME":d.isDateTime=!0;d.isEditable=!0;d.isTimeStamp=!1;break;default:d.isDateTime=!1,d.isEditable=!0,d.isTimeStamp=!1}return d}))};kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],z=>new Promise((h,d)=>{((v,A)=>{e.mobile=v;e.type=A;kb.config[I].config.get().then(E=>{0!=Object.keys(E).length?kb.field.load(kb.config[I].app,!0).then(C=>{e.app={id:kb.config[I].app,fields:C.origin};e.fieldInfos=C;e.records={};e.tasks={};try{(y=>{if(y){y.taskTitle.value&&(y.taskTitle.value in
e.fieldInfos.parallelize||h(z));y.taskStart.value&&(y.taskStart.value in e.fieldInfos.parallelize||h(z));y.taskEnd.value&&(y.taskEnd.value in e.fieldInfos.parallelize||h(z));var B=kb.elm("#kb-gantt");B&&K(B,y)}h(z)})(JSON.parse(E.tab).map((y,B)=>kb.extend({sIndex:{value:B.toString()}},y.setting)).reduce((y,B)=>{B.view.value==z.viewId.toString()&&(y=B);return y},null))}catch(y){kb.alert(kb.error.parse(y)),h(z)}}).catch(C=>h(z)):h(z)}).catch(E=>h(z))})("mobile"==z.type.split(".").first(),z.type.split(".").slice(-2).first())}));
kintone.events.on(["app.record.create.show","mobile.app.record.create.show"],z=>new Promise((h,d)=>{((v,A)=>{A?(E=>{((C,y)=>{kb.event.call("kb.action.call",{container:kb.elm("body"),record:z.record,mobile:v,pattern:"change",fields:C,stopPropagation:!0,workplace:"record"}).then(B=>{kb.event.call("kb.style.call",{container:B.container,record:B.record,mobile:B.mobile,pattern:"$id"in B.record?B.record.$id.value?"edit":"create":"create",workplace:B.workplace}).then(k=>{kb.event.call("kb.cascade.call",
k).then(p=>y()).catch(()=>y())}).catch(()=>y())}).catch(()=>y())})(E.fields.reduce((C,y)=>{y.tableCode?(C.includes(y.tableCode)||C.push(y.tableCode),z.record[y.tableCode].value.first().value[y.code].value=y.value):z.record[y.code].value=y.value;return C},E.fields.map(C=>C.code)),()=>{localStorage.removeItem("kb-gantt-create");h(z)})})(JSON.parse(A)):h(z)})("mobile"==z.type.split(".").first(),localStorage.getItem("kb-gantt-create"))}));kintone.events.on(["app.record.edit.show","mobile.app.record.edit.show"],
z=>new Promise((h,d)=>{((v,A)=>{A?(E=>{((C,y,B)=>{kb.event.call("kb.action.call",{container:kb.elm("body"),record:y,mobile:v,pattern:"change",fields:C,stopPropagation:!0,workplace:"record"}).then(k=>{kb.event.call("kb.style.call",{container:k.container,record:k.record,mobile:k.mobile,pattern:"$id"in k.record?k.record.$id.value?"edit":"create":"create",workplace:k.workplace}).then(p=>{kb.event.call("kb.cascade.call",p).then(b=>B()).catch(()=>B())}).catch(()=>B())}).catch(()=>B())})([E.tableCode],(C=>
{delete E.row.value.$rowId;C[E.tableCode].value.push(E.row);return C})(z.record),()=>{localStorage.removeItem("kb-gantt-reuse");h(z)})})(JSON.parse(A)):h(z)})("mobile"==z.type.split(".").first(),localStorage.getItem("kb-gantt-reuse"))}));kintone.events.on(["app.record.create.submit.success","app.record.edit.submit.success","mobile.app.record.create.submit.success","mobile.app.record.edit.submit.success"],z=>new Promise((h,d)=>{(new BroadcastChannel("kb-gantt-channel")).postMessage({record:z.record});
h(z)}))})(kintone.$PLUGIN_ID);
kb.constants=kb.extend({groupgantt:{message:{confirm:{create:{en:"Start Date: %start%<br>End Date: %end%<br>Would you like to add a record with the above details?",ja:"\u958b\u59cb\u65e5\u4ed8: %start%<br>\u7d42\u4e86\u65e5\u4ed8: %end%<br>\u4e0a\u8a18\u5185\u5bb9\u3067\u30ec\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u304b\uff1f",zh:"\u5f00\u59cb\u65e5\u671f: %start%<br>\u7ed3\u675f\u65e5\u671f: %end%<br>\u60a8\u60f3\u6839\u636e\u4e0a\u8ff0\u5185\u5bb9\u6dfb\u52a0\u8bb0\u5f55\u5417\uff1f","zh-TW":"\u958b\u59cb\u65e5\u671f: %start%<br>\u7d50\u675f\u65e5\u671f: %end%<br>\u60a8\u60f3\u6839\u64da\u4e0a\u8ff0\u5167\u5bb9\u65b0\u589e\u8a18\u9304\u55ce\uff1f"},
edit:{en:"Do you want to open the record?",ja:"\u30ec\u30b3\u30fc\u30c9\u3092\u958b\u304d\u307e\u3059\u304b\uff1f",zh:"\u60a8\u8981\u6253\u5f00\u8bb0\u5f55\u5417\uff1f","zh-TW":"\u60a8\u8981\u6253\u958b\u8a18\u9304\u55ce\uff1f"}},invalid:{record:{en:"There are records where the end date is earlier than the start date.<br>%recordId%",ja:"\u7d42\u4e86\u65e5\u304c\u958b\u59cb\u65e5\u3088\u308a\u3082\u65e9\u3044\u30ec\u30b3\u30fc\u30c9\u304c\u3042\u308a\u307e\u3059\u3002<br>%recordId%",zh:"\u5b58\u5728\u7ed3\u675f\u65e5\u671f\u65e9\u4e8e\u5f00\u59cb\u65e5\u671f\u7684\u8bb0\u5f55\u3002<br>%recordId%",
"zh-TW":"\u5b58\u5728\u7d50\u675f\u65e5\u671f\u65e9\u65bc\u958b\u59cb\u65e5\u671f\u7684\u8a18\u9304\u3002<br>%recordId%"},search:{en:"Please select an end date that is later than the start date.",ja:"\u7d42\u4e86\u65e5\u4ed8\u306f\u958b\u59cb\u65e5\u4ed8\u3088\u308a\u3082\u5f8c\u306e\u65e5\u4ed8\u3092\u9078\u629e\u3057\u3066\u304f\u3060\u3055\u3044\u3002",zh:"\u8bf7\u9009\u62e9\u665a\u4e8e\u5f00\u59cb\u65e5\u671f\u7684\u7ed3\u675f\u65e5\u671f\u3002","zh-TW":"\u8acb\u9078\u64c7\u665a\u65bc\u958b\u59cb\u65e5\u671f\u7684\u7d50\u675f\u65e5\u671f\u3002"}}}}},
kb.constants);
