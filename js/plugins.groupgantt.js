/*
* FileName "plugins.groupgantt.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(I=>{var e={},K=(z,h)=>{(d=>{var v=null,A=()=>{var k=a=>{var n=a.changedTouches?Array.from(a.changedTouches).first():a,t=a.currentTarget.closest(".kb-gantt-row").elms(".kb-gantt-cell"),l=a.currentTarget.closest(".kb-gantt-row"),u=n.clientX+v.scrollLeft,m={move:c=>{var b=c.changedTouches?Array.from(c.changedTouches).first():c,f=Math.min(u-v.scrollLeft,b.clientX),r=Math.max(u-v.scrollLeft,b.clientX);t.each((q,g)=>{g=q.getBoundingClientRect();g.left<r&&g.right>f?q.addClass("kb-gantt-hover-cell"):q.removeClass("kb-gantt-hover-cell")});
c.stopPropagation();c.preventDefault()},end:c=>{(b=>{var f=(q=>d.time.start?q:(new Date(q)).format("Y-m-d"))(b.first().attr("startvalue")),r=(q=>{d.time.end||(q=new Date(q),q=0===q.getHours()&&0===q.getMinutes()?q.calc("-1 day").format("Y-m-d"):q.format("Y-m-d"));return q})(b.last().attr("endvalue"));kb.confirm((()=>{var q=kb.constants.groupgantt.message.confirm.create[kb.operator.language];q=q.replace(/%start%/,(new Date(f)).format(d.time.start?"Y-m-d H:i":"Y-m-d"));return q=q.replace(/%end%/,(new Date(r)).format(d.time.end?
"Y-m-d H:i":"Y-m-d"))})(),()=>{localStorage.setItem("kb-gantt-create",(()=>{var q=[];(g=>{g.value=f;q.push(g)})(kb.extend({},e.fieldInfos.parallelize[h.taskStart.value]));(g=>{g.value=r;q.push(g)})(kb.extend({},e.fieldInfos.parallelize[h.taskEnd.value]));l.groupValues.reduce((g,x)=>{g=kb.extend({},e.fieldInfos.parallelize[x.field]);g.value=x.value;q.push(g);return q},q);return JSON.stringify({fields:q})})());window.open(kb.record.page.add(e.mobile,kb.config[I].app))})})(t.filter(b=>b.hasClass("kb-gantt-hover-cell")));
kb.elm("body").removeClass("kb-gantt-pointer-lock");t.each((b,f)=>b.removeClass("kb-gantt-hover-cell"));window.off("mousemove,touchmove",m.move);window.off("mouseup,touchend",m.end);c.stopPropagation();c.preventDefault()}};if(d.editable.start||d.editable.end)kb.elm("body").addClass("kb-gantt-pointer-lock"),window.on("mousemove,touchmove",m.move),window.on("mouseup,touchend",m.end);a.stopPropagation();a.preventDefault()},p=a=>{var n=a.changedTouches?Array.from(a.changedTouches).first():a,t=a.currentTarget.closest(".kb-gantt-group"),
l=n.pageX,u=a.currentTarget.closest(".kb-gantt-group").outerWidth(!1),m={move:c=>{var b=c.changedTouches?Array.from(c.changedTouches).first():c,f=u+b.pageX-l;v.elms(".kb-gantt-group").each((r,q)=>{r.css({maxWidth:f.toString()+"px",width:f.toString()+"px"})});c.stopPropagation();c.preventDefault()},end:c=>{((b,f)=>{kb.elm(".kb_groupgantt_style_"+CSS.escape(f))&&kb.elm("head").removeChild(kb.elm(".kb_groupgantt_style_"+CSS.escape(f)));kb.elm("head").append(kb.create("style").addClass("kb_groupgantt_style_"+
f).attr("type","text/css").text(b));localStorage.setItem(f,b)})((b=>".kb-gantt-group{max-width:"+b+";width:"+b+";}")(t.css("width")),"kb-gantt-style-"+h.view.value);window.off("mousemove,touchmove",m.move);window.off("mouseup,touchend",m.end);c.stopPropagation();c.preventDefault()}};window.on("mousemove,touchmove",m.move);window.on("mouseup,touchend",m.end);a.stopPropagation();a.preventDefault()};v.empty().append(kb.create("thead").append(kb.create("tr").addClass("kb-gantt-head-top").append(kb.create("th").addClass("kb-gantt-group").attr("rowspan",
"3").append(kb.create("div").addClass("kb-gantt-group-container").append(kb.create("span").addClass("kb-gantt-group-label").html("&nbsp;")).append(kb.create("span").addClass("kb-gantt-group-resizer").on("mousedown,touchstart",a=>p(a)))))).append(kb.create("tr").addClass("kb-gantt-head-center").append(kb.create("th").addClass("kb-hidden"))).append(kb.create("tr").addClass("kb-gantt-head-bottom").append(kb.create("th").addClass("kb-hidden")))).append(kb.create("tbody").append(kb.create("tr").addClass("kb-gantt-row").append(kb.create("td").addClass("kb-gantt-group").append(kb.create("div").addClass("kb-gantt-group-container").append(kb.create("span").addClass("kb-gantt-group-label")).append(kb.create("span").addClass("kb-gantt-group-resizer"))))));
(a=>{var n=e.range.start,t=e.range.end,l=(u,m)=>{a[u].cells.each((c,b)=>{0==b?(c.attr("colspan",a[u].cells.length),m&&(c.addClass(m),a[u].latest=c)):c.hide()});a[u].cells=[]};C(n,E(t,1)).each(u=>{(m=>{var c="";a.top&&0!=a.top.cells.length&&n.format(a.top.format)!=m.format(a.top.format)&&(c||="kb-gantt-border-thick",l("top",c));a.center&&0!=a.center.cells.length&&n.format(a.center.format)!=m.format(a.center.format)&&(c||="kb-gantt-border-thin",l("center",c));c&&(v.elm(".kb-gantt-head-bottom").lastElementChild.addClass(c),
v.elm(".kb-gantt-row").lastElementChild.addClass(c))})(E(n,-1));(m=>{if(m>t)return m=[v.elms(".kb-gantt-head-bottom th").last(),v.elms(".kb-gantt-row td").last()],a.top&&(0!=a.top.cells.length&&l("top"),a.top.latest&&m.push(a.top.latest)),a.center&&(0!=a.center.cells.length&&l("center"),a.center.latest&&m.push(a.center.latest)),m.each((c,b)=>c.removeClass("kb-gantt-border-thick").removeClass("kb-gantt-border-thin")),KB_BREAK;a.top&&(c=>{v.elm(".kb-gantt-head-top").append(c);a.top.cells.push(c);a.top.latest=
null})(kb.create("th").html(n.format(a.top.format)));a.center&&(c=>{v.elm(".kb-gantt-head-center").append(c);a.center.cells.push(c);a.center.latest=null})(kb.create("th").html(n.format(a.center.format)));v.elm(".kb-gantt-head-bottom").append((c=>{if(a.bottom.format){var b=n.format(a.bottom.format);a.bottom.indicator?(a.bottom.exclude||[]).includes(b)||c.append(kb.create("span").addClass("kb-gantt-head-indicator").html(b)):c.html(b)}return c.css({"min-width":h.columnWidth.value+"px"})})(kb.create("th").html("&nbsp;")));
v.elm(".kb-gantt-row").append(kb.create("td").addClass("kb-gantt-cell").attr("startvalue",n.toISOString()).attr("endvalue",m.toISOString()).attr("columnindex",u));n=m})(E(n,1))})})((()=>{switch(h.columnScale.value){case "12hour":case "6hour":case "4hour":case "3hour":case "1hour":var a={top:{format:"Y-m",cells:[]},center:{format:"d",cells:[]},bottom:{exclude:["00"],format:"H",indicator:!0}};break;case "30min":case "20min":case "15min":a={top:{format:"m-d",cells:[]},center:{format:"H",cells:[]},bottom:{exclude:["00"],
format:"i",indicator:!0}};break;default:a={top:{format:"Y-m",cells:[]},center:!1,bottom:{format:"d"}}}return a})());(a=>{v.elms(".kb-gantt-group").each((n,t)=>{"th"==n.tagName.toLowerCase()?n.css({height:n.getBoundingClientRect().height.toString()+"px",zIndex:a.elms("td").length+1}):n.closest("tr").elms("td").reverse().each((l,u)=>l.css({zIndex:u+1}))});(n=>{v.elm("tbody").empty();h.group.value.each((t,l)=>{((u,m)=>{t.value.backcolor.value&&m.css({backgroundColor:t.value.backcolor.value});t.value.forecolor.value&&
m.css({color:t.value.forecolor.value});m.attr("groupid",u).elm(".kb-gantt-group-label").html(t.value.label.value);m.tasks={};m.grouping=()=>{m.tasks={};(c=>{Object.values(m.tasks).each(b=>b.render(u));kb.event.call("kb.groupgantt.group.load",{container:m,records:c})})(Object.values(e.records).reduce((c,b)=>{var f=kb.filter.scan(e.app,b,t.value.condition.value);f&&(d.tableCode?(r=>{f[d.tableCode].value.each((q,g)=>{g=f.$id.value.toString()+"_"+q.value.$rowId.value.toString();g in e.tasks?(e.tasks[g].create(u),
m.tasks[g]=e.tasks[g]):r.push(q.id.toString())});0!=r.length&&(f[d.tableCode].value=f[d.tableCode].value.filter(q=>!r.includes(q.id)))})([]):(r=>{r in e.tasks?(e.tasks[r].create(u),m.tasks[r]=e.tasks[r]):f=!1})(f.$id.value.toString()),f&&c.push(f));return c},[]))};(new MutationObserver(c=>{for(const q of c)if([...q.addedNodes,...q.removedNodes].some(g=>g.classList&&g.classList.contains("kb-gantt-task"))){var b=(g=>g?g.outerHeight(!0):0)(m.elm(".kb-gantt-task")),f=0,r=[];Object.values(m.tasks).each((g,
x)=>{for(f=0;(r[f]||[]).some(H=>!(g.fields.end.value<=H.fields.start.value||g.fields.start.value>=H.fields.end.value));)f++;r[f]||(r[f]=[]);r[f].push(g);e.tasks[g.id].groups[u]&&e.tasks[g.id].groups[u].css({top:(f*b).toString()+"px"})});m.elm(".kb-gantt-group-container").css({minHeight:((r.length+1)*b).toString()+"px"});break}})).observe(m,{childList:!0,subtree:!0});Promise.resolve().then(()=>{(c=>{c=c.some(b=>{var f;(f=e.fieldInfos.disables.includes(b.field))||(f=!["=","in"].includes(b.operator));
f||e.fieldInfos.parallelize[b.field].tableCode&&(f=e.fieldInfos.parallelize[b.field].tableCode!=d.tableCode);f||["DROP_DOWN","RADIO_BUTTON"].includes(e.fieldInfos.parallelize[b.field].type)&&(f=1<b.value.replace(/^\(|\)$/g,"").split(",").length);return f})?[]:c;m.groupQuery=c.filter(b=>!e.fieldInfos.parallelize[b.field].tableCode).map(b=>b.field+" "+b.operator+" "+b.value).join(" and ");m.groupValues=c.map(b=>{b.value=b.value.replace(/^\(|\)$/g,"");switch(e.fieldInfos.parallelize[b.field].type){case "CHECK_BOX":case "MULTI_SELECT":b.value=
b.value.split(",").map(f=>f.replace(/^"|"$/g,""));break;case "GROUP_SELECT":case "ORGANIZATION_SELECT":case "USER_SELECT":b.value=b.value.split(",").map(f=>({code:f.replace(/^"|"$/g,"")}));break;default:b.value=b.value.replace(/^"|"$/g,"")}return b})})(kb.filter.query.parse.expand(e.app,t.value.condition.value));m.grouping()});v.elm("tbody").append((c=>{c.elms(".kb-gantt-cell").each((b,f)=>{b.addEventListener("mousedown",r=>k(r));b.addEventListener("touchstart",r=>k(r),{passive:!0})});(b=>{b.addEventListener("mousedown",
f=>p(f));b.addEventListener("touchstart",f=>p(f),{passive:!0})})(c.elm(".kb-gantt-group-resizer"));return c})(m))})("_"+l.toString(),n.cloneNode(!0))})})(a.cloneNode(!0))})(v.elm(".kb-gantt-row"))},E=(k,p)=>new Date(k.getTime()+p*d.scale.interval),C=(k,p)=>{k=p.getTime()-k.getTime();return Math.ceil(k/d.scale.interval)},y=(k,p)=>{kb.view.records.get(e.app.id,(a=>{var n=[],t=(l,u)=>d.timeStamp[u]?(l.getTime()/1E3).toString():d.time[u]?l.toISOString():l.format("Y-m-d");n.push(h.taskStart.value+(d.tableCode?
' not in ("")':'!=""'));n.push(h.taskEnd.value+(d.tableCode?' not in ("")':'!=""'));n.push(h.taskStart.value+'<"'+t(d.time.start?(new Date(k.end)).calc("1 day").calc(kb.timezoneOffset()+" hour"):(new Date(k.end)).calc("1 day"),"start")+'"');n.push(h.taskEnd.value+'>"'+t(d.time.end?(new Date(k.start)).calc(kb.timezoneOffset()+" hour"):(new Date(k.start)).calc("-1 day"),"end")+'"');return(a?"("+a+") and ":"")+"("+n.join(" and ")+")"})((e.mobile?kintone.mobile.app:kintone.app).getQueryCondition()),(a=>
{a=a.match(/order by/g)?a.replace(/^.*order by/g,""):"";return(a=a.replace(/limit [0-9]+/g,"").replace(/ offset [0-9]+/g,"").replace(/^[ ]+/g,"").replace(/[ ]+$/g,""))?a:"$id asc"})((e.mobile?kintone.mobile.app:kintone.app).getQuery())).then(a=>{var n=(t,l)=>{B(a[t],()=>{t++;t<a.length?n(t,l):l()})};e.range={start:(new Date(d.session.start)).calc(kb.timezoneOffset()+" hour"),end:(new Date(d.session.end)).calc("1 day").calc(kb.timezoneOffset()+" hour")};e.records={};e.tasks={};0!=a.length?n(0,()=>
p()):p()}).catch(a=>kb.alert(kb.error.parse(a)))},B=(k,p)=>{try{(a=>{var n=l=>{(u=>{var m=(c,b,f)=>{f||(c=c.calc(kb.timezoneOffset()+" hour"));var r=c.getTime();f=e.range.start.getTime();r-=f;f+=Math.floor(r/d.scale.interval)*d.scale.interval;switch(b){case "ceil":c.setTime(0===r%d.scale.interval?f:f+d.scale.interval);break;case "floor":c.setTime(f)}return c};e.tasks[u]={id:u,recordId:a.toString(),rowId:"$rowId"in l?l.$rowId.value.toString():"",source:l,span:null,fields:{title:l[h.taskTitle.value],
start:l[h.taskStart.value],end:(c=>{!d.time.end&&c.value&&(c.value=(new Date(c.value)).calc("1 day").format("Y-m-d"));return c})(l[h.taskEnd.value])},groups:{},visible:{start:null,end:null,span:null},create:c=>{(b=>{c in b.groups||(b.groups[c]=(f=>{var r=g=>{g.changedTouches&&Array.from(g.changedTouches).first();var x=(w=>({destination:null,guide:g.currentTarget.parentNode.cloneNode(!0).css({left:w.left.toString()+"px",margin:"0",pointerEvents:"none",position:"fixed",top:w.top.toString()+"px",zIndex:g.currentTarget.closest(".kb-gantt-row").elms("td").length+
1}),offset:{x:g.clientX-w.left,y:g.clientY-w.top},source:g.currentTarget.closest(".kb-gantt-cell")}))(g.currentTarget.parentNode.getBoundingClientRect()),H={move:w=>{var D=w.changedTouches?Array.from(w.changedTouches).first():w,F=document.elementFromPoint(D.clientX,D.clientY);if(F instanceof HTMLElement){if(F.hasClass("kb-gantt-cell")&&!F.closest(".kb-gantt-row").hasClass("kb-gantt-cursor-lock")){var G=new Date(F.attr("startvalue"));if(d.time.start||!d.time.start&&0===G.getHours()&&0===G.getMinutes())x.destination&&
x.destination!==F&&x.destination.removeClass("kb-gantt-hover-cell"),x.destination=F.addClass("kb-gantt-hover-cell")}x.guide.css({left:(D.clientX-x.offset.x).toString()+"px",top:(D.clientY-x.offset.y).toString()+"px"})}w.stopPropagation();w.preventDefault()},end:w=>{x.destination&&(((D,F)=>{e.queuedTask={id:u,fields:[h.taskStart.value,h.taskEnd.value]};b.fields.start.value=E(new Date(b.fields.start.value),F).toISOString();D!==x.source.closest(".kb-gantt-row")&&(D.groupValues.each((G,J)=>{G.field in
b.source&&(e.queuedTask.fields.push(G.field),b.source[G.field].value=G.value)}),b.create(D.attr("groupid")));b.grouping()})(x.destination.closest(".kb-gantt-row"),C(new Date(b.visible.start),new Date(x.destination.attr("startvalue")))),x.destination.removeClass("kb-gantt-hover-cell"));kb.elm("body").removeClass("kb-gantt-pointer-lock").removeChild(x.guide);v.elms(".kb-gantt-cursor-lock").each((D,F)=>D.removeClass("kb-gantt-cursor-lock"));window.off("mousemove,touchmove",H.move);window.off("mouseup,touchend",
H.end);w.stopPropagation();w.preventDefault()}};g.currentTarget.hasClass("kb-gantt-task-disabled")||(kb.elm("body").addClass("kb-gantt-pointer-lock").append(x.guide),v.elms(".kb-gantt-row").each((w,D)=>{w!=g.currentTarget.closest(".kb-gantt-row")&&(0==w.groupValues.length?w.addClass("kb-gantt-cursor-lock"):u in w.tasks?w.addClass("kb-gantt-cursor-lock"):d.tableCode&&!kb.filter.scan(e.app,e.records[a],w.groupQuery)&&w.addClass("kb-gantt-cursor-lock"))}),window.on("mousemove,touchmove",H.move),window.on("mouseup,touchend",
H.end),g.stopPropagation(),g.preventDefault())},q=g=>{g.changedTouches&&Array.from(g.changedTouches).first();var x=parseInt(g.currentTarget.closest(".kb-gantt-row").elm('[endvalue="'+CSS.escape(b.visible.end)+'"]').attr("columnindex")),H=g.currentTarget.closest(".kb-gantt-task"),w=0,D={move:F=>{var G=F.changedTouches?Array.from(F.changedTouches).first():F;if((G=document.elementFromPoint(G.clientX,G.clientY))&&G.hasClass("kb-gantt-cell")){var J=new Date(G.attr("endvalue"));if(d.time.end||!d.time.end&&
0===J.getHours()&&0===J.getMinutes())w=parseInt(G.attr("columnindex"))-x,0<b.visible.span+w&&H.css({width:((b.visible.span+w)*parseFloat(h.columnWidth.value)-1).toString()+"px"})}F.stopPropagation();F.preventDefault()},end:F=>{e.queuedTask={id:u,fields:[h.taskStart.value,h.taskEnd.value]};b.span+=w;b.render();kb.elm("body").removeClass("kb-gantt-pointer-lock");window.off("mousemove,touchmove",D.move);window.off("mouseup,touchend",D.end);F.stopPropagation();F.preventDefault()}};g.currentTarget.hasClass("kb-gantt-task-disabled")||
(kb.elm("body").addClass("kb-gantt-pointer-lock"),window.on("mousemove,touchmove",D.move),window.on("mouseup,touchend",D.end),g.stopPropagation(),g.preventDefault())};f.append((g=>{d.editable.start||g.addClass("kb-gantt-task-disabled");g.addEventListener("mousedown",x=>r(x));g.addEventListener("touchstart",x=>r(x),{passive:!0});return g})(kb.create("span").addClass("kb-gantt-task-handle"))).append(kb.create("span").addClass("kb-gantt-task-label")).append((g=>{d.editable.end||g.addClass("kb-gantt-task-disabled");
g.addEventListener("mousedown",x=>q(x));g.addEventListener("touchstart",x=>q(x),{passive:!0});return g})(kb.create("span").addClass("kb-gantt-task-resizer")));(g=>{f.addEventListener("mousedown",g);f.addEventListener("touchstart",g,{passive:!0});f.addEventListener("contextmenu",x=>{var H=x.changedTouches?Array.from(x.changedTouches).first():x;e.popup.contents.css({bottom:(document.documentElement.clientHeight-H.clientY).toString()+"px",left:H.clientX.toString()+"px"});e.popup.show(()=>{kb.confirm(kb.constants.groupgantt.message.confirm.edit[kb.operator.language],
()=>{h.readOnly.value.includes("readOnly")?window.open(kb.record.page.detail(e.mobile,e.app.id,a)):window.open(kb.record.page.edit(e.mobile,e.app.id,a))})},()=>{kb.confirm(kb.constants.common.message.confirm.copy[kb.operator.language],()=>{d.tableCode?kintone.api(kintone.api.url("/k/v1/record",!0),"GET",{app:e.app.id,id:a}).then(w=>{w.record&&(localStorage.setItem("kb-gantt-reuse",JSON.stringify({row:w.record[d.tableCode].value.find(D=>D.id.toString()==b.rowId),tableCode:d.tableCode})),window.open(kb.record.page.edit(e.mobile,
e.app.id,a)))}).catch(w=>kb.alert(kb.error.parse(w))):window.open(kb.record.page.reuse(e.mobile,e.app.id,a))})},()=>{kb.confirm(kb.constants.common.message.confirm.delete[kb.operator.language],()=>{d.tableCode?(w=>{w.value=w.value.filter(D=>D.value.$rowId.value!=b.rowId);e.queuedTask={id:u,fields:[h.taskStart.value,h.taskEnd.value]};kb.event.call("kb.groupgantt.task.submit",{task:b}).then(D=>b.leave()).catch(()=>{})})(e.records[a][d.tableCode]):(delete e.records[a],kb.view.records.delete(e.app.id,
[a]).then(w=>b.leave()).catch(w=>kb.alert(kb.error.parse(w))))})});x.stopPropagation();x.preventDefault()})})(g=>{g.stopPropagation();g.preventDefault()});return f})(kb.create("div").addClass("kb-gantt-task")))})(e.tasks[u])},grouping:()=>{(c=>{v.elms(".kb-gantt-row").each((b,f)=>{Promise.resolve().then(()=>{b.grouping();if(!(c.id in b.tasks)){var r=b.attr("groupid");r in c.groups&&(c.groups[r].remove(),delete c.groups[r])}})})})(e.tasks[u])},leave:()=>{var c=e.tasks[u],b;for(b in c.groups)delete v.elm('[groupid="'+
CSS.escape(b)+'"]').tasks[c.id],c.groups[b].remove();delete e.tasks[u]},render:c=>{(b=>{b.span?b.fields.end.value=E(new Date(b.fields.start.value),b.span).toISOString():b.span=C(new Date(b.fields.start.value),new Date(b.fields.end.value));b.visible=((f,r)=>({start:f,end:r,span:C(new Date(f),new Date(r))}))((f=>b.fields.start.value<f?f:b.fields.start.value)(e.range.start.toISOString()),(f=>b.fields.end.value>f?f:b.fields.end.value)(e.range.end.toISOString()));kb.event.call("kb.style.call",{container:kb.elm("body"),
record:e.records[a],mobile:e.mobile,pattern:"detail",workplace:"view"}).then(f=>{f=c?{[c]:b.groups[c]}:b.groups;for(var r in f){var q=f[r];q.elm(".kb-gantt-task-label").html(kb.field.stringify(e.fieldInfos.parallelize[h.taskTitle.value],b.fields.title.value," / "));q.css({backgroundColor:b.source[h.taskTitle.value].backcolor||"",color:b.source[h.taskTitle.value].forecolor||"",width:(b.visible.span*parseFloat(h.columnWidth.value)-1).toString()+"px"});v.elm('[groupid="'+CSS.escape(r)+'"] .kb-gantt-cell[startvalue="'+
CSS.escape(b.visible.start)+'"]').append(q)}}).catch(f=>{});kb.event.call("kb.groupgantt.task.submit",{task:b})})(e.tasks[u])}};(c=>{c.fields.start.value=m(new Date(c.fields.start.value),"floor",d.time.start).toISOString();c.fields.end.value=m(new Date(c.fields.end.value),"ceil",d.time.end).toISOString()})(e.tasks[u])})(d.tableCode?a.toString()+"_"+l.$rowId.value.toString():a.toString())},t=(l,u)=>{var m=(c=>c?d.time.start?new Date(c):(new Date(c)).calc(kb.timezoneOffset()+" hour"):"")(l[h.taskStart.value].value);
l=(c=>c?d.time.end?new Date(c):(new Date(c)).calc("1 day").calc(kb.timezoneOffset()+" hour"):"")(l[h.taskEnd.value].value);if(m&&l){if(m>=l)throw Error((()=>{var c=kb.constants.groupgantt.message.invalid.record[kb.operator.language];return c=c.replace(/%recordId%/,'<a href="'+kb.record.page.detail(e.mobile,e.app.id,a)+'" target="_blank">Open Record</a>')})());m<e.range.end&&l>e.range.start&&u()}};d.tableCode?k[d.tableCode].value.each((l,u)=>{l.value.$rowId={value:l.id};t(l.value,()=>n(l.value,a))}):
t(k,()=>n(k,a));e.records[a]=k;p()})(k.$id.value)}catch(a){kb.alert(kb.error.parse(a))}};z.empty().append((k=>{k.append(kb.create("div").addClass("kb-gantt-header-filter").append(kb.create("span").addClass("kb-gantt-guide").html("From:")).append(kb.create("button").addClass("kb-gantt-button kb-gantt-pickup-button").on("click",p=>{(a=>{kb.pickupDate(d.session.start,n=>{d.session.start=n;a.html(d.session.start)})})(p.currentTarget.nextElementSibling)})).append(kb.create("span").addClass("kb-gantt-guide").html(d.session.start)).append(kb.create("span").addClass("kb-gantt-guide").html("&nbsp;&nbsp;To:")).append(kb.create("button").addClass("kb-gantt-button kb-gantt-pickup-button").on("click",
p=>{(a=>{kb.pickupDate(d.session.end,n=>{d.session.end=n;a.html(d.session.end)})})(p.currentTarget.nextElementSibling)})).append(kb.create("span").addClass("kb-gantt-guide").html(d.session.end)).append(kb.create("button").addClass("kb-gantt-button kb-gantt-search-button").on("click",p=>{d.session.start<=d.session.end?(y(d.session,()=>A()),sessionStorage.setItem("kb-gantt-cache-"+h.view.value,JSON.stringify({start:d.session.start,end:d.session.end}))):kb.alert(kb.constants.groupgantt.message.invalid.search[kb.operator.language])})));
return k})(kb.create("div").attr("id","kb-gantt-header"))).append(kb.create("div").attr("id","kb-gantt-main").append((k=>{v=k;h.readOnly.value.includes("readOnly")&&v.addClass("kb-gantt-readonly");return v})(kb.create("table").addClass("kb-gantt"))));e.popup||(e.popup=(k=>{var p={delete:null,edit:null,reuse:null};kb.elm("body").append(k.on("mousedown,touchstart",a=>{a.currentTarget.hide();a.stopPropagation();a.preventDefault()}).append(k.contents=kb.create("div").on("mousedown,touchstart",a=>{a.stopPropagation();
a.preventDefault()}).append(kb.create("button").addClass("kb-icon kb-icon-edit").on("click",a=>{k.hide();p.edit&&p.edit()})).append(kb.create("button").addClass("kb-icon kb-icon-copy").on("click",a=>{k.hide();p.reuse&&p.reuse()})).append(kb.create("button").addClass("kb-icon kb-icon-del").on("click",a=>{k.hide();p.delete&&p.delete()}))));h.readOnly.value.includes("readOnly")&&(k.contents.elm(".kb-icon-copy").attr("disabled","disabled"),k.contents.elm(".kb-icon-del").attr("disabled","disabled"));k.show=
(a,n,t)=>{p.edit=a;p.reuse=n;p.delete=t;k.css({display:"block"})};return k})(kb.create("div").addClass("kb-gantt-popup")));y(d.session,()=>A());(k=>{kb.elm(".kb_groupgantt_style_"+CSS.escape(k))||localStorage.getItem(k)&&kb.elm("head").append(kb.create("style").addClass("kb_groupgantt_style_"+k).attr("type","text/css").text(localStorage.getItem(k)))})("kb-gantt-style-"+h.view.value);kb.event.on("kb.groupgantt.task.submit",k=>{var p={id:k.task.recordId,record:{}};"queuedTask"in e&&e.queuedTask.id==
k.task.id&&(d.tableCode?(p.record[d.tableCode]={value:[]},e.records[k.task.recordId][d.tableCode].value.each((a,n)=>{(t=>{e.queuedTask.fields.each((l,u)=>{!d.time.start&&l==h.taskStart.value&&t.value[l].value&&(t.value[l].value=(new Date(t.value[l].value)).format("Y-m-d"));!d.time.end&&l==h.taskEnd.value&&t.value[l].value&&(t.value[l].value=(new Date(t.value[l].value)).calc("-1 day").format("Y-m-d"))});p.record[d.tableCode].value.push(t)})(kb.extend({},a))})):e.queuedTask.fields.each((a,n)=>{p.record[a]=
{value:k.task.source[a].value};!d.time.start&&a==h.taskStart.value&&p.record[a].value&&(p.record[a].value=(new Date(p.record[a].value)).format("Y-m-d"));!d.time.end&&a==h.taskEnd.value&&p.record[a].value&&(p.record[a].value=(new Date(p.record[a].value)).calc("-1 day").format("Y-m-d"))}),kb.view.records.set(e.app.id,{put:[p]},!0).then(a=>{}).catch(a=>kb.alert(kb.error.parse(a))),delete e.queuedTask)});(k=>{k.onmessage=p=>{"record"in p.data&&(a=>{(n=>{if(n in e.records)for(var t in e.tasks)e.tasks[t].recordId==
n&&e.tasks[t].leave();B(a,()=>{v.elms(".kb-gantt-row").each((l,u)=>{Promise.resolve().then(()=>l.grouping())})})})(a.$id.value)})(p.data.record)}})(new BroadcastChannel("kb-gantt-channel"))})((d=>(v=>({editable:{start:v.start.isEditable,end:v.end.isEditable},scale:((A,E)=>({amount:A,interval:A*{min:6E4,hour:36E5,day:864E5}[E],unit:E}))(parseInt(h.columnScale.value.replace(/\D/g,""),10),h.columnScale.value.replace(/\d/g,"")),session:(A=>{if(A)A=JSON.parse(A);else switch(h.columnScale.value){case "12hour":A=
{start:(new Date).format("Y-m-d"),end:(new Date).calc("1 month,-1 day").format("Y-m-d")};break;case "6hour":A={start:(new Date).format("Y-m-d"),end:(new Date).calc("6 day").format("Y-m-d")};break;case "4hour":A={start:(new Date).format("Y-m-d"),end:(new Date).calc("6 day").format("Y-m-d")};break;case "3hour":A={start:(new Date).format("Y-m-d"),end:(new Date).calc("6 day").format("Y-m-d")};break;case "1hour":A={start:(new Date).format("Y-m-d"),end:(new Date).calc("1 day").format("Y-m-d")};break;case "30min":A=
{start:(new Date).format("Y-m-d"),end:(new Date).format("Y-m-d")};break;case "20min":A={start:(new Date).format("Y-m-d"),end:(new Date).format("Y-m-d")};break;case "15min":A={start:(new Date).format("Y-m-d"),end:(new Date).format("Y-m-d")};break;default:A={start:(new Date).format("Y-m-d"),end:(new Date).calc("1 month,-1 day").format("Y-m-d")}}return A})(sessionStorage.getItem("kb-gantt-cache-"+h.view.value)),tableCode:e.fieldInfos.parallelize[h.taskTitle.value].tableCode,time:{start:v.start.isDateTime,
end:v.end.isDateTime},timeStamp:{start:v.start.isTimeStamp,end:v.end.isTimeStamp}}))({start:d(e.fieldInfos.parallelize[h.taskStart.value]),end:d(e.fieldInfos.parallelize[h.taskEnd.value])}))(d=>{switch(d.type){case "CALC":switch(d.format){case "DATE":d.isDateTime=!1;d.isEditable=!1;break;case "DATETIME":d.isDateTime=!0,d.isEditable=!1}d.isTimeStamp=!0;break;case "CREATED_TIME":case "UPDATED_TIME":d.isDateTime=!0;d.isEditable=!1;d.isTimeStamp=!1;break;case "DATE":d.isDateTime=!1;d.isEditable=!0;d.isTimeStamp=
!1;break;case "DATETIME":d.isDateTime=!0;d.isEditable=!0;d.isTimeStamp=!1;break;default:d.isDateTime=!1,d.isEditable=!0,d.isTimeStamp=!1}return d}))};kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],z=>new Promise((h,d)=>{((v,A)=>{e.mobile=v;e.type=A;kb.config[I].config.get().then(E=>{0!=Object.keys(E).length?kb.field.load(kb.config[I].app,!0).then(C=>{e.app={id:kb.config[I].app,fields:C.origin};e.fieldInfos=C;e.records={};e.tasks={};try{(y=>{if(y){y.taskTitle.value&&(y.taskTitle.value in
e.fieldInfos.parallelize||h(z));y.taskStart.value&&(y.taskStart.value in e.fieldInfos.parallelize||h(z));y.taskEnd.value&&(y.taskEnd.value in e.fieldInfos.parallelize||h(z));var B=kb.elm("#kb-gantt");B&&K(B,y)}h(z)})(JSON.parse(E.tab).map((y,B)=>kb.extend({sIndex:{value:B.toString()}},y.setting)).reduce((y,B)=>{B.view.value==z.viewId.toString()&&(y=B);return y},null))}catch(y){kb.alert(kb.error.parse(y)),h(z)}}).catch(C=>h(z)):h(z)}).catch(E=>h(z))})("mobile"==z.type.split(".").first(),z.type.split(".").slice(-2).first())}));
kintone.events.on(["app.record.create.show","mobile.app.record.create.show"],z=>new Promise((h,d)=>{((v,A)=>{A?(E=>{((C,y)=>{kb.event.call("kb.action.call",{container:kb.elm("body"),record:z.record,mobile:v,pattern:"change",fields:C,stopPropagation:!0,workplace:"record"}).then(B=>{kb.event.call("kb.style.call",{container:B.container,record:B.record,mobile:B.mobile,pattern:"$id"in B.record?B.record.$id.value?"edit":"create":"create",workplace:B.workplace}).then(k=>{kb.event.call("kb.cascade.call",
k).then(p=>y()).catch(()=>y())}).catch(()=>y())}).catch(()=>y())})(E.fields.reduce((C,y)=>{y.tableCode?(C.includes(y.tableCode)||C.push(y.tableCode),z.record[y.tableCode].value.first().value[y.code].value=y.value):z.record[y.code].value=y.value;return C},E.fields.map(C=>C.code)),()=>{localStorage.removeItem("kb-gantt-create");h(z)})})(JSON.parse(A)):h(z)})("mobile"==z.type.split(".").first(),localStorage.getItem("kb-gantt-create"))}));kintone.events.on(["app.record.edit.show","mobile.app.record.edit.show"],
z=>new Promise((h,d)=>{((v,A)=>{A?(E=>{((C,y,B)=>{kb.event.call("kb.action.call",{container:kb.elm("body"),record:y,mobile:v,pattern:"change",fields:C,stopPropagation:!0,workplace:"record"}).then(k=>{kb.event.call("kb.style.call",{container:k.container,record:k.record,mobile:k.mobile,pattern:"$id"in k.record?k.record.$id.value?"edit":"create":"create",workplace:k.workplace}).then(p=>{kb.event.call("kb.cascade.call",p).then(a=>B()).catch(()=>B())}).catch(()=>B())}).catch(()=>B())})([E.tableCode],(C=>
{delete E.row.value.$rowId;C[E.tableCode].value.push(E.row);return C})(z.record),()=>{localStorage.removeItem("kb-gantt-reuse");h(z)})})(JSON.parse(A)):h(z)})("mobile"==z.type.split(".").first(),localStorage.getItem("kb-gantt-reuse"))}));kintone.events.on(["app.record.create.submit.success","app.record.edit.submit.success","mobile.app.record.create.submit.success","mobile.app.record.edit.submit.success"],z=>new Promise((h,d)=>{(new BroadcastChannel("kb-gantt-channel")).postMessage({record:z.record});
h(z)}))})(kintone.$PLUGIN_ID);
kb.constants=kb.extend({groupgantt:{message:{confirm:{create:{en:"Start Date: %start%<br>End Date: %end%<br>Would you like to add a record with the above details?",ja:"\u958b\u59cb\u65e5\u4ed8: %start%<br>\u7d42\u4e86\u65e5\u4ed8: %end%<br>\u4e0a\u8a18\u5185\u5bb9\u3067\u30ec\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u304b\uff1f",zh:"\u5f00\u59cb\u65e5\u671f: %start%<br>\u7ed3\u675f\u65e5\u671f: %end%<br>\u60a8\u60f3\u6839\u636e\u4e0a\u8ff0\u5185\u5bb9\u6dfb\u52a0\u8bb0\u5f55\u5417\uff1f","zh-TW":"\u958b\u59cb\u65e5\u671f: %start%<br>\u7d50\u675f\u65e5\u671f: %end%<br>\u60a8\u60f3\u6839\u64da\u4e0a\u8ff0\u5167\u5bb9\u65b0\u589e\u8a18\u9304\u55ce\uff1f"},
edit:{en:"Do you want to open the record?",ja:"\u30ec\u30b3\u30fc\u30c9\u3092\u958b\u304d\u307e\u3059\u304b\uff1f",zh:"\u60a8\u8981\u6253\u5f00\u8bb0\u5f55\u5417\uff1f","zh-TW":"\u60a8\u8981\u6253\u958b\u8a18\u9304\u55ce\uff1f"}},invalid:{record:{en:"There are records where the end date is earlier than the start date.<br>%recordId%",ja:"\u7d42\u4e86\u65e5\u304c\u958b\u59cb\u65e5\u3088\u308a\u3082\u65e9\u3044\u30ec\u30b3\u30fc\u30c9\u304c\u3042\u308a\u307e\u3059\u3002<br>%recordId%",zh:"\u5b58\u5728\u7ed3\u675f\u65e5\u671f\u65e9\u4e8e\u5f00\u59cb\u65e5\u671f\u7684\u8bb0\u5f55\u3002<br>%recordId%",
"zh-TW":"\u5b58\u5728\u7d50\u675f\u65e5\u671f\u65e9\u65bc\u958b\u59cb\u65e5\u671f\u7684\u8a18\u9304\u3002<br>%recordId%"},search:{en:"Please select an end date that is later than the start date.",ja:"\u7d42\u4e86\u65e5\u4ed8\u306f\u958b\u59cb\u65e5\u4ed8\u3088\u308a\u3082\u5f8c\u306e\u65e5\u4ed8\u3092\u9078\u629e\u3057\u3066\u304f\u3060\u3055\u3044\u3002",zh:"\u8bf7\u9009\u62e9\u665a\u4e8e\u5f00\u59cb\u65e5\u671f\u7684\u7ed3\u675f\u65e5\u671f\u3002","zh-TW":"\u8acb\u9078\u64c7\u665a\u65bc\u958b\u59cb\u65e5\u671f\u7684\u7d50\u675f\u65e5\u671f\u3002"}}}}},
kb.constants);
