/*
* FileName "plugins.groupgantt.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(I=>{var e={},K=(z,h)=>{(d=>{var u=null,A=()=>{var k=a=>{var r=a.changedTouches?Array.from(a.changedTouches).first():a,n=a.currentTarget.closest(".kb-gantt-row").elms(".kb-gantt-cell"),g=a.currentTarget.closest(".kb-gantt-row"),t=r.clientX+u.scrollLeft,m={move:c=>{var b=c.changedTouches?Array.from(c.changedTouches).first():c,f=Math.min(t-u.scrollLeft,b.clientX),p=Math.max(t-u.scrollLeft,b.clientX);n.each((v,l)=>{l=v.getBoundingClientRect();l.left<p&&l.right>f?v.addClass("kb-gantt-hover-cell"):v.removeClass("kb-gantt-hover-cell")});
c.stopPropagation();c.preventDefault()},end:c=>{(b=>{var f=(v=>d.time.start?v:(new Date(v)).format("Y-m-d"))(b.first().attr("startvalue")),p=(v=>{d.time.end||(v=new Date(v),v=0===v.getHours()&&0===v.getMinutes()?v.calc("-1 day").format("Y-m-d"):v.format("Y-m-d"));return v})(b.last().attr("endvalue"));kb.confirm((()=>{var v=kb.constants.groupgantt.message.confirm.create[kb.operator.language];v=v.replace(/%start%/,(new Date(f)).format(d.time.start?"Y-m-d H:i":"Y-m-d"));return v=v.replace(/%end%/,(new Date(p)).format(d.time.end?
"Y-m-d H:i":"Y-m-d"))})(),()=>{localStorage.setItem("kb-gantt-create",(()=>{var v=[];(l=>{l.value=f;v.push(l)})(kb.extend({},e.fieldInfos.parallelize[h.taskStart.value]));(l=>{l.value=p;v.push(l)})(kb.extend({},e.fieldInfos.parallelize[h.taskEnd.value]));g.groupValues.reduce((l,x)=>{l=kb.extend({},e.fieldInfos.parallelize[x.field]);l.value=x.value;v.push(l);return v},v);return JSON.stringify({fields:v})})());window.open(kb.record.page.add(e.mobile,kb.config[I].app))})})(n.filter(b=>b.hasClass("kb-gantt-hover-cell")));
kb.elm("body").removeClass("kb-gantt-pointer-lock");n.each((b,f)=>b.removeClass("kb-gantt-hover-cell"));window.off("mousemove,touchmove",m.move);window.off("mouseup,touchend",m.end);c.stopPropagation();c.preventDefault()}};d.editable.start&&d.editable.end&&(kb.elm("body").addClass("kb-gantt-pointer-lock"),window.on("mousemove,touchmove",m.move),window.on("mouseup,touchend",m.end));a.stopPropagation();a.preventDefault()},q=a=>{var r=a.changedTouches?Array.from(a.changedTouches).first():a,n=a.currentTarget.closest(".kb-gantt-group"),
g=r.pageX,t=a.currentTarget.closest(".kb-gantt-group").outerWidth(!1),m={move:c=>{var b=c.changedTouches?Array.from(c.changedTouches).first():c,f=t+b.pageX-g;u.elms(".kb-gantt-group").each((p,v)=>{p.css({maxWidth:f.toString()+"px",width:f.toString()+"px"})});c.stopPropagation();c.preventDefault()},end:c=>{((b,f)=>{kb.elm(".kb_groupgantt_style_"+CSS.escape(f))&&kb.elm("head").removeChild(kb.elm(".kb_groupgantt_style_"+CSS.escape(f)));kb.elm("head").append(kb.create("style").addClass("kb_groupgantt_style_"+
f).attr("type","text/css").text(b));localStorage.setItem(f,b)})((b=>".kb-gantt-group{max-width:"+b+";width:"+b+";}")(n.css("width")),"kb-gantt-style-"+h.view.value);window.off("mousemove,touchmove",m.move);window.off("mouseup,touchend",m.end);c.stopPropagation();c.preventDefault()}};window.on("mousemove,touchmove",m.move);window.on("mouseup,touchend",m.end);a.stopPropagation();a.preventDefault()};u.empty().append(kb.create("thead").append(kb.create("tr").addClass("kb-gantt-head-top").append(kb.create("th").addClass("kb-gantt-group").attr("rowspan",
"3").append(kb.create("div").addClass("kb-gantt-group-container").append(kb.create("span").addClass("kb-gantt-group-label").html("&nbsp;")).append(kb.create("span").addClass("kb-gantt-group-resizer").on("mousedown,touchstart",a=>q(a)))))).append(kb.create("tr").addClass("kb-gantt-head-center").append(kb.create("th").addClass("kb-hidden"))).append(kb.create("tr").addClass("kb-gantt-head-bottom").append(kb.create("th").addClass("kb-hidden")))).append(kb.create("tbody").append(kb.create("tr").addClass("kb-gantt-row").append(kb.create("td").addClass("kb-gantt-group").append(kb.create("div").addClass("kb-gantt-group-container").append(kb.create("span").addClass("kb-gantt-group-label")).append(kb.create("span").addClass("kb-gantt-group-resizer"))))));
(a=>{var r=e.range.start,n=e.range.end,g=(t,m)=>{a[t].cells.each((c,b)=>{0==b?(c.attr("colspan",a[t].cells.length),m&&(c.addClass(m),a[t].latest=c)):c.hide()});a[t].cells=[]};C(r,E(n,1)).each(t=>{(m=>{var c="";a.top&&0!=a.top.cells.length&&r.format(a.top.format)!=m.format(a.top.format)&&(c||="kb-gantt-border-thick",g("top",c));a.center&&0!=a.center.cells.length&&r.format(a.center.format)!=m.format(a.center.format)&&(c||="kb-gantt-border-thin",g("center",c));c&&(u.elm(".kb-gantt-head-bottom").lastElementChild.addClass(c),
u.elm(".kb-gantt-row").lastElementChild.addClass(c))})(E(r,-1));(m=>{if(m>n)return m=[u.elms(".kb-gantt-head-bottom th").last(),u.elms(".kb-gantt-row td").last()],a.top&&(0!=a.top.cells.length&&g("top"),a.top.latest&&m.push(a.top.latest)),a.center&&(0!=a.center.cells.length&&g("center"),a.center.latest&&m.push(a.center.latest)),m.each((c,b)=>c.removeClass("kb-gantt-border-thick").removeClass("kb-gantt-border-thin")),KB_BREAK;a.top&&(c=>{u.elm(".kb-gantt-head-top").append(c);a.top.cells.push(c);a.top.latest=
null})(kb.create("th").html(r.format(a.top.format)));a.center&&(c=>{u.elm(".kb-gantt-head-center").append(c);a.center.cells.push(c);a.center.latest=null})(kb.create("th").html(r.format(a.center.format)));u.elm(".kb-gantt-head-bottom").append((c=>{if(a.bottom.format){var b=r.format(a.bottom.format);a.bottom.indicator?(a.bottom.exclude||[]).includes(b)||c.append(kb.create("span").addClass("kb-gantt-head-indicator").html(b)):c.html(b)}return c.css({"min-width":h.columnWidth.value+"px"})})(kb.create("th").html("&nbsp;")));
u.elm(".kb-gantt-row").append(kb.create("td").addClass("kb-gantt-cell").attr("startvalue",r.toISOString()).attr("endvalue",m.toISOString()).attr("columnindex",t));r=m})(E(r,1))})})((()=>{switch(h.columnScale.value){case "12hour":case "6hour":case "4hour":case "3hour":case "1hour":var a={top:{format:"Y-m",cells:[]},center:{format:"d",cells:[]},bottom:{exclude:["00"],format:"H",indicator:!0}};break;case "30min":case "20min":case "15min":a={top:{format:"m-d",cells:[]},center:{format:"H",cells:[]},bottom:{exclude:["00"],
format:"i",indicator:!0}};break;default:a={top:{format:"Y-m",cells:[]},center:!1,bottom:{format:"d"}}}return a})());(a=>{u.elms(".kb-gantt-group").each((r,n)=>{"th"==r.tagName.toLowerCase()?r.css({height:r.getBoundingClientRect().height.toString()+"px",zIndex:a.elms("td").length+1}):r.closest("tr").elms("td").reverse().each((g,t)=>g.css({zIndex:t+1}))});(r=>{u.elm("tbody").empty();h.group.value.each((n,g)=>{((t,m)=>{n.value.backcolor.value&&m.css({backgroundColor:n.value.backcolor.value});n.value.forecolor.value&&
m.css({color:n.value.forecolor.value});m.attr("groupid",t).elm(".kb-gantt-group-label").html(n.value.label.value);m.tasks={};m.grouping=()=>{m.tasks={};(c=>{Object.values(m.tasks).each(b=>b.render(t));kb.event.call("kb.groupgantt.group.load",{records:c})})(Object.values(e.records).reduce((c,b)=>{var f=kb.filter.scan(e.app,b,n.value.condition.value);f&&(d.tableCode?f[d.tableCode].value.each((p,v)=>{p=f.$id.value.toString()+"_"+p.value.$rowId.value.toString();p in e.tasks&&(e.tasks[p].create(t),m.tasks[p]=
e.tasks[p])}):(p=>{p in e.tasks&&(e.tasks[p].create(t),m.tasks[p]=e.tasks[p])})(f.$id.value.toString()),f&&c.push(f));return c},[]))};(new MutationObserver(c=>{for(const v of c)if([...v.addedNodes,...v.removedNodes].some(l=>l.classList&&l.classList.contains("kb-gantt-task"))){var b=(l=>l?l.outerHeight(!0):0)(m.elm(".kb-gantt-task")),f=0,p=[];Object.values(m.tasks).each((l,x)=>{for(f=0;(p[f]||[]).some(H=>!(l.fields.end.value<=H.fields.start.value||l.fields.start.value>=H.fields.end.value));)f++;p[f]||
(p[f]=[]);p[f].push(l);e.tasks[l.id].groups[t]&&e.tasks[l.id].groups[t].css({top:(f*b).toString()+"px"})});m.elm(".kb-gantt-group-container").css({minHeight:((p.length+1)*b).toString()+"px"});break}})).observe(m,{childList:!0,subtree:!0});Promise.resolve().then(()=>{(c=>{c=c.some(b=>{var f;(f=e.fieldInfos.disables.includes(b.field))||(f=!["=","in"].includes(b.operator));f||e.fieldInfos.parallelize[b.field].tableCode&&(f=e.fieldInfos.parallelize[b.field].tableCode!=d.tableCode);f||["DROP_DOWN","RADIO_BUTTON"].includes(e.fieldInfos.parallelize[b.field].type)&&
(f=1<b.value.replace(/^\(|\)$/g,"").split(",").length);return f})?[]:c;m.groupQuery=c.filter(b=>!e.fieldInfos.parallelize[b.field].tableCode).map(b=>b.field+" "+b.operator+" "+b.value).join(" and ");m.groupValues=c.map(b=>{b.value=b.value.replace(/^\(|\)$/g,"");switch(e.fieldInfos.parallelize[b.field].type){case "CHECK_BOX":case "MULTI_SELECT":b.value=b.value.split(",").map(f=>f.replace(/^"|"$/g,""));break;case "GROUP_SELECT":case "ORGANIZATION_SELECT":case "USER_SELECT":b.value=b.value.split(",").map(f=>
({code:f.replace(/^"|"$/g,"")}));break;default:b.value=b.value.replace(/^"|"$/g,"")}return b})})(kb.filter.query.parse.expand(e.app,n.value.condition.value));m.grouping()});u.elm("tbody").append((c=>{c.elms(".kb-gantt-cell").each((b,f)=>{b.addEventListener("mousedown",p=>k(p));b.addEventListener("touchstart",p=>k(p),{passive:!0})});(b=>{b.addEventListener("mousedown",f=>q(f));b.addEventListener("touchstart",f=>q(f),{passive:!0})})(c.elm(".kb-gantt-group-resizer"));return c})(m))})("_"+g.toString(),
r.cloneNode(!0))})})(a.cloneNode(!0))})(u.elm(".kb-gantt-row"))},E=(k,q)=>new Date(k.getTime()+q*d.scale.interval),C=(k,q)=>{k=q.getTime()-k.getTime();return Math.ceil(k/d.scale.interval)},y=(k,q)=>{kb.view.records.get(e.app.id,(a=>{var r=[],n=(g,t)=>d.timeStamp[t]?(g.getTime()/1E3).toString():d.time[t]?g.toISOString():g.format("Y-m-d");r.push((()=>{var g=[];g.push(h.taskStart.value+(d.tableCode?' not in ("")':'!=""'));g.push(h.taskStart.value+'>"'+n(d.time.start?(new Date(k.start)).calc("-1 second").calc(kb.timezoneOffset()+
" hour"):(new Date(k.start)).calc("-1 day"),"start")+'"');g.push(h.taskStart.value+'<"'+n(d.time.start?(new Date(k.end)).calc("1 day").calc(kb.timezoneOffset()+" hour"):(new Date(k.end)).calc("1 day"),"start")+'"');return"("+g.join(" and ")+")"})());r.push((()=>{var g=[];g.push(h.taskEnd.value+(d.tableCode?' not in ("")':'!=""'));g.push(h.taskEnd.value+'>"'+n(d.time.end?(new Date(k.start)).calc("-1 second").calc(kb.timezoneOffset()+" hour"):(new Date(k.start)).calc("-1 day"),"end")+'"');g.push(h.taskEnd.value+
'<"'+n(d.time.end?(new Date(k.end)).calc("1 day").calc(kb.timezoneOffset()+" hour"):(new Date(k.end)).calc("1 day"),"end")+'"');return"("+g.join(" and ")+")"})());r.push((()=>{var g=[];g.push(h.taskStart.value+(d.tableCode?' not in ("")':'!=""'));g.push(h.taskEnd.value+(d.tableCode?' not in ("")':'!=""'));g.push(h.taskStart.value+'<="'+n(d.time.start?(new Date(k.start)).calc("-1 second").calc(kb.timezoneOffset()+" hour"):(new Date(k.start)).calc("-1 day"),"start")+'"');g.push(h.taskEnd.value+'>="'+
n(d.time.end?(new Date(k.end)).calc("1 day").calc(kb.timezoneOffset()+" hour"):(new Date(k.end)).calc("1 day"),"end")+'"');return"("+g.join(" and ")+")"})());return(a?"("+a+") and ":"")+"("+r.join(" or ")+")"})((e.mobile?kintone.mobile.app:kintone.app).getQueryCondition()),(a=>{a=a.match(/order by/g)?a.replace(/^.*order by/g,""):"";return(a=a.replace(/limit [0-9]+/g,"").replace(/ offset [0-9]+/g,"").replace(/^[ ]+/g,"").replace(/[ ]+$/g,""))?a:"$id asc"})((e.mobile?kintone.mobile.app:kintone.app).getQuery())).then(a=>
{var r=(n,g)=>{B(a[n],()=>{n++;n<a.length?r(n,g):g()})};e.range={start:(new Date(d.session.start)).calc(kb.timezoneOffset()+" hour"),end:(new Date(d.session.end)).calc("1 day").calc(kb.timezoneOffset()+" hour")};e.records={};0!=a.length?r(0,()=>q()):q()}).catch(a=>kb.alert(kb.error.parse(a)))},B=(k,q)=>{try{(a=>{var r=g=>{(t=>{var m=(c,b,f)=>{f||(c=c.calc(kb.timezoneOffset()+" hour"));var p=c.getTime();f=e.range.start.getTime();p-=f;f+=Math.floor(p/d.scale.interval)*d.scale.interval;switch(b){case "ceil":c.setTime(0===
p%d.scale.interval?f:f+d.scale.interval);break;case "floor":c.setTime(f)}return c};e.tasks[t]={id:t,recordId:a.toString(),rowId:"$rowId"in g?g.$rowId.value.toString():"",source:g,span:null,fields:{title:g[h.taskTitle.value],start:g[h.taskStart.value],end:(c=>{!d.time.end&&c.value&&(c.value=(new Date(c.value)).calc("1 day").format("Y-m-d"));return c})(g[h.taskEnd.value])},groups:{},visible:{start:null,end:null,span:null},create:c=>{(b=>{c in b.groups||(b.groups[c]=(f=>{var p=l=>{l.changedTouches&&
Array.from(l.changedTouches).first();var x=(w=>({destination:null,guide:l.currentTarget.parentNode.cloneNode(!0).css({left:w.left.toString()+"px",margin:"0",pointerEvents:"none",position:"fixed",top:w.top.toString()+"px",zIndex:l.currentTarget.closest(".kb-gantt-row").elms("td").length+1}),offset:{x:l.clientX-w.left,y:l.clientY-w.top},source:l.currentTarget.closest(".kb-gantt-cell")}))(l.currentTarget.parentNode.getBoundingClientRect()),H={move:w=>{var D=w.changedTouches?Array.from(w.changedTouches).first():
w,F=document.elementFromPoint(D.clientX,D.clientY);if(F instanceof HTMLElement){if(F.hasClass("kb-gantt-cell")&&!F.closest(".kb-gantt-row").hasClass("kb-gantt-cursor-lock")){var G=new Date(F.attr("startvalue"));if(d.time.start||!d.time.start&&0===G.getHours()&&0===G.getMinutes())x.destination&&x.destination!==F&&x.destination.removeClass("kb-gantt-hover-cell"),x.destination=F.addClass("kb-gantt-hover-cell")}x.guide.css({left:(D.clientX-x.offset.x).toString()+"px",top:(D.clientY-x.offset.y).toString()+
"px"})}w.stopPropagation();w.preventDefault()},end:w=>{x.destination&&(((D,F)=>{e.queuedTask={id:t,fields:[h.taskStart.value,h.taskEnd.value]};b.fields.start.value=E(new Date(b.fields.start.value),F).toISOString();D!==x.source.closest(".kb-gantt-row")&&(D.groupValues.each((G,J)=>{G.field in b.source&&(e.queuedTask.fields.push(G.field),b.source[G.field].value=G.value)}),b.create(D.attr("groupid")));b.grouping()})(x.destination.closest(".kb-gantt-row"),C(new Date(b.visible.start),new Date(x.destination.attr("startvalue")))),
x.destination.removeClass("kb-gantt-hover-cell"));kb.elm("body").removeClass("kb-gantt-pointer-lock").removeChild(x.guide);u.elms(".kb-gantt-cursor-lock").each((D,F)=>D.removeClass("kb-gantt-cursor-lock"));window.off("mousemove,touchmove",H.move);window.off("mouseup,touchend",H.end);w.stopPropagation();w.preventDefault()}};l.currentTarget.hasClass("kb-gantt-task-disabled")||(kb.elm("body").addClass("kb-gantt-pointer-lock").append(x.guide),u.elms(".kb-gantt-row").each((w,D)=>{w!=l.currentTarget.closest(".kb-gantt-row")&&
(0==w.groupValues.length?w.addClass("kb-gantt-cursor-lock"):t in w.tasks?w.addClass("kb-gantt-cursor-lock"):d.tableCode&&!kb.filter.scan(e.app,e.records[a],w.groupQuery)&&w.addClass("kb-gantt-cursor-lock"))}),window.on("mousemove,touchmove",H.move),window.on("mouseup,touchend",H.end),l.stopPropagation(),l.preventDefault())},v=l=>{l.changedTouches&&Array.from(l.changedTouches).first();var x=parseInt(l.currentTarget.closest(".kb-gantt-row").elm('[endvalue="'+CSS.escape(b.visible.end)+'"]').attr("columnindex")),
H=l.currentTarget.closest(".kb-gantt-task"),w=0,D={move:F=>{var G=F.changedTouches?Array.from(F.changedTouches).first():F;if((G=document.elementFromPoint(G.clientX,G.clientY))&&G.hasClass("kb-gantt-cell")){var J=new Date(G.attr("endvalue"));if(d.time.end||!d.time.end&&0===J.getHours()&&0===J.getMinutes())w=parseInt(G.attr("columnindex"))-x,0<b.visible.span+w&&H.css({width:((b.visible.span+w)*parseFloat(h.columnWidth.value)-1).toString()+"px"})}F.stopPropagation();F.preventDefault()},end:F=>{e.queuedTask=
{id:t,fields:[h.taskStart.value,h.taskEnd.value]};b.span+=w;b.render();kb.elm("body").removeClass("kb-gantt-pointer-lock");window.off("mousemove,touchmove",D.move);window.off("mouseup,touchend",D.end);F.stopPropagation();F.preventDefault()}};l.currentTarget.hasClass("kb-gantt-task-disabled")||(kb.elm("body").addClass("kb-gantt-pointer-lock"),window.on("mousemove,touchmove",D.move),window.on("mouseup,touchend",D.end),l.stopPropagation(),l.preventDefault())};f.append((l=>{d.editable.start||l.addClass("kb-gantt-task-disabled");
l.addEventListener("mousedown",x=>p(x));l.addEventListener("touchstart",x=>p(x),{passive:!0});return l})(kb.create("span").addClass("kb-gantt-task-handle"))).append(kb.create("span").addClass("kb-gantt-task-label")).append((l=>{d.editable.end||l.addClass("kb-gantt-task-disabled");l.addEventListener("mousedown",x=>v(x));l.addEventListener("touchstart",x=>v(x),{passive:!0});return l})(kb.create("span").addClass("kb-gantt-task-resizer")));(l=>{f.addEventListener("mousedown",l);f.addEventListener("touchstart",
l,{passive:!0});f.addEventListener("contextmenu",x=>{var H=x.changedTouches?Array.from(x.changedTouches).first():x;e.popup.contents.css({bottom:(document.documentElement.clientHeight-H.clientY).toString()+"px",left:H.clientX.toString()+"px"});e.popup.show(()=>{kb.confirm(kb.constants.groupgantt.message.confirm.edit[kb.operator.language],()=>{h.readOnly.value.includes("readOnly")?window.open(kb.record.page.detail(e.mobile,e.app.id,a)):window.open(kb.record.page.edit(e.mobile,e.app.id,a))})},()=>{kb.confirm(kb.constants.common.message.confirm.copy[kb.operator.language],
()=>{d.tableCode?kintone.api(kintone.api.url("/k/v1/record",!0),"GET",{app:e.app.id,id:a}).then(w=>{w.record&&(localStorage.setItem("kb-gantt-reuse",JSON.stringify({row:w.record[d.tableCode].value.find(D=>D.id.toString()==b.rowId),tableCode:d.tableCode})),window.open(kb.record.page.edit(e.mobile,e.app.id,a)))}).catch(w=>kb.alert(kb.error.parse(w))):window.open(kb.record.page.reuse(e.mobile,e.app.id,a))})},()=>{kb.confirm(kb.constants.common.message.confirm.delete[kb.operator.language],()=>{d.tableCode?
(w=>{w.value=w.value.filter(D=>D.value.$rowId.value!=b.rowId);e.queuedTask={id:t,fields:[h.taskStart.value,h.taskEnd.value]};kb.event.call("kb.groupgantt.task.submit",{task:b}).then(D=>b.leave()).catch(()=>{})})(e.records[a][d.tableCode]):(delete e.records[a],kb.view.records.delete(e.app.id,[a]).then(w=>b.leave()).catch(w=>kb.alert(kb.error.parse(w))))})});x.stopPropagation();x.preventDefault()})})(l=>{l.stopPropagation();l.preventDefault()});return f})(kb.create("div").addClass("kb-gantt-task")))})(e.tasks[t])},
grouping:()=>{(c=>{u.elms(".kb-gantt-row").each((b,f)=>{Promise.resolve().then(()=>{b.grouping();if(!(c.id in b.tasks)){var p=b.attr("groupid");p in c.groups&&(c.groups[p].remove(),delete c.groups[p])}})})})(e.tasks[t])},leave:()=>{var c=e.tasks[t],b;for(b in c.groups)delete u.elm('[groupid="'+CSS.escape(b)+'"]').tasks[c.id],c.groups[b].remove();delete e.tasks[t]},render:c=>{(b=>{b.span?b.fields.end.value=E(new Date(b.fields.start.value),b.span).toISOString():b.span=C(new Date(b.fields.start.value),
new Date(b.fields.end.value));b.visible=((f,p)=>({start:f,end:p,span:C(new Date(f),new Date(p))}))((f=>b.fields.start.value<f?f:b.fields.start.value)(e.range.start.toISOString()),(f=>b.fields.end.value>f?f:b.fields.end.value)(e.range.end.toISOString()));kb.event.call("kb.style.call",{container:kb.elm("body"),record:e.records[a],mobile:e.mobile,pattern:"detail",workplace:"view"}).then(f=>{f=c?{[c]:b.groups[c]}:b.groups;for(var p in f){var v=f[p];v.elm(".kb-gantt-task-label").html(kb.field.stringify(e.fieldInfos.parallelize[h.taskTitle.value],
b.fields.title.value," / "));v.css({backgroundColor:b.source[h.taskTitle.value].backcolor||"",color:b.source[h.taskTitle.value].forecolor||"",width:(b.visible.span*parseFloat(h.columnWidth.value)-1).toString()+"px"});u.elm('[groupid="'+CSS.escape(p)+'"] .kb-gantt-cell[startvalue="'+CSS.escape(b.visible.start)+'"]').append(v)}}).catch(f=>{});kb.event.call("kb.groupgantt.task.submit",{task:b})})(e.tasks[t])}};(c=>{c.fields.start.value=m(new Date(c.fields.start.value),"floor",d.time.start).toISOString();
c.fields.end.value=m(new Date(c.fields.end.value),"ceil",d.time.end).toISOString()})(e.tasks[t])})(d.tableCode?a.toString()+"_"+g.$rowId.value.toString():a.toString())},n=(g,t)=>{var m=(c=>c?d.time.start?new Date(c):(new Date(c)).calc(kb.timezoneOffset()+" hour"):"")(g[h.taskStart.value].value);g=(c=>c?d.time.end?new Date(c):(new Date(c)).calc("1 day").calc(kb.timezoneOffset()+" hour"):"")(g[h.taskEnd.value].value);if(m&&g){if(m>=g)throw Error((()=>{var c=kb.constants.groupgantt.message.invalid.record[kb.operator.language];
return c=c.replace(/%recordId%/,'<a href="'+kb.record.page.detail(e.mobile,e.app.id,a)+'" target="_blank">Open Record</a>')})());m<e.range.end&&g>e.range.start&&t()}};d.tableCode?k[d.tableCode].value.each((g,t)=>{g.value.$rowId={value:g.id};n(g.value,()=>r(g.value,a))}):n(k,()=>r(k,a));e.records[a]=k;q()})(k.$id.value)}catch(a){kb.alert(kb.error.parse(a))}};z.empty().append((k=>{k.append(kb.create("div").addClass("kb-gantt-header-filter").append(kb.create("span").addClass("kb-gantt-guide").html("From:")).append(kb.create("button").addClass("kb-gantt-button kb-gantt-pickup-button").on("click",
q=>{(a=>{kb.pickupDate(d.session.start,r=>{d.session.start=r;a.html(d.session.start)})})(q.currentTarget.nextElementSibling)})).append(kb.create("span").addClass("kb-gantt-guide").html(d.session.start)).append(kb.create("span").addClass("kb-gantt-guide").html("&nbsp;&nbsp;To:")).append(kb.create("button").addClass("kb-gantt-button kb-gantt-pickup-button").on("click",q=>{(a=>{kb.pickupDate(d.session.end,r=>{d.session.end=r;a.html(d.session.end)})})(q.currentTarget.nextElementSibling)})).append(kb.create("span").addClass("kb-gantt-guide").html(d.session.end)).append(kb.create("button").addClass("kb-gantt-button kb-gantt-search-button").on("click",
q=>{d.session.start<=d.session.end?(y(d.session,()=>A()),sessionStorage.setItem("kb-gantt-cache-"+h.view.value,JSON.stringify({start:d.session.start,end:d.session.end}))):kb.alert(kb.constants.groupgantt.message.invalid.search[kb.operator.language])})));return k})(kb.create("div").attr("id","kb-gantt-header"))).append(kb.create("div").attr("id","kb-gantt-main").append((k=>{u=k;h.readOnly.value.includes("readOnly")&&u.addClass("kb-gantt-readonly");return u})(kb.create("table").addClass("kb-gantt"))));
e.popup||(e.popup=(k=>{var q={delete:null,edit:null,reuse:null};kb.elm("body").append(k.on("mousedown,touchstart",a=>{a.currentTarget.hide();a.stopPropagation();a.preventDefault()}).append(k.contents=kb.create("div").on("mousedown,touchstart",a=>{a.stopPropagation();a.preventDefault()}).append(kb.create("button").addClass("kb-icon kb-icon-edit").on("click",a=>{k.hide();q.edit&&q.edit()})).append(kb.create("button").addClass("kb-icon kb-icon-copy").on("click",a=>{k.hide();q.reuse&&q.reuse()})).append(kb.create("button").addClass("kb-icon kb-icon-del").on("click",
a=>{k.hide();q.delete&&q.delete()}))));h.readOnly.value.includes("readOnly")&&(k.contents.elm(".kb-icon-copy").attr("disabled","disabled"),k.contents.elm(".kb-icon-del").attr("disabled","disabled"));k.show=(a,r,n)=>{q.edit=a;q.reuse=r;q.delete=n;k.css({display:"block"})};return k})(kb.create("div").addClass("kb-gantt-popup")));y(d.session,()=>A());(k=>{kb.elm(".kb_groupgantt_style_"+CSS.escape(k))||localStorage.getItem(k)&&kb.elm("head").append(kb.create("style").addClass("kb_groupgantt_style_"+k).attr("type",
"text/css").text(localStorage.getItem(k)))})("kb-gantt-style-"+h.view.value);kb.event.on("kb.groupgantt.task.submit",k=>{var q={id:k.task.recordId,record:{}};"queuedTask"in e&&e.queuedTask.id==k.task.id&&(d.tableCode?(q.record[d.tableCode]={value:[]},e.records[k.task.recordId][d.tableCode].value.each((a,r)=>{(n=>{e.queuedTask.fields.each((g,t)=>{!d.time.start&&g==h.taskStart.value&&n.value[g].value&&(n.value[g].value=(new Date(n.value[g].value)).format("Y-m-d"));!d.time.end&&g==h.taskEnd.value&&n.value[g].value&&
(n.value[g].value=(new Date(n.value[g].value)).calc("-1 day").format("Y-m-d"))});q.record[d.tableCode].value.push(n)})(kb.extend({},a))})):e.queuedTask.fields.each((a,r)=>{q.record[a]={value:k.task.source[a].value};!d.time.start&&a==h.taskStart.value&&q.record[a].value&&(q.record[a].value=(new Date(q.record[a].value)).format("Y-m-d"));!d.time.end&&a==h.taskEnd.value&&q.record[a].value&&(q.record[a].value=(new Date(q.record[a].value)).calc("-1 day").format("Y-m-d"))}),kb.view.records.set(e.app.id,
{put:[q]},!0).then(a=>{}).catch(a=>kb.alert(kb.error.parse(a))),delete e.queuedTask)});(k=>{k.onmessage=q=>{"record"in q.data&&(a=>{(r=>{if(r in e.records)for(var n in e.tasks)e.tasks[n].recordId==r&&e.tasks[n].leave();B(a,()=>{u.elms(".kb-gantt-row").each((g,t)=>{Promise.resolve().then(()=>g.grouping())})})})(a.$id.value)})(q.data.record)}})(new BroadcastChannel("kb-gantt-channel"))})((d=>(u=>({editable:{start:u.start.isEditable,end:u.end.isEditable},scale:((A,E)=>({amount:A,interval:A*{min:6E4,
hour:36E5,day:864E5}[E],unit:E}))(parseInt(h.columnScale.value.replace(/\D/g,""),10),h.columnScale.value.replace(/\d/g,"")),session:(A=>{if(A)A=JSON.parse(A);else switch(h.columnScale.value){case "12hour":A={start:(new Date).format("Y-m-d"),end:(new Date).calc("1 month,-1 day").format("Y-m-d")};break;case "6hour":A={start:(new Date).format("Y-m-d"),end:(new Date).calc("6 day").format("Y-m-d")};break;case "4hour":A={start:(new Date).format("Y-m-d"),end:(new Date).calc("6 day").format("Y-m-d")};break;
case "3hour":A={start:(new Date).format("Y-m-d"),end:(new Date).calc("6 day").format("Y-m-d")};break;case "1hour":A={start:(new Date).format("Y-m-d"),end:(new Date).calc("1 day").format("Y-m-d")};break;case "30min":A={start:(new Date).format("Y-m-d"),end:(new Date).format("Y-m-d")};break;case "20min":A={start:(new Date).format("Y-m-d"),end:(new Date).format("Y-m-d")};break;case "15min":A={start:(new Date).format("Y-m-d"),end:(new Date).format("Y-m-d")};break;default:A={start:(new Date).format("Y-m-d"),
end:(new Date).calc("1 month,-1 day").format("Y-m-d")}}return A})(sessionStorage.getItem("kb-gantt-cache-"+h.view.value)),tableCode:e.fieldInfos.parallelize[h.taskTitle.value].tableCode,time:{start:u.start.isDateTime,end:u.end.isDateTime},timeStamp:{start:u.start.isTimeStamp,end:u.end.isTimeStamp}}))({start:d(e.fieldInfos.parallelize[h.taskStart.value]),end:d(e.fieldInfos.parallelize[h.taskEnd.value])}))(d=>{switch(d.type){case "CALC":switch(d.format){case "DATE":d.isDateTime=!1;d.isEditable=!1;break;
case "DATETIME":d.isDateTime=!0,d.isEditable=!1}d.isTimeStamp=!0;break;case "CREATED_TIME":case "UPDATED_TIME":d.isDateTime=!0;d.isEditable=!1;d.isTimeStamp=!1;break;case "DATE":d.isDateTime=!1;d.isEditable=!0;d.isTimeStamp=!1;break;case "DATETIME":d.isDateTime=!0;d.isEditable=!0;d.isTimeStamp=!1;break;default:d.isDateTime=!1,d.isEditable=!0,d.isTimeStamp=!1}return d}))};kintone.events.on(["app.record.index.show","mobile.app.record.index.show"],z=>new Promise((h,d)=>{((u,A)=>{e.mobile=u;e.type=A;
kb.config[I].config.get().then(E=>{0!=Object.keys(E).length?kb.field.load(kb.config[I].app,!0).then(C=>{e.app={id:kb.config[I].app,fields:C.origin};e.fieldInfos=C;e.records={};e.tasks={};try{(y=>{if(y){y.taskTitle.value&&(y.taskTitle.value in e.fieldInfos.parallelize||h(z));y.taskStart.value&&(y.taskStart.value in e.fieldInfos.parallelize||h(z));y.taskEnd.value&&(y.taskEnd.value in e.fieldInfos.parallelize||h(z));var B=kb.elm("#kb-gantt");B&&K(B,y)}h(z)})(JSON.parse(E.tab).map((y,B)=>kb.extend({sIndex:{value:B.toString()}},
y.setting)).reduce((y,B)=>{B.view.value==z.viewId.toString()&&(y=B);return y},null))}catch(y){kb.alert(kb.error.parse(y)),h(z)}}).catch(C=>h(z)):h(z)}).catch(E=>h(z))})("mobile"==z.type.split(".").first(),z.type.split(".").slice(-2).first())}));kintone.events.on(["app.record.create.show","mobile.app.record.create.show"],z=>new Promise((h,d)=>{((u,A)=>{A?(E=>{((C,y)=>{kb.event.call("kb.action.call",{container:kb.elm("body"),record:z.record,mobile:u,pattern:"change",fields:C,stopPropagation:!0,workplace:"record"}).then(B=>
{kb.event.call("kb.style.call",{container:B.container,record:B.record,mobile:B.mobile,pattern:"$id"in B.record?B.record.$id.value?"edit":"create":"create",workplace:B.workplace}).then(k=>{kb.event.call("kb.cascade.call",k).then(q=>y()).catch(()=>y())}).catch(()=>y())}).catch(()=>y())})(E.fields.reduce((C,y)=>{y.tableCode?(C.includes(y.tableCode)||C.push(y.tableCode),z.record[y.tableCode].value.first().value[y.code].value=y.value):z.record[y.code].value=y.value;return C},E.fields.map(C=>C.code)),()=>
{localStorage.removeItem("kb-gantt-create");h(z)})})(JSON.parse(A)):h(z)})("mobile"==z.type.split(".").first(),localStorage.getItem("kb-gantt-create"))}));kintone.events.on(["app.record.edit.show","mobile.app.record.edit.show"],z=>new Promise((h,d)=>{((u,A)=>{A?(E=>{((C,y,B)=>{kb.event.call("kb.action.call",{container:kb.elm("body"),record:y,mobile:u,pattern:"change",fields:C,stopPropagation:!0,workplace:"record"}).then(k=>{kb.event.call("kb.style.call",{container:k.container,record:k.record,mobile:k.mobile,
pattern:"$id"in k.record?k.record.$id.value?"edit":"create":"create",workplace:k.workplace}).then(q=>{kb.event.call("kb.cascade.call",q).then(a=>B()).catch(()=>B())}).catch(()=>B())}).catch(()=>B())})([E.tableCode],(C=>{delete E.row.value.$rowId;C[E.tableCode].value.push(E.row);return C})(z.record),()=>{localStorage.removeItem("kb-gantt-reuse");h(z)})})(JSON.parse(A)):h(z)})("mobile"==z.type.split(".").first(),localStorage.getItem("kb-gantt-reuse"))}));kintone.events.on(["app.record.create.submit.success",
"app.record.edit.submit.success","mobile.app.record.create.submit.success","mobile.app.record.edit.submit.success"],z=>new Promise((h,d)=>{(new BroadcastChannel("kb-gantt-channel")).postMessage({record:z.record});h(z)}))})(kintone.$PLUGIN_ID);
kb.constants=kb.extend({groupgantt:{message:{confirm:{create:{en:"Start Date: %start%<br>End Date: %end%<br>Would you like to add a record with the above details?",ja:"\u958b\u59cb\u65e5\u4ed8: %start%<br>\u7d42\u4e86\u65e5\u4ed8: %end%<br>\u4e0a\u8a18\u5185\u5bb9\u3067\u30ec\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u304b\uff1f",zh:"\u5f00\u59cb\u65e5\u671f: %start%<br>\u7ed3\u675f\u65e5\u671f: %end%<br>\u60a8\u60f3\u6839\u636e\u4e0a\u8ff0\u5185\u5bb9\u6dfb\u52a0\u8bb0\u5f55\u5417\uff1f",
"zh-TW":"\u958b\u59cb\u65e5\u671f: %start%<br>\u7d50\u675f\u65e5\u671f: %end%<br>\u60a8\u60f3\u6839\u64da\u4e0a\u8ff0\u5167\u5bb9\u65b0\u589e\u8a18\u9304\u55ce\uff1f"},edit:{en:"Do you want to open the record?",ja:"\u30ec\u30b3\u30fc\u30c9\u3092\u958b\u304d\u307e\u3059\u304b\uff1f",zh:"\u60a8\u8981\u6253\u5f00\u8bb0\u5f55\u5417\uff1f","zh-TW":"\u60a8\u8981\u6253\u958b\u8a18\u9304\u55ce\uff1f"}},invalid:{record:{en:"There are records where the end date is earlier than the start date.<br>%recordId%",
ja:"\u7d42\u4e86\u65e5\u304c\u958b\u59cb\u65e5\u3088\u308a\u3082\u65e9\u3044\u30ec\u30b3\u30fc\u30c9\u304c\u3042\u308a\u307e\u3059\u3002<br>%recordId%",zh:"\u5b58\u5728\u7ed3\u675f\u65e5\u671f\u65e9\u4e8e\u5f00\u59cb\u65e5\u671f\u7684\u8bb0\u5f55\u3002<br>%recordId%","zh-TW":"\u5b58\u5728\u7d50\u675f\u65e5\u671f\u65e9\u65bc\u958b\u59cb\u65e5\u671f\u7684\u8a18\u9304\u3002<br>%recordId%"},search:{en:"Please select an end date that is later than the start date.",ja:"\u7d42\u4e86\u65e5\u4ed8\u306f\u958b\u59cb\u65e5\u4ed8\u3088\u308a\u3082\u5f8c\u306e\u65e5\u4ed8\u3092\u9078\u629e\u3057\u3066\u304f\u3060\u3055\u3044\u3002",
zh:"\u8bf7\u9009\u62e9\u665a\u4e8e\u5f00\u59cb\u65e5\u671f\u7684\u7ed3\u675f\u65e5\u671f\u3002","zh-TW":"\u8acb\u9078\u64c7\u665a\u65bc\u958b\u59cb\u65e5\u671f\u7684\u7d50\u675f\u65e5\u671f\u3002"}}}}},kb.constants);
