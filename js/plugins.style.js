/*
* FileName "plugins.style.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(x=>{var b={handlers:{}},y=(d,h,w,r="record",v="detail")=>{var p=(()=>{var m={},q=0;if("record"==r)for(var n in h)n in b.fieldInfos.tables&&h[n].value.each((f,e)=>{null==f.id&&(q++,f.id=q);m[f.id]=e},{});return m})();return new Promise((m,q)=>{var n={},f=(e,l)=>{(u=>{var k=kb.filter.scan(b.app,h,u.condition.value);k?kb.filter.auth(u.user.value,u.organization.value,u.group.value).then(z=>{z&&(u.color.value.map(c=>c.value).each((c,A)=>{c.field.value in b.fieldInfos.parallelize&&(a=>{switch(r){case "record":a.tableCode?
a.tableCode in k&&(g=>{if(b.mobile)g();else if(kb.elms(".subtable-"+b.fieldInfos.tables[a.tableCode].id+" tbody tr").length!=h[a.tableCode].value.length){let t=new MutationObserver(()=>{kb.elms(".subtable-"+b.fieldInfos.tables[a.tableCode].id+" tbody tr").length==h[a.tableCode].value.length&&(g(),t.disconnect())});t.observe(kb.elm(".subtable-"+b.fieldInfos.tables[a.tableCode].id),{childList:!0,subtree:!0})}else g()})(()=>{k[a.tableCode].value.each((g,t)=>{a.code in g.value&&(t=kb.field.get(a,b.mobile,
b.type||v))&&(t[p[g.id]].value.css({backgroundColor:c.backcolor.value,color:c.forecolor.value}),c.backcolor.value?t[p[g.id]].value.addClass("kb-inherit-backcolor"):t[p[g.id]].value.removeClass("kb-inherit-backcolor"),c.forecolor.value?t[p[g.id]].value.addClass("kb-inherit-forecolor"):t[p[g.id]].value.removeClass("kb-inherit-forecolor"))})}):a.code in k&&(g=>{g&&(g.value.css({backgroundColor:c.backcolor.value,color:c.forecolor.value}),c.backcolor.value?g.value.addClass("kb-inherit-backcolor"):g.value.removeClass("kb-inherit-backcolor"),
c.forecolor.value?g.value.addClass("kb-inherit-forecolor"):g.value.removeClass("kb-inherit-forecolor"))})(kb.field.get(a,b.mobile,b.type||v));break;case "view":a.tableCode?a.tableCode in k&&k[a.tableCode].value.each((g,t)=>{a.code in g.value&&(g.value[a.code].backcolor=c.backcolor.value,g.value[a.code].forecolor=c.forecolor.value)}):a.code in k&&(k[a.code].backcolor=c.backcolor.value,k[a.code].forecolor=c.forecolor.value)}})(b.fieldInfos.parallelize[c.field.value])}),u.display.value.map(c=>c.value).each((c,
A)=>{switch(r){case "record":(b.mobile?kintone.mobile.app.record:kintone.app.record).setFieldShown(c.field.value,"show"==c.state.value);break;case "view":c.field.value in b.fieldInfos.groups?b.fieldInfos.groups[c.field.value].fields.map(a=>a.code).each((a,g)=>{a in b.fieldInfos.parallelize&&a in k&&(k[a].hidden="hide"==c.state.value)}):c.field.value in b.fieldInfos.tables?c.field.value in k&&(k[c.field.value].hidden="hide"==c.state.value):(a=>{a.tableCode?a.tableCode in k&&k[a.tableCode].value.each((g,
t)=>{a.code in g.value&&(g.value[a.code].hidden="hide"==c.state.value)}):a.code in k&&(k[a.code].hidden="hide"==c.state.value)})(b.fieldInfos.parallelize[c.field.value])}}),u.toggle.value.map(c=>c.value).each((c,A)=>{switch(r){case "record":(b.mobile?kintone.mobile.app.record:kintone.app.record).setGroupFieldOpen(c.field.value,"open"==c.state.value)}}),(["create","edit"].includes(b.type||v)||"view"==r)&&u.editable.value.map(c=>c.value).each((c,A)=>{c.field.value in b.fieldInfos.parallelize&&(a=>{b.fieldInfos.disables.includes(a.code)||
(a.tableCode?a.tableCode in k&&(k[a.tableCode].value.each((g,t)=>{a.code in g.value&&(g.value[a.code].disabled="disable"==c.state.value)}),n[a.code]=h[a.tableCode].value.map(g=>g.value[a.code].disabled?"disabled":"")):a.code in k&&(k[a.code].disabled="disable"==c.state.value,n[a.code]=h[a.code].disabled?"disabled":""))})(b.fieldInfos.parallelize[c.field.value])}));e++;e<d.length?f(e,l):l()}).catch(z=>{kb.alert(kb.error.parse(z));q()}):(e++,e<d.length?f(e,l):l())})(d[e])};"record"==r&&(kb.elms(".kb-inherit-backcolor").each((e,
l)=>{e.css({backgroundColor:""});e.removeClass("kb-inherit-backcolor")}),kb.elms(".kb-inherit-forecolor").each((e,l)=>{e.css({color:""});e.removeClass("kb-inherit-forecolor")}));f(0,()=>{w.latest?w.latest.style||(w.latest.style="{}"):w.latest={style:"{}"};var e=JSON.stringify(n),l="{}"!=e?w.latest.style!=e:!1;l&&(w.latest.style=e);m({performed:l})})})};kintone.events.on("app.record.create.show app.record.detail.show app.record.edit.show app.record.print.show mobile.app.record.create.show mobile.app.record.detail.show mobile.app.record.edit.show".split(" "),
d=>new Promise((h,w)=>{((r,v)=>{b.mobile=r;b.type=v;for(var p in b.handlers)b.handlers[p].each((m,q)=>{kintone.events.off(p,m)});kb.config[x].config.get().then(m=>{0!=Object.keys(m).length?(d.reuse&&(q=>{"reusecolor"in q&&q.reusecolor.value&&kintone.app.record.getHeaderMenuSpaceElement().nextSibling.firstElementChild.css({backgroundColor:q.reusecolor.value})})(JSON.parse(m.flat)),kb.field.load(kb.config[x].app,!0).then(q=>{b.app={id:kb.config[x].app,fields:q.origin};b.fieldInfos=q;try{(n=>{0!=n.length?
["create","edit"].includes(b.type)?(((f,e)=>{kintone.events.on(f,e);f.each((l,u)=>{l in b.handlers||(b.handlers[l]=[]);b.handlers[l].push(e)})})(q.changes.reduce((f,e)=>{f.push("app.record.create.change."+e);f.push("app.record.edit.change."+e);f.push("mobile.app.record.create.change."+e);f.push("mobile.app.record.edit.change."+e);return f},[]),f=>{if((()=>{var e=!0;["DATETIME","TIME"].includes(f.changes.field.type)&&(l=>{l&&(Array.isArray(l)?l:[l]).each((u,k)=>{u.elm(".control-errors-content-gaia")&&
(e=!1)})})(kb.field.get(b.fieldInfos.parallelize[f.type.split(".").last()],b.mobile,b.type));return e})())return kb.event.call("kb.action.installed.change",{installed:!1,mobile:b.mobile}).then(e=>{e.installed||y(n,f.record,kb.elm("body"),"record").then(l=>{l.performed&&(b.mobile?kintone.mobile.app.record:kintone.app.record).set(f)}).catch(()=>{})}),f}),kb.event.call("kb.action.installed.show",{installed:!1,mobile:b.mobile}).then(f=>{f.installed?h(d):y(n,d.record,kb.elm("body"),"record").then(e=>h(d)).catch(()=>
{})})):y(n,d.record,kb.elm("body"),"record").then(f=>h(d)).catch(()=>{}):h(d)})(JSON.parse(m.tab).map((n,f)=>kb.extend({sIndex:{value:f.toString()}},n.setting)).reduce((n,f)=>{(b.mobile?["all","both","mobile"]:["all","both","pc"]).includes(f.device.value)&&f.page.value.includes(b.type)&&n.push(f);return n},[]))}catch(n){kb.alert(kb.error.parse(n)),h(d)}}).catch(q=>h(d))):h(d)}).catch(m=>h(d))})("mobile"==d.type.split(".").first(),d.type.split(".").slice(-2).first())}));kb.event.on("kb.style.call",
d=>new Promise((h,w)=>{kb.config[x].config.get().then(r=>{0!=Object.keys(r).length?kb.field.load(kb.config[x].app,!0).then(v=>{b.app={id:kb.config[x].app,fields:v.origin};b.fieldInfos=v;b.mobile="mobile"in b?b.mobile:d.mobile;try{(p=>{0!=p.length?y(p,d.record,d.container,d.workplace?d.workplace:"record",d.pattern).then(m=>{d.performed=m.performed;h(d)}).catch(()=>h(d)):h(d)})(JSON.parse(r.tab).map((p,m)=>kb.extend({sIndex:{value:m.toString()}},p.setting)).reduce((p,m)=>{(d.mobile?["all","both","mobile"]:
["all","both","pc"]).includes(m.device.value)&&m.page.value.includes(d.pattern)&&p.push(m);return p},[]))}catch(p){kb.alert(kb.error.parse(p)),h(d)}}).catch(v=>h(d)):h(d)}).catch(r=>h(d))}))})(kintone.$PLUGIN_ID);
