/*
* FileName "plugins.style.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(z=>{var c={handlers:{}},B=(e,l,x,t="record",v="detail")=>{var m=(()=>{var p={},u=0;if("record"==t)for(var r in l)r in c.fieldInfos.tables&&l[r].value.each((g,f)=>{null==g.id&&(u++,g.id=u);p[g.id]=f},{});return p})();return new Promise((p,u)=>{var r={},g=(f,n)=>{var y={color:(h,k,w)=>{if(h.nextSibling&&h.nextSibling.tagName.toLowerCase().startsWith("kuc"))switch(k){case "DROP_DOWN":if(h.nextSibling.elm("button"))h.nextSibling.elm("button").css(w);else{let b=new MutationObserver(()=>{h.nextSibling.elm("button").css(w);
b.disconnect()});b.observe(h.nextSibling,{childList:!0,subtree:!0})}break;case "FILE":h.nextSibling.firstElementChild&&(h.nextSibling.firstElementChild.css(w),h.nextSibling.firstElementChild.elms("*").filter(b=>b instanceof HTMLElement).each((b,A)=>b.css(w))),(new MutationObserver(()=>{h.nextSibling.firstElementChild.css(w);h.nextSibling.firstElementChild.elms("*").filter(b=>b instanceof HTMLElement).each((b,A)=>b.css(w))})).observe(h.nextSibling,{childList:!0,subtree:!0})}},display:(h,k)=>{h.nextSibling&&
h.nextSibling.tagName.toLowerCase().startsWith("kuc")&&(h.nextSibling.visible=k)},editable:(h,k)=>{h.nextSibling&&h.nextSibling.tagName.toLowerCase().startsWith("kuc")&&(h.nextSibling.disabled=k)}};(h=>{var k=kb.filter.scan(c.app,l,h.condition.value);k?kb.filter.auth(h.user.value,h.organization.value,h.group.value).then(w=>{w&&(h.color.value.map(b=>b.value).each((b,A)=>{b.field.value in c.fieldInfos.parallelize&&(a=>{switch(t){case "record":a.tableCode?a.tableCode in k&&(d=>{if(c.mobile)d();else if(kb.elms(".subtable-"+
c.fieldInfos.tables[a.tableCode].id+" tbody tr").length!=l[a.tableCode].value.length){let q=new MutationObserver(()=>{kb.elms(".subtable-"+c.fieldInfos.tables[a.tableCode].id+" tbody tr").length==l[a.tableCode].value.length&&(d(),q.disconnect())});q.observe(kb.elm(".subtable-"+c.fieldInfos.tables[a.tableCode].id),{childList:!0,subtree:!0})}else d()})(()=>{k[a.tableCode].value.each((d,q)=>{a.code in d.value&&(q=kb.field.get(a,c.mobile,c.type||v))&&(q[m[d.id]].value.css({backgroundColor:b.backcolor.value,
color:b.forecolor.value}),y.color(q[m[d.id]],a.type,{backgroundColor:b.backcolor.value,color:b.forecolor.value}),b.backcolor.value?q[m[d.id]].value.addClass("kb-inherit-backcolor"):q[m[d.id]].value.removeClass("kb-inherit-backcolor"),b.forecolor.value?q[m[d.id]].value.addClass("kb-inherit-forecolor"):q[m[d.id]].value.removeClass("kb-inherit-forecolor"))})}):a.code in k&&(d=>{d&&(d.value.css({backgroundColor:b.backcolor.value,color:b.forecolor.value}),y.color(d,{backgroundColor:b.backcolor.value,color:b.forecolor.value}),
b.backcolor.value?d.value.addClass("kb-inherit-backcolor"):d.value.removeClass("kb-inherit-backcolor"),b.forecolor.value?d.value.addClass("kb-inherit-forecolor"):d.value.removeClass("kb-inherit-forecolor"))})(kb.field.get(a,c.mobile,c.type||v));break;case "view":a.tableCode?a.tableCode in k&&k[a.tableCode].value.each((d,q)=>{a.code in d.value&&(d.value[a.code].backcolor=b.backcolor.value,d.value[a.code].forecolor=b.forecolor.value)}):a.code in k&&(k[a.code].backcolor=b.backcolor.value,k[a.code].forecolor=
b.forecolor.value)}})(c.fieldInfos.parallelize[b.field.value])}),h.display.value.map(b=>b.value).each((b,A)=>{switch(t){case "record":((a,d)=>{a&&!a.tableCode&&(a=kb.field.get(a,c.mobile,c.type||v))&&a.nextSibling&&a.nextSibling.tagName.toLowerCase().startsWith("kuc")&&(y.display(a,"show"==b.state.value),d=!0);d||(c.mobile?kintone.mobile.app.record:kintone.app.record).setFieldShown(b.field.value,"show"==b.state.value)})(c.fieldInfos.parallelize[b.field.value],!1);break;case "view":b.field.value in
c.fieldInfos.groups?c.fieldInfos.groups[b.field.value].fields.map(a=>a.code).each((a,d)=>{a in c.fieldInfos.parallelize&&a in k&&(k[a].hidden="hide"==b.state.value)}):b.field.value in c.fieldInfos.tables?b.field.value in k&&(k[b.field.value].hidden="hide"==b.state.value):(a=>{a.tableCode?a.tableCode in k&&k[a.tableCode].value.each((d,q)=>{a.code in d.value&&(d.value[a.code].hidden="hide"==b.state.value)}):a.code in k&&(k[a.code].hidden="hide"==b.state.value)})(c.fieldInfos.parallelize[b.field.value])}}),
h.toggle.value.map(b=>b.value).each((b,A)=>{switch(t){case "record":(c.mobile?kintone.mobile.app.record:kintone.app.record).setGroupFieldOpen(b.field.value,"open"==b.state.value)}}),(["create","edit"].includes(c.type||v)||"view"==t)&&h.editable.value.map(b=>b.value).each((b,A)=>{b.field.value in c.fieldInfos.parallelize&&(a=>{c.fieldInfos.disables.includes(a.code)||(a.tableCode?a.tableCode in k&&(k[a.tableCode].value.each((d,q)=>{a.code in d.value&&(d.value[a.code].disabled="disable"==b.state.value)}),
r[a.code]=l[a.tableCode].value.map(d=>d.value[a.code].disabled?"disabled":""),"record"==t&&(d=>{if(c.mobile)d();else if(kb.elms(".subtable-"+c.fieldInfos.tables[a.tableCode].id+" tbody tr").length!=l[a.tableCode].value.length){let q=new MutationObserver(()=>{kb.elms(".subtable-"+c.fieldInfos.tables[a.tableCode].id+" tbody tr").length==l[a.tableCode].value.length&&(d(),q.disconnect())});q.observe(kb.elm(".subtable-"+c.fieldInfos.tables[a.tableCode].id),{childList:!0,subtree:!0})}else d()})(()=>{k[a.tableCode].value.each((d,
q)=>{a.code in d.value&&(q=kb.field.get(a,c.mobile,c.type||v))&&y.editable(q[m[d.id]],"disable"==b.state.value)})})):a.code in k&&(k[a.code].disabled="disable"==b.state.value,"record"==t&&(d=>{d&&y.editable(d,"disable"==b.state.value)})(kb.field.get(a,c.mobile,c.type||v)),r[a.code]=l[a.code].disabled?"disabled":""))})(c.fieldInfos.parallelize[b.field.value])}));f++;f<e.length?g(f,n):n()}).catch(w=>{kb.alert(kb.error.parse(w));u()}):(f++,f<e.length?g(f,n):n())})(e[f])};"record"==t&&(kb.elms(".kb-inherit-backcolor").each((f,
n)=>{f.css({backgroundColor:""});f.removeClass("kb-inherit-backcolor")}),kb.elms(".kb-inherit-forecolor").each((f,n)=>{f.css({color:""});f.removeClass("kb-inherit-forecolor")}));g(0,()=>{x.latest?x.latest.style||(x.latest.style="{}"):x.latest={style:"{}"};var f=JSON.stringify(r),n="{}"!=f?x.latest.style!=f:!1;n&&(x.latest.style=f);p({performed:n})})})};kintone.events.on("app.record.create.show app.record.detail.show app.record.edit.show app.record.print.show mobile.app.record.create.show mobile.app.record.detail.show mobile.app.record.edit.show".split(" "),
e=>new Promise((l,x)=>{((t,v)=>{c.mobile=t;c.type=v;for(var m in c.handlers)c.handlers[m].each((p,u)=>{kintone.events.off(m,p)});kb.config[z].config.get().then(p=>{0!=Object.keys(p).length?(e.reuse&&(u=>{"reusecolor"in u&&u.reusecolor.value&&kintone.app.record.getHeaderMenuSpaceElement().nextSibling.firstElementChild.css({backgroundColor:u.reusecolor.value})})(JSON.parse(p.flat)),kb.field.load(kb.config[z].app,!0).then(u=>{c.app={id:kb.config[z].app,fields:u.origin};c.fieldInfos=u;try{(r=>{0!=r.length?
["create","edit"].includes(c.type)?(((g,f)=>{kintone.events.on(g,f);g.each((n,y)=>{n in c.handlers||(c.handlers[n]=[]);c.handlers[n].push(f)})})(u.changes.reduce((g,f)=>{g.push("app.record.create.change."+f);g.push("app.record.edit.change."+f);g.push("mobile.app.record.create.change."+f);g.push("mobile.app.record.edit.change."+f);return g},[]),g=>{if((()=>{var f=!0;["DATETIME","TIME"].includes(g.changes.field.type)&&(n=>{n&&(Array.isArray(n)?n:[n]).each((y,h)=>{y.elm(".control-errors-content-gaia")&&
(f=!1)})})(kb.field.get(c.fieldInfos.parallelize[g.type.split(".").last()],c.mobile,c.type));return f})())return kb.event.call("kb.action.installed.change",{installed:!1,mobile:c.mobile}).then(f=>{f.installed||B(r,g.record,kb.elm("body"),"record").then(n=>{n.performed&&(c.mobile?kintone.mobile.app.record:kintone.app.record).set(g)}).catch(()=>{})}),g}),kb.event.call("kb.action.installed.show",{installed:!1,mobile:c.mobile}).then(g=>{g.installed?l(e):B(r,e.record,kb.elm("body"),"record").then(f=>l(e)).catch(()=>
{})})):B(r,e.record,kb.elm("body"),"record").then(g=>l(e)).catch(()=>{}):l(e)})(JSON.parse(p.tab).map((r,g)=>kb.extend({sIndex:{value:g.toString()}},r.setting)).reduce((r,g)=>{(c.mobile?["all","both","mobile"]:["all","both","pc"]).includes(g.device.value)&&g.page.value.includes(c.type)&&r.push(g);return r},[]))}catch(r){kb.alert(kb.error.parse(r)),l(e)}}).catch(u=>l(e))):l(e)}).catch(p=>l(e))})("mobile"==e.type.split(".").first(),e.type.split(".").slice(-2).first())}));kb.event.on("kb.style.call",
e=>new Promise((l,x)=>{kb.config[z].config.get().then(t=>{0!=Object.keys(t).length?kb.field.load(kb.config[z].app,!0).then(v=>{c.app={id:kb.config[z].app,fields:v.origin};c.fieldInfos=v;c.mobile="mobile"in c?c.mobile:e.mobile;try{(m=>{0!=m.length?B(m,e.record,e.container,e.workplace?e.workplace:"record",e.pattern).then(p=>{e.performed=p.performed;l(e)}).catch(()=>l(e)):l(e)})(JSON.parse(t.tab).map((m,p)=>kb.extend({sIndex:{value:p.toString()}},m.setting)).reduce((m,p)=>{(e.mobile?["all","both","mobile"]:
["all","both","pc"]).includes(p.device.value)&&p.page.value.includes(e.pattern)&&m.push(p);return m},[]))}catch(m){kb.alert(kb.error.parse(m)),l(e)}}).catch(v=>l(e)):l(e)}).catch(t=>l(e))}))})(kintone.$PLUGIN_ID);
