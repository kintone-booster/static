/*
* FileName "plugins.style.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(x=>{var c={handlers:{}},A=(d,k,w,t="record",v="detail")=>{var m=(()=>{var h={},q=0;if("record"==t)for(var p in k)p in c.fieldInfos.tables&&k[p].value.each((f,g)=>{null==f.id&&(q++,f.id=q);h[f.id]=g},{});return h})();return new Promise((h,q)=>{var p={},f=(g,n)=>{(u=>{var l=kb.filter.scan(c.app,k,u.condition.value);l?kb.filter.auth(u.user.value,u.organization.value,u.group.value).then(y=>{y&&(u.color.value.map(b=>b.value).each((b,z)=>{b.field.value in c.fieldInfos.parallelize&&(a=>{switch(t){case "record":a.tableCode?
a.tableCode in l&&(e=>{if(c.mobile)e();else if(kb.elms(".subtable-"+c.fieldInfos.tables[a.tableCode].id+" tbody tr").length!=k[a.tableCode].value.length){let r=new MutationObserver(()=>{kb.elms(".subtable-"+c.fieldInfos.tables[a.tableCode].id+" tbody tr").length==k[a.tableCode].value.length&&(e(),r.disconnect())});r.observe(kb.elm(".subtable-"+c.fieldInfos.tables[a.tableCode].id),{childList:!0,subtree:!0})}else e()})(()=>{l[a.tableCode].value.each((e,r)=>{a.code in e.value&&(r=kb.field.get(a,c.mobile,
c.type||v))&&(r[m[e.id]].value.css({backgroundColor:b.backcolor.value,color:b.forecolor.value}),b.backcolor.value?r[m[e.id]].value.addClass("kb-inherit-backcolor"):r[m[e.id]].value.removeClass("kb-inherit-backcolor"),b.forecolor.value?r[m[e.id]].value.addClass("kb-inherit-forecolor"):r[m[e.id]].value.removeClass("kb-inherit-forecolor"))})}):a.code in l&&(e=>{e&&(e.value.css({backgroundColor:b.backcolor.value,color:b.forecolor.value}),b.backcolor.value?e.value.addClass("kb-inherit-backcolor"):e.value.removeClass("kb-inherit-backcolor"),
b.forecolor.value?e.value.addClass("kb-inherit-forecolor"):e.value.removeClass("kb-inherit-forecolor"))})(kb.field.get(a,c.mobile,c.type||v));break;case "view":a.tableCode?a.tableCode in l&&l[a.tableCode].value.each((e,r)=>{a.code in e.value&&(e.value[a.code].backcolor=b.backcolor.value,e.value[a.code].forecolor=b.forecolor.value)}):a.code in l&&(l[a.code].backcolor=b.backcolor.value,l[a.code].forecolor=b.forecolor.value)}})(c.fieldInfos.parallelize[b.field.value])}),u.display.value.map(b=>b.value).each((b,
z)=>{switch(t){case "record":(c.mobile?kintone.mobile.app.record:kintone.app.record).setFieldShown(b.field.value,"show"==b.state.value);break;case "view":b.field.value in c.fieldInfos.groups?c.fieldInfos.groups[b.field.value].fields.map(a=>a.code).each((a,e)=>{a in c.fieldInfos.parallelize&&a in l&&(l[a].hidden="hide"==b.state.value)}):b.field.value in c.fieldInfos.tables?b.field.value in l&&(l[b.field.value].hidden="hide"==b.state.value):(a=>{a.tableCode?a.tableCode in l&&l[a.tableCode].value.each((e,
r)=>{a.code in e.value&&(e.value[a.code].hidden="hide"==b.state.value)}):a.code in l&&(l[a.code].hidden="hide"==b.state.value)})(c.fieldInfos.parallelize[b.field.value])}}),u.toggle.value.map(b=>b.value).each((b,z)=>{switch(t){case "record":(c.mobile?kintone.mobile.app.record:kintone.app.record).setGroupFieldOpen(b.field.value,"open"==b.state.value)}}),(["create","edit"].includes(c.type||v)||"view"==t)&&u.editable.value.map(b=>b.value).each((b,z)=>{b.field.value in c.fieldInfos.parallelize&&(a=>{c.fieldInfos.disables.includes(a.code)||
(a.tableCode?a.tableCode in l&&(l[a.tableCode].value.each((e,r)=>{a.code in e.value&&(e.value[a.code].disabled="disable"==b.state.value)}),p[a.code]=k[a.tableCode].value.map(e=>e.value[a.code].disabled?"disabled":"")):a.code in l&&(l[a.code].disabled="disable"==b.state.value,p[a.code]=k[a.code].disabled?"disabled":""))})(c.fieldInfos.parallelize[b.field.value])}));g++;g<d.length?f(g,n):n()}).catch(y=>{kb.alert(kb.error.parse(y));q()}):(g++,g<d.length?f(g,n):n())})(d[g])};f(0,()=>{w.latest?w.latest.style||
(w.latest.style="{}"):w.latest={style:"{}"};var g=JSON.stringify(p),n="{}"!=g?w.latest.style!=g:!1;n&&(w.latest.style=g);h({performed:n})})})};kintone.events.on("app.record.create.show app.record.detail.show app.record.edit.show app.record.print.show mobile.app.record.create.show mobile.app.record.detail.show mobile.app.record.edit.show".split(" "),d=>new Promise((k,w)=>{((t,v)=>{c.mobile=t;c.type=v;for(var m in c.handlers)c.handlers[m].each((h,q)=>{kintone.events.off(m,h)});kb.elms(".kb-inherit-backcolor").each((h,
q)=>{h.css({backgroundColor:""});h.removeClass("kb-inherit-backcolor")});kb.elms(".kb-inherit-forecolor").each((h,q)=>{h.css({color:""});h.removeClass("kb-inherit-forecolor")});kb.config[x].config.get().then(h=>{0!=Object.keys(h).length?(d.reuse&&(q=>{"reusecolor"in q&&q.reusecolor.value&&kintone.app.record.getHeaderMenuSpaceElement().nextSibling.firstElementChild.css({backgroundColor:q.reusecolor.value})})(JSON.parse(h.flat)),kb.field.load(kb.config[x].app,!0).then(q=>{c.app={id:kb.config[x].app,
fields:q.origin};c.fieldInfos=q;try{(p=>{0!=p.length?(["create","edit"].includes(c.type)&&((f,g)=>{kintone.events.on(f,g);f.each((n,u)=>{n in c.handlers||(c.handlers[n]=[]);c.handlers[n].push(g)})})(q.changes.reduce((f,g)=>{f.push("app.record.create.change."+g);f.push("app.record.edit.change."+g);f.push("mobile.app.record.create.change."+g);f.push("mobile.app.record.edit.change."+g);return f},[]),f=>{(()=>{var g=!0;["DATETIME","TIME"].includes(f.changes.field.type)&&(n=>{n&&(Array.isArray(n)?n:[n]).each((u,
l)=>{u.elm(".control-errors-content-gaia")&&(g=!1)})})(kb.field.get(c.fieldInfos.parallelize[f.type.split(".").last()],c.mobile,c.type));return g})()&&kb.event.call("kb.action.installed",{installed:!1,mobile:c.mobile}).then(g=>{g.installed||A(p,f.record,kb.elm("body"),"record").then(n=>{n.performed&&(c.mobile?kintone.mobile.app.record:kintone.app.record).set(f)}).catch(()=>{})});return f}),A(p,d.record,kb.elm("body"),"record").then(f=>k(d)).catch(()=>{})):k(d)})(JSON.parse(h.tab).map((p,f)=>kb.extend({sIndex:{value:f.toString()}},
p.setting)).reduce((p,f)=>{(c.mobile?["all","both","mobile"]:["all","both","pc"]).includes(f.device.value)&&f.page.value.includes(c.type)&&p.push(f);return p},[]))}catch(p){kb.alert(kb.error.parse(p)),k(d)}}).catch(q=>k(d))):k(d)}).catch(h=>k(d))})("mobile"==d.type.split(".").first(),d.type.split(".").slice(-2).first())}));kb.event.on("kb.style.call",d=>new Promise((k,w)=>{kb.config[x].config.get().then(t=>{0!=Object.keys(t).length?kb.field.load(kb.config[x].app,!0).then(v=>{c.app={id:kb.config[x].app,
fields:v.origin};c.fieldInfos=v;try{(m=>{0!=m.length?A(m,d.record,d.container,d.workplace?d.workplace:"record",d.pattern).then(h=>{d.performed=h.performed;k(d)}).catch(()=>k(d)):k(d)})(JSON.parse(t.tab).map((m,h)=>kb.extend({sIndex:{value:h.toString()}},m.setting)).reduce((m,h)=>{(d.mobile?["all","both","mobile"]:["all","both","pc"]).includes(h.device.value)&&h.page.value.includes(d.pattern)&&m.push(h);return m},[]))}catch(m){kb.alert(kb.error.parse(m)),k(d)}}).catch(v=>k(d)):k(d)}).catch(t=>k(d))}))})(kintone.$PLUGIN_ID);
