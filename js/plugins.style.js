/*
* FileName "plugins.style.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(w=>{var c={},z=(e,h,v,r="record")=>{var t=(()=>{var m={},l=0;if("record"==r)for(var n in h)n in c.fieldInfos.tables&&h[n].value.each((f,g)=>{null==f.id&&(l++,f.id=l);m[f.id]=g},{});return m})();return new Promise((m,l)=>{var n={},f=(g,p)=>{(u=>{var k=kb.filter.scan(c.app,h,u.condition.value);k?kb.filter.auth(u.user.value,u.organization.value,u.group.value).then(x=>{x&&(u.color.value.map(b=>b.value).each((b,y)=>{b.field.value in c.fieldInfos.parallelize&&(a=>{switch(r){case "record":a.tableCode?
a.tableCode in k&&(d=>{if(c.mobile)d();else if(kb.elms(".subtable-"+c.fieldInfos.tables[a.tableCode].id+" tbody tr").length!=h[a.tableCode].value.length){let q=new MutationObserver(()=>{kb.elms(".subtable-"+c.fieldInfos.tables[a.tableCode].id+" tbody tr").length==h[a.tableCode].value.length&&(d(),q.disconnect())});q.observe(kb.elm(".subtable-"+c.fieldInfos.tables[a.tableCode].id),{childList:!0,subtree:!0})}else d()})(()=>{k[a.tableCode].value.each((d,q)=>{a.code in d.value&&(q=kb.field.get(a,c.mobile,
c.type))&&(q[t[d.id]].value.css({backgroundColor:b.backcolor.value,color:b.forecolor.value}),b.backcolor.value?q[t[d.id]].value.addClass("kb-inherit-backcolor"):q[t[d.id]].value.removeClass("kb-inherit-backcolor"),b.forecolor.value?q[t[d.id]].value.addClass("kb-inherit-forecolor"):q[t[d.id]].value.removeClass("kb-inherit-forecolor"))})}):a.code in k&&(d=>{d&&(d.value.css({backgroundColor:b.backcolor.value,color:b.forecolor.value}),b.backcolor.value?d.value.addClass("kb-inherit-backcolor"):d.value.removeClass("kb-inherit-backcolor"),
b.forecolor.value?d.value.addClass("kb-inherit-forecolor"):d.value.removeClass("kb-inherit-forecolor"))})(kb.field.get(a,c.mobile,c.type));break;case "view":a.tableCode?a.tableCode in k&&k[a.tableCode].value.each((d,q)=>{a.code in d.value&&(d.value[a.code].backcolor=b.backcolor.value,d.value[a.code].forecolor=b.forecolor.value)}):a.code in k&&(k[a.code].backcolor=b.backcolor.value,k[a.code].forecolor=b.forecolor.value)}})(c.fieldInfos.parallelize[b.field.value])}),u.display.value.map(b=>b.value).each((b,
y)=>{switch(r){case "record":(c.mobile?kintone.mobile.app.record:kintone.app.record).setFieldShown(b.field.value,"show"==b.state.value);break;case "view":b.field.value in c.fieldInfos.groups?c.fieldInfos.groups[b.field.value].fields.map(a=>a.code).each((a,d)=>{a in c.fieldInfos.parallelize&&a in k&&(k[a].hidden="hide"==b.state.value)}):b.field.value in c.fieldInfos.tables?b.field.value in k&&(k[b.field.value].hidden="hide"==b.state.value):(a=>{a.tableCode?a.tableCode in k&&k[a.tableCode].value.each((d,
q)=>{a.code in d.value&&(d.value[a.code].hidden="hide"==b.state.value)}):a.code in k&&(k[a.code].hidden="hide"==b.state.value)})(c.fieldInfos.parallelize[b.field.value])}}),u.toggle.value.map(b=>b.value).each((b,y)=>{switch(r){case "record":(c.mobile?kintone.mobile.app.record:kintone.app.record).setGroupFieldOpen(b.field.value,"open"==b.state.value)}}),(["create","edit"].includes(c.type)||"view"==r)&&u.editable.value.map(b=>b.value).each((b,y)=>{b.field.value in c.fieldInfos.parallelize&&(a=>{c.fieldInfos.disables.includes(a.code)||
(a.tableCode?a.tableCode in k&&(k[a.tableCode].value.each((d,q)=>{a.code in d.value&&(d.value[a.code].disabled="disable"==b.state.value)}),n[a.code]=h[a.tableCode].value.map(d=>d.value[a.code].disabled?"disabled":"")):a.code in k&&(k[a.code].disabled="disable"==b.state.value,n[a.code]=h[a.code].disabled?"disabled":""))})(c.fieldInfos.parallelize[b.field.value])}));g++;g<e.length?f(g,p):p()}).catch(x=>{kb.alert(kb.error.parse(x));l()}):(g++,g<e.length?f(g,p):p())})(e[g])};f(0,()=>{v.latest?v.latest.style||
(v.latest.style="{}"):v.latest={style:"{}"};var g=JSON.stringify(n),p="{}"!=g?v.latest.style!=g:!1;p&&(v.latest.style=g);m({performed:p})})})};kintone.events.on("app.record.create.show app.record.detail.show app.record.edit.show app.record.print.show mobile.app.record.create.show mobile.app.record.detail.show mobile.app.record.edit.show".split(" "),e=>new Promise((h,v)=>{((r,t)=>{c.mobile=r;c.type=t;kb.config[w].config.get().then(m=>{0!=Object.keys(m).length?(e.reuse&&(l=>{"reusecolor"in l&&l.reusecolor.value&&
kintone.app.record.getHeaderMenuSpaceElement().nextSibling.firstElementChild.css({backgroundColor:l.reusecolor.value})})(JSON.parse(m.flat)),kb.field.load(kb.config[w].app,!0).then(l=>{c.app={id:kb.config[w].app,fields:l.origin};c.fieldInfos=l;try{(n=>{if(0!=n.length){if(["create","edit"].includes(c.type))kintone.events.on(l.changes.reduce((f,g)=>{f.push("app.record.create.change."+g);f.push("app.record.edit.change."+g);f.push("mobile.app.record.create.change."+g);f.push("mobile.app.record.edit.change."+
g);return f},[]),f=>{if((()=>{var g=!0;["DATETIME","TIME"].includes(f.changes.field.type)&&(p=>{p&&(Array.isArray(p)?p:[p]).each((u,k)=>{u.elm(".control-errors-content-gaia")&&(g=!1)})})(kb.field.get(c.fieldInfos.parallelize[f.type.split(".").last()],c.mobile,c.type));return g})())return kb.event.call("kb.action.installed",{installed:!1,mobile:c.mobile}).then(g=>{g.installed||z(n,f.record,kb.elm("body"),"record").then(p=>{p.performed&&(c.mobile?kintone.mobile.app.record:kintone.app.record).set(f)}).catch(()=>
{})}),f});z(n,e.record,kb.elm("body"),"record").then(f=>h(e)).catch(()=>{})}else h(e)})(JSON.parse(m.tab).map((n,f)=>kb.extend({sIndex:{value:f.toString()}},n.setting)).reduce((n,f)=>{(c.mobile?["all","both","mobile"]:["all","both","pc"]).includes(f.device.value)&&f.page.value.includes(c.type)&&n.push(f);return n},[]))}catch(n){kb.alert(kb.error.parse(n)),h(e)}}).catch(l=>h(e))):h(e)}).catch(m=>h(e))})("mobile"==e.type.split(".").first(),e.type.split(".").slice(-2).first())}));kb.event.on("kb.style.call",
e=>new Promise((h,v)=>{kb.config[w].config.get().then(r=>{0!=Object.keys(r).length?kb.field.load(kb.config[w].app,!0).then(t=>{c.app={id:kb.config[w].app,fields:t.origin};c.fieldInfos=t;try{(m=>{0!=m.length?z(m,e.record,e.container,e.workplace?e.workplace:"record").then(l=>{e.performed=l.performed;h(e)}).catch(()=>h(e)):h(e)})(JSON.parse(r.tab).map((m,l)=>kb.extend({sIndex:{value:l.toString()}},m.setting)).reduce((m,l)=>{(e.mobile?["all","both","mobile"]:["all","both","pc"]).includes(l.device.value)&&
l.page.value.includes(e.pattern)&&m.push(l);return m},[]))}catch(m){kb.alert(kb.error.parse(m)),h(e)}}).catch(t=>h(e)):h(e)}).catch(r=>h(e))}))})(kintone.$PLUGIN_ID);