/*
* FileName "plugins.delete.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(t=>{var l={},y=(b,e)=>new Promise((w,u)=>{var n={suspend:f=>{try{var g=(c,d)=>{var m=()=>{c++;c<b.length?g(c,d):d(!1)};(a=>{kb.filter.scan(l.app,e,a.condition.value)?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(p=>{p?a.suspendMessage.value?kb.filter.scan(l.app,e,a.suspendFilter.value)?a.suspendContinue.value.includes("continue")?kb.confirm(a.suspendMessage.value,v=>{v?d(v):m()},!0):kb.alert(a.suspendMessage.value,()=>d(!0)):m():m():m()}).catch(p=>{kb.alert(kb.error.parse(p));
d(!0)}):m()})(b[c])};g(0,c=>f(c))}catch(c){kb.alert(kb.error.parse(c)),f(!0)}},backup:f=>{try{var g=(c,d)=>{var m=()=>{c++;c<b.length?g(c,d):d(!1)};(a=>{kb.filter.scan(l.app,e,a.condition.value)?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(p=>{p?a.backupApp.value?kintone.api(kintone.api.url("/k/v1/app",!0),"GET",{id:l.app.id}).then(v=>{kb.field.load(a.backupApp.value).then(x=>{(q=>{a.backupID.value in q.external?a.backupName.value in q.external?a.backupUser.value in q.external?
a.backupDatetime.value in q.external?a.backupFile.value in q.external?a.backupRecord.value in q.external?(r=>{r.each((h,k)=>{h.keepName=h.name;h.name="file_"+k.toString()+"."+h.name.split(".").last()});kb.file.clone(r,!0).then(()=>{kb.record.comments.get(l.app.id,e.$id.value).then(h=>{kb.view.records.set(a.backupApp.value,{post:(()=>{var k={};k[a.backupID.value]={value:l.app.id};k[a.backupName.value]={value:v.name};k[a.backupUser.value]={value:[{code:kb.operator.code}]};k[a.backupDatetime.value]=
{value:(new Date).format("ISO")};k[a.backupFile.value]={value:r};k[a.backupRecord.value]={value:JSON.stringify({comments:h,record:e})};return[k]})()},!0).then(k=>m()).catch(k=>{kb.alert(kb.error.parse(k));d(!0)})}).catch(h=>{kb.alert(kb.error.parse(h));d(!0)})})})(Object.values(q.internal).reduce((r,h)=>{h.type=="FILE"&&(h.tableCode?e[h.tableCode].value.each((k,z)=>{k.value[h.code].value&&Array.prototype.push.apply(r,k.value[h.code].value)}):e[h.code].value&&Array.prototype.push.apply(r,e[h.code].value));
return r},[])):(kb.alert("No field to backup was found"),d(!0)):(kb.alert("No field to backup was found"),d(!0)):(kb.alert("No field to backup was found"),d(!0)):(kb.alert("No field to backup was found"),d(!0)):(kb.alert("No field to backup was found"),d(!0)):(kb.alert("No field to backup was found"),d(!0))})({external:x.parallelize,internal:l.fieldInfos.parallelize})}).catch(x=>{kb.alert(kb.error.parse(x));d(!0)})}).catch(v=>{kb.alert(kb.error.parse(v));d(!0)}):m():m()}).catch(p=>{kb.alert(kb.error.parse(p));
d(!0)}):m()})(b[c])};g(0,c=>f(c))}catch(c){kb.alert(kb.error.parse(c)),f(!0)}}};n.suspend(f=>{f?w({error:f}):b.some(g=>g.backupApp.value)&&(kb.loadStart(),n.backup(g=>{kb.loadEnd();w({error:g})}))})});kintone.events.on(["app.record.detail.delete.submit","app.record.index.delete.submit","mobile.app.record.detail.delete.submit"],b=>new Promise((e,w)=>{((u,n)=>{l.mobile=u;l.type=n;kb.config[t].config.get().then(f=>{Object.keys(f).length!=0?kb.field.load(kb.config[t].app,!0).then(g=>{l.app={id:kb.config[t].app,
fields:g.origin};l.fieldInfos=g;try{(c=>{c.length!=0?y(c,b.record).then(d=>{e(d.error?!1:b)}).catch(()=>{e(resp.error?!1:b)}):e(b)})(JSON.parse(f.tab).map((c,d)=>kb.extend({sIndex:{value:d.toString()}},c.setting)).reduce((c,d)=>{(l.mobile?["all","both","mobile"]:["all","both","pc"]).includes(d.device.value)&&c.push(d);return c},[]))}catch(c){kb.alert(kb.error.parse(c)),e(b)}}).catch(g=>e(b)):e(b)}).catch(f=>e(b))})(b.type.split(".").first()=="mobile",b.type.split(".").slice(-2).first())}));kb.event.on("kb.view.delete",
b=>new Promise((e,w)=>{kb.config[t].config.get().then(u=>{Object.keys(u).length!=0?kb.field.load(kb.config[t].app,!0).then(n=>{l.app={id:kb.config[t].app,fields:n.origin};l.fieldInfos=n;try{(f=>{f.length!=0?y(f,b.record).then(g=>{b.error=g.error;e(b)}).catch(()=>{b.error=!0;e(b)}):e(b)})(JSON.parse(u.tab).map((f,g)=>kb.extend({sIndex:{value:g.toString()}},f.setting)).reduce((f,g)=>{(b.mobile?["all","both","mobile"]:["all","both","pc"]).includes(g.device.value)&&f.push(g);return f},[]))}catch(f){kb.alert(kb.error.parse(f)),
e(b)}}).catch(n=>e(b)):e(b)}).catch(u=>e(b))}))})(kintone.$PLUGIN_ID);