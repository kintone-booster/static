/*
* FileName "plugins.mail.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(E){var d={},D=function(c,l,t){t=void 0===t?!1:t;return new Promise(function(u,p){var y="",z=function(e,k){var b=function(){e++;t||kb.progressUpdate();e<c.length?z(e,k):k()};(function(a){var h=kb.filter.scan(d.app,l,a.condition.value);h?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(function(v){if(v){var w=function(g,m,q){"HTML"==a.format.value&&(g=g.replace(/\r/g,"").replace(/\n/g,"<br>"));for(var f in m)g=g.replace(new RegExp("%"+f+"%","g"),kb.field.stringify(d.fieldInfos.parallelize[f],
m[f].value," / "));for(f in q)g=g.replace(new RegExp("%"+f+"%","g"),kb.field.stringify(d.fieldInfos.parallelize[f],q[f].value," / "));return g};(function(g){var m=function(q){(function(f){var B=function(n,x){0!=f.attachment.length?kb.file.download(f.attachment[n],!0).then(function(r){kb.field.blobToBase64(r,function(A){f.attachment[n].data=A;n++;n<f.attachment.length?B(n,x):x()})})["catch"](function(r){kb.alert(kb.error.parse(r));p()}):x()};B(0,function(){kb.encrypt(JSON.stringify(f.data),y).then(function(n){var x=
fetch,r="https://api.kintone-booster.com/mail/"+kb.operator.language,A=JSON,F=A.stringify;f.data=n.data;f.iv=n.iv;f.tag=n.tag;x(r,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:F.call(A,f)}).then(function(C){C.json().then(function(G){switch(C.status){case 200:q++;q<g.length?m(q):b();break;default:kb.alert(kb.error.parse(G)),p()}})})["catch"](function(C){kb.alert(kb.error.parse(C));p()})})["catch"](function(n){p()})})})(g[q])};0!=g.length&&m(0)})(function(){var g=[];(d.fieldInfos.parallelize[a.to.value].tableCode?
h[d.fieldInfos.parallelize[a.to.value].tableCode].value:[h]).each(function(m,q){if(m[a.to.value].value){var f=g.push,B={mail:a.mail.value,sender:a.sender.value,host:a.host.value,port:a.port.value,author:a.author.value,pwd:a.pwd.value,secure:a.secure.value,to:m[a.to.value].value,cc:a.cc.value,bcc:a.bcc.value,html:"HTML"==a.format.value},n=w(a.subject.value,h,d.fieldInfos.parallelize[a.to.value].tableCode?m:{}),x=w(a.body.value,h,d.fieldInfos.parallelize[a.to.value].tableCode?m:{}),r=[];a.attachment.value&&
a.attachment.value in d.fieldInfos.parallelize&&(r=(d.fieldInfos.parallelize[a.attachment.value].tableCode?m:h)[a.attachment.value].value);f.call(g,{data:B,subject:n,body:x,attachment:r})}});return g}())}else b()})["catch"](function(v){kb.alert(kb.error.parse(v));p()}):b()})(c[e])};fetch("https://api.kintone-booster.com/mail/"+kb.operator.language,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(function(e){e.json().then(function(k){switch(e.status){case 200:y=k.passphrase;t||kb.progressStart(c.length);
z(0,function(){t||kb.progressEnd();u()});break;default:kb.alert(kb.error.parse(k)),p()}})})["catch"](function(e){kb.alert(kb.error.parse(e));p()})})};kintone.events.on("app.record.create.submit.success app.record.detail.process.proceed app.record.detail.show app.record.edit.submit.success app.record.index.show mobile.app.record.create.submit.success mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.submit.success mobile.app.record.index.show".split(" "),
function(c){return new Promise(function(l,t){(function(u,p){d.mobile=u;d.type=p;kb.config[E].config.get().then(function(y){0!=Object.keys(y).length?kb.field.load(kb.config[E].app,!0).then(function(z){d.app={id:kb.config[E].app,fields:z.origin};d.fieldInfos=z;try{(function(e){if(0!=e.length)switch(d.type){case "create":case "edit":D(e,c.record).then(function(b){return l(c)})["catch"](function(){});break;case "process":(function(b){0!=b.length?D(b,c.record).then(function(a){return l(c)})["catch"](function(){}):
l(c)})(e.filter(function(b){return b.action.value==c.action.value+":"+c.status.value+":"+c.nextStatus.value}));break;case "detail":var k=function(b){(function(a){kb.filter.scan(d.app,c.record,a.condition.value)?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(function(h){h&&kb.button.create(d.mobile,d.type,"kb-mail-button"+b.toString(),a.label.value,a.message.value,function(){return D([a],c.record).then(function(v){return kb.alert("Done!")})["catch"](function(){})});b++;b<e.length&&
k(b)})["catch"](function(h){b++;b<e.length&&k(b)}):(b++,b<e.length&&k(b))})(e[b])};k(0);l(c);break;case "index":e.each(function(b,a){b.view.value&&b.view.value!=c.viewId.toString()||kb.button.create(d.mobile,d.type,"kb-mail-button"+a.toString(),b.label.value,b.message.value,function(){kb.view.records.get(d.app.id,(d.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(function(h){var v=function(w,g){D([b],h[w],!0).then(function(m){kb.progressUpdate();w++;w<h.length?v(w,g):g()})["catch"](function(){})};
0!=h.length?(kb.progressStart(h.length),v(0,function(){return kb.alert("Done!")})):kb.alert("There are no records.")})["catch"](function(h){return kb.alert(kb.error.parse(h))})})}),l(c)}else l(c)})(JSON.parse(y.tab).reduce(function(e,k){(d.mobile?["both","mobile"]:["both","pc"]).includes(k.setting.device.value)&&k.setting.event.value.includes(d.type)&&e.push(k.setting);return e},[]))}catch(e){kb.alert(kb.error.parse(e)),l(c)}})["catch"](function(z){return l(c)}):l(c)})["catch"](function(y){return l(c)})})("mobile"==
c.type.split(".").first(),function(u){switch(u){case "submit":u=c.type.split(".").slice(-3).first()}return u}(c.type.split(".").slice(-2).first()))})})})(kintone.$PLUGIN_ID);