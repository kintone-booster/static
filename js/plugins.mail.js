/*
* FileName "plugins.mail.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(x=>{var e={},A=(b,f,B=!1)=>new Promise((t,n)=>{var l="",p=(d,g)=>{var c=()=>{d++;d<b.length?p(d,g):g()};(a=>{var q=kb.filter.scan(e.app,f,a.condition.value);q?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(u=>{if(u){var y=(h,m,v)=>{"HTML"==a.format.value&&(h=h.replace(/\r/g,"").replace(/\n/g,"<br>"));for(var k in m)h=h.replace(new RegExp("%"+k+"%","g"),kb.field.stringify(e.fieldInfos.parallelize[k],m[k].value," / ",!0));for(k in v)h=h.replace(new RegExp("%"+k+"%",
"g"),kb.field.stringify(e.fieldInfos.parallelize[k],v[k].value," / ",!0));return h};(h=>{var m=v=>{(k=>{var D=(r,w)=>{0!=k.attachment.length?kb.file.download(k.attachment[r],!0).then(z=>{kb.field.blobToBase64(z,C=>{k.attachment[r].data=C;r++;r<k.attachment.length?D(r,w):w()})}).catch(z=>{kb.alert(kb.error.parse(z));n()}):w()};D(0,()=>{kb.encrypt(JSON.stringify(k.data),l).then(r=>{var w=fetch,z="https://api.kintone-booster.com/mail/"+kb.operator.language,C=JSON,F=C.stringify;k.data=r.data;k.iv=r.iv;
k.tag=r.tag;w(z,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:F.call(C,k)}).then(E=>{E.json().then(G=>{switch(E.status){case 200:v++;v<h.length?m(v):c();break;default:kb.alert(kb.error.parse(G)),n()}})}).catch(E=>{kb.alert(kb.error.parse(E));n()})}).catch(r=>{n()})})})(h[v])};0!=h.length?m(0):c()})((()=>{var h=[];(e.fieldInfos.parallelize[a.to.value].tableCode?q[e.fieldInfos.parallelize[a.to.value].tableCode].value:[{value:q}]).each((m,v)=>{if(m.value[a.to.value].value){v=h.push;
var k={mail:a.mail.value,sender:a.sender.value,host:a.host.value,port:a.port.value,author:a.author.value,pwd:a.pwd.value,secure:a.secure.value,to:m.value[a.to.value].value,cc:a.cc.value,bcc:a.bcc.value,html:"HTML"==a.format.value},D=y(a.subject.value,q,e.fieldInfos.parallelize[a.to.value].tableCode?m.value:{}),r=y(a.body.value,q,e.fieldInfos.parallelize[a.to.value].tableCode?m.value:{}),w=[];a.attachment.value&&a.attachment.value in e.fieldInfos.parallelize&&(w=(e.fieldInfos.parallelize[a.attachment.value].tableCode?
m.value:q)[a.attachment.value].value);v.call(h,{data:k,subject:D,body:r,attachment:w})}});return h})())}else c()}).catch(u=>{kb.alert(kb.error.parse(u));n()}):c()})(b[d])};fetch("https://api.kintone-booster.com/mail/"+kb.operator.language,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(d=>{d.json().then(g=>{switch(d.status){case 200:l=g.passphrase;B||kb.loadStart();p(0,()=>{B||kb.loadEnd();t()});break;default:kb.alert(kb.error.parse(g)),n()}})}).catch(d=>{kb.alert(kb.error.parse(d));
n()})});kintone.events.on("app.record.create.submit.success app.record.detail.process.proceed app.record.detail.show app.record.edit.submit.success app.record.index.show mobile.app.record.create.submit.success mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.submit.success mobile.app.record.index.show".split(" "),b=>new Promise((f,B)=>{((t,n)=>{e.mobile=t;e.type=n;kb.config[x].config.get().then(l=>{0!=Object.keys(l).length?kb.field.load(kb.config[x].app,
!0).then(p=>{e.app={id:kb.config[x].app,fields:p.origin};e.fieldInfos=p;try{(d=>{if(0!=d.length)switch(e.type){case "create":case "edit":A(d,b.record).then(c=>f(b)).catch(()=>{});break;case "process":(c=>{0!=c.length?A(c,b.record).then(a=>f(b)).catch(()=>{}):f(b)})(d.filter(c=>c.action.value==b.action.value+":"+b.status.value+":"+b.nextStatus.value));break;case "detail":var g=c=>{(a=>{kb.filter.scan(e.app,b.record,a.condition.value)?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(q=>
{q&&kb.button.create(e.mobile,e.type,"kb-mail-button"+c.toString(),a.label.value,a.message.value,()=>A([a],b.record).then(u=>kb.alert("Done!")).catch(()=>{}));c++;c<d.length&&g(c)}).catch(q=>{c++;c<d.length&&g(c)}):(c++,c<d.length&&g(c))})(d[c])};g(0);f(b);break;case "index":g=c=>{(a=>{kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(q=>{q&&(a.view.value&&a.view.value!=b.viewId.toString()||kb.button.create(e.mobile,e.type,"kb-mail-button"+c.toString(),a.label.value,a.message.value,
()=>{kb.view.records.get(e.app.id,(e.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(u=>{let y=(h,m)=>{A([a],u[h],!0).then(v=>{kb.progressUpdate();h++;h<u.length?y(h,m):m()}).catch(()=>{})};0!=u.length?(kb.progressStart(u.length),y(0,()=>kb.alert("Done!"))):kb.alert("There are no records.")}).catch(u=>kb.alert(kb.error.parse(u)))}));c++;c<d.length&&g(c)}).catch(q=>{c++;c<d.length&&g(c)})})(d[c])},g(0),f(b)}else f(b)})(JSON.parse(l.tab).map((d,g)=>kb.extend({sIndex:{value:g.toString()}},
d.setting)).reduce((d,g)=>{(e.mobile?["both","mobile"]:["both","pc"]).includes(g.device.value)&&g.event.value.includes(e.type)&&d.push(g);return d},[]))}catch(d){kb.alert(kb.error.parse(d)),f(b)}}).catch(p=>f(b)):f(b)}).catch(l=>f(b))})("mobile"==b.type.split(".").first(),(t=>{switch(t){case "submit":t=b.type.split(".").slice(-3).first()}return t})(b.type.split(".").slice(-2).first()))}));kb.event.on("kb.mail.call",b=>new Promise((f,B)=>{kb.config[x].config.get().then(t=>{0!=Object.keys(t).length?
kb.field.load(kb.config[x].app,!0).then(n=>{e.app={id:kb.config[x].app,fields:n.origin};e.fieldInfos=n;try{(l=>{0!=l.length?A(l,b.record,!0).then(p=>f(b)).catch(()=>f(b)):f(b)})(JSON.parse(t.tab).map((l,p)=>kb.extend({sIndex:{value:p.toString()}},l.setting)).reduce((l,p)=>{(b.mobile?["both","mobile"]:["both","pc"]).includes(p.device.value)&&p.event.value.includes(b.pattern)&&l.push(p);return l},[]))}catch(l){kb.alert(kb.error.parse(l)),f(b)}}).catch(n=>f(b)):f(b)}).catch(t=>f(b))}))})(kintone.$PLUGIN_ID);