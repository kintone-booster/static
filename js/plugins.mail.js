/*
* FileName "plugins.mail.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
(function(E){var e={},D=function(c,l,u){u=void 0===u?!1:u;return new Promise(function(v,q){var x="",y=function(d,h){var b=function(){d++;u||kb.progressUpdate();d<c.length?y(d,h):h()};(function(a){var m=kb.filter.scan(e.app,l,a.condition.value);m?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(function(p){if(p){var z=function(f,k,r){"HTML"==a.format.value&&(f=f.replace(/\r/g,"").replace(/\n/g,"<br>"));for(var g in k)f=f.replace(new RegExp("%"+g+"%","g"),kb.field.stringify(e.fieldInfos.parallelize[g],
k[g].value," / "));for(g in r)f=f.replace(new RegExp("%"+g+"%","g"),kb.field.stringify(e.fieldInfos.parallelize[g],r[g].value," / "));return f};(function(f){var k=function(r){(function(g){var B=function(n,w){0!=g.attachment.length?kb.file.download(g.attachment[n],!0).then(function(t){kb.field.blobToBase64(t,function(A){g.attachment[n].data=A;n++;n<g.attachment.length?B(n,w):w()})})["catch"](function(t){kb.alert(kb.error.parse(t));q()}):w()};B(0,function(){kb.encrypt(JSON.stringify(g.data),x).then(function(n){var w=
fetch,t="https://api.kintone-booster.com/mail/"+kb.operator.language,A=JSON,F=A.stringify;g.data=n.data;g.iv=n.iv;g.tag=n.tag;w(t,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:F.call(A,g)}).then(function(C){C.json().then(function(G){switch(C.status){case 200:r++;r<f.length?k(r):b();break;default:kb.alert(kb.error.parse(G)),q()}})})["catch"](function(C){kb.alert(kb.error.parse(C));q()})})["catch"](function(n){q()})})})(f[r])};0!=f.length&&k(0)})(function(){var f=[];(e.fieldInfos.parallelize[a.to.value].tableCode?
m[e.fieldInfos.parallelize[a.to.value].tableCode].value:[m]).each(function(k,r){if(k[a.to.value].value){var g=f.push,B={mail:a.mail.value,sender:a.sender.value,host:a.host.value,port:a.port.value,author:a.author.value,pwd:a.pwd.value,secure:a.secure.value,to:k[a.to.value].value,cc:a.cc.value,bcc:a.bcc.value,html:"HTML"==a.format.value},n=z(a.subject.value,m,e.fieldInfos.parallelize[a.to.value].tableCode?k:{}),w=z(a.body.value,m,e.fieldInfos.parallelize[a.to.value].tableCode?k:{}),t=[];a.attachment.value&&
a.attachment.value in e.fieldInfos.parallelize&&(t=(e.fieldInfos.parallelize[a.attachment.value].tableCode?k:m)[a.attachment.value].value);g.call(f,{data:B,subject:n,body:w,attachment:t})}});return f}())}else b()})["catch"](function(p){kb.alert(kb.error.parse(p));q()}):b()})(c[d])};fetch("https://api.kintone-booster.com/mail/"+kb.operator.language,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(function(d){d.json().then(function(h){switch(d.status){case 200:x=h.passphrase;u||kb.progressStart(c.length);
y(0,function(){u||kb.progressEnd();v()});break;default:kb.alert(kb.error.parse(h)),q()}})})["catch"](function(d){kb.alert(kb.error.parse(d));q()})})};kintone.events.on("app.record.create.submit.success app.record.detail.process.proceed app.record.detail.show app.record.edit.submit.success app.record.index.show mobile.app.record.create.submit.success mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.submit.success mobile.app.record.index.show".split(" "),
function(c){return new Promise(function(l,u){(function(v,q){e.mobile=v;e.type=q;kb.config[E].config.get().then(function(x){0!=Object.keys(x).length?kb.field.load(kb.config[E].app,!0).then(function(y){e.app={id:kb.config[E].app,fields:y.origin};e.fieldInfos=y;try{(function(d){if(0!=d.length)switch(e.type){case "create":case "edit":D(d,c.record).then(function(b){return l(c)})["catch"](function(){});break;case "process":(function(b){0!=b.length?D(b,c.record).then(function(a){return l(c)})["catch"](function(){}):
l(c)})(d.filter(function(b){return b.action.value==c.action.value+":"+c.status.value+":"+c.nextStatus.value}));break;case "detail":var h=function(b){(function(a){kb.filter.scan(e.app,c.record,a.condition.value)?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(function(m){m&&kb.button.create(e.mobile,e.type,"kb-mail-button"+b.toString(),a.label.value,a.message.value,function(){return D([a],c.record).then(function(p){return kb.alert("Done!")})["catch"](function(){})});b++;b<d.length&&
h(b)})["catch"](function(m){b++;b<d.length&&h(b)}):(b++,b<d.length&&h(b))})(d[b])};h(0);l(c);break;case "index":h=function(b){(function(a){kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(function(m){m&&(a.view.value&&a.view.value!=c.viewId.toString()||kb.button.create(e.mobile,e.type,"kb-mail-button"+b.toString(),a.label.value,a.message.value,function(){kb.view.records.get(e.app.id,(e.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(function(p){var z=function(f,
k){D([a],p[f],!0).then(function(r){kb.progressUpdate();f++;f<p.length?z(f,k):k()})["catch"](function(){})};0!=p.length?(kb.progressStart(p.length),z(0,function(){return kb.alert("Done!")})):kb.alert("There are no records.")})["catch"](function(p){return kb.alert(kb.error.parse(p))})}));b++;b<d.length&&h(b)})["catch"](function(m){b++;b<d.length&&h(b)})})(d[b])},h(0),l(c)}else l(c)})(JSON.parse(x.tab).reduce(function(d,h){(e.mobile?["both","mobile"]:["both","pc"]).includes(h.setting.device.value)&&
h.setting.event.value.includes(e.type)&&d.push(h.setting);return d},[]))}catch(d){kb.alert(kb.error.parse(d)),l(c)}})["catch"](function(y){return l(c)}):l(c)})["catch"](function(x){return l(c)})})("mobile"==c.type.split(".").first(),function(v){switch(v){case "submit":v=c.type.split(".").slice(-3).first()}return v}(c.type.split(".").slice(-2).first()))})})})(kintone.$PLUGIN_ID);