/*
* FileName "plugins.mail.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(z=>{var c={},B=(b,g,C=!1)=>new Promise((u,q)=>{var m="",r=(e,h)=>{var d=()=>{e++;e<b.length?r(e,h):h()};(a=>{var p=kb.filter.scan(c.app,g,a.condition.value);p?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(v=>{if(v){var y=(k,n,w)=>{"HTML"==a.format.value&&(k=k.replace(/\r/g,"").replace(/\n/g,"<br>"));for(var f in n){var t=n[f].value;f in c.fieldInfos.parallelize&&("HTML"==a.format.value&&"MULTI_LINE_TEXT"==c.fieldInfos.parallelize[f].type&&(t=t.replace(/\r/g,"").replace(/\n/g,
"<br>")),k=k.replace(new RegExp("%"+f+"%","g"),kb.field.stringify(c.fieldInfos.parallelize[f],t," / ",!0)))}for(f in w)t=w[f].value,f in c.fieldInfos.parallelize&&("HTML"==a.format.value&&"MULTI_LINE_TEXT"==c.fieldInfos.parallelize[f].type&&(t=t.replace(/\r/g,"").replace(/\n/g,"<br>")),k=k.replace(new RegExp("%"+f+"%","g"),kb.field.stringify(c.fieldInfos.parallelize[f],t," / ",!0)));return k};(k=>{var n=w=>{(f=>{var t=(l,x)=>{if(0!=f.attachment.length){var D=!1;window.hasOwnProperty("kb_report_temp")&&
f.attachment[l].fileKey in window.kb_report_temp&&(D=!0);D?(f.attachment[l].data=window.kb_report_temp[f.attachment[l].fileKey],l++,l<f.attachment.length?t(l,x):x()):kb.file.download(f.attachment[l],!0).then(A=>{kb.field.blobToBase64(A,F=>{f.attachment[l].data=F;l++;l<f.attachment.length?t(l,x):x()})}).catch(A=>{kb.alert(kb.error.parse(A));q()})}else x()};t(0,()=>{kb.encrypt(JSON.stringify(f.data),m).then(l=>{var x=fetch,D="https://api.kintone-booster.com/mail/"+kb.operator.language,A=JSON,F=A.stringify;
f.data=l.data;f.iv=l.iv;f.tag=l.tag;x(D,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:F.call(A,f)}).then(E=>{E.json().then(G=>{switch(E.status){case 200:w++;w<k.length?n(w):d();break;default:kb.alert(kb.error.parse(G)),q()}})}).catch(E=>{kb.alert(kb.error.parse(E));q()})}).catch(l=>{q()})})})(k[w])};0!=k.length?n(0):d()})((()=>{var k=[];(c.fieldInfos.parallelize[a.to.value].tableCode?p[c.fieldInfos.parallelize[a.to.value].tableCode].value:[{value:p}]).each((n,w)=>{if(n.value[a.to.value].value){w=
k.push;var f={mail:a.mail.value,sender:a.sender.value,host:a.host.value,port:a.port.value,author:a.author.value,pwd:a.pwd.value,secure:a.secure.value,to:n.value[a.to.value].value,cc:y(a.cc.value,p,c.fieldInfos.parallelize[a.to.value].tableCode?n.value:{}),bcc:y(a.bcc.value,p,c.fieldInfos.parallelize[a.to.value].tableCode?n.value:{}),html:"HTML"==a.format.value},t=y(a.subject.value,p,c.fieldInfos.parallelize[a.to.value].tableCode?n.value:{}),l=y(a.body.value,p,c.fieldInfos.parallelize[a.to.value].tableCode?
n.value:{}),x=[];a.attachment.value&&a.attachment.value in c.fieldInfos.parallelize&&(x=(c.fieldInfos.parallelize[a.attachment.value].tableCode?n.value:p)[a.attachment.value].value);w.call(k,{data:f,subject:t,body:l,attachment:x})}});return k})())}else d()}).catch(v=>{kb.alert(kb.error.parse(v));q()}):d()})(b[e])};fetch("https://api.kintone-booster.com/mail/"+kb.operator.language,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>{e.json().then(h=>{switch(e.status){case 200:m=h.passphrase;
C||kb.loadStart();r(0,()=>{C||kb.loadEnd();u()});break;default:kb.alert(kb.error.parse(h)),q()}})}).catch(e=>{kb.alert(kb.error.parse(e));q()})});kintone.events.on("app.record.create.submit.success app.record.detail.process.proceed app.record.detail.show app.record.edit.submit.success app.record.index.show mobile.app.record.create.submit.success mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.submit.success mobile.app.record.index.show".split(" "),b=>
new Promise((g,C)=>{((u,q)=>{c.mobile=u;c.type=q;kb.config[z].config.get().then(m=>{0!=Object.keys(m).length?kb.field.load(kb.config[z].app,!0).then(r=>{c.app={id:kb.config[z].app,fields:r.origin};c.fieldInfos=r;try{(e=>{if(0!=e.length)switch(c.type){case "create":case "edit":B(e,b.record).then(d=>g(b)).catch(()=>{});break;case "process":(d=>{0!=d.length?B(d,b.record).then(a=>g(b)).catch(()=>{}):g(b)})(e.filter(d=>d.action.value==b.action.value+":"+b.status.value+":"+b.nextStatus.value));break;case "detail":var h=
d=>{(a=>{kb.filter.scan(c.app,b.record,a.condition.value)?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(p=>{p&&kb.button.create(c.mobile,c.type,"kb-mail-button"+d.toString(),a.label.value,a.message.value,()=>B([a],b.record).then(v=>kb.alert("Done!")).catch(()=>{}));d++;d<e.length&&h(d)}).catch(p=>{d++;d<e.length&&h(d)}):(d++,d<e.length&&h(d))})(e[d])};h(0);g(b);break;case "index":h=d=>{(a=>{kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(p=>{p&&(a.view.value&&
a.view.value!=b.viewId.toString()||kb.button.create(c.mobile,c.type,"kb-mail-button"+d.toString(),a.label.value,a.message.value,()=>{kb.view.records.get(c.app.id,(c.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(v=>{let y=(k,n)=>{B([a],v[k],!0).then(w=>{kb.progressUpdate();k++;k<v.length?y(k,n):n()}).catch(()=>{})};0!=v.length?(kb.progressStart(v.length),y(0,()=>kb.alert("Done!"))):kb.alert("There are no records.")}).catch(v=>kb.alert(kb.error.parse(v)))}));d++;d<e.length&&h(d)}).catch(p=>
{d++;d<e.length&&h(d)})})(e[d])},h(0),g(b)}else g(b)})(JSON.parse(m.tab).map((e,h)=>kb.extend({sIndex:{value:h.toString()}},e.setting)).reduce((e,h)=>{(c.mobile?["all","both","mobile"]:["all","both","pc"]).includes(h.device.value)&&h.event.value.includes(c.type)&&e.push(h);return e},[]))}catch(e){kb.alert(kb.error.parse(e)),g(b)}}).catch(r=>g(b)):g(b)}).catch(m=>g(b))})("mobile"==b.type.split(".").first(),(u=>{switch(u){case "submit":u=b.type.split(".").slice(-3).first()}return u})(b.type.split(".").slice(-2).first()))}));
kb.event.on("kb.mail.call",b=>new Promise((g,C)=>{kb.config[z].config.get().then(u=>{0!=Object.keys(u).length?kb.field.load(kb.config[z].app,!0).then(q=>{c.app={id:kb.config[z].app,fields:q.origin};c.fieldInfos=q;try{(m=>{0!=m.length?B(m,b.record,!0).then(r=>g(b)).catch(()=>g(b)):g(b)})(JSON.parse(u.tab).map((m,r)=>kb.extend({sIndex:{value:r.toString()}},m.setting)).reduce((m,r)=>{(b.mobile?["all","both","mobile"]:["all","both","pc"]).includes(r.device.value)&&r.event.value.includes(b.pattern)&&m.push(r);
return m},[]))}catch(m){kb.alert(kb.error.parse(m)),g(b)}}).catch(q=>g(b)):g(b)}).catch(u=>g(b))}))})(kintone.$PLUGIN_ID);
