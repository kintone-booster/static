/*
* FileName "plugins.mail.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(z=>{var b={},C=(d,k,D=!1)=>new Promise((w,r)=>{var p="",t=(e,q)=>{var u=()=>{e++;e<d.length?t(e,q):q()};(a=>{var c=kb.filter.scan(b.app,k,a.condition.value);c?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(x=>{if(x){var v=(m,n,f)=>{"HTML"==a.format.value&&(m=m.replace(/\r/g,"").replace(/\n/g,"<br>"));for(var g in n){var h=n[g].value;g in b.fieldInfos.parallelize&&("HTML"==a.format.value&&"MULTI_LINE_TEXT"==b.fieldInfos.parallelize[g].type&&(h=h.replace(/\r/g,"").replace(/\n/g,
"<br>")),m=m.replace(new RegExp("%"+g+"%","g"),kb.field.stringify(b.fieldInfos.parallelize[g],h," / ",!0)))}for(g in f)h=f[g].value,g in b.fieldInfos.parallelize&&("HTML"==a.format.value&&"MULTI_LINE_TEXT"==b.fieldInfos.parallelize[g].type&&(h=h.replace(/\r/g,"").replace(/\n/g,"<br>")),m=m.replace(new RegExp("%"+g+"%","g"),kb.field.stringify(b.fieldInfos.parallelize[g],h," / ",!0)));return m};(m=>{var n=(f,g)=>{(h=>{var B=(l,y)=>{if(0!=h.attachment.length){var E=!1;window.hasOwnProperty("kb_report_temp")&&
h.attachment[l].fileKey in window.kb_report_temp&&(E=!0);E?(h.attachment[l].data=window.kb_report_temp[h.attachment[l].fileKey],l++,l<h.attachment.length?B(l,y):y()):kb.file.download(h.attachment[l],!0).then(A=>{kb.field.blobToBase64(A,G=>{h.attachment[l].data=G;l++;l<h.attachment.length?B(l,y):y()})}).catch(A=>{kb.alert(kb.error.parse(A));r()})}else y()};B(0,()=>{kb.encrypt(JSON.stringify(h.data),p).then(l=>{var y=fetch,E="https://api.kintone-booster.com/mail/"+kb.operator.language,A=JSON,G=A.stringify;
h.data=l.data;h.iv=l.iv;h.tag=l.tag;y(E,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:G.call(A,h)}).then(F=>{F.json().then(H=>{switch(F.status){case 200:f++;f<m.length?n(f,g):g();break;default:kb.alert(kb.error.parse(H)),r()}})}).catch(F=>{kb.alert(kb.error.parse(F));r()})}).catch(l=>{r()})})})(m[f])};0!=m.length?n(0,()=>{try{a.formula.value.map(f=>f.value).each((f,g)=>{f.field.value in b.fieldInfos.parallelize&&(g=b.fieldInfos.parallelize[f.field.value],g.tableCode||(c[g.code].value=
kb.formula.calculate(f,c,c,k,b.fieldInfos.parallelize),g.lookup&&(c[g.code].lookup=!0),f=c.$id.value,f in b.formulaRecords||(b.formulaRecords[f]={$id:{value:f}}),b.formulaRecords[f][g.code]=c[g.code]))}),u()}catch(f){kb.alert(kb.error.parse(f)),r()}}):u()})((()=>{var m=[];(b.fieldInfos.parallelize[a.to.value].tableCode?c[b.fieldInfos.parallelize[a.to.value].tableCode].value:[{value:c}]).each((n,f)=>{if(n.value[a.to.value].value){f=m.push;var g={mail:a.mail.value,sender:a.sender.value,host:a.host.value,
port:a.port.value,author:a.author.value,pwd:a.pwd.value,secure:a.secure.value,to:n.value[a.to.value].value,cc:v(a.cc.value,c,b.fieldInfos.parallelize[a.to.value].tableCode?n.value:{}),bcc:v(a.bcc.value,c,b.fieldInfos.parallelize[a.to.value].tableCode?n.value:{}),html:"HTML"==a.format.value},h=v(a.subject.value,c,b.fieldInfos.parallelize[a.to.value].tableCode?n.value:{}),B=v(a.body.value,c,b.fieldInfos.parallelize[a.to.value].tableCode?n.value:{}),l=[];a.attachment.value&&a.attachment.value in b.fieldInfos.parallelize&&
(l=(b.fieldInfos.parallelize[a.attachment.value].tableCode?n.value:c)[a.attachment.value].value);f.call(m,{data:g,subject:h,body:B,attachment:l})}});return m})())}else u()}).catch(x=>{kb.alert(kb.error.parse(x));r()}):u()})(d[e])};fetch("https://api.kintone-booster.com/mail/"+kb.operator.language,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>{e.json().then(q=>{switch(e.status){case 200:p=q.passphrase;D||kb.loadStart();t(0,()=>{D||kb.loadEnd();w()});break;default:kb.alert(kb.error.parse(q)),
r()}})}).catch(e=>{kb.alert(kb.error.parse(e));r()})});kintone.events.on("app.record.create.submit.success app.record.detail.process.proceed app.record.detail.show app.record.edit.submit.success app.record.index.show mobile.app.record.create.submit.success mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.submit.success mobile.app.record.index.show".split(" "),d=>new Promise((k,D)=>{((w,r)=>{b.mobile=w;b.type=r;kb.config[z].config.get().then(p=>{0!=Object.keys(p).length?
kb.field.load(kb.config[z].app,!0).then(t=>{b.app={id:kb.config[z].app,fields:t.origin};b.fieldInfos=t;b.formulaRecords={};try{(e=>{if(0!=e.length){var q=a=>{["process"].includes(b.type)||0==Object.keys(b.formulaRecords).length?a():kb.view.records.set(b.app.id,{put:Object.values(b.formulaRecords).map(c=>kb.view.records.transform(c))},!1).then(c=>a()).catch(c=>kb.alert(kb.error.parse(c)))};"formula"in e.first()||(kb.alert(kb.error.config.update("Boost! Mail")),e=e.map(a=>{a.formula={value:[]};return a}));
switch(b.type){case "create":case "edit":C(e,d.record).then(a=>q(()=>k(d))).catch(()=>{});break;case "process":(a=>{0!=a.length?C(a,d.record).then(c=>q(()=>k(d))).catch(()=>{}):k(d)})(e.filter(a=>a.action.value==d.action.value+":"+d.status.value+":"+d.nextStatus.value));break;case "detail":var u=a=>{(c=>{kb.filter.scan(b.app,d.record,c.condition.value)?kb.filter.auth(c.user.value,c.organization.value,c.group.value).then(x=>{x&&kb.button.create(b.mobile,b.type,"kb-mail-button"+a.toString(),c.label.value,
c.message.value,()=>C([c],d.record).then(v=>q(()=>kb.alert("Done!",()=>window.location.reload(!0)))).catch(()=>{}));a++;a<e.length&&u(a)}).catch(x=>{a++;a<e.length&&u(a)}):(a++,a<e.length&&u(a))})(e[a])};u(0);k(d);break;case "index":u=a=>{(c=>{kb.filter.auth(c.user.value,c.organization.value,c.group.value).then(x=>{x&&(c.view.value&&c.view.value!=d.viewId.toString()||kb.button.create(b.mobile,b.type,"kb-mail-button"+a.toString(),c.label.value,c.message.value,()=>{kb.view.records.get(b.app.id,(b.mobile?
kintone.mobile.app:kintone.app).getQueryCondition()).then(v=>{let m=(n,f)=>{C([c],v[n],!0).then(g=>{kb.progressUpdate();n++;n<v.length?m(n,f):f()}).catch(()=>{})};0!=v.length?(kb.progressStart(v.length),m(0,()=>q(()=>kb.alert("Done!",()=>window.location.reload(!0))))):kb.alert("There are no records.")}).catch(v=>kb.alert(kb.error.parse(v)))}));a++;a<e.length&&u(a)}).catch(x=>{a++;a<e.length&&u(a)})})(e[a])},u(0),k(d)}}else k(d)})(JSON.parse(p.tab).map((e,q)=>kb.extend({sIndex:{value:q.toString()}},
e.setting)).reduce((e,q)=>{(b.mobile?["all","both","mobile"]:["all","both","pc"]).includes(q.device.value)&&q.event.value.includes(b.type)&&e.push(q);return e},[]))}catch(e){kb.alert(kb.error.parse(e)),k(d)}}).catch(t=>k(d)):k(d)}).catch(p=>k(d))})("mobile"==d.type.split(".").first(),(w=>{switch(w){case "submit":w=d.type.split(".").slice(-3).first()}return w})(d.type.split(".").slice(-2).first()))}));kb.event.on("kb.mail.call",d=>new Promise((k,D)=>{kb.config[z].config.get().then(w=>{0!=Object.keys(w).length?
kb.field.load(kb.config[z].app,!0).then(r=>{b.app={id:kb.config[z].app,fields:r.origin};b.fieldInfos=r;try{(p=>{0!=p.length?C(p,d.record,!0).then(t=>k(d)).catch(()=>k(d)):k(d)})(JSON.parse(w.tab).map((p,t)=>kb.extend({sIndex:{value:t.toString()}},p.setting)).reduce((p,t)=>{(d.mobile?["all","both","mobile"]:["all","both","pc"]).includes(t.device.value)&&t.event.value.includes(d.pattern)&&p.push(t);return p},[]))}catch(p){kb.alert(kb.error.parse(p)),k(d)}}).catch(r=>k(d)):k(d)}).catch(w=>k(d))}))})(kintone.$PLUGIN_ID);
