/*
* FileName "plugins.mail.js"
* Version: 1.0.0
* Copyright (c) 2023 Pandafirm LLC
* Distributed under the terms of the GNU Lesser General Public License.
* https://opensource.org/licenses/LGPL-2.1
*/
'use strict';(y=>{var d={},A=(b,f,B=!1)=>new Promise((t,p)=>{var l="",q=(e,g)=>{var c=()=>{e++;e<b.length?q(e,g):g()};(a=>{var n=kb.filter.scan(d.app,f,a.condition.value);n?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(u=>{if(u){var x=(h,m,v)=>{"HTML"==a.format.value&&(h=h.replace(/\r/g,"").replace(/\n/g,"<br>"));for(var k in m)h=h.replace(new RegExp("%"+k+"%","g"),kb.field.stringify(d.fieldInfos.parallelize[k],m[k].value," / ",!0));for(k in v)h=h.replace(new RegExp("%"+k+"%",
"g"),kb.field.stringify(d.fieldInfos.parallelize[k],v[k].value," / ",!0));return h};(h=>{var m=v=>{(k=>{var D=(r,w)=>{0!=k.attachment.length?kb.file.download(k.attachment[r],!0).then(z=>{kb.field.blobToBase64(z,C=>{k.attachment[r].data=C;r++;r<k.attachment.length?D(r,w):w()})}).catch(z=>{kb.alert(kb.error.parse(z));p()}):w()};D(0,()=>{kb.encrypt(JSON.stringify(k.data),l).then(r=>{var w=fetch,z="https://api.kintone-booster.com/mail/"+kb.operator.language,C=JSON,F=C.stringify;k.data=r.data;k.iv=r.iv;
k.tag=r.tag;w(z,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:F.call(C,k)}).then(E=>{E.json().then(G=>{switch(E.status){case 200:v++;v<h.length?m(v):c();break;default:kb.alert(kb.error.parse(G)),p()}})}).catch(E=>{kb.alert(kb.error.parse(E));p()})}).catch(r=>{p()})})})(h[v])};0!=h.length?m(0):c()})((()=>{var h=[];(d.fieldInfos.parallelize[a.to.value].tableCode?n[d.fieldInfos.parallelize[a.to.value].tableCode].value:[{value:n}]).each((m,v)=>{if(m.value[a.to.value].value){v=h.push;
var k={mail:a.mail.value,sender:a.sender.value,host:a.host.value,port:a.port.value,author:a.author.value,pwd:a.pwd.value,secure:a.secure.value,to:m.value[a.to.value].value,cc:x(a.cc.value,n,d.fieldInfos.parallelize[a.to.value].tableCode?m.value:{}),bcc:x(a.bcc.value,n,d.fieldInfos.parallelize[a.to.value].tableCode?m.value:{}),html:"HTML"==a.format.value},D=x(a.subject.value,n,d.fieldInfos.parallelize[a.to.value].tableCode?m.value:{}),r=x(a.body.value,n,d.fieldInfos.parallelize[a.to.value].tableCode?
m.value:{}),w=[];a.attachment.value&&a.attachment.value in d.fieldInfos.parallelize&&(w=(d.fieldInfos.parallelize[a.attachment.value].tableCode?m.value:n)[a.attachment.value].value);v.call(h,{data:k,subject:D,body:r,attachment:w})}});return h})())}else c()}).catch(u=>{kb.alert(kb.error.parse(u));p()}):c()})(b[e])};fetch("https://api.kintone-booster.com/mail/"+kb.operator.language,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>{e.json().then(g=>{switch(e.status){case 200:l=g.passphrase;
B||kb.loadStart();q(0,()=>{B||kb.loadEnd();t()});break;default:kb.alert(kb.error.parse(g)),p()}})}).catch(e=>{kb.alert(kb.error.parse(e));p()})});kintone.events.on("app.record.create.submit.success app.record.detail.process.proceed app.record.detail.show app.record.edit.submit.success app.record.index.show mobile.app.record.create.submit.success mobile.app.record.detail.process.proceed mobile.app.record.detail.show mobile.app.record.edit.submit.success mobile.app.record.index.show".split(" "),b=>
new Promise((f,B)=>{((t,p)=>{d.mobile=t;d.type=p;kb.config[y].config.get().then(l=>{0!=Object.keys(l).length?kb.field.load(kb.config[y].app,!0).then(q=>{d.app={id:kb.config[y].app,fields:q.origin};d.fieldInfos=q;try{(e=>{if(0!=e.length)switch(d.type){case "create":case "edit":A(e,b.record).then(c=>f(b)).catch(()=>{});break;case "process":(c=>{0!=c.length?A(c,b.record).then(a=>f(b)).catch(()=>{}):f(b)})(e.filter(c=>c.action.value==b.action.value+":"+b.status.value+":"+b.nextStatus.value));break;case "detail":var g=
c=>{(a=>{kb.filter.scan(d.app,b.record,a.condition.value)?kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(n=>{n&&kb.button.create(d.mobile,d.type,"kb-mail-button"+c.toString(),a.label.value,a.message.value,()=>A([a],b.record).then(u=>kb.alert("Done!")).catch(()=>{}));c++;c<e.length&&g(c)}).catch(n=>{c++;c<e.length&&g(c)}):(c++,c<e.length&&g(c))})(e[c])};g(0);f(b);break;case "index":g=c=>{(a=>{kb.filter.auth(a.user.value,a.organization.value,a.group.value).then(n=>{n&&(a.view.value&&
a.view.value!=b.viewId.toString()||kb.button.create(d.mobile,d.type,"kb-mail-button"+c.toString(),a.label.value,a.message.value,()=>{kb.view.records.get(d.app.id,(d.mobile?kintone.mobile.app:kintone.app).getQueryCondition()).then(u=>{let x=(h,m)=>{A([a],u[h],!0).then(v=>{kb.progressUpdate();h++;h<u.length?x(h,m):m()}).catch(()=>{})};0!=u.length?(kb.progressStart(u.length),x(0,()=>kb.alert("Done!"))):kb.alert("There are no records.")}).catch(u=>kb.alert(kb.error.parse(u)))}));c++;c<e.length&&g(c)}).catch(n=>
{c++;c<e.length&&g(c)})})(e[c])},g(0),f(b)}else f(b)})(JSON.parse(l.tab).map((e,g)=>kb.extend({sIndex:{value:g.toString()}},e.setting)).reduce((e,g)=>{(d.mobile?["both","mobile"]:["both","pc"]).includes(g.device.value)&&g.event.value.includes(d.type)&&e.push(g);return e},[]))}catch(e){kb.alert(kb.error.parse(e)),f(b)}}).catch(q=>f(b)):f(b)}).catch(l=>f(b))})("mobile"==b.type.split(".").first(),(t=>{switch(t){case "submit":t=b.type.split(".").slice(-3).first()}return t})(b.type.split(".").slice(-2).first()))}));
kb.event.on("kb.mail.call",b=>new Promise((f,B)=>{kb.config[y].config.get().then(t=>{0!=Object.keys(t).length?kb.field.load(kb.config[y].app,!0).then(p=>{d.app={id:kb.config[y].app,fields:p.origin};d.fieldInfos=p;try{(l=>{0!=l.length?A(l,b.record,!0).then(q=>f(b)).catch(()=>f(b)):f(b)})(JSON.parse(t.tab).map((l,q)=>kb.extend({sIndex:{value:q.toString()}},l.setting)).reduce((l,q)=>{(b.mobile?["both","mobile"]:["both","pc"]).includes(q.device.value)&&q.event.value.includes(b.pattern)&&l.push(q);return l},
[]))}catch(l){kb.alert(kb.error.parse(l)),f(b)}}).catch(p=>f(b)):f(b)}).catch(t=>f(b))}))})(kintone.$PLUGIN_ID);